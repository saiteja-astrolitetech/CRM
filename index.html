<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diary Dashboard</title>

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />

    <!-- Leaflet CSS -->
    <link href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" rel="stylesheet" />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- jsPDF and Plugins -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <!-- SheetJS (XLSX) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <link rel="stylesheet" href="CRM.css">

</head>

<body>

    <header>
        <img alt="Logo" class="hdr-logo" onclick="showSection('dashboard')" src="Company logo.jpg" />
        <button onclick="toggleSidebar()">☰</button>
        <input class="hdr-search" placeholder="Search..." type="text" style="flex: 1;" />
        <i class="fas fa-bell hdr-icon"></i>
        <i class="fas fa-envelope hdr-icon"></i>

        <div class="dropdown">
            <button class="dropdown-btn">English</button>
            <div class="dropdown-content">
                <div class="dropdown-item" onclick="setLanguage('en')">English</div>
                <div class="dropdown-item" onclick="setLanguage('hi')">Hindi</div>
                <div class="dropdown-item" onclick="setLanguage('te')">Telugu</div>
                <div class="dropdown-item" onclick="setLanguage('de')">German</div>
            </div>
        </div>

        <div class="dropdown">
            <button class="dropdown-btn"><span class="dot green"></span> Active</button>
            <div class="dropdown-content">
                <div class="dropdown-item" onclick="setWorkMode('active')"><span class="dot green"></span> Active</div>
                <div class="dropdown-item" onclick="setWorkMode('away')"><span class="dot gray"></span> Away</div>
                <div class="dropdown-item" onclick="setWorkMode('dnd')"><span class="dot red"></span> Do Not Disturb
                </div>
            </div>
        </div>
        <button class="theme-toggle" id="theme-toggle"><i class="fas fa-moon"></i></button>

        <div class="profile-section"
            onclick="document.querySelectorAll('.section').forEach(s=>s.classList.remove('active')); document.getElementById('profile').classList.add('active');">
            <span class="profile-name">Sai Teja Kasanagottu</span>
            <img alt="Profile" class="profile-img" src="image.png" />
        </div>
    </header>
    <aside class="sidebar" id="sidebar">
        <ul>
            <li class="active" onclick="activateNav(this,'dashboard')"><i class="fas fa-home"></i> Dashboard</li>
            <li onclick="activateNav(this,'farmer-mgmt')"><i class="fas fa-users"></i> Farmer Management</li>
            <li onclick="activateNav(this,'milk-collection')"><i class="fas fa-tint"></i> Milk Collection</li>
            <li onclick="activateNav(this,'chilling')"><i class="fas fa-snowflake"></i> Chilling Centers</li>
            <li onclick="activateNav(this,'processing')"><i class="fas fa-cogs"></i> Processing Plants</li>
            <li onclick="activateNav(this,'quality')"><i class="fas fa-check-circle"></i> Quality Control</li>
            <li onclick="activateNav(this,'inventory')"><i class="fas fa-boxes"></i> Product Inventory</li>
            <li onclick="activateNav(this,'logistics')"><i class="fas fa-truck"></i> Distribution &amp; Logistics</li>
            <li onclick="activateNav(this,'retail')"><i class="fas fa-store"></i> Retail &amp; Franchise</li>
            <li onclick="activateNav(this,'dashboard-section')"><i class="fas fa-chart-line"></i> Dashboard Analytics
            </li>
            <li onclick="activateNav(this,'customers-section')"><i class="fas fa-user-friends"></i> Customers</li>
            <li onclick="activateNav(this,'suppliers-section')"><i class="fas fa-tractor"></i> Suppliers</li>
            <li onclick="activateNav(this,'deliveries-section')"><i class="fas fa-shipping-fast"></i> Deliveries</li>
            <li onclick="activateNav(this,'payments-section')"><i class="fas fa-rupee-sign"></i> Payments</li>
            <li onclick="activateNav(this,'reports-section')"><i class="fas fa-file-alt"></i> Reports</li>
            <li onclick="activateNav(this,'settings-section')"><i class="fas fa-cog"></i> Settings</li>
        </ul>
    </aside>

    <div class="main" id="main">

        <div class="section active fade-in" id="dashboard">
            <!-- Dashboard Banner -->
            <div class="banner">
                <i class="fas fa-chart-line"></i>
                📊 Real-Time Dashboard Metrics
            </div>

            <!-- Dashboard Cards -->
            <div class="card-grid" id="dashboardCards">
                <div class="card">
                    <i class="fas fa-wine-bottle card-icon"></i>
                    <h3>Total Milk (L)</h3>
                    <h2 id="cardTotalMilk">0</h2>
                    <p class="card-change" id="cardChangeMilk">N/A</p>
                </div>
                <div class="card">
                    <i class="fas fa-rupee-sign card-icon"></i>
                    <h3>Total Revenue</h3>
                    <h2 id="cardTotalRevenue">₹0</h2>
                    <p class="card-change" id="cardChangeRevenue">N/A</p>
                </div>
                <div class="card">
                    <i class="fas fa-user card-icon"></i>
                    <h3>Customers</h3>
                    <h2 id="cardTotalCustomers">0</h2>
                    <p class="card-change" id="cardChangeCustomers">N/A</p>
                </div>
            </div>

            <!-- Sales Records Section -->
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-file-invoice-dollar"></i>
                    💼 Sales Records
                </h3>
                <button class="btn btn-success" onclick="openDashboardModal()">
                    <i class="fas fa-plus"></i> Add Record
                </button>
                <input type="text" placeholder="Search..." id="dashboardSearch" class="form-control" />
            </div>

            <!-- Sales Table -->
            <div class="data-section">
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Milk (L)</th>
                            <th>Revenue (₹)</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="dashboardTableBody"></tbody>
                </table>
            </div>

            <!-- Revenue Trends Chart -->
            <div class="chart-container">
                <div class="chart-box">
                    <div class="chart-header">
                        <div class="chart-title">
                            <i class="fas fa-chart-bar"></i>
                            📈 Revenue Trends
                        </div>
                    </div>
                    <div id="dashboardChart"></div>
                </div>
            </div>

            <!-- Customer Revenue Distribution Chart -->
            <div class="chart-container">
                <div class="chart-box">
                    <div class="chart-header">
                        <div class="chart-title">
                            <i class="fas fa-chart-pie"></i>
                            📊 Customer Revenue Distribution
                        </div>
                        <div class="chart-actions">
                            <button class="btn btn-export" onclick="exportDashboardChart()">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    <canvas id="polarChart" height="400"></canvas>
                </div>
            </div>

            <!-- Recent Activity Log -->
            <div class="alert-container">
                <h4>
                    <i class="fas fa-history"></i>
                    🕒Recent Activity
                </h4>
                <ul id="dashboardActivity" style="padding-left: 1rem; line-height: 1.6;"></ul>
            </div>

            <!-- Modal for Adding/Editing Sales Record -->
            <div class="modal" id="dashboardModal">
                <div class="modal-content">
                    <button class="modal-close" onclick="closeDashboardModal()">&times;</button>
                    <div class="modal-title" id="modalTitle">Add Sale</div>

                    <div id="validationSummary" class="validation-summary"></div>

                    <div class="form-group">
                        <label>Customer Name <span class="required">*</span></label>
                        <input type="text" id="inputCustomer" class="form-control" required />
                        <div id="customerError" class="error-message">Customer name is required</div>
                    </div>
                    <div class="form-group">
                        <label>Milk Quantity (L) <span class="required">*</span></label>
                        <input type="number" id="inputMilk" class="form-control" min="1" step="0.1" />
                        <div id="milkError" class="error-message">Milk quantity must be at least 1L</div>
                    </div>
                    <div class="form-group">
                        <label>Revenue (₹) <span class="required">*</span></label>
                        <input type="number" id="inputRevenue" class="form-control" min="0" step="1" />
                        <div id="revenueError" class="error-message">Revenue must be a positive number</div>
                    </div>
                    <div class="form-group">
                        <label>Date <span class="required">*</span></label>
                        <input type="date" id="inputDate" class="form-control" />
                        <div id="dateError" class="error-message">Date is required and cannot be in the future</div>
                    </div>
                    <div class="form-group">
                        <label>Status <span class="required">*</span></label>
                        <select id="inputStatus" class="form-control">
                            <option>Completed</option>
                            <option>Pending</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-success" onclick="saveDashboardRecord()">
                            <i class="fas fa-save"></i> 💾 Save
                        </button>
                        <button class="btn btn-outline" onclick="closeDashboardModal()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Farmer Management Section -->
        <div class="section fade-in" id="farmer-mgmt">
            <div class="banner">Farmer Management</div>

            <!-- Summary Cards -->
            <section class="card-grid">
                <div class="card card-flex">
                    <div class="card-icon"><i class="fas fa-users"></i></div>
                    <div>
                        <div class="card-label">Total Farmers</div>
                        <div class="card-value"><span id="totalFarmers">0</span></div>
                    </div>
                </div>
                <div class="card card-flex">
                    <div class="card-icon"><i class="fas fa-tint"></i></div>
                    <div>
                        <div class="card-label">Total Milk (L)</div>
                        <div class="card-value"><span id="totalMilk">0</span></div>
                    </div>
                </div>
                <div class="card card-flex">
                    <div class="card-icon"><i class="fas fa-map-marker-alt"></i></div>
                    <div>
                        <div class="card-label">Active Regions</div>
                        <div class="card-value"><span id="activeRegions">0</span></div>
                    </div>
                </div>
            </section>

            <!-- Add/Edit Form -->
            <section class="data-section">
                <p class="section-title">Add / Edit Farmer</p>
                <form id="farmerForm" class="settings-grid" novalidate>
                    <input type="hidden" id="editIndex" value="-1" />
                    <div class="form-group">
                        <input type="text" id="name" placeholder="Farmer Name" required pattern="[A-Za-z\s.'-]{2,100}"
                            title="2-100 characters, only letters, spaces, hyphens, apostrophes, and periods"
                            class="form-control" />
                        <div class="error-message" id="name-error"></div>
                    </div>
                    <div class="form-group">
                        <input type="number" id="longitude" placeholder="Longitude" required step="0.000001" min="-180"
                            max="180" class="form-control" />
                        <div class="error-message" id="longitude-error"></div>
                    </div>
                    <div class="form-group">
                        <input type="number" id="milk" placeholder="Milk (liters)" required min="0" max="10000"
                            step="0.01" class="form-control" />
                        <div class="error-message" id="milk-error"></div>
                    </div>
                    <div class="form-group">
                        <input type="number" id="latitude" placeholder="Latitude" required step="0.000001" min="-90"
                            max="90" class="form-control" />
                        <div class="error-message" id="latitude-error"></div>
                    </div>
                    <div class="form-group">
                        <input type="text" id="region" placeholder="Region" required pattern="[A-Za-z0-9\s.'-]{2,50}"
                            title="2-50 characters, letters, numbers, spaces, hyphens, apostrophes, and periods"
                            class="form-control" />
                        <div class="error-message" id="region-error"></div>
                    </div>
                    <div class="form-actions" style="grid-column: span 2;">
                        <button type="submit" class="btn btn-primary">Save Farmer</button>
                        <button type="button" onclick="farmerMgmt.resetForm()" class="btn btn-outline">Cancel</button>
                    </div>
                </form>
            </section>

            <!-- Table & Filters -->
            <section class="table-section">
                <div class="data-section">
                    <div class="section-actions">
                        <input type="text" id="searchInput" placeholder="Search by name or region..."
                            class="form-control" />
                        <select id="regionFilter" class="form-control">
                            <option value="">All Regions</option>
                        </select>
                        <button onclick="farmerMgmt.exportToCSV()" class="btn btn-outline">Export CSV</button>
                        <button onclick="window.print()" class="btn btn-outline">🖨️ Print</button>
                    </div>
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Region</th>
                                <th>Milk (L)</th>
                                <th>Latitude</th>
                                <th>Longitude</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="farmerTableBody"></tbody>
                    </table>
                    <div id="paginationControls" class="pagination"></div>
                </div>
            </section>

            <!-- Charts -->
            <div class="chart-grid">
                <div class="chart-container">
                    <h2>Milk Distribution by Region</h2>
                    <div id="pie_chart" class="chart-box"></div>
                </div>
                <div class="chart-container">
                    <h2>Milk Production Trend</h2>
                    <div id="area_chart" class="chart-box"></div>
                </div>
            </div>

            <!-- Map -->
            <div class="map-container">
                <h2>Farmers Map</h2>
                <div id="map" class="map-placeholder" style="height: 400px; background-color: #e0e0e0;">
                    <div id="map-fallback" style="display: none; padding: 20px; text-align: center;">
                        <p>Google Maps couldn't be loaded. Showing coordinates instead.</p>
                        <div id="coordinates-display"></div>
                    </div>
                </div>
            </div>

            <!-- Activity Log -->
            <section class="alert-container">
                <h2>Recent Activity Log</h2>
                <ul id="activityLog"></ul>
            </section>

            <!-- Modal -->
            <div id="modal" class="modal">
                <div class="modal-content">
                    <p id="modalMessage"></p>
                    <button onclick="farmerMgmt.confirmModal()" class="btn btn-primary">Confirm</button>
                    <button onclick="farmerMgmt.closeModal()" class="btn btn-outline">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Milk Collection Section -->
        <div class="section fade-in" id="milk-collection">
            <div class="banner">Milk Collections</div>

            <!-- Summary Cards -->
            <div class="card-grid">
                <div id="dairy_totalLitresCard" class="card">
                    <h4>Total Milk Collected</h4>
                    <div id="dairy_totalLitresChart" style="display: none;"></div>
                    <p id="dairy_totalLitresVal" class="card-value">0 L</p>
                </div>
                <div id="dairy_totalFarmersCard" class="card">
                    <h4>Total Farmers</h4>
                    <div id="dairy_totalFarmersChart" style="display: none;"></div>
                    <p id="dairy_totalFarmersVal" class="card-value">0</p>
                </div>
                <div id="dairy_avgFatCard" class="card">
                    <h4>Average Fat %</h4>
                    <div id="dairy_avgFatChart" style="display: none;"></div>
                    <p id="dairy_avgFatVal" class="card-value">0%</p>
                </div>
                <div id="dairy_avgSNFCard" class="card">
                    <h4>Average SNF %</h4>
                    <div id="dairy_avgSNFChart" style="display: none;"></div>
                    <p id="dairy_avgSNFVal" class="card-value">0%</p>
                </div>
            </div>

            <!-- Form -->
            <div class="data-section">
                <h3>Add Milk Collection Entry</h3>
                <form id="dairy_entryForm" class="settings-grid">
                    <div class="form-group">
                        <input type="text" id="dairy_farmer" placeholder="Farmer Name" required class="form-control" />
                    </div>
                    <div class="form-group">
                        <input type="number" id="dairy_qty" placeholder="Qty (L)" min="0" required
                            class="form-control" />
                    </div>
                    <div class="form-group">
                        <input type="number" id="dairy_fat" placeholder="Fat %" min="0" max="10" step="0.1" required
                            class="form-control" />
                    </div>
                    <div class="form-group">
                        <input type="number" id="dairy_snf" placeholder="SNF %" min="0" max="10" step="0.1" required
                            class="form-control" />
                    </div>
                    <div class="form-group">
                        <input type="number" id="dairy_rate" placeholder="Rate ₹/L" min="0" required
                            class="form-control" />
                    </div>
                    <div class="form-group">
                        <input type="datetime-local" id="dairy_datetime" required class="form-control" />
                    </div>
                    <div class="form-actions" style="grid-column: span 2;">
                        <button type="submit" class="btn btn-primary">Add Entry</button>
                    </div>
                </form>
            </div>

            <!-- Export Buttons -->
            <div class="section-actions">
                <button id="dairy_excelBtn" class="btn btn-outline">Export to Excel</button>
                <button id="dairy_pdfBtn" class="btn btn-outline">Export to PDF</button>
            </div>

            <!-- Table -->
            <div class="data-section">
                <h3>Milk Collection Records</h3>
                <table id="dairy_dataTable" class="custom-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Farmer</th>
                            <th>Date</th>
                            <th>Qty</th>
                            <th>Fat</th>
                            <th>SNF</th>
                            <th>Rate</th>
                            <th>Amount</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Recent Activity -->
            <div class="alert-container">
                <h3>Recent Activity</h3>
                <ul id="dairy_recentActivity"></ul>
            </div>

            <!-- View/Edit Modal -->
            <div id="dairy_modal" class="modal">
                <div class="modal-content">
                    <h3 id="dairy_modalTitle">View/Edit Entry</h3>
                    <form id="dairy_modalForm" class="settings-grid">
                        <input type="hidden" id="dairy_editId" />
                        <div class="form-group">
                            <input type="text" id="dairy_editFarmer" required placeholder="Farmer"
                                class="form-control" />
                        </div>
                        <div class="form-group">
                            <input type="number" id="dairy_editQty" required placeholder="Quantity"
                                class="form-control" />
                        </div>
                        <div class="form-group">
                            <input type="number" id="dairy_editFat" required placeholder="Fat %" step="0.1"
                                class="form-control" />
                        </div>
                        <div class="form-group">
                            <input type="number" id="dairy_editSNF" required placeholder="SNF %" step="0.1"
                                class="form-control" />
                        </div>
                        <div class="form-group">
                            <input type="number" id="dairy_editRate" required placeholder="Rate" class="form-control" />
                        </div>
                        <div class="form-group">
                            <input type="datetime-local" id="dairy_editDate" required class="form-control" />
                        </div>
                        <div class="form-actions" style="grid-column: span 2;">
                            <button type="submit" class="btn btn-primary">Update Entry</button>
                        </div>
                    </form>
                    <button id="dairy_closeModalBtn" class="modal-close">✖</button>
                </div>
            </div>

            <div id="dairy_dailyMilkChartContainer" style="margin-top: 30px;"></div>
            <div id="dairy_fatSNFChartContainer" style="margin-top: 30px;"></div>

        </div>


        <div class="section fade-in" id="chilling">
            <div class="container">
                <!-- Banner -->
                <div class="banner fade-in">
                    Chilling Centers Management
                </div>

                <!-- Summary Cards -->
                <div class="cards-grid">
                    <div class="card">
                        <i class="fas fa-building card-icon"></i>
                        <h4>Total Centers</h4>
                        <p id="summary_totalCenters">0</p>
                    </div>
                    <div class="card">
                        <i class="fas fa-thermometer-half card-icon"></i>
                        <h4>Avg. Temperature</h4>
                        <p id="summary_avgTemp">0°C</p>
                    </div>
                    <div class="card">
                        <i class="fas fa-tint card-icon"></i>
                        <h4>Total Capacity</h4>
                        <p id="summary_totalCapacity">0 L</p>
                    </div>
                    <div class="card">
                        <i class="fas fa-tint card-icon"></i>
                        <h4>Current Capacity</h4>
                        <p id="summary_currentCapacity">0 L</p>
                    </div>
                    <div class="card">
                        <i class="fas fa-solar-panel card-icon"></i>
                        <h4>Energy Utilization</h4>
                        <p id="summary_energyMix">0% Solar</p>
                    </div>
                </div>

                <!-- Add New Button -->
                <div class="section-actions">
                    <button class="btn-primary btn" id="addCenterBtn">
                        <i class="fa-plus fas"></i> Add New Center
                    </button>
                </div>

                <!-- Form Container -->
                <div class="profile-form" id="formContainer" style="display:none;">
                    <h3 id="formTitle"><i class="fa-plus-circle fas"></i> Add New Chilling Center</h3>
                    <form class="settings-grid" id="entryForm">
                        <input id="editId" type="hidden" />
                        <div class="form-group">
                            <label for="centerName">Center Name</label>
                            <input class="form-control" id="centerName" required type="text" />
                            <div class="error-message" id="nameError">Center name must be at least 2 characters</div>
                        </div>
                        <div class="form-group">
                            <label for="location">Location</label>
                            <input class="form-control" id="location" required type="text" />
                            <div class="error-message" id="locationError">Location must be at least 2 characters</div>
                        </div>
                        <div class="form-group">
                            <label for="totalCapacity">Total Capacity (L)</label>
                            <input class="form-control" id="totalCapacity" min="1000" required type="number"
                                value="1000" />
                            <div class="error-message" id="totalCapacityError">Capacity must be at least 1,000 L</div>
                        </div>
                        <div class="form-group">
                            <label for="currentCapacity">Current Capacity (L)</label>
                            <input class="form-control" id="currentCapacity" min="0" required type="number" value="0" />
                            <div class="error-message" id="currentCapacityError">Current capacity cannot exceed total
                                capacity</div>
                        </div>
                        <div class="form-group">
                            <label for="temperature">Temperature (°C)</label>
                            <input class="form-control" id="temperature" required step="0.1" type="number"
                                value="4.0" />
                            <div class="error-message" id="temperatureError">Temperature must be between 0°C and 10°C
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="status">Status</label>
                            <select class="form-control" id="status" required>
                                <option value="">Select Status</option>
                                <option selected value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                                <option value="Maintenance">Maintenance</option>
                            </select>
                            <div class="error-message" id="statusError">Please select a status</div>
                        </div>
                        <div class="form-group">
                            <label for="energyType">Energy Source</label>
                            <select class="form-control" id="energyType" required>
                                <option value="">Select Energy Source</option>
                                <option value="Grid Power">Grid Power</option>
                                <option selected value="Solar">Solar</option>
                                <option value="Generator">Generator</option>
                                <option value="Battery">Battery</option>
                            </select>
                            <div class="error-message" id="energyTypeError">Please select an energy source</div>
                        </div>
                        <div class="form-actions">
                            <button class="btn-primary btn-outline btn" id="cancelBtn" type="button">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                            <button class="btn-primary btn btn-success" id="submitBtn" type="submit">
                                <i class="fa-plus fas"></i> Add Center
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Search and Filter -->
                <div class="data-section">
                    <div class="section-header">
                        <h3 class="section-title"><i class="fas fa-list"></i> Chilling Centers</h3>
                        <div class="search-container">
                            <input class="form-control" id="searchInput" placeholder="Search by any field..."
                                type="text" />
                        </div>
                    </div>
                    <!-- Table -->
                    <table class="custom-table" id="dataTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Center Name</th>
                                <th>Location</th>
                                <th>Capacity (L)</th>
                                <th>Temp (°C)</th>
                                <th>Status</th>
                                <th>Energy Source</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>

                <!-- Charts Section -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title"><i class="fa-chart-line fas"></i> Performance Dashboard</h3>
                    </div>
                    <div class="chart-grid">
                        <div class="chart-wrapper" id="temperatureChart"></div>
                        <div class="chart-wrapper" id="capacityChart"></div>
                        <div class="chart-wrapper" id="energyChart"></div>
                        <div class="chart-wrapper" id="tempPerformanceChart"></div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="data-section">
                    <div class="section-header">
                        <h3 class="section-title"><i class="fa-history fas"></i> Recent Activity</h3>
                    </div>
                    <div id="activityContainer">
                        <!-- Activity items will be added here -->
                    </div>
                </div>
            </div>

            <div style="display: none;">
                <div class="banner">Chilling Centers</div>
                <div class="card-grid">
                    <div class="card fade-up" style="display: flex; align-items: center; gap: 1rem;">
                        <div
                            style="background-color: rgba(66,133,244,0.1); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;">
                            <i class="fas fa-warehouse card-icon"
                                style="font-size: 1.25rem; color: #1d4ed8; margin: 0;"></i>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: #6b7280;">Active Centers</div>
                            <div style="font-size: 1.8rem; font-weight: bold;">15</div>
                            <div style="font-size: 0.85rem; color: #16a34a;"></div>
                        </div>
                    </div>
                    <div class="card fade-up" style="display: flex; align-items: center; gap: 1rem;">
                        <div
                            style="background-color: rgba(66,133,244,0.1); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;">
                            <i class="fas fa-boxes card-icon"
                                style="font-size: 1.25rem; color: #1d4ed8; margin: 0;"></i>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: #6b7280;">Total Capacity</div>
                            <div style="font-size: 1.8rem; font-weight: bold;">50,000 L</div>
                            <div style="font-size: 0.85rem; color: #16a34a;"></div>
                        </div>
                    </div>
                    <div class="card fade-up" style="display: flex; align-items: center; gap: 1rem;">
                        <div
                            style="background-color: rgba(66,133,244,0.1); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;">
                            <i class="fas fa-box-open card-icon"
                                style="font-size: 1.25rem; color: #1d4ed8; margin: 0;"></i>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: #6b7280;">Current Storage</div>
                            <div style="font-size: 1.8rem; font-weight: bold;">32,450 L</div>
                            <div style="font-size: 0.85rem; color: #16a34a;"></div>
                        </div>
                    </div>
                    <div class="card fade-up" style="display: flex; align-items: center; gap: 1rem;">
                        <div
                            style="background-color: rgba(66,133,244,0.1); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;">
                            <i class="fas fa-temperature-low card-icon"
                                style="font-size: 1.25rem; color: #1d4ed8; margin: 0;"></i>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: #6b7280;">Avg. Temperature</div>
                            <div style="font-size: 1.8rem; font-weight: bold;">4°C</div>
                            <div style="font-size: 0.85rem; color: #16a34a;"></div>
                        </div>
                    </div>
                </div>

                <div class="banner">Capacity Utilization</div>
                <div class="chart-container" style="display:flex; flex-wrap:wrap; gap:2rem;">
                    <div class="chart-box fade-up"
                        style="min-width:300px; width:100%; flex:1;; margin-bottom: 2rem; min-width: 300px; width: 100%; flex: 1; margin-bottom:2rem; flex: 1 1 100%;">
                        <div class="chart-header">
                            <div class="chart-title">Storage Utilization by Center</div>
                            <div class="chart-actions">
                                <button class="btn btn-export" onclick="exportChartToPDF('capacityChart')">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                            </div>
                        </div>
                        <canvas id="capacityChart"></canvas>
                    </div>
                </div>

                <div class="banner">Maintenance Alerts</div>
                <div class="alert-container">
                    <div class="alert-item warning" style="background: var(--accent);">
                        <i class="fas fa-exclamation-triangle alert-icon"></i>
                        <div>
                            <strong>Center CH1003</strong> - Scheduled maintenance tomorrow from 2-4 PM
                        </div>
                    </div>
                    <div class="alert-item">
                        <i class="fas fa-info-circle alert-icon"></i>
                        <div>
                            <strong>Center CH1005</strong> - Temperature sensor needs calibration
                        </div>
                    </div>
                    <div class="alert-item success">
                        <i class="fas fa-check-circle alert-icon"></i>
                        <div>
                            <strong>Center CH1001</strong> - Monthly maintenance completed
                        </div>
                    </div>
                </div>
                <div class="banner">Center Details</div>
                <div class="table-wrapper">
                    <table class="custom-table" style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
                        <thead>
                            <tr>
                                <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Center ID</th>
                                <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Location</th>
                                <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Capacity (L)</th>
                                <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Current (L)</th>
                                <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Temp (°C)</th>
                                <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">CH1001</td>
                                <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">Village A</td>
                                <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">5,000</td>
                                <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">3,245</td>
                                <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">4.2</td>
                                <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">
                                    <span class="status-badge status-completed">Operational</span>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">CH1002</td>
                                <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">Village B</td>
                                <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">3,500</td>
                                <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">2,980</td>
                                <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">3.8</td>
                                <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">
                                    <span class="status-badge status-completed">Operational</span>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">CH1003</td>
                                <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">Village C</td>
                                <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">4,000</td>
                                <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">1,245</td>
                                <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">4.5</td>
                                <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">
                                    <span class="status-badge status-pending">Maintenance</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="section fade-in" id="processing">
            <div class="banner">🥛 Processing Plant Management</div>

            <!-- Cards -->
            <div class="cards-grid">
                <div class="card">
                    <i class="fas fa-industry"></i>
                    <h3>Total Plants</h3>
                    <h2 id="procTotalPlants">0</h2>
                </div>
                <div class="card">
                    <i class="fas fa-flask"></i>
                    <h3>Total Capacity</h3>
                    <h2 id="procTotalCapacity">0 L</h2>
                </div>
                <div class="card">
                    <i class="fas fa-bolt"></i>
                    <h3>Active Plants</h3>
                    <h2 id="procActivePlants">0</h2>
                </div>
                <div class="card">
                    <i class="fas fa-boxes"></i>
                    <h3>Total Products</h3>
                    <h2 id="procTotalProducts">0</h2>
                </div>
            </div>

            <!-- Filters -->
            <div class="filter-list">
                <input type="text" class="form-control" id="procSearch" placeholder="🔍 Search Plant Name"
                    oninput="renderProcessingAll()">
                <select class="form-control" id="procStatusFilter" onchange="renderProcessingAll()">
                    <option value="">All Status</option>
                    <option value="Active">Active</option>
                    <option value="Inactive">Inactive</option>
                    <option value="Maintenance">Maintenance</option>
                </select>
            </div>

            <!-- View Switch & Add Button -->
            <div class="section-header">
                <div class="section-actions">
                    <button class="chart-btn active" onclick="toggleProcView('cards')"><i class="fas fa-th-large"></i>
                        Card View</button>
                    <button class="chart-btn" onclick="toggleProcView('table')"><i class="fas fa-table"></i> Table
                        View</button>
                    <button class="btn btn-primary" onclick="openProcModal()"><i class="fas fa-plus"></i> Add
                        Plant</button>
                </div>
            </div>

            <!-- Card View -->
            <div id="procCardView" class="cards-grid"></div>

            <!-- Table View -->
            <div id="procTableView" class="data-section" style="display: none">
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th>Plant</th>
                            <th>Location</th>
                            <th>Capacity</th>
                            <th>Status</th>
                            <th>Manager</th>
                            <th>Products</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="procTableBody"></tbody>
                </table>
            </div>

            <!-- Charts Section -->
            <div class="chart-container">
                <div class="chart-box">
                    <div class="chart-header">
                        <h4 class="chart-title"><i class="fas fa-chart-bar"></i> Plant-wise Stacked Products</h4>
                    </div>
                    <canvas id="procStackedBarChart" height="400"></canvas>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="log-section">
                <h2><i class="fas fa-history"></i> Recent Processing Activities</h2>
                <div class="log-list" id="procActivityLogs"></div>
            </div>

            <!-- Modal Form -->
            <div id="procModal" class="modal">
                <div class="modal-content">
                    <button class="modal-close" onclick="closeProcModal()">&times;</button>
                    <h2 class="modal-title" id="procModalTitle">Add Processing Plant</h2>
                    <div class="form-group">
                        <label>Plant Name</label>
                        <input type="text" id="procPlantName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="procPlantLocation" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Capacity (L)</label>
                        <input type="number" id="procPlantCapacity" class="form-control" min="1000" max="1000000"
                            required>
                        <small class="form-text">Min: 1,000L - Max: 1,000,000L</small>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="procPlantStatus" class="form-control" required>
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                            <option value="Maintenance">Maintenance</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Manager</label>
                        <input type="text" id="procPlantManager" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Products</label>
                        <div id="procProductInputs">
                            <div class="product-row">
                                <select class="productName form-control">
                                    <option value="">Select Product</option>
                                    <option value="Milk">Milk</option>
                                    <option value="Cheese">Cheese</option>
                                    <option value="Butter">Butter</option>
                                    <option value="Ice Cream">Ice Cream</option>
                                    <option value="Yogurt">Yogurt</option>
                                    <option value="Ghee">Ghee</option>
                                    <option value="Paneer">Paneer</option>
                                </select>
                                <input type="number" class="productQty form-control" min="0" placeholder="Liters">
                                <button class="btn btn-danger" onclick="removeProcProduct(this)"><i
                                        class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <button class="btn btn-outline" onclick="addProcProduct()">+ Add Product</button>
                        <div id="capacityWarning" class="text-danger mt-2" style="display: none;">
                            Total products exceed plant capacity!
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-warning" onclick="closeProcModal()">Cancel</button>
                        <button class="btn btn-success" onclick="saveProcPlant()">Save</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="section fade-in" id="quality">
        </div>

        <div class="section fade-in" id="inventory">
            <div class="banner">Product Inventory</div>
            <div class="cards-grid">
                <div class="card-grid">
                    <div class="card fade-up" style="display: flex; align-items: center; gap: 1rem;">
                        <div
                            style="background-color: rgba(66,133,244,0.1); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;">
                            <i class="fas fa-tint" style="font-size: 1.25rem; color: #1d4ed8; margin: 0;"></i>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: #6b7280;">Total Milk Collected</div>
                            <div style="font-size: 1.8rem; font-weight: bold;">24,500 L</div>
                            <div style="font-size: 0.85rem; color: #16a34a;">↑ 3.2% Today</div>
                        </div>
                    </div>
                    <div class="card fade-up" style="display: flex; align-items: center; gap: 1rem;">
                        <div
                            style="background-color: rgba(66,133,244,0.1); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;">
                            <i class="fas fa-rupee-sign" style="font-size: 1.25rem; color: #1d4ed8; margin: 0;"></i>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: #6b7280;">Revenue</div>
                            <div style="font-size: 1.8rem; font-weight: bold;">₹ 1,200,000</div>
                            <div style="font-size: 0.85rem; color: #dc2626;">↓ 1.2% This Month</div>
                        </div>
                    </div>
                    <div class="card fade-up" style="display: flex; align-items: center; gap: 1rem;">
                        <div
                            style="background-color: rgba(66,133,244,0.1); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;">
                            <i class="fas fa-user-check" style="font-size: 1.25rem; color: #1d4ed8; margin: 0;"></i>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: #6b7280;">Active Customers</div>
                            <div style="font-size: 1.8rem; font-weight: bold;">1,850</div>
                            <div style="font-size: 0.85rem; color: #16a34a;">↑ 4.1% Growth</div>
                        </div>
                    </div>
                    <div class="card fade-up" style="display: flex; align-items: center; gap: 1rem;">
                        <div
                            style="background-color: rgba(66,133,244,0.1); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;">
                            <i class="fas fa-truck" style="font-size: 1.25rem; color: #1d4ed8; margin: 0;"></i>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: #6b7280;">Deliveries</div>
                            <div style="font-size: 1.8rem; font-weight: bold;">980</div>
                            <div style="font-size: 0.85rem; color: #16a34a;">↑ 2.4% This Week</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="banner">Expiry Tracking</div>
            <div class="alert-container">
                <div class="alert-item warning">
                    <i class="fas fa-exclamation-triangle alert-icon"></i>
                    <div>
                        <strong>Batch #P10045 (Paneer)</strong> - Expires in 2 days (200 units)
                    </div>
                </div>
                <div class="alert-item">
                    <i class="fas fa-info-circle alert-icon"></i>
                    <div>
                        <strong>Batch #M10032 (Milk)</strong> - Expires in 5 days (500 units)
                    </div>
                </div>
                <div class="alert-item success">
                    <i class="fas fa-check-circle alert-icon"></i>
                    <div>
                        <strong>Batch #G10012 (Ghee)</strong> - Good for 45 more days
                    </div>
                </div>
            </div>

            <div class="banner">Stock Alerts</div>
            <div class="row-grid">
                <div class="info-box warning hover-lift fade-up"
                    style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); transition: transform 0.3s ease;">
                    <h4>Low Stock Items</h4>
                    <p>Paneer (200g) - 120 units left</p>
                    <p>Curd (500g) - 85 units left</p>
                </div>
                <div class="info-box hover-lift fade-up"
                    style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); transition: transform 0.3s ease;">
                    <h4>Replenishment Needed</h4>
                    <p>Milk Pouches - 2 days supply left</p>
                    <p>Ghee Jars - 3 days supply left</p>
                </div>
            </div>
            <div class="banner">Inventory Details</div>
            <table class="custom-table" style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
                <thead>
                    <tr>
                        <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Product</th>
                        <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Stock</th>
                        <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Unit Cost</th>
                        <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Total Value</th>
                        <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Location</th>
                        <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">Milk Pouch (500 ml)</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">5,000</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">₹ 5.20</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">₹ 26,000</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">Warehouse 1</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">
                            <span class="status-badge status-completed">In Stock</span>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">Bottle (1 L)</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">3,000</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">₹ 8.50</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">₹ 25,500</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">Warehouse 2</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">
                            <span class="status-badge status-completed">In Stock</span>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">Paneer (200 g)</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">2,500</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">₹ 40.00</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">₹ 100,000</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">Cold Storage</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">
                            <span class="status-badge status-pending">Low Stock</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="section fade-in" id="logistics">
            <div class="banner">Distribution &amp; Logistics</div>
            <div class="cards-grid">
                <div class="card-grid">
                    <div class="card fade-up" style="display: flex; align-items: center; gap: 1rem;">
                        <div
                            style="background-color: rgba(66,133,244,0.1); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;">
                            <i class="fas fa-tint" style="font-size: 1.25rem; color: #1d4ed8; margin: 0;"></i>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: #6b7280;">Total Milk Collected</div>
                            <div style="font-size: 1.8rem; font-weight: bold;">24,500 L</div>
                            <div style="font-size: 0.85rem; color: #16a34a;">↑ 3.2% Today</div>
                        </div>
                    </div>
                    <div class="card fade-up" style="display: flex; align-items: center; gap: 1rem;">
                        <div
                            style="background-color: rgba(66,133,244,0.1); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;">
                            <i class="fas fa-rupee-sign" style="font-size: 1.25rem; color: #1d4ed8; margin: 0;"></i>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: #6b7280;">Revenue</div>
                            <div style="font-size: 1.8rem; font-weight: bold;">₹ 1,200,000</div>
                            <div style="font-size: 0.85rem; color: #dc2626;">↓ 1.2% This Month</div>
                        </div>
                    </div>
                    <div class="card fade-up" style="display: flex; align-items: center; gap: 1rem;">
                        <div
                            style="background-color: rgba(66,133,244,0.1); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;">
                            <i class="fas fa-user-check" style="font-size: 1.25rem; color: #1d4ed8; margin: 0;"></i>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: #6b7280;">Active Customers</div>
                            <div style="font-size: 1.8rem; font-weight: bold;">1,850</div>
                            <div style="font-size: 0.85rem; color: #16a34a;">↑ 4.1% Growth</div>
                        </div>
                    </div>
                    <div class="card fade-up" style="display: flex; align-items: center; gap: 1rem;">
                        <div
                            style="background-color: rgba(66,133,244,0.1); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;">
                            <i class="fas fa-truck" style="font-size: 1.25rem; color: #1d4ed8; margin: 0;"></i>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: #6b7280;">Deliveries</div>
                            <div style="font-size: 1.8rem; font-weight: bold;">980</div>
                            <div style="font-size: 0.85rem; color: #16a34a;">↑ 2.4% This Week</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="banner">Live Delivery Tracking</div>
            <div class="map-container">
                <div id="deliveryMap"></div>
            </div>

            <div class="banner">Vehicle Performance</div>
            <div class="chart-container" style="display:flex; flex-wrap:wrap; gap:2rem;">
                <div class="chart-box fade-up"
                    style="min-width:300px; width:100%; flex:1;; margin-bottom: 2rem; min-width: 300px; width: 100%; flex: 1; margin-bottom:2rem; flex: 1 1 100%;">
                    <div class="chart-header">
                        <div class="chart-title">Average Delivery Times</div>
                        <div class="chart-actions">
                            <button class="btn btn-export" onclick="exportChartToPDF('deliveryTimesChart')">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                        </div>
                    </div>
                    <canvas id="deliveryTimesChart"></canvas>
                </div>
                <div class="chart-box fade-up"
                    style="min-width:300px; width:100%; flex:1;; margin-bottom: 2rem; min-width: 300px; width: 100%; flex: 1; margin-bottom:2rem; flex: 1 1 100%;">
                    <div class="chart-header">
                        <div class="chart-title">Delay Reasons</div>
                        <div class="chart-actions">
                            <button class="btn btn-export" onclick="exportChartToPDF('delayReasonsChart')">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                        </div>
                    </div>
                    <canvas id="delayReasonsChart"></canvas>
                </div>
            </div>
            <div class="banner">Today's Deliveries</div>
            <div class="table-wrapper">
                <table class="custom-table" style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
                    <thead>
                        <tr>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Delivery ID</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Route</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Vehicle</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Stops</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Status</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">ETA</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">D4045</td>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">Route A</td>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">Truck 101</td>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">8</td>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">
                                <span class="status-badge status-completed">Completed</span>
                            </td>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">10:30 AM</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">D4044</td>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">Route B</td>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">Van 202</td>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">5</td>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">
                                <span class="status-badge status-completed">In Progress</span>
                            </td>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">11:45 AM</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">D4043</td>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">Route C</td>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">Truck 103</td>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">10</td>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">
                                <span class="status-badge status-pending">Pending</span>
                            </td>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">01:15 PM</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="section fade-in" id="retail">
            <div class="banner">Retail &amp; Franchise</div>
            <div class="card-grid">
                <div class="card fade-up" style="display: flex; align-items: center; gap: 1rem;">
                    <div
                        style="background-color: rgba(66,133,244,0.1); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;">
                        <i class="fas fa-store card-icon" style="font-size: 1.25rem; color: #1d4ed8; margin: 0;"></i>
                    </div>
                    <div>
                        <div style="font-size: 0.9rem; color: #6b7280;">Total Stores</div>
                        <div style="font-size: 1.8rem; font-weight: bold;">50</div>
                        <div style="font-size: 0.85rem; color: #16a34a;"></div>
                    </div>
                </div>
                <div class="card fade-up" style="display: flex; align-items: center; gap: 1rem;">
                    <div
                        style="background-color: rgba(66,133,244,0.1); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;">
                        <i class="fas fa-money-bill-wave card-icon"
                            style="font-size: 1.25rem; color: #1d4ed8; margin: 0;"></i>
                    </div>
                    <div>
                        <div style="font-size: 0.9rem; color: #6b7280;">Avg Revenue/Store</div>
                        <div style="font-size: 1.8rem; font-weight: bold;">₹ 10,000</div>
                        <div style="font-size: 0.85rem; color: #16a34a;"></div>
                    </div>
                </div>
                <div class="card fade-up" style="display: flex; align-items: center; gap: 1rem;">
                    <div
                        style="background-color: rgba(66,133,244,0.1); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;">
                        <i class="fas fa-plus-circle card-icon"
                            style="font-size: 1.25rem; color: #1d4ed8; margin: 0;"></i>
                    </div>
                    <div>
                        <div style="font-size: 0.9rem; color: #6b7280;">New Stores (Month)</div>
                        <div style="font-size: 1.8rem; font-weight: bold;">5</div>
                        <div style="font-size: 0.85rem; color: #16a34a;"></div>
                    </div>
                </div>
                <div class="card fade-up" style="display: flex; align-items: center; gap: 1rem;">
                    <div
                        style="background-color: rgba(66,133,244,0.1); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;">
                        <i class="fas fa-star card-icon" style="font-size: 1.25rem; color: #1d4ed8; margin: 0;"></i>
                    </div>
                    <div>
                        <div style="font-size: 0.9rem; color: #6b7280;">Top Selling Product</div>
                        <div style="font-size: 1.8rem; font-weight: bold;">Milk (500ml)</div>
                        <div style="font-size: 0.85rem; color: #16a34a;"></div>
                    </div>
                </div>
            </div>

            <div class="banner">Top Performing Stores</div>
            <div class="chart-container" style="display:flex; flex-wrap:wrap; gap:2rem;">
                <div class="chart-box fade-up"
                    style="min-width:300px; width:100%; flex:1;; margin-bottom: 2rem; min-width: 300px; width: 100%; flex: 1; margin-bottom:2rem; flex: 1 1 100%;">
                    <div class="chart-header">
                        <div class="chart-title">Revenue Trend (Top 5 Stores)</div>
                        <div class="chart-actions">
                            <button class="btn btn-export" onclick="exportChartToPDF('topStoresChart')">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                        </div>
                    </div>
                    <canvas id="topStoresChart"></canvas>
                </div>
            </div>

            <div class="banner">Customer Feedback</div>
            <div class="feedback-container">
                <div class="feedback-card">
                    <div class="feedback-header">
                        <div class="feedback-store">Main Market Store</div>
                        <div class="feedback-rating">4.8 ★</div>
                    </div>
                    <div class="feedback-comment">
                        "Excellent quality milk, always fresh. Staff is very helpful."
                    </div>
                </div>
                <div class="feedback-card">
                    <div class="feedback-header">
                        <div class="feedback-store">City Center Store</div>
                        <div class="feedback-rating">4.5 ★</div>
                    </div>
                    <div class="feedback-comment">
                        "Good variety of products. Could improve on paneer availability."
                    </div>
                </div>
                <div class="feedback-card">
                    <div class="feedback-header">
                        <div class="feedback-store">Suburb Plaza Store</div>
                        <div class="feedback-rating">4.2 ★</div>
                    </div>
                    <div class="feedback-comment">
                        "Prices are reasonable. Need more frequent deliveries."
                    </div>
                </div>
            </div>
            <div class="banner">Store Performance</div>
            <div class="table-wrapper">
                <table class="custom-table" style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
                    <thead>
                        <tr>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Store ID</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Location</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Today's Sales</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Monthly Avg.</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Growth</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">S5045</td>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">Main Market</td>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">₹ 15,245</td>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">₹ 12,500</td>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">+22%</td>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;"><span
                                    class="status-badge status-completed">Open</span></td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">S5044</td>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">City Center</td>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">₹ 12,800</td>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">₹ 11,200</td>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">+14%</td>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;"><span
                                    class="status-badge status-completed">Open</span></td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">S5043</td>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">Suburb Plaza</td>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">₹ 8,450</td>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">₹ 9,800</td>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">-14%</td>
                            <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;"><span
                                    class="status-badge status-pending">Closed</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="section fade-in" id="dashboard-section">

            <div class="card-grid">
                <div class="card fade-up">
                    <div class="card-header">
                        <span class="card-title">Total Customers</span>
                        <div class="card-icon">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                    <div class="card-value">248</div>
                    <div class="card-change positive">
                        <i class="fas fa-arrow-up"></i>
                        <span>12% from last month</span>
                    </div>
                </div>
                <div class="card fade-up">
                    <div class="card-header">
                        <span class="card-title">Daily Collection</span>
                        <div class="card-icon">
                            <i class="fas fa-weight"></i>
                        </div>
                    </div>
                    <div class="card-value">1,245 L</div>
                    <div class="card-change positive">
                        <i class="fas fa-arrow-up"></i>
                        <span>5% from yesterday</span>
                    </div>
                </div>
                <div class="card fade-up">
                    <div class="card-header">
                        <span class="card-title">Pending Deliveries</span>
                        <div class="card-icon">
                            <i class="fas fa-truck"></i>
                        </div>
                    </div>
                    <div class="card-value">18</div>
                    <div class="card-change negative">
                        <i class="fas fa-arrow-down"></i>
                        <span>3 from yesterday</span>
                    </div>
                </div>
                <div class="card fade-up">
                    <div class="card-header">
                        <span class="card-title">Monthly Revenue</span>
                        <div class="card-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                    </div>
                    <div class="card-value">$8,745</div>
                    <div class="card-change positive">
                        <i class="fas fa-arrow-up"></i>
                        <span>15% from last month</span>
                    </div>
                </div>
            </div>

            <div class="card-gridss">
                <div class="chart-container">
                    <div class="chart-header">
                        <h2 class="chart-title">Milk Collection Trend (Last 7 Days)</h2>
                        <div class="chart-actions">
                            <button class="chart-btn active" onclick="updateCollectionChart('7days')">
                                7 Days
                            </button>
                            <button class="chart-btn" onclick="updateCollectionChart('30days')">
                                30 Days
                            </button>
                            <button class="chart-btn" onclick="updateCollectionChart('90days')">
                                90 Days
                            </button>
                        </div>
                    </div>
                    <canvas id="collectionChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-header">
                        <h2 class="chart-title">Revenue Breakdown</h2>
                    </div>
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>

            <div class="data-section">
                <div class="section-header">
                    <h2 class="section-title">Recent Activity</h2>
                    <div class="section-actions">
                        <button class="btn btn-outline" onclick="exportActivityToPDF()">
                            <i class="fas fa-file-pdf"></i>
                            PDF
                        </button>
                        <button class="btn btn-outline" onclick="exportActivityToExcel()">
                            <i class="fas fa-file-excel"></i>
                            Excel
                        </button>
                        <button class="btn btn-primary" onclick="openModal('activity-modal')">
                            <i class="fas fa-plus"></i>
                            Add Activity
                        </button>
                    </div>
                </div>
                <table style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
                    <thead>
                        <tr>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Action</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">User</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Time</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Details</th>
                        </tr>
                    </thead>
                    <tbody id="activity-table">

                    </tbody>
                </table>
            </div>
        </div>

        <div class="section fade-in" id="customers-section">
            <div class="banner">Customer Insights</div>

            <!-- Cards -->
            <div class="cards-grid">
                <div class="card"><i class="fas fa-users card-icon"></i>
                    <h3>Total Customers</h3>
                    <h2 id="totalCustomers">0</h2>
                </div>
                <div class="card"><i class="fas fa-user-check card-icon"></i>
                    <h3>Active</h3>
                    <h2 id="activeCustomers">0</h2>
                </div>
                <div class="card"><i class="fas fa-user-times card-icon"></i>
                    <h3>Inactive</h3>
                    <h2 id="inactiveCustomers">0</h2>
                </div>
                <div class="card"><i class="fas fa-rupee-sign card-icon"></i>
                    <h3>Avg. Orders</h3>
                    <h2 id="avgOrderValue">₹0</h2>
                </div>
            </div>

            <!-- Filters -->
            <div class="section-header">
                <div>
                    <strong>Filter:</strong>
                    <select id="filterRegion" onchange="applyCustomerFilters()">
                        <option value="">All Regions</option>
                        <option>North</option>
                        <option>South</option>
                        <option>East</option>
                        <option>West</option>
                    </select>
                    <select id="filterStatus" onchange="applyCustomerFilters()">
                        <option value="">All Status</option>
                        <option>Active</option>
                        <option>Inactive</option>
                    </select>
                </div>
                <div class="section-actions">
                    <button class="btn btn-export" onclick="exportCustomers('pdf')">📄 PDF</button>
                    <button class="btn btn-export" onclick="exportCustomers('excel')">📊 Excel</button>
                    <button class="btn btn-primary" onclick="openCustomerModal()">+ Add Customer</button>
                </div>
            </div>

            <!-- Charts -->
            <div class="chart-container">
                <div class="chart-box">
                    <div class="chart-title">📈 Monthly New Customers</div>
                    <canvas id="customerTrendChart"></canvas>
                </div>
                <div class="chart-box">
                    <div class="chart-title">🗺️ Customer Region Distribution</div>
                    <div id="customerMap" style="height: 250px; border-radius: 12px;"></div>
                </div>
            </div>

            <!-- Customer Table -->
            <div class="data-section">
                <h4>Customer List</h4>
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Region</th>
                            <th>Status</th>
                            <th>Orders</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="customerTableBody"></tbody>
                </table>
            </div>

            <!-- Activity Feed -->
            <div class="data-section">
                <h4>Customer Activity Log</h4>
                <ul id="customerActivityFeed" style="list-style:none; padding-left:0;"></ul>
            </div>

            <!-- Modal -->
            <div class="modal" id="customerModal">
                <div class="modal-content">
                    <button class="modal-close" onclick="closeCustomerModal()">&times;</button>
                    <h2 class="modal-title">Add / Edit Customer</h2>
                    <div class="form-group"><label>Name</label><input type="text" id="custName" class="form-control" />
                    </div>
                    <div class="form-group"><label>Email</label><input type="email" id="custEmail"
                            class="form-control" /></div>
                    <div class="form-group"><label>Phone</label><input type="text" id="custPhone"
                            class="form-control" /></div>
                    <div class="form-group"><label>Region</label>
                        <select id="custRegion" class="form-control">
                            <option>North</option>
                            <option>South</option>
                            <option>East</option>
                            <option>West</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Status</label>
                        <select id="custStatus" class="form-control">
                            <option>Active</option>
                            <option>Inactive</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-success" onclick="saveCustomer()">Save</button>
                        <button class="btn btn-outline" onclick="closeCustomerModal()">Cancel</button>
                    </div>
                </div>
            </div>
            <div class="tabs" style="display: none;">
                <div class="tab active" onclick="showCustomerTab('all')">
                    All Customers
                </div>
                <div class="tab" onclick="showCustomerTab('active')">Active</div>
                <div class="tab" onclick="showCustomerTab('inactive')">Inactive</div>
            </div>
            <div class="data-section">
                <div class="section-header">
                    <h2 class="section-title">Customer Management</h2>
                    <div class="section-actions">
                        <button class="btn btn-outline" onclick="exportCustomersToPDF()">
                            <i class="fas fa-file-pdf"></i>
                            PDF
                        </button>
                        <button class="btn btn-outline" onclick="exportCustomersToExcel()">
                            <i class="fas fa-file-excel"></i>
                            Excel
                        </button>
                        <button class="btn btn-success" onclick="openCustomerModal()">
                            <i class="fas fa-plus"></i>
                            Add Customer
                        </button>
                    </div>
                </div>
                <table style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
                    <thead>
                        <tr>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Name</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Contact</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Address</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Delivery Schedule
                            </th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Status</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="customers-table">

                    </tbody>
                </table>
            </div>
        </div>

        <div class="section fade-in" id="suppliers-section">
            <div class="banner">Suppliers Overview</div>

            <!-- Summary Cards -->
            <div class="card-grid" style="margin-bottom: 2rem;">
                <div class="card fade-up">
                    <div class="card-header">
                        <div class="card-title">Total Suppliers</div><i class="fas fa-tractor card-icon"></i>
                    </div>
                    <div class="card-value" id="supplierCount">0</div>
                </div>
                <div class="card fade-up">
                    <div class="card-header">
                        <div class="card-title">Active Suppliers</div><i class="fas fa-check-circle card-icon"></i>
                    </div>
                    <div class="card-value" id="activeSupplierCount">0</div>
                </div>
                <div class="card fade-up">
                    <div class="card-header">
                        <div class="card-title">Avg. Daily Supply</div><i class="fas fa-tint card-icon"></i>
                    </div>
                    <div class="card-value" id="avgDailySupply">0 L</div>
                </div>
                <div class="card fade-up">
                    <div class="card-header">
                        <div class="card-title">Top Supplier</div><i class="fas fa-trophy card-icon"></i>
                    </div>
                    <div class="card-value" id="topSupplier">None</div>
                </div>
            </div>

            <!-- Supplier Table -->
            <div class="data-section">
                <div class="section-header">
                    <div class="section-title">Supplier Records</div>
                    <div class="section-actions">
                        <button class="btn btn-export" onclick="exportSuppliersPDF()"><i class="fas fa-file-pdf"></i>
                            PDF</button>
                        <button class="btn btn-export" onclick="exportSuppliersExcel()"><i
                                class="fas fa-file-excel"></i>
                            Excel</button>
                        <button class="btn btn-primary" onclick="openAddSupplierModal()"><i class="fas fa-plus"></i> Add
                            Supplier</button>
                    </div>
                </div>
                <table id="supplierTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Contact</th>
                            <th>Location</th>
                            <th>Cows</th>
                            <th>Avg Yield (L)</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="supplierTableBody"></tbody>
                </table>
            </div>

            <!-- Add/Edit Modal -->
            <div class="modal" id="supplierModal">
                <div class="modal-content">
                    <button class="modal-close" onclick="closeSupplierModal()">&times;</button>
                    <h2 class="modal-title" id="modalTitle">Add Supplier</h2>
                    <div class="form-group"><label>Name</label><input class="form-control" id="supplierName" required />
                    </div>
                    <div class="form-group"><label>Contact</label><input class="form-control" id="supplierContact"
                            required />
                    </div>
                    <div class="form-group"><label>Location</label><input class="form-control" id="supplierLocation"
                            required />
                    </div>
                    <div class="form-group"><label>Cows</label><input type="number" class="form-control"
                            id="supplierCows" required /></div>
                    <div class="form-group"><label>Avg Yield (L)</label><input type="number" class="form-control"
                            id="supplierYield" required /></div>
                    <div class="form-group">
                        <label>Status</label>
                        <select class="form-control" id="supplierStatus">
                            <option value="Active">Active</option>
                            <option value="New">New</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-primary" onclick="saveSupplier()">Save</button>
                    </div>
                </div>
            </div>

            <!-- View Modal -->
            <div class="modal" id="viewSupplierModal">
                <div class="modal-content">
                    <button class="modal-close"
                        onclick="document.getElementById('viewSupplierModal').style.display='none'">&times;</button>
                    <h2 class="modal-title">Supplier Details</h2>
                    <div class="form-group"><strong>Name:</strong> <span id="viewName"></span></div>
                    <div class="form-group"><strong>Contact:</strong> <span id="viewContact"></span></div>
                    <div class="form-group"><strong>Location:</strong> <span id="viewLocation"></span></div>
                    <div class="form-group"><strong>Cows:</strong> <span id="viewCows"></span></div>
                    <div class="form-group"><strong>Avg Yield (L):</strong> <span id="viewYield"></span></div>
                    <div class="form-group"><strong>Status:</strong> <span id="viewStatus"></span></div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="orders-section fade-up" style="margin-top: 2rem;">
                <h3>Recent Supplier Activities</h3>
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th>Supplier</th>
                            <th>Activity</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody id="activityLog"></tbody>
                </table>
            </div>



            <div class="data-section" style="display: none;">
                <div class="section-header">
                    <h2 class="section-title">Supplier Management</h2>
                    <div class="section-actions">
                        <button class="btn btn-outline" onclick="exportSuppliersToPDF()">
                            <i class="fas fa-file-pdf"></i>
                            PDF
                        </button>
                        <button class="btn btn-outline" onclick="exportSuppliersToExcel()">
                            <i class="fas fa-file-excel"></i>
                            Excel
                        </button>
                        <button class="btn btn-success" onclick="openSupplierModal()">
                            <i class="fas fa-plus"></i>
                            Add Supplier
                        </button>
                    </div>
                </div>
                <table style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
                    <thead>
                        <tr>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Name</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Contact</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Location</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Cows</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Avg. Yield</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Status</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="suppliers-table">

                    </tbody>
                </table>
            </div>
        </div>

        <div class="section fade-in" id="deliveries-section">
            <div class="tabs">
                <div class="tab active" onclick="showDeliveryTab('today')">Today</div>
                <div class="tab" onclick="showDeliveryTab('upcoming')">Upcoming</div>
                <div class="tab" onclick="showDeliveryTab('completed')">
                    Completed
                </div>
            </div>
            <div class="data-section">
                <div class="section-header">
                    <h2 class="section-title">Delivery Management</h2>
                    <div class="section-actions">
                        <button class="btn btn-outline" onclick="exportDeliveriesToPDF()">
                            <i class="fas fa-file-pdf"></i>
                            PDF
                        </button>
                        <button class="btn btn-outline" onclick="exportDeliveriesToExcel()">
                            <i class="fas fa-file-excel"></i>
                            Excel
                        </button>
                        <button class="btn btn-success" onclick="openDeliveryModal()">
                            <i class="fas fa-plus"></i>
                            Schedule Delivery
                        </button>
                    </div>
                </div>
                <table style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
                    <thead>
                        <tr>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Customer</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Date</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Time</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Items</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Quantity</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Status</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="deliveries-table">

                    </tbody>
                </table>
            </div>
        </div>

        <div class="section fade-in" id="payments-section">
            <!-- ✅ FINAL Payments Section: Fully Functional, Clean, Persistent -->
            <div class="banner">Payments Dashboard</div>

            <!-- Summary Cards -->
            <div class="cards-grid">
                <div class="card"><i class="fas fa-wallet card-icon"></i>
                    <h3>Total Payments</h3>
                    <h2 id="totalPayments">₹0</h2>
                </div>
                <div class="card"><i class="fas fa-arrow-circle-up card-icon"></i>
                    <h3>Received</h3>
                    <h2 id="paymentsReceived">₹0</h2>
                </div>
                <div class="card"><i class="fas fa-arrow-circle-down card-icon"></i>
                    <h3>Pending</h3>
                    <h2 id="pendingPayments">₹0</h2>
                </div>
                <div class="card"><i class="fas fa-credit-card card-icon"></i>
                    <h3>Avg Per Payment</h3>
                    <h2 id="averagePayment">₹0</h2>
                </div>
            </div>

            <!-- Filters + Actions -->
            <div class="section-header">
                <div>
                    <strong>Filter by Date:</strong>
                    <input type="date" id="filterStart"> to <input type="date" id="filterEnd">
                    <button class="btn" onclick="applyDateFilter()">Apply</button>
                </div>
                <div class="section-actions">
                    <button class="btn btn-export" onclick="exportPayments('pdf')"><i class="fas fa-file-pdf"></i>
                        PDF</button>
                    <button class="btn btn-export" onclick="exportPayments('excel')"><i class="fas fa-file-excel"></i>
                        Excel</button>
                    <button class="btn btn-primary" onclick="openPaymentModal()">+ Add Payment</button>
                </div>
            </div>

            <!-- Table -->
            <div class="data-section">
                <h4>Payment Records</h4>
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Recipient</th>
                            <th>Type</th>
                            <th>Amount (₹)</th>
                            <th>Method</th>
                            <th>Status</th>
                            <th>Receipt</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="paymentsTableBody"></tbody>
                </table>
            </div>

            <!-- Charts Row 1 -->
            <div class="chart-container">
                <div class="chart-box">
                    <div class="chart-title">Monthly Payment Trends</div>
                    <canvas id="paymentTrendChart"></canvas>
                </div>
                <div class="chart-box">
                    <div class="chart-title">Payment Methods Used</div>
                    <canvas id="paymentMethodChart"></canvas>
                </div>
            </div>

            <!-- Charts Row 2 -->
            <div class="chart-container">
                <div class="chart-box">
                    <div class="chart-title">Status Breakdown</div>
                    <canvas id="paymentStatusChart"></canvas>
                </div>
                <div class="chart-box">
                    <div class="chart-title">Recipient Type Distribution</div>
                    <canvas id="paymentTypeChart"></canvas>
                </div>
            </div>
            <div class="flow-container">
                <div class="flow-step">
                    <div class="flow-icon"><i class="fas fa-file-invoice"></i></div>
                    <div class="flow-label">Invoice Generated</div>
                </div>
                <div class="flow-step">
                    <div class="flow-icon"><i class="fas fa-paper-plane"></i></div>
                    <div class="flow-label">Payment Sent</div>
                </div>
                <div class="flow-step">
                    <div class="flow-icon"><i class="fas fa-check-circle"></i></div>
                    <div class="flow-label">Status Verified</div>
                </div>
                <div class="flow-step">
                    <div class="flow-icon"><i class="fas fa-receipt"></i></div>
                    <div class="flow-label">Receipt Generated</div>
                </div>
            </div>
            <div class="info-box-grid"
                style="display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                <div class="info-box">
                    <h4>🧠 Tips for Successful Transactions</h4>
                    <ul style="padding-left: 1.2rem;">
                        <li>Always confirm recipient details</li>
                        <li>Double-check invoice amounts</li>
                        <li>Review failed transactions weekly</li>
                    </ul>
                </div>
                <div class="info-box">
                    <h4>📘 Status Guide</h4>
                    <p><strong>Paid</strong> - Fully processed<br><strong>Pending</strong> - Awaiting
                        confirmation<br><strong>Failed</strong> - Error in processing</p>
                </div>
            </div>


            <!-- Activity Feed -->
            <div class="data-section">
                <h4>Persistent Activity Log</h4>
                <ul id="activityFeed" style="list-style:none; padding-left: 0;"></ul>
            </div>

            <!-- Payment Modal -->
            <div class="modal" id="paymentModal">
                <div class="modal-content">
                    <button class="modal-close" onclick="closePaymentModal()">&times;</button>
                    <h2 class="modal-title">Add / Edit Payment</h2>
                    <div class="form-group"><label>Date</label><input type="date" class="form-control" id="paymentDate">
                    </div>
                    <div class="form-group"><label>Recipient</label><input type="text" class="form-control"
                            id="paymentRecipient">
                    </div>
                    <div class="form-group"><label>Recipient Type</label><select id="paymentType" class="form-control">
                            <option>Customer</option>
                            <option>Supplier</option>
                        </select></div>
                    <div class="form-group"><label>Amount</label><input type="number" class="form-control"
                            id="paymentAmount">
                    </div>
                    <div class="form-group"><label>Method</label>
                        <select class="form-control" id="paymentMethod">
                            <option>Cash</option>
                            <option>UPI</option>
                            <option>Bank Transfer</option>
                            <option>Cheque</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Status</label>
                        <select class="form-control" id="paymentStatus">
                            <option>Received</option>
                            <option>Pending</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-success" onclick="savePayment()">Save</button>
                        <button class="btn btn-outline" onclick="closePaymentModal()">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Receipt Modal -->
            <div class="modal" id="receiptModal">
                <div class="modal-content">
                    <button class="modal-close" onclick="closeReceiptModal()">&times;</button>
                    <h2 class="modal-title">Payment Receipt</h2>
                    <div id="receiptContent"></div>
                </div>
            </div>


            <div class="data-section" style="display: none;">
                <div class="section-header">
                    <h2 class="section-title">Payment Records</h2>
                    <div class="section-actions">
                        <button class="btn btn-outline" onclick="filterPayments('all')">
                            All
                        </button>
                        <button class="btn btn-outline" onclick="filterPayments('pending')">
                            Pending
                        </button>
                        <button class="btn btn-outline" onclick="filterPayments('completed')">
                            Completed
                        </button>
                        <button class="btn btn-outline" onclick="exportPaymentsToPDF()">
                            <i class="fas fa-file-pdf"></i>
                            PDF
                        </button>
                        <button class="btn btn-outline" onclick="exportPaymentsToExcel()">
                            <i class="fas fa-file-excel"></i>
                            Excel
                        </button>
                        <button class="btn btn-success" onclick="openPaymentModal()">
                            <i class="fas fa-plus"></i>
                            Record Payment
                        </button>
                    </div>
                </div>
                <table style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
                    <thead>
                        <tr>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Payment ID</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Date</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Supplier</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Amount</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Method</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Status</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="payments-table">

                    </tbody>
                </table>
            </div>
        </div>

        <div class="section fade-in" id="reports-section">
            <div class="banner">Reports </div>
            <div class="chart-grid">
                <div class="chart-container"
                    style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div class="chart-header">
                        <h2 class="chart-title">Monthly Production</h2>
                    </div>
                    <canvas id="productionChart"></canvas>
                </div>
                <div class="chart-container"
                    style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div class="chart-header">
                        <h2 class="chart-title">Customer Growth</h2>
                    </div>
                    <canvas id="growthChart"></canvas>
                </div>
            </div>
            <div class="data-section">
                <div class="section-header">
                    <h2 class="section-title">Financial Summary</h2>
                    <div class="section-actions">
                        <button class="btn btn-outline" onclick="exportReportsToPDF()">
                            <i class="fas fa-file-pdf"></i>
                            PDF
                        </button>
                        <button class="btn btn-outline" onclick="exportReportsToExcel()">
                            <i class="fas fa-file-excel"></i>
                            Excel
                        </button>
                        <button class="btn btn-primary" onclick="generateReport()">
                            <i class="fas fa-file-export"></i>
                            Generate Report
                        </button>
                    </div>
                </div>
                <table style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
                    <thead>
                        <tr>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Period</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Revenue</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Expenses</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Profit</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Milk Collected</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">New Customers</th>
                        </tr>
                    </thead>
                    <tbody id="reports-table">

                    </tbody>
                </table>
            </div>
        </div>

        <div class="section fade-in" id="settings-section">

            <div class="banner">Settings </div>

            <div class="settings-grid">
                <div class="setting-card">
                    <h3 class="setting-title">Appearance</h3>
                    <p class="setting-description">
                        Customize the look and feel of your dashboard
                    </p>
                    <div class="form-group">
                        <label for="theme-mode">Theme Mode</label>
                        <div class="switch">
                            <input id="theme-mode" onchange="toggleThemeMode()" type="checkbox" />
                            <span class="slider"></span>
                        </div>
                        <span id="theme-mode-label" style="margin-left: 10px">Dark Mode</span>
                    </div>
                </div>
                <div class="setting-card">
                    <h3 class="setting-title">Notifications</h3>
                    <p class="setting-description">
                        Configure how you receive notifications
                    </p>
                    <div class="form-group">
                        <label for="email-notifications">Email Notifications</label>
                        <div class="switch">
                            <input checked="" id="email-notifications" type="checkbox" />
                            <span class="slider"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="app-notifications">App Notifications</label>
                        <div class="switch">
                            <input checked="" id="app-notifications" type="checkbox" />
                            <span class="slider"></span>
                        </div>
                    </div>
                </div>
                <div class="setting-card">
                    <h3 class="setting-title">Data Management</h3>
                    <p class="setting-description">Manage your data and backups</p>
                    <div class="setting-actions">
                        <button class="btn btn-outline" onclick="backupData()">
                            <i class="fas fa-database"></i>
                            Backup Data
                        </button>
                        <button class="btn btn-outline" onclick="restoreData()">
                            <i class="fas fa-undo"></i>
                            Restore Data
                        </button>
                    </div>
                </div>
                <div class="setting-card">
                    <h3 class="setting-title">System Information</h3>
                    <p class="setting-description">View system details and version</p>
                    <div class="form-group">
                        <label>Version</label>
                        <p>DairyMaster Pro v2.1.0</p>
                    </div>
                    <div class="form-group">
                        <label>Last Updated</label>
                        <p>July 25, 2023</p>
                    </div>
                    <div class="setting-actions">
                        <button class="btn btn-primary" onclick="checkForUpdates()">
                            <i class="fas fa-sync-alt"></i>
                            Check for Updates
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="section fade-in" id="profile">
            <div class="banner">Profile Settings</div>
            <form class="profile-form" onsubmit="saveProfile();return false;">
                <label>Name:</label>
                <input id="pName" placeholder="Rekha Iyer" type="text" />
                <label>Email:</label>
                <input id="pEmail" placeholder="Enter your email" type="email" />
                <label>Phone:</label>
                <input id="pPhone" pattern="[6-9][0-9]{9}" placeholder="Enter 10-digit Indian number" required=""
                    title="Phone number must be 10 digits starting with 6,7,8 or 9" type="tel" />
                <label>Address:</label>
                <textarea id="pAddress" placeholder="Enter your address" rows="3"></textarea>
                <label>Language Preference:</label>
                <select id="pLanguage">
                    <option value="en">English</option>
                    <option value="hi">Hindi</option>
                    <option value="te">Telugu</option>
                    <option value="de">German</option>
                </select>
                <label>Work Mode:</label>
                <select id="pWorkMode">
                    <option value="active">Active</option>
                    <option value="away">Away</option>
                    <option value="dnd">Do Not Disturb</option>
                </select>
                <button type="submit">Save Changes</button>
            </form>
        </div>
    </div>


    <div style="display: none;">
        <div style="display: none;">
            <div class="section fade-in" id="farmer-mgmt">
                <div class="banner">Farmer Management</div>
                <div class="card-grid">
                    <div class="card fade-up" style="display: flex; align-items: center; gap: 1rem;">
                        <div
                            style="background-color: rgba(66,133,244,0.1); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;">
                            <i class="fas fa-users card-icon"
                                style="font-size: 1.25rem; color: #1d4ed8; margin: 0;"></i>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: #6b7280;">Total Farmers</div>
                            <div style="font-size: 1.8rem; font-weight: bold;">5,000</div>
                            <div style="font-size: 0.85rem; color: #16a34a;">Registered in our system</div>
                        </div>
                    </div>
                    <div class="card fade-up" style="display: flex; align-items: center; gap: 1rem;">
                        <div
                            style="background-color: rgba(66,133,244,0.1); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;">
                            <i class="fas fa-user-plus card-icon"
                                style="font-size: 1.25rem; color: #1d4ed8; margin: 0;"></i>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: #6b7280;">New Farmers (This Month)</div>
                            <div style="font-size: 1.8rem; font-weight: bold;">320</div>
                            <div style="font-size: 0.85rem; color: #16a34a;">+15% from last month</div>
                        </div>
                    </div>
                    <div class="card fade-up" style="display: flex; align-items: center; gap: 1rem;">
                        <div
                            style="background-color: rgba(66,133,244,0.1); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;">
                            <i class="fas fa-user-check card-icon"
                                style="font-size: 1.25rem; color: #1d4ed8; margin: 0;"></i>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: #6b7280;">Active This Week</div>
                            <div style="font-size: 1.8rem; font-weight: bold;">3,450</div>
                            <div style="font-size: 0.85rem; color: #16a34a;">69% of total farmers</div>
                        </div>
                    </div>
                    <div class="card fade-up" style="display: flex; align-items: center; gap: 1rem;">
                        <div
                            style="background-color: rgba(66,133,244,0.1); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;">
                            <i class="fas fa-wine-bottle card-icon"
                                style="font-size: 1.25rem; color: #1d4ed8; margin: 0;"></i>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: #6b7280;">Avg. Milk Contribution</div>
                            <div style="font-size: 1.8rem; font-weight: bold;">50 L</div>
                            <div style="font-size: 0.85rem; color: #16a34a;">Per farmer per day</div>
                        </div>
                    </div>
                </div>

                <div class="banner">Farmer Distribution by Region</div>
                <div class="map-container">
                    <div id="farmerMap"></div>
                    <div class="map-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #3b82f6;"></div>
                            <span>1-50 Farmers</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #10b981;"></div>
                            <span>51-100 Farmers</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #f59e0b;"></div>
                            <span>101-200 Farmers</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #ef4444;"></div>
                            <span>200+ Farmers</span>
                        </div>
                    </div>
                </div>

                <div class="banner">Farmer Engagement Metrics</div>
                <div class="chart-container" style="display:flex; flex-wrap:wrap; gap:2rem;">
                    <div class="chart-box fade-up"
                        style="min-width:300px; width:100%; flex:1;; margin-bottom: 2rem; min-width: 300px; width: 100%; flex: 1; margin-bottom:2rem; flex: 1 1 100%;">
                        <div class="chart-header">
                            <div class="chart-title">Training Participation</div>
                            <div class="chart-actions">
                                <button class="btn btn-export" onclick="exportChartToPDF('trainingChart')">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                            </div>
                        </div>
                        <canvas id="trainingChart"></canvas>
                    </div>
                    <div class="chart-box fade-up"
                        style="min-width:300px; width:100%; flex:1;; margin-bottom: 2rem; min-width: 300px; width: 100%; flex: 1; margin-bottom:2rem; flex: 1 1 100%;">
                        <div class="chart-header">
                            <div class="chart-title">Quality Compliance</div>
                            <div class="chart-actions">
                                <button class="btn btn-export" onclick="exportChartToPDF('qualityChart')">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                            </div>
                        </div>
                        <canvas id="qualityChart"></canvas>
                    </div>
                </div>
                <div class="banner">Recent Farmer Registrations</div>
                <div class="table-wrapper">
                    <table class="custom-table" style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
                        <thead>
                            <tr>
                                <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Farmer ID</th>
                                <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Name</th>
                                <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Location</th>
                                <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Join Date</th>
                                <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Avg. Milk (L/day)
                                </th>
                                <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">F10045</td>
                                <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">Rajesh Kumar</td>
                                <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">Village A</td>
                                <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">2025-03-28</td>
                                <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">45</td>
                                <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">
                                    <span class="status-badge status-completed">Active</span>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">F10044</td>
                                <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">Sunil Reddy</td>
                                <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">Village B</td>
                                <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">2025-03-27</td>
                                <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">60</td>
                                <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">
                                    <span class="status-badge status-completed">Active</span>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">F10043</td>
                                <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">Anil Sharma</td>
                                <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">Village C</td>
                                <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">2025-03-25</td>
                                <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">38</td>
                                <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">
                                    <span class="status-badge status-pending">Pending</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="pagination">
                    <button>«</button>
                    <button class="active">1</button>
                    <button>2</button>
                    <button>3</button>
                    <button>»</button>
                </div>
            </div>
        </div>



        <div class="banner">Dashboard Overview</div>

        <ul class="filter-list">
            <li>Daily</li>
            <li>Weekly</li>
            <li>Monthly</li>
            <li>Custom</li>
        </ul>

        <div class="card-grid">
            <div class="card fade-up" style="display: flex; align-items: center; gap: 1rem;">
                <div
                    style="background-color: rgba(66,133,244,0.1); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;">
                    <i class="fas fa-wine-bottle card-icon" style="font-size: 1.25rem; color: #1d4ed8; margin: 0;"></i>
                </div>
                <div>
                    <div style="font-size: 0.9rem; color: #6b7280;">Total Milk Procurement</div>
                    <div style="font-size: 1.8rem; font-weight: bold;">250,000 L</div>
                    <div style="font-size: 0.85rem; color: #16a34a;">+12.5%</div>
                </div>
            </div>
            <div class="card fade-up" style="display: flex; align-items: center; gap: 1rem;">
                <div
                    style="background-color: rgba(66,133,244,0.1); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;">
                    <i class="fas fa-money-bill-wave card-icon"
                        style="font-size: 1.25rem; color: #1d4ed8; margin: 0;"></i>
                </div>
                <div>
                    <div style="font-size: 0.9rem; color: #6b7280;">Total Sales Revenue</div>
                    <div style="font-size: 1.8rem; font-weight: bold;">₹ 1,500,000</div>
                    <div style="font-size: 0.85rem; color: #dc2626;">-2%</div>
                </div>
            </div>
            <div class="card fade-up" style="display: flex; align-items: center; gap: 1rem;">
                <div
                    style="background-color: rgba(66,133,244,0.1); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;">
                    <i class="fas fa-user-friends card-icon" style="font-size: 1.25rem; color: #1d4ed8; margin: 0;"></i>
                </div>
                <div>
                    <div style="font-size: 0.9rem; color: #6b7280;">Active Farmers</div>
                    <div style="font-size: 1.8rem; font-weight: bold;">5,000+</div>
                    <div style="font-size: 0.85rem; color: #16a34a;">+5.7%</div>
                </div>
            </div>
            <div class="card fade-up" style="display: flex; align-items: center; gap: 1rem;">
                <div
                    style="background-color: rgba(66,133,244,0.1); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;">
                    <i class="fas fa-truck card-icon" style="font-size: 1.25rem; color: #1d4ed8; margin: 0;"></i>
                </div>
                <div>
                    <div style="font-size: 0.9rem; color: #6b7280;">Distributors/Retailers</div>
                    <div style="font-size: 1.8rem; font-weight: bold;">1,200</div>
                    <div style="font-size: 0.85rem; color: #16a34a;">+8.3%</div>
                </div>
            </div>
            <div class="card fade-up" style="display: flex; align-items: center; gap: 1rem;">
                <div
                    style="background-color: rgba(66,133,244,0.1); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;">
                    <i class="fas fa-chart-line card-icon" style="font-size: 1.25rem; color: #1d4ed8; margin: 0;"></i>
                </div>
                <div>
                    <div style="font-size: 0.9rem; color: #6b7280;">Customer Growth Rate</div>
                    <div style="font-size: 1.8rem; font-weight: bold;">12%</div>
                    <div style="font-size: 0.85rem; color: #16a34a;">+12.5%</div>
                </div>
            </div>
            <div class="card fade-up" style="display: flex; align-items: center; gap: 1rem;">
                <div
                    style="background-color: rgba(66,133,244,0.1); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;">
                    <i class="fas fa-check-circle card-icon" style="font-size: 1.25rem; color: #1d4ed8; margin: 0;"></i>
                </div>
                <div>
                    <div style="font-size: 0.9rem; color: #6b7280;">Quality Metrics</div>
                    <div style="font-size: 1.8rem; font-weight: bold;">95%</div>
                    <div style="font-size: 0.85rem; color: #16a34a;">+12.5%</div>
                </div>
            </div>
            <div class="card fade-up" style="display: flex; align-items: center; gap: 1rem;">
                <div
                    style="background-color: rgba(66,133,244,0.1); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;">
                    <i class="fas fa-leaf card-icon" style="font-size: 1.25rem; color: #1d4ed8; margin: 0;"></i>
                </div>
                <div>
                    <div style="font-size: 0.9rem; color: #6b7280;">Environmental Metrics</div>
                    <div style="font-size: 1.8rem; font-weight: bold;">70%</div>
                    <div style="font-size: 0.85rem; color: #16a34a;">+12.5%</div>
                </div>
            </div>
            <div class="card fade-up" style="display: flex; align-items: center; gap: 1rem;">
                <div
                    style="background-color: rgba(66,133,244,0.1); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;">
                    <i class="fas fa-users card-icon" style="font-size: 1.25rem; color: #1d4ed8; margin: 0;"></i>
                </div>
                <div>
                    <div style="font-size: 0.9rem; color: #6b7280;">Employee Engagement</div>
                    <div style="font-size: 1.8rem; font-weight: bold;">90%</div>
                    <div style="font-size: 0.85rem; color: #16a34a;">+12.5%</div>
                </div>
            </div>
        </div>

        <div class="banner">Investment Summary</div>
        <div class="row-grid">
            <div class="info-box hover-lift fade-up"
                style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); transition: transform 0.3s ease;">
                <h4>Milk Purchased</h4>
                <p><i class="fas fa-tint" style="margin-right: 6px; font-size: 1rem; color: #1d4ed8;"></i>12,450 L
                </p>
            </div>
            <div class="info-box hover-lift fade-up"
                style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); transition: transform 0.3s ease;">
                <h4>Total Investment</h4>
                <p><i class="fas fa-rupee-sign" style="margin-right: 6px; font-size: 1rem; color: #1d4ed8;"></i>₹
                    487,500</p>
            </div>
            <div class="info-box hover-lift fade-up"
                style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); transition: transform 0.3s ease;">
                <h4>Avg. Milk Price</h4>
                <p><i class="fas fa-balance-scale" style="margin-right: 6px; font-size: 1rem; color: #1d4ed8;"></i>₹
                    32 /L</p>
            </div>
            <div class="info-box hover-lift fade-up"
                style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); transition: transform 0.3s ease;">
                <h4>Active Suppliers</h4>
                <p><i class="fas fa-tractor" style="margin-right: 6px; font-size: 1rem; color: #1d4ed8;"></i>24</p>
            </div>
        </div>

        <div class="banner">Top Suppliers</div>
        <table class="custom-table" style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
            <thead>
                <tr>
                    <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Supplier</th>
                    <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Qty (L)</th>
                    <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Rate (₹/L)</th>
                    <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Total</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">Green Pastures</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">1,250</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">32.00</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">₹ 40,000</td>
                </tr>
                <tr>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">Happy Cows Dairy</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">980</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">31.00</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">₹ 30,380</td>
                </tr>
                <tr>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">Organic Valley</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">1,500</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">34.00</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">₹ 51,000</td>
                </tr>
            </tbody>
        </table>

        <div class="banner">Packaging Investments</div>
        <table class="custom-table" style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
            <thead>
                <tr>
                    <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Package Type</th>
                    <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Qty</th>
                    <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Cost/Unit</th>
                    <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Total</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">500 ml Pouch</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">5,000</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">₹ 5.20</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">₹ 26,000</td>
                </tr>
                <tr>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">1 L Bottle</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">3,000</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">₹ 8.50</td>
                    <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">₹ 25,500</td>
                </tr>
            </tbody>
        </table>

        <div class="section fade-in" id="direct-sales">
            <div class="banner">Direct Sales</div>
            <div class="sales-cards">
                <div class="card fade-up">
                    <i class="fas fa-shopping-cart card-icon"></i>
                    <h3>Today's Sales</h3>
                    <h1>1,245</h1>
                    <p style="color: green">↑ 12% from yesterday</p>
                </div>
                <div class="card fade-up">
                    <i class="fas fa-store card-icon"></i>
                    <h3>Store Orders</h3>
                    <h1>24</h1>
                    <p style="color: green">↑ 3 new today</p>
                </div>
                <div class="card fade-up">
                    <i class="fas fa-calendar-check card-icon"></i>
                    <h3>Subscriptions</h3>
                    <h1>156</h1>
                    <p style="color: orange">↓ 2 renewals needed</p>
                </div>
                <div class="card fade-up">
                    <i class="fas fa-user-plus card-icon"></i>
                    <h3>New Customers</h3>
                    <h1>8</h1>
                    <p style="color: green">↑ 2 this week</p>
                </div>
            </div>
        </div>

        <div class="orders-section">
            <h3>Recent Farm Store Purchases</h3>
            <table style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
                <thead>
                    <tr>
                        <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Order #</th>
                        <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Customer</th>
                        <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Products</th>
                        <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Total</th>
                        <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Date</th>
                        <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Status</th>
                        <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Action</th>
                    </tr>
                </thead>
                <tbody id="ordersBody">

                </tbody>
            </table>
            <div class="pagination">
                <button onclick="changePage(1)">«</button>
                <button class="page-btn" onclick="changePage(1)">1</button>
                <button class="page-btn" onclick="changePage(2)">2</button>
                <button class="page-btn" onclick="changePage(3)">3</button>
                <button onclick="changePage(3)">»</button>
            </div>
        </div>

        <div class="modal-overlay" style="display: none;" id="orderModal">
            <div class="modal-content"
                style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); max-width: 500px; margin: auto;">
                <h3>Order Details</h3>
                <p id="modalOrderInfo"></p>
                <button onclick="closeModal()">Close</button>
            </div>
        </div>

        <div class="banner">Production Overview</div>
        <div class="chart-container" style="display:flex; flex-wrap:wrap; gap:2rem;">
            <div class="chart-box fade-up"
                style="min-width:300px; width:100%; flex:1;; margin-bottom: 2rem; min-width: 300px; width: 100%; flex: 1; margin-bottom:2rem; flex: 1 1 100%;">
                <div class="chart-header">
                    <div class="chart-title">Monthly Milk Procurement</div>
                    <div class="chart-actions">
                        <button class="btn btn-export" onclick="exportChartToPDF('milkBarChart')">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                        <button class="btn btn-export" onclick="exportChartToExcel('milkBarChart')">
                            <i class="fas fa-file-excel"></i> Excel
                        </button>
                    </div>
                </div>
                <canvas id="milkBarChart"></canvas>
            </div>
            <div class="chart-box fade-up"
                style="min-width:300px; width:100%; flex:1;; margin-bottom: 2rem; min-width: 300px; width: 100%; flex: 1; margin-bottom:2rem; flex: 1 1 100%;">
                <div class="chart-header">
                    <div class="chart-title">Investment Distribution</div>
                    <div class="chart-actions">
                        <button class="btn btn-export" onclick="exportChartToPDF('investmentPieChart')">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                        <button class="btn btn-export" onclick="exportChartToExcel('investmentPieChart')">
                            <i class="fas fa-file-excel"></i> Excel
                        </button>
                    </div>
                </div>
                <canvas id="investmentPieChart"></canvas>
            </div>
        </div>
        <div class="row-grid">
            <div class="info-box hover-lift fade-up"
                style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); transition: transform 0.3s ease;">
                <h4>Key Insights</h4>
                <p>Total Milk Purchased: <strong>12,450 L</strong></p>
                <p>Total Packaging Investment: <strong>₹ 414,900</strong></p>
                <p>Most Expensive Packaging: <strong>Ghee (₹ 170,000)</strong></p>
                <p>Highest Volume Product: <strong>Curd (13,500 units)</strong></p>
            </div>
            <div class="info-box hover-lift fade-up"
                style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); transition: transform 0.3s ease;">
                <h4>Monthly Trends</h4>
                <div class="highlight">
                    📈 <strong>Positive:</strong> Milk purchases ↑ 5.2% vs last month
                </div>
                <div class="warning">
                    ⚠️ <strong>Watch:</strong> Avg milk price ↓ 1.2%
                </div>
                <div class="recommendation">
                    💡 <strong>Recommendation:</strong> Negotiate rates with top 3 suppliers
                </div>
            </div>
        </div>




        <div class="banner">Milk Collection</div>
        <div class="card-grid">
            <div class="card fade-up" style="display: flex; align-items: center; gap: 1rem;">
                <div
                    style="background-color: rgba(66,133,244,0.1); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;">
                    <i class="fas fa-wine-bottle card-icon" style="font-size: 1.25rem; color: #1d4ed8; margin: 0;"></i>
                </div>
                <div>
                    <div style="font-size: 0.9rem; color: #6b7280;">Collected Today</div>
                    <div style="font-size: 1.8rem; font-weight: bold;">12,450 L</div>
                    <div style="font-size: 0.85rem; color: #16a34a;">From all collection centers</div>
                </div>
            </div>
            <div class="card fade-up" style="display: flex; align-items: center; gap: 1rem;">
                <div
                    style="background-color: rgba(66,133,244,0.1); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;">
                    <i class="fas fa-calendar-alt card-icon" style="font-size: 1.25rem; color: #1d4ed8; margin: 0;"></i>
                </div>
                <div>
                    <div style="font-size: 0.9rem; color: #6b7280;">Avg. Collection/Day</div>
                    <div style="font-size: 1.8rem; font-weight: bold;">10,800 L</div>
                    <div style="font-size: 0.85rem; color: #16a34a;">Last 30 days average</div>
                </div>
            </div>
            <div class="card fade-up" style="display: flex; align-items: center; gap: 1rem;">
                <div
                    style="background-color: rgba(66,133,244,0.1); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;">
                    <i class="fas fa-check-circle card-icon" style="font-size: 1.25rem; color: #1d4ed8; margin: 0;"></i>
                </div>
                <div>
                    <div style="font-size: 0.9rem; color: #6b7280;">Quality Pass Rate</div>
                    <div style="font-size: 1.8rem; font-weight: bold;">95%</div>
                    <div style="font-size: 0.85rem; color: #16a34a;">Of collected milk</div>
                </div>
            </div>
            <div class="card fade-up" style="display: flex; align-items: center; gap: 1rem;">
                <div
                    style="background-color: rgba(66,133,244,0.1); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;">
                    <i class="fas fa-warehouse card-icon" style="font-size: 1.25rem; color: #1d4ed8; margin: 0;"></i>
                </div>
                <div>
                    <div style="font-size: 0.9rem; color: #6b7280;">Collection Centers</div>
                    <div style="font-size: 1.8rem; font-weight: bold;">25</div>
                    <div style="font-size: 0.85rem; color: #16a34a;">Active centers</div>
                </div>
            </div>
        </div>

        <div class="banner">Collection Trends</div>
        <div class="chart-container" style="display:flex; flex-wrap:wrap; gap:2rem;">
            <div class="chart-box fade-up"
                style="min-width:300px; width:100%; flex:1;; margin-bottom: 2rem; min-width: 300px; width: 100%; flex: 1; margin-bottom:2rem; flex: 1 1 100%;">
                <div class="chart-header">
                    <div class="chart-title">Weekly Milk Collection by Center</div>
                    <div class="chart-actions">
                        <button class="btn btn-export" onclick="exportChartToPDF('milkCollectChart')">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                        <button class="btn btn-export" onclick="exportChartToExcel('milkCollectChart')">
                            <i class="fas fa-file-excel"></i> Excel
                        </button>
                    </div>
                </div>
                <canvas id="milkCollectChart"></canvas>
            </div>
            <div class="chart-box fade-up"
                style="min-width:300px; width:100%; flex:1;; margin-bottom: 2rem; min-width: 300px; width: 100%; flex: 1; margin-bottom:2rem; flex: 1 1 100%;">
                <div class="chart-header">
                    <div class="chart-title">Fat/SNF Analysis</div>
                    <div class="chart-actions">
                        <button class="btn btn-export" onclick="exportChartToPDF('fatSnfChart')">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                    </div>
                </div>
                <canvas id="fatSnfChart"></canvas>
            </div>
        </div>
        <div class="banner">Recent Collections</div>
        <div class="table-wrapper">
            <table class="custom-table" style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
                <thead>
                    <tr>
                        <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Collection ID</th>
                        <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Center</th>
                        <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Farmer ID</th>
                        <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Quantity (L)</th>
                        <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Fat %</th>
                        <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">SNF %</th>
                        <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Time</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">C2045</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">Center A</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">F10045</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">45</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">4.2</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">8.5</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">Today, 06:30 AM</td>
                    </tr>
                    <tr>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">C2044</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">Center B</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">F10032</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">38</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">3.8</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">8.2</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">Today, 06:45 AM</td>
                    </tr>
                    <tr>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">C2043</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">Center A</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">F10028</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">52</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">4.5</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">8.7</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">Today, 07:15 AM</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="banner">Quality Control</div>
        <div class="cards-grid">
            <div class="card-grid">
                <div class="card fade-up" style="display: flex; align-items: center; gap: 1rem;">
                    <div
                        style="background-color: rgba(66,133,244,0.1); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;">
                        <i class="fas fa-tint" style="font-size: 1.25rem; color: #1d4ed8; margin: 0;"></i>
                    </div>
                    <div>
                        <div style="font-size: 0.9rem; color: #6b7280;">Total Milk Collected</div>
                        <div style="font-size: 1.8rem; font-weight: bold;">24,500 L</div>
                        <div style="font-size: 0.85rem; color: #16a34a;">↑ 3.2% Today</div>
                    </div>
                </div>
                <div class="card fade-up" style="display: flex; align-items: center; gap: 1rem;">
                    <div
                        style="background-color: rgba(66,133,244,0.1); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;">
                        <i class="fas fa-rupee-sign" style="font-size: 1.25rem; color: #1d4ed8; margin: 0;"></i>
                    </div>
                    <div>
                        <div style="font-size: 0.9rem; color: #6b7280;">Revenue</div>
                        <div style="font-size: 1.8rem; font-weight: bold;">₹ 1,200,000</div>
                        <div style="font-size: 0.85rem; color: #dc2626;">↓ 1.2% This Month</div>
                    </div>
                </div>
                <div class="card fade-up" style="display: flex; align-items: center; gap: 1rem;">
                    <div
                        style="background-color: rgba(66,133,244,0.1); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;">
                        <i class="fas fa-user-check" style="font-size: 1.25rem; color: #1d4ed8; margin: 0;"></i>
                    </div>
                    <div>
                        <div style="font-size: 0.9rem; color: #6b7280;">Active Customers</div>
                        <div style="font-size: 1.8rem; font-weight: bold;">1,850</div>
                        <div style="font-size: 0.85rem; color: #16a34a;">↑ 4.1% Growth</div>
                    </div>
                </div>
                <div class="card fade-up" style="display: flex; align-items: center; gap: 1rem;">
                    <div
                        style="background-color: rgba(66,133,244,0.1); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;">
                        <i class="fas fa-truck" style="font-size: 1.25rem; color: #1d4ed8; margin: 0;"></i>
                    </div>
                    <div>
                        <div style="font-size: 0.9rem; color: #6b7280;">Deliveries</div>
                        <div style="font-size: 1.8rem; font-weight: bold;">980</div>
                        <div style="font-size: 0.85rem; color: #16a34a;">↑ 2.4% This Week</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="banner">Quality Test Results</div>
        <div class="chart-container" style="display:flex; flex-wrap:wrap; gap:2rem;">
            <div class="chart-box fade-up"
                style="min-width:300px; width:100%; flex:1;; margin-bottom: 2rem; min-width: 300px; width: 100%; flex: 1; margin-bottom:2rem; flex: 1 1 100%;">
                <div class="chart-header">
                    <div class="chart-title">Test Result History (Last 30 Days)</div>
                    <div class="chart-actions">
                        <button class="btn btn-export" onclick="exportChartToPDF('testHistoryChart')">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                    </div>
                </div>
                <canvas id="testHistoryChart"></canvas>
            </div>
            <div class="chart-box fade-up"
                style="min-width:300px; width:100%; flex:1;; margin-bottom: 2rem; min-width: 300px; width: 100%; flex: 1; margin-bottom:2rem; flex: 1 1 100%;">
                <div class="chart-header">
                    <div class="chart-title">Failure Reasons</div>
                    <div class="chart-actions">
                        <button class="btn btn-export" onclick="exportChartToPDF('failureReasonsChart')">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                    </div>
                </div>
                <canvas id="failureReasonsChart"></canvas>
            </div>
        </div>
        <div class="banner">Recent Quality Tests</div>
        <div class="table-wrapper">
            <table class="custom-table" style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
                <thead>
                    <tr>
                        <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Test ID</th>
                        <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Batch</th>
                        <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Fat %</th>
                        <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">SNF %</th>
                        <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Acidity</th>
                        <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Result</th>
                        <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Time</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">T3045</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">B10045</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">4.2</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">8.5</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">0.14</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">
                            <span class="status-badge status-completed">Passed</span>
                        </td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">Today, 08:30 AM</td>
                    </tr>
                    <tr>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">T3044</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">B10044</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">3.8</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">8.2</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">0.16</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">
                            <span class="status-badge status-completed">Passed</span>
                        </td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">Today, 08:45 AM</td>
                    </tr>
                    <tr>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">T3043</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">B10043</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">3.5</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">7.9</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">0.18</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;"><span
                                class="status-badge status-pending">Failed</span></td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">Today, 09:15 AM</td>
                    </tr>
                </tbody>
            </table>
        </div>

    </div>
</body>



<script>
    function applyTheme(mode) {
        const html = document.documentElement;
        html.classList.toggle('dark-mode', mode === 'dark');
        localStorage.setItem('theme', mode);
        const icon = document.querySelector('#theme-toggle i');
        if (icon) {
            icon.className = mode === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }
        const label = document.getElementById("theme-mode-label");
        if (label) {
            label.textContent = mode === "dark" ? "Dark Mode" : "Light Mode";
            label.style.color = mode === "dark" ? "var(--dark)" : "var(--text)";
        }
        const toggleCheckbox = document.getElementById("theme-mode");
        if (toggleCheckbox) {
            toggleCheckbox.checked = (mode === 'dark');
        }
    }

    function toggleTheme() {
        const isDark = document.documentElement.classList.contains("dark-mode");
        applyTheme(isDark ? "light" : "dark");
    }

    document.addEventListener("DOMContentLoaded", () => {
        const savedTheme = localStorage.getItem("theme") || "light";
        applyTheme(savedTheme);

        const toggleBtn = document.getElementById("theme-toggle");
        if (toggleBtn) {
            toggleBtn.addEventListener("click", toggleTheme);
        }

        const themeCheckbox = document.getElementById("theme-mode");
        if (themeCheckbox) {
            themeCheckbox.addEventListener("change", () => {
                applyTheme(themeCheckbox.checked ? "dark" : "light");
            });
        }
    });



    // Auto-format phone input (prevents non-numbers and limits to 10 digits)
    document.getElementById("pPhone").addEventListener("input", function (e) {
        this.value = this.value.replace(/\D/g, '').substring(0, 10);
    });

    // Chart references
    let milkBarChart, investmentPieChart, milkCollectChart, fatSnfChart, trainingChart, qualityChart;
    let capacityChart, testHistoryChart, failureReasonsChart, deliveryTimesChart, delayReasonsChart, topStoresChart;
    let farmerMap, deliveryMap;

    const chartData = {
        milkBarChart: {
            labels: ["April", "May", "June", "July", "August", "September", "October", "November", "Sep", "Oct", "Nov", "Dec"],
            datasets: [{
                label: "Milk Purchased (L)",
                data: [8900, 9400, 10100, 11200, 12500, 13100, 14500, 12800, 11900, 10400, 9900, 10900]
            }]
        },
        investmentPieChart: {
            labels: ["Milk Packaging", "Curd Packaging", "Ghee Packaging", "Paneer Packaging", "Other"],
            datasets: [{
                label: "Investment Amount (₹)",
                data: [100000, 80000, 170000, 50000, 14900]
            }]
        },
        milkCollectChart: {
            labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
            datasets: [{
                label: "Collected (L)",
                data: [1800, 2000, 2200, 2100, 2500, 2300, 2400]
            }]
        },
        fatSnfChart: {
            labels: ["Farmer 1", "Farmer 2", "Farmer 3", "Farmer 4", "Farmer 5", "Farmer 6"],
            datasets: [
                {
                    label: "Fat %",
                    data: [4.2, 3.8, 4.5, 3.9, 4.1, 3.7],
                    borderColor: "#3b82f6",
                    backgroundColor: "rgba(59, 130, 246, 0.5)"
                },
                {
                    label: "SNF %",
                    data: [8.5, 8.2, 8.7, 8.3, 8.6, 8.1],
                    borderColor: "#10b981",
                    backgroundColor: "rgba(16, 185, 129, 0.5)"
                }
            ]
        },
        trainingChart: {
            labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun"],
            datasets: [{
                label: "Farmers Trained",
                data: [120, 150, 180, 200, 220, 250],
                backgroundColor: "rgba(59, 130, 246, 0.5)"
            }]
        },
        qualityChart: {
            labels: ["Village A", "Village B", "Village C", "Village D", "Village E"],
            datasets: [{
                label: "Quality Compliance %",
                data: [92, 88, 95, 90, 85],
                backgroundColor: [
                    "rgba(16, 185, 129, 0.5)",
                    "rgba(16, 185, 129, 0.5)",
                    "rgba(16, 185, 129, 0.5)",
                    "rgba(16, 185, 129, 0.5)",
                    "rgba(239, 68, 68, 0.5)"
                ]
            }]
        },
        capacityChart: {
            labels: ["Center A", "Center B", "Center C", "Center D", "Center E"],
            datasets: [{
                label: "Capacity Utilization %",
                data: [85, 92, 78, 65, 88],
                backgroundColor: "rgba(59, 130, 246, 0.5)"
            }]
        },
        testHistoryChart: {
            labels: ["Week 1", "Week 2", "Week 3", "Week 4", "Week 5"],
            datasets: [
                {
                    label: "Passed",
                    data: [95, 97, 93, 96],
                    backgroundColor: "rgba(16, 185, 129, 0.5)"
                },
                {
                    label: "Failed",
                    data: [5, 3, 7, 4],
                    backgroundColor: "rgba(239, 68, 68, 0.5)"
                }
            ]
        },
        failureReasonsChart: {
            labels: ["High Acidity", "Low Fat", "Low SNF", "Contamination"],
            datasets: [{
                label: "Failure Reasons",
                data: [65, 20, 10, 5],
                backgroundColor: [
                    "rgba(239, 68, 68, 0.5)",
                    "rgba(234, 179, 8, 0.5)",
                    "rgba(59, 130, 246, 0.5)",
                    "rgba(107, 114, 128, 0.5)"
                ]
            }]
        },
        deliveryTimesChart: {
            labels: ["Route A", "Route B", "Route C", "Route D"],
            datasets: [{
                label: "Average Delivery Time (hours)",
                data: [2.1, 2.5, 1.8, 2.3],
                backgroundColor: "rgba(59, 130, 246, 0.5)"
            }]
        },
        delayReasonsChart: {
            labels: ["Traffic", "Vehicle Issues", "Loading Delays", "Other"],
            datasets: [{
                label: "Delay Reasons",
                data: [60, 20, 15, 5],
                backgroundColor: [
                    "rgba(239, 68, 68, 0.5)",
                    "rgba(234, 179, 8, 0.5)",
                    "rgba(59, 130, 246, 0.5)",
                    "rgba(107, 114, 128, 0.5)"
                ]
            }]
        },
        topStoresChart: {
            labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun"],
            datasets: [
                {
                    label: "Main Market Store",
                    data: [12000, 12500, 13000, 13500, 14000, 14500],
                    borderColor: "#3b82f6"
                },
                {
                    label: "City Center Store",
                    data: [11000, 11500, 12000, 12500, 13000, 13500],
                    borderColor: "#10b981"
                },
                {
                    label: "Suburb Plaza Store",
                    data: [9000, 9500, 10000, 10500, 11000, 11500],
                    borderColor: "#f59e0b"
                }
            ]
        }
    };

    // Initialize maps
    function initFarmerMap() {
        farmerMap = L.map('farmerMap').setView([20.5937, 78.9629], 5);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(farmerMap);

        // Mock farmer locations (in a real app, these would come from your data)
        const farmerLocations = [
            { lat: 19.0760, lng: 72.8777, count: 120, name: "Mumbai" },
            { lat: 28.6139, lng: 77.2090, count: 85, name: "Delhi" },
            { lat: 12.9716, lng: 77.5946, count: 65, name: "Bangalore" },
            { lat: 17.3850, lng: 78.4867, count: 210, name: "Hyderabad" },
            { lat: 13.0827, lng: 80.2707, count: 75, name: "Chennai" },
            { lat: 26.9124, lng: 75.7873, count: 45, name: "Jaipur" }
        ];

        // Add markers for each location
        farmerLocations.forEach(location => {
            let color;
            if (location.count > 200) color = '#ef4444';
            else if (location.count > 100) color = '#f59e0b';
            else if (location.count > 50) color = '#10b981';
            else color = '#3b82f6';

            L.circleMarker([location.lat, location.lng], {
                radius: Math.sqrt(location.count) * 0.8,
                fillColor: color,
                color: '#000',
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(farmerMap)
                .bindPopup(`<b>${location.name}</b><br>Farmers: ${location.count}`);
        });
    }

    function initDeliveryMap() {
        deliveryMap = L.map('deliveryMap').setView([20.5937, 78.9629], 5);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(deliveryMap);

        // Mock delivery routes (in a real app, these would come from your data)
        const routes = [
            {
                name: "Route A",
                coordinates: [[19.0760, 72.8777], [19.2183, 72.9781], [19.1383, 72.9111]],
                status: "completed",
                vehicle: "Truck 101"
            },
            {
                name: "Route B",
                coordinates: [[19.0760, 72.8777], [19.0176, 72.8561], [18.9750, 72.8258]],
                status: "in-progress",
                vehicle: "Van 202"
            },
            {
                name: "Route C",
                coordinates: [[19.0760, 72.8777], [19.0760, 73.8777], [19.0760, 74.8777]],
                status: "pending",
                vehicle: "Truck 103"
            }
        ];

        // Add routes to the map
        routes.forEach(route => {
            let color;
            if (route.status === "completed") color = '#10b981';
            else if (route.status === "in-progress") color = '#f59e0b';
            else color = '#ef4444';

            L.polyline(route.coordinates, { color: color, weight: 3 }).addTo(deliveryMap)
                .bindPopup(`<b>${route.name}</b><br>Vehicle: ${route.vehicle}<br>Status: ${route.status.replace('-', ' ')}`);
        });

        // Add markers for start/end points
        routes.forEach(route => {
            L.marker(route.coordinates[0]).addTo(deliveryMap)
                .bindPopup(`<b>Start: ${route.name}</b>`);

            L.marker(route.coordinates[route.coordinates.length - 1]).addTo(deliveryMap)
                .bindPopup(`<b>End: ${route.name}</b>`);
        });
    }

    // —— PDF Export for Charts using jsPDF ——
    function exportChartToPDF(chartId) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('landscape');

        // Get chart instance based on ID
        let chart;
        switch (chartId) {
            case 'milkBarChart': chart = milkBarChart; break;
            case 'investmentPieChart': chart = investmentPieChart; break;
            case 'milkCollectChart': chart = milkCollectChart; break;
            case 'fatSnfChart': chart = fatSnfChart; break;
            case 'trainingChart': chart = trainingChart; break;
            case 'qualityChart': chart = qualityChart; break;
            case 'capacityChart': chart = capacityChart; break;
            case 'testHistoryChart': chart = testHistoryChart; break;
            case 'failureReasonsChart': chart = failureReasonsChart; break;
            case 'deliveryTimesChart': chart = deliveryTimesChart; break;
            case 'delayReasonsChart': chart = delayReasonsChart; break;
            case 'topStoresChart': chart = topStoresChart; break;
        }

        // 1. Add title
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(16);
        const title = document.querySelector(`#${chartId}`).parentNode.querySelector('.chart-title').textContent;
        doc.text(title, 140, 20, { align: 'center' });

        // 2. Add chart image (top half)
        const imgData = document.getElementById(chartId).toDataURL('image/png');
        doc.addImage(imgData, 'PNG', 40, 30, 200, 100);

        // 3. Add data table (bottom half)
        doc.setFontSize(12);
        doc.text('Detailed Data:', 20, 140);

        // Prepare table data
        const headers = ["Period"].concat(chart.data.datasets.map(ds => ds.label));
        const rows = chart.data.labels.map((label, i) =>
            [label].concat(chart.data.datasets.map(ds => ds.data[i]))
        );

        // Generate table
        doc.autoTable({
            startY: 150,
            head: [headers],
            body: rows,
            styles: { fontSize: 10, cellPadding: 3 },
            columnStyles: {
                0: { fontStyle: 'bold', cellWidth: 30 }
            }
        });

        // 4. Add footer
        doc.setFontSize(10);
        doc.text(`Exported on ${new Date().toLocaleDateString()}`, 140, 280, { align: 'center' });

        // Save PDF
        doc.save(`${title.replace(/ /g, '_')}_Export.pdf`);
    }

    // —— Excel Export for Charts ——
    function exportChartToExcel(chartId) {
        const data = chartData[chartId];
        const chartTitle = document.querySelector(`#${chartId}`).parentNode.querySelector('.chart-title').textContent;

        let worksheet;
        if (chartId === 'investmentPieChart' || chartId === 'failureReasonsChart' || chartId === 'delayReasonsChart') {
            // For pie charts, create two columns: Category and Value
            const rows = data.labels.map((label, i) => ({
                Category: label,
                [data.datasets[0].label]: data.datasets[0].data[i]
            }));
            worksheet = XLSX.utils.json_to_sheet(rows);
        } else {
            // For bar/line charts, create columns for each dataset
            const rows = data.labels.map((label, i) => {
                const row = { Period: label };
                data.datasets.forEach(ds => {
                    row[ds.label] = ds.data[i];
                });
                return row;
            });
            worksheet = XLSX.utils.json_to_sheet(rows);
        }

        // Create a new workbook
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Chart Data");

        // Generate the Excel file
        XLSX.writeFile(workbook, `${chartTitle.replace(/[^a-z0-9]/gi, '_')}_${new Date().getTime()}.xlsx`);
    }

    // —— Charts Initialization ——
    window.addEventListener("DOMContentLoaded", () => {
        loadProfile();
        initFarmerMap();
        initDeliveryMap();

        // Milk Procurement Chart (Bar)
        milkBarChart = new Chart(document.getElementById("milkBarChart").getContext("2d"), {
            type: "bar",
            data: chartData.milkBarChart,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return `${context.dataset.label}: ${context.raw.toLocaleString()} L`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function (value) { return value.toLocaleString() + " L"; }
                        }
                    }
                }
            }
        });

        // Investment Pie Chart
        investmentPieChart = new Chart(document.getElementById("investmentPieChart").getContext("2d"), {
            type: "pie",
            data: chartData.investmentPieChart,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: "bottom",
                        labels: { padding: 20, usePointStyle: true, pointStyle: "circle" }
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                const label = context.label || "";
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ₹${value.toLocaleString()} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });

        // Milk Collection Chart (Line)
        milkCollectChart = new Chart(document.getElementById("milkCollectChart").getContext("2d"), {
            type: "line",
            data: chartData.milkCollectChart,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return `${context.dataset.label}: ${context.raw.toLocaleString()} L`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function (value) { return value.toLocaleString() + " L"; }
                        }
                    }
                }
            }
        });

        // Fat/SNF Analysis Chart
        fatSnfChart = new Chart(document.getElementById("fatSnfChart").getContext("2d"), {
            type: "bar",
            data: chartData.fatSnfChart,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return `${context.dataset.label}: ${context.raw}%`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 10,
                        ticks: {
                            callback: function (value) { return value + "%"; }
                        }
                    }
                }
            }
        });

        // Training Participation Chart
        trainingChart = new Chart(document.getElementById("trainingChart").getContext("2d"), {
            type: "bar",
            data: chartData.trainingChart,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return `${context.dataset.label}: ${context.raw}`;
                            }
                        }
                    }
                }
            }
        });

        // Quality Compliance Chart
        qualityChart = new Chart(document.getElementById("qualityChart").getContext("2d"), {
            type: "bar",
            data: chartData.qualityChart,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return `${context.dataset.label}: ${context.raw}%`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function (value) { return value + "%"; }
                        }
                    }
                }
            }
        });

        // Capacity Utilization Chart
        capacityChart = new Chart(document.getElementById("capacityChart").getContext("2d"), {
            type: "bar",
            data: chartData.capacityChart,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return `${context.dataset.label}: ${context.raw}%`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function (value) { return value + "%"; }
                        }
                    }
                }
            }
        });

        // Test History Chart
        testHistoryChart = new Chart(document.getElementById("testHistoryChart").getContext("2d"), {
            type: "bar",
            data: chartData.testHistoryChart,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return `${context.dataset.label}: ${context.raw}%`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function (value) { return value + "%"; }
                        }
                    }
                }
            }
        });

        // Failure Reasons Chart
        failureReasonsChart = new Chart(document.getElementById("failureReasonsChart").getContext("2d"), {
            type: "pie",
            data: chartData.failureReasonsChart,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: "bottom",
                        labels: { padding: 20, usePointStyle: true, pointStyle: "circle" }
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                const label = context.label || "";
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });

        // Delivery Times Chart
        deliveryTimesChart = new Chart(document.getElementById("deliveryTimesChart").getContext("2d"), {
            type: "bar",
            data: chartData.deliveryTimesChart,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return `${context.dataset.label}: ${context.raw} hours`;
                            }
                        }
                    }
                }
            }
        });

        // Delay Reasons Chart
        delayReasonsChart = new Chart(document.getElementById("delayReasonsChart").getContext("2d"), {
            type: "pie",
            data: chartData.delayReasonsChart,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: "bottom",
                        labels: { padding: 20, usePointStyle: true, pointStyle: "circle" }
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                const label = context.label || "";
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });

        // Top Stores Chart
        topStoresChart = new Chart(document.getElementById("topStoresChart").getContext("2d"), {
            type: "line",
            data: chartData.topStoresChart,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return `${context.dataset.label}: ₹${context.raw.toLocaleString()}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function (value) { return '₹' + value.toLocaleString(); }
                        }
                    }
                }
            }
        });
    });

    // —— Sidebar toggle ——
    function toggleSidebar() {
        document.getElementById("sidebar").classList.toggle("collapsed");
        document.querySelector(".main").classList.toggle("collapsed");
    }

    // —— Navigation ——
    function activateNav(el, sectionId) {
        document.querySelectorAll(".sidebar li").forEach((li) => li.classList.remove("active"));
        el.classList.add("active");
        document.querySelectorAll(".section").forEach((sec) => sec.classList.remove("active"));
        document.getElementById(sectionId).classList.add("active");
        window.scrollTo(0, 0);

        // Reinitialize maps when their sections are shown
        if (sectionId === 'farmer-mgmt' && farmerMap) {
            setTimeout(() => {
                farmerMap.invalidateSize();
            }, 300);
        }
        if (sectionId === 'logistics' && deliveryMap) {
            setTimeout(() => {
                deliveryMap.invalidateSize();
            }, 300);
        }
    }

    function showSection(sectionId) {
        const navItem = document.querySelector(`.sidebar li[onclick*="${sectionId}"]`);
        if (navItem) activateNav(navItem, sectionId);
    }

    // —— Language & Work Mode ——
    function setLanguage(lang) {
        const languages = { en: "English", hi: "Hindi", te: "Telugu", de: "German" };
        document.querySelector(".dropdown-btn span").className =
            (lang === "en" ? "green" : lang === "hi" ? "red" : "gray");
        document.querySelector(".dropdown-btn").innerHTML =
            `<span class=" ${lang === "en" ? "green" : lang === "hi" ? "red" : "gray"}"></span> ${languages[lang]}`;
        localStorage.setItem("language", lang);
    }

    function setWorkMode(mode) {
        const modes = { active: "Active", away: "Away", dnd: "Do Not Disturb" };
        document.querySelectorAll(".dropdown-btn")[1].innerHTML =
            `<span class="dot ${mode === "active" ? "green" : mode === "away" ? "gray" : "red"}"></span> ${modes[mode]}`;
        localStorage.setItem("workMode", mode);
    }

    // —— Profile Save/Load ——
    function saveProfile() {
        const phoneInput = document.getElementById("pPhone");
        const phoneValue = phoneInput.value.replace(/\D/g, ''); // Remove non-digits

        // Validate phone number
        if (!/^[6-9]\d{9}$/.test(phoneValue)) {
            alert("❌ Invalid Indian number! Must be 10 digits starting with 6,7,8 or 9");
            phoneInput.focus();
            return false;
        }

        const profile = {
            name: document.getElementById("pName").value,
            email: document.getElementById("pEmail").value,
            phone: "+91 " + phoneValue, // Format as +91 XXXXXXXXXX
            address: document.getElementById("pAddress").value,
            language: document.getElementById("pLanguage").value,
            workMode: document.getElementById("pWorkMode").value,
        };

        localStorage.setItem("profile", JSON.stringify(profile));
        document.querySelector(".profile-name").textContent = profile.name;
        setLanguage(profile.language);
        setWorkMode(profile.workMode);
        alert("✅ Profile saved successfully!");
        return false; // Prevent form submission
    }

    function loadProfile() {
        const profile = JSON.parse(localStorage.getItem("profile")) || {};
        if (profile.name) {
            document.getElementById("pName").value = profile.name;
            document.getElementById("pEmail").value = profile.email || "";
            document.getElementById("pPhone").value = profile.phone || "";
            document.getElementById("pAddress").value = profile.address || "";
            document.getElementById("pLanguage").value = profile.language || "en";
            document.getElementById("pWorkMode").value = profile.workMode || "active";
            document.querySelector(".profile-name").textContent = profile.name;
            setLanguage(profile.language || "en");
            setWorkMode(profile.workMode || "active");
        }
    }

    // Orders functionality
    const orders = [
        [
            { id: '#10245', name: 'Shiva Kumar', products: 'Milk (2), Curd (1), Paneer (3)', total: '₹2280.50', date: 'Today, 10:45 AM' },
            { id: '#10244', name: 'Aravind Bandi', products: 'Paneer (2), Ghee (1)', total: '₹1800.75', date: 'Today, 9:30 AM' },
            { id: '#10243', name: 'Santhosh Kumar', products: 'Milk (2), Ghee (1)', total: '₹1200.25', date: 'Yesterday, 4:15 PM' }
        ],
        [
            { id: '#10242', name: 'Kiran Kumar', products: 'Curd (3), Milk (1)', total: '₹980.00', date: 'Yesterday, 11:00 AM' },
            { id: '#10241', name: 'Priya Reddy', products: 'Paneer (2)', total: '₹900.00', date: 'Yesterday, 10:00 AM' },
            { id: '#10240', name: 'Anil Kumar', products: 'Ghee (2)', total: '₹1200.00', date: '2 days ago, 5:00 PM' }
        ],
        [
            { id: '#10239', name: 'Meena Devi', products: 'Milk (5)', total: '₹1500.00', date: '2 days ago, 2:00 PM' },
            { id: '#10238', name: 'Ravi Teja', products: 'Curd (2), Paneer (1)', total: '₹1100.00', date: '3 days ago, 3:30 PM' },
            { id: '#10237', name: 'Lakshmi Narayana', products: 'Milk (1), Ghee (1)', total: '₹950.00', date: '3 days ago, 1:00 PM' }
        ]
    ];

    let currentPage = 1;

    function changePage(pageNum) {
        currentPage = pageNum;
        const tbody = document.getElementById('ordersBody');
        tbody.innerHTML = '';
        orders[pageNum - 1].forEach((order, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
            <td>${order.id}</td>
            <td>${order.name}</td>
            <td>${order.products}</td>
            <td>${order.total}</td>
            <td>${order.date}</td>
            <td><span class="status-badge status-completed">Completed</span></td>
            <td><button class="details-btn" onclick="showDetails('${order.id}', '${order.name}', '${order.products}', '${order.total}', '${order.date}')">Details</button></td>
          `;
            tbody.appendChild(row);
        });

        document.querySelectorAll('.page-btn').forEach(btn => btn.classList.remove('active'));
        if (document.querySelectorAll('.page-btn')[pageNum - 1]) {
            document.querySelectorAll('.page-btn')[pageNum - 1].classList.add('active');
        }
    }

    function showDetails(id, name, products, total, date) {
        const info = `
          <strong>Order ID:</strong> ${id}<br>
          <strong>Customer:</strong> ${name}<br>
          <strong>Products:</strong> ${products}<br>
          <strong>Total:</strong> ${total}<br>
          <strong>Date:</strong> ${date}
        `;
        document.getElementById('modalOrderInfo').innerHTML = info;
        document.getElementById('orderModal').style.display = 'flex';
    }

    function formatDate(dateString) {
        const options = { year: "numeric", month: "short", day: "numeric" };
        return new Date(dateString).toLocaleDateString("en-US", options);
    }


    function loadDeliveries(filter = "today") {
        const table = document.getElementById("deliveries-table");
        table.innerHTML = "";

        let deliveries = appData.deliveries;
        const today = new Date().toISOString().split("T")[0];

        if (filter === "today") {
            deliveries = deliveries.filter((d) => d.date === today);
        } else if (filter === "upcoming") {
            deliveries = deliveries.filter((d) => d.date > today);
        } else if (filter === "completed") {
            deliveries = deliveries.filter(
                (d) => d.date < today || d.status === "Completed"
            );
        }

        deliveries.forEach((delivery) => {
            const customer = appData.customers.find(
                (c) => c.id === delivery.customerId
            );
            const row = document.createElement("tr");
            row.innerHTML = `
                    <td>${customer ? customer.name : "Unknown"}</td>
                    <td>${formatDate(delivery.date)}</td>
                    <td>${delivery.time}</td>
                    <td>${delivery.items}</td>
                    <td>${delivery.quantity}L</td>
                    <td><span class="status ${delivery.status === "Completed"
                    ? "status-completed"
                    : delivery.status === "Pending"
                        ? "status-pending"
                        : "status-active"
                }">${delivery.status}</span></td>
                    <td>
                        <button class="action-btn" onclick="openDeliveryModal(${delivery.id
                })">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn" onclick="deleteDelivery(${delivery.id
                })">
                            <i class="fas fa-trash"></i>
                        </button>
                        ${delivery.status !== "Completed"
                    ? `
                        <button class="action-btn" onclick="completeDelivery(${delivery.id})">
                            <i class="fas fa-check"></i>
                        </button>`
                    : ""
                }
                    </td>
                `;
            table.appendChild(row);
        });
    }


    function exportPaymentsToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.text("Payment Records", 10, 10);
        let y = 20;

        appData.payments.forEach((payment) => {
            const supplier = appData.suppliers.find(
                (s) => s.id === payment.supplierId
            );
            doc.text(`Payment ID: ${payment.id}`, 10, y);
            doc.text(`Date: ${formatDate(payment.date)}`, 10, y + 5);
            doc.text(
                `Supplier: ${supplier ? supplier.name : "Unknown"}`,
                10,
                y + 10
            );
            doc.text(`Amount: $${payment.amount.toFixed(2)}`, 10, y + 15);
            doc.text(`Method: ${payment.method}`, 10, y + 20);
            doc.text(`Status: ${payment.status}`, 10, y + 25);
            doc.text("--------------------------------", 10, y + 30);
            y += 35;
        });

        doc.save("payments.pdf");
    }

    function exportDeliveriesToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.text("Delivery List", 10, 10);
        let y = 20;

        appData.deliveries.forEach((delivery) => {
            const customer = appData.customers.find(
                (c) => c.id === delivery.customerId
            );
            doc.text(`Customer: ${customer ? customer.name : "Unknown"}`, 10, y);
            doc.text(`Date: ${formatDate(delivery.date)}`, 10, y + 5);
            doc.text(`Time: ${delivery.time}`, 10, y + 10);
            doc.text(`Items: ${delivery.items}`, 10, y + 15);
            doc.text(`Quantity: ${delivery.quantity}L`, 10, y + 20);
            doc.text(`Status: ${delivery.status}`, 10, y + 25);
            doc.text("--------------------------------", 10, y + 30);
            y += 35;
        });

        doc.save("deliveries.pdf");
    }

    function loadPayments(filter = "all") {
        const table = document.getElementById("payments-table");
        table.innerHTML = "";

        let payments = appData.payments;
        if (filter === "pending") {
            payments = payments.filter((p) => p.status === "Pending");
        } else if (filter === "completed") {
            payments = payments.filter((p) => p.status === "Completed");
        }

        payments.forEach((payment) => {
            const supplier = appData.suppliers.find(
                (s) => s.id === payment.supplierId
            );
            const row = document.createElement("tr");
            row.innerHTML = `
                    <td>${payment.id}</td>
                    <td>${formatDate(payment.date)}</td>
                    <td>${supplier ? supplier.name : "Unknown"}</td>
                    <td>$${payment.amount.toFixed(2)}</td>
                    <td>${payment.method}</td>
                    <td><span class="status ${payment.status === "Completed"
                    ? "status-completed"
                    : "status-pending"
                }">${payment.status}</span></td>
                    <td>
                        <button class="action-btn" onclick="openPaymentModal('${payment.id
                }')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn" onclick="deletePayment('${payment.id
                }')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            table.appendChild(row);
        });
    }


    function exportDeliveriesToExcel() {
        const data = appData.deliveries.map((delivery) => {
            const customer = appData.customers.find(
                (c) => c.id === delivery.customerId
            );
            return {
                Customer: customer ? customer.name : "Unknown",
                Date: formatDate(delivery.date),
                Time: delivery.time,
                Items: delivery.items,
                "Quantity (L)": delivery.quantity,
                Status: delivery.status,
                Notes: delivery.notes,
            };
        });

        const worksheet = XLSX.utils.json_to_sheet(data);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Deliveries");
        XLSX.writeFile(workbook, "deliveries.xlsx");
    }

    function exportPaymentsToExcel() {
        const data = appData.payments.map((payment) => {
            const supplier = appData.suppliers.find(
                (s) => s.id === payment.supplierId
            );
            return {
                "Payment ID": payment.id,
                Date: formatDate(payment.date),
                Supplier: supplier ? supplier.name : "Unknown",
                Amount: payment.amount,
                Method: payment.method,
                Status: payment.status,
                Notes: payment.notes,
            };
        });

        const worksheet = XLSX.utils.json_to_sheet(data);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Payments");
        XLSX.writeFile(workbook, "payments.xlsx");
    }


    function closeModal() {
        document.getElementById('orderModal').style.display = 'none';
    }

    // Load first page initially
    changePage(1);


    // Application Data
    const appData = {
        customers: [
            {
                id: 1,
                name: "John Doe",
                phone: "+1 (555) 123-4567",
                email: "john.doe@example.com",
                address: "123 Main St, New York, NY",
                payment: "Credit Card",
                status: "Active",
                deliverySchedule: "Daily",
            },
            {
                id: 2,
                name: "Jane Smith",
                phone: "+1 (555) 987-6543",
                email: "jane.smith@example.com",
                address: "456 Oak Ave, Boston, MA",
                payment: "Bank Transfer",
                status: "Active",
                deliverySchedule: "MWF",
            },
            {
                id: 3,
                name: "Robert Johnson",
                phone: "+1 (555) 456-7890",
                email: "robert.j@example.com",
                address: "789 Pine Rd, Chicago, IL",
                payment: "Cash",
                status: "Inactive",
                deliverySchedule: "Weekly",
            },
        ],
        suppliers: [
            {
                id: 1,
                name: "Rajesh Patel",
                contact: "9876543210",
                location: "Village A",
                cows: 5,
                yield: 24.5,
                status: "Active",
            },
            {
                id: 2,
                name: "Meena Sharma",
                contact: "8765432109",
                location: "Village B",
                cows: 8,
                yield: 38.2,
                status: "Active",
            },
            {
                id: 3,
                name: "Vijay Kumar",
                contact: "7654321098",
                location: "Village C",
                cows: 12,
                yield: 52.7,
                status: "New",
            },
        ],
        deliveries: [
            {
                id: 1,
                customerId: 1,
                date: new Date().toISOString().split("T")[0],
                time: "Morning",
                items: "Standard Milk",
                quantity: 2,
                notes: "Leave at doorstep",
                status: "Pending",
            },
            {
                id: 2,
                customerId: 2,
                date: new Date().toISOString().split("T")[0],
                time: "Evening",
                items: "Low-fat Milk",
                quantity: 1,
                notes: "Ring bell twice",
                status: "Pending",
            },
            {
                id: 3,
                customerId: 1,
                date: new Date(Date.now() + 86400000).toISOString().split("T")[0],
                time: "Morning",
                items: "Standard Milk + Curd",
                quantity: 3,
                notes: "",
                status: "Scheduled",
            },
            {
                id: 4,
                customerId: 2,
                date: new Date(Date.now() - 86400000).toISOString().split("T")[0],
                time: "Evening",
                items: "Skimmed Milk",
                quantity: 2,
                notes: "Delivered successfully",
                status: "Completed",
            },
        ],
        payments: [
            {
                id: "PY-2023-0719",
                supplierId: 1,
                date: "2023-07-19",
                amount: 5420,
                method: "Bank Transfer",
                status: "Completed",
                notes: "Regular payment",
            },
            {
                id: "PY-2023-0718",
                supplierId: 2,
                date: "2023-07-18",
                amount: 8320,
                method: "Cash",
                status: "Completed",
                notes: "Bonus included",
            },
            {
                id: "PY-2023-0720",
                supplierId: 3,
                date: new Date().toISOString().split("T")[0],
                amount: 3120,
                method: "Bank Transfer",
                status: "Pending",
                notes: "New supplier payment",
            },
        ],
        activities: [
            {
                id: 1,
                type: "Note",
                content: "Customer requested early delivery tomorrow",
                user: "Admin",
                time: "Today, 10:30 AM",
            },
            {
                id: 2,
                type: "Reminder",
                content: "Follow up with supplier about quality issue",
                user: "Admin",
                time: "Today, 09:15 AM",
            },
            {
                id: 3,
                type: "Issue",
                content: "Reported milk consistency problem from SP-1002",
                user: "Quality Control",
                time: "Yesterday, 3:45 PM",
            },
            {
                id: 4,
                type: "Alert",
                content: "Low inventory alert for plastic bottles",
                user: "Inventory",
                time: "Yesterday, 11:20 AM",
            },
        ],
        reports: [
            {
                period: "July 2023",
                revenue: 8745,
                expenses: 4520,
                profit: 4225,
                milkCollected: 1245,
                newCustomers: 12,
            },
            {
                period: "June 2023",
                revenue: 7980,
                expenses: 4120,
                profit: 3860,
                milkCollected: 1180,
                newCustomers: 8,
            },
            {
                period: "May 2023",
                revenue: 7450,
                expenses: 3980,
                profit: 3470,
                milkCollected: 1050,
                newCustomers: 5,
            },
        ],
        settings: {
            darkMode: false,
            emailNotifications: true,
            appNotifications: true,
        },
    };

    // Chart instances
    let collectionChart, revenueChart, productionChart, growthChart;

    // Initialize the application
    document.addEventListener("DOMContentLoaded", function () {
        // Load all data
        loadCustomers();
        loadSuppliers();
        loadDeliveries();
        loadPayments();
        loadActivities();
        loadReports();
        loadSettings();

        // Initialize charts
        initCharts();

        // Setup form submissions
        document
            .getElementById("customer-form")
            .addEventListener("submit", saveCustomer);
        document
            .getElementById("supplier-form")
            .addEventListener("submit", saveSupplier);
        document
            .getElementById("delivery-form")
            .addEventListener("submit", saveDelivery);
        document
            .getElementById("payment-form")
            .addEventListener("submit", savePayment);
        document
            .getElementById("activity-form")
            .addEventListener("submit", saveActivity);

        // Set default dates in forms
        const today = new Date();
        document.getElementById("delivery-date").valueAsDate = today;
        document.getElementById("payment-date").valueAsDate = today;

        // Theme toggle
        document
            .getElementById("theme-toggle")
            .addEventListener("click", toggleTheme);
    });

    // Navigation functions
    function showSection(sectionId) {
        // Hide all sections
        document.querySelectorAll(".content-section").forEach((section) => {
            section.style.display = "none";
        });

        // Show selected section
        const section = document.getElementById(`${sectionId}-section`);
        section.style.display = "block";
        section.classList.add("fade-in");

        // Update page title
        document.getElementById("page-title").textContent =
            sectionId.charAt(0).toUpperCase() + sectionId.slice(1);

        // Refresh specific sections if needed
        if (sectionId === "reports") {
            updateCharts();
        }
    }

    function showCustomerTab(tab) {
        document.querySelectorAll("#customers-section .tab").forEach((t) => {
            t.classList.remove("active");
        });
        event.currentTarget.classList.add("active");
        loadCustomers(tab);
    }

    function showDeliveryTab(tab) {
        document.querySelectorAll("#deliveries-section .tab").forEach((t) => {
            t.classList.remove("active");
        });
        event.currentTarget.classList.add("active");
        loadDeliveries(tab);
    }

    // Modal functions
    function openModal(modalId) {
        document.getElementById(modalId).style.display = "flex";

        // Initialize forms if needed
        if (modalId === "delivery-modal") {
            initDeliveryForm();
        } else if (modalId === "payment-modal") {
            initPaymentForm();
        }
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
        document.getElementById(modalId.replace("-modal", "-form")).reset();
    }

    function openCustomerModal(customerId = null) {
        if (customerId) {
            const customer = appData.customers.find((c) => c.id === customerId);
            if (customer) {
                document.getElementById("customer-id").value = customer.id;
                document.getElementById("customer-name").value = customer.name;
                document.getElementById("customer-phone").value = customer.phone;
                document.getElementById("customer-email").value = customer.email;
                document.getElementById("customer-address").value =
                    customer.address;
                document.getElementById("customer-payment").value =
                    customer.payment;
                document.getElementById("customer-schedule").value =
                    customer.deliverySchedule;
                document.getElementById("customer-status").value = customer.status;

                document.getElementById("customer-modal-title").textContent =
                    "Edit Customer";
            }
        } else {
            document.getElementById("customer-id").value = "";
            document.getElementById("customer-modal-title").textContent =
                "Add New Customer";
        }
        openModal("customer-modal");
    }

    function openDeliveryModal(deliveryId = null) {
        if (deliveryId) {
            const delivery = appData.deliveries.find((d) => d.id === deliveryId);
            if (delivery) {
                document.getElementById("delivery-id").value = delivery.id;
                document.getElementById("delivery-customer").value =
                    delivery.customerId;
                document.getElementById("delivery-date").value = delivery.date;
                document.getElementById("delivery-time").value = delivery.time;
                document.getElementById("delivery-items").value = delivery.items;
                document.getElementById("delivery-quantity").value =
                    delivery.quantity;
                document.getElementById("delivery-notes").value = delivery.notes;

                document.getElementById("delivery-modal-title").textContent =
                    "Edit Delivery";
            }
        } else {
            document.getElementById("delivery-id").value = "";
            document.getElementById("delivery-modal-title").textContent =
                "Schedule Delivery";
        }
        openModal("delivery-modal");
    }

    function openSupplierModal(supplierId = null) {
        if (supplierId) {
            const supplier = appData.suppliers.find((s) => s.id === supplierId);
            if (supplier) {
                document.getElementById("supplier-id").value = supplier.id;
                document.getElementById("supplier-name").value = supplier.name;
                document.getElementById("supplier-contact").value =
                    supplier.contact;
                document.getElementById("supplier-location").value =
                    supplier.location;
                document.getElementById("supplier-cows").value = supplier.cows;
                document.getElementById("supplier-yield").value = supplier.yield;
                document.getElementById("supplier-status").value = supplier.status;

                document.getElementById("supplier-modal-title").textContent =
                    "Edit Supplier";
            }
        } else {
            document.getElementById("supplier-id").value = "";
            document.getElementById("supplier-modal-title").textContent =
                "Add New Supplier";
        }
        openModal("supplier-modal");
    }

    function openPaymentModal(paymentId = null) {
        if (paymentId) {
            const payment = appData.payments.find((p) => p.id === paymentId);
            if (payment) {
                document.getElementById("payment-id").value = payment.id;
                document.getElementById("payment-supplier").value =
                    payment.supplierId;
                document.getElementById("payment-date").value = payment.date;
                document.getElementById("payment-amount").value = payment.amount;
                document.getElementById("payment-method").value = payment.method;
                document.getElementById("payment-status").value = payment.status;
                document.getElementById("payment-notes").value = payment.notes;

                document.getElementById("payment-modal-title").textContent =
                    "Edit Payment";
            }
        } else {
            // Generate new payment ID
            const today = new Date();
            const paymentId = `PY-${today.getFullYear()}-${(today.getMonth() + 1)
                .toString()
                .padStart(2, "0")}${today.getDate().toString().padStart(2, "0")}`;
            document.getElementById("payment-id").value = paymentId;
            document.getElementById("payment-modal-title").textContent =
                "Record Payment";
        }
        openModal("payment-modal");
    }

    // Form initialization
    function initDeliveryForm() {
        const select = document.getElementById("delivery-customer");
        select.innerHTML = '<option value="">Select Customer</option>';

        appData.customers
            .filter((c) => c.status === "Active")
            .forEach((customer) => {
                const option = document.createElement("option");
                option.value = customer.id;
                option.textContent = customer.name;
                select.appendChild(option);
            });

        // Set default date to today
        document.getElementById("delivery-date").valueAsDate = new Date();
    }

    function initPaymentForm() {
        const select = document.getElementById("payment-supplier");
        select.innerHTML = '<option value="">Select Supplier</option>';

        appData.suppliers.forEach((supplier) => {
            const option = document.createElement("option");
            option.value = supplier.id;
            option.textContent = supplier.name;
            select.appendChild(option);
        });

        // Set default date to today
        document.getElementById("payment-date").valueAsDate = new Date();
    }

    // Data loading functions
    function loadCustomers(filter = "all") {
        const table = document.getElementById("customers-table");
        table.innerHTML = "";

        let customers = appData.customers;
        if (filter === "active") {
            customers = customers.filter((c) => c.status === "Active");
        } else if (filter === "inactive") {
            customers = customers.filter((c) => c.status === "Inactive");
        }

        customers.forEach((customer) => {
            const row = document.createElement("tr");
            row.innerHTML = `
                    <td>${customer.name}</td>
                    <td>${customer.phone}</td>
                    <td>${customer.address}</td>
                    <td>${customer.deliverySchedule}</td>
                    <td><span class="status ${customer.status === "Active"
                    ? "status-active"
                    : "status-inactive"
                }">${customer.status}</span></td>
                    <td>
                        <button class="action-btn" onclick="openCustomerModal(${customer.id
                })">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn" onclick="deleteCustomer(${customer.id
                })">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            table.appendChild(row);
        });
    }

    function loadSuppliers() {
        const table = document.getElementById("suppliers-table");
        table.innerHTML = "";

        appData.suppliers.forEach((supplier) => {
            const row = document.createElement("tr");
            row.innerHTML = `
                    <td>${supplier.name}</td>
                    <td>${supplier.contact}</td>
                    <td>${supplier.location}</td>
                    <td>${supplier.cows}</td>
                    <td>${supplier.yield} L</td>
                    <td><span class="status ${supplier.status === "Active"
                    ? "status-active"
                    : supplier.status === "New"
                        ? "status-pending"
                        : "status-inactive"
                }">${supplier.status}</span></td>
                    <td>
                        <button class="action-btn" onclick="openSupplierModal(${supplier.id
                })">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn" onclick="deleteSupplier(${supplier.id
                })">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            table.appendChild(row);
        });
    }


    function loadActivities() {
        const table = document.getElementById("activity-table");
        table.innerHTML = "";

        appData.activities.forEach((activity) => {
            const row = document.createElement("tr");
            row.innerHTML = `
                    <td><span class="status ${activity.type === "Note"
                    ? "status-active"
                    : activity.type === "Reminder"
                        ? "status-pending"
                        : "status-inactive"
                }">${activity.type}</span></td>
                    <td>${activity.user}</td>
                    <td>${activity.time}</td>
                    <td>${activity.content}</td>
                `;
            table.appendChild(row);
        });
    }

    function loadReports() {
        const table = document.getElementById("reports-table");
        table.innerHTML = "";

        appData.reports.forEach((report) => {
            const row = document.createElement("tr");
            row.innerHTML = `
                    <td>${report.period}</td>
                    <td>$${report.revenue.toFixed(2)}</td>
                    <td>$${report.expenses.toFixed(2)}</td>
                    <td>$${report.profit.toFixed(2)}</td>
                    <td>${report.milkCollected} L</td>
                    <td>${report.newCustomers}</td>
                `;
            table.appendChild(row);
        });
    }

    function loadSettings() {
        document.getElementById("theme-mode").checked =
            appData.settings.darkMode;
        document.getElementById("email-notifications").checked =
            appData.settings.emailNotifications;
        document.getElementById("app-notifications").checked =
            appData.settings.appNotifications;
        updateThemeModeLabel();
    }

    // Chart initialization
    function initCharts() {
        // Milk Collection Chart
        const collectionCtx = document
            .getElementById("collectionChart")
            .getContext("2d");
        collectionChart = new Chart(collectionCtx, {
            type: "line",
            data: {
                labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
                datasets: [
                    {
                        label: "Milk Collection (Liters)",
                        data: [1200, 1150, 1250, 1300, 1245, 1100, 1050],
                        borderColor: "var(--primary)",
                        backgroundColor: "rgba(66, 133, 244, 0.1)",
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true,
                    },
                ],
            },
            options: getChartOptions("Milk Collection Trend (Last 7 Days)"),
        });

        // Revenue Chart
        const revenueCtx = document
            .getElementById("revenueChart")
            .getContext("2d");
        revenueChart = new Chart(revenueCtx, {
            type: "doughnut",
            data: {
                labels: ["Retail", "Wholesale", "Online", "Subscriptions"],
                datasets: [
                    {
                        data: [65, 20, 10, 5],
                        backgroundColor: [
                            "#4285F4", // Blue
                            "#34A853", // Green
                            "#EA4335", // Red
                            "#FBBC05", // Yellow
                        ],
                        borderWidth: 1,
                    },
                ],
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: "right",
                        labels: {
                            color: "var(--text)",
                        },
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                const label = context.label || "";
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce(
                                    (a, b) => a + b,
                                    0
                                );
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: $${value} (${percentage}%)`;
                            },
                        },
                    },
                },
            },
        });

        // Production Chart
        const productionCtx = document
            .getElementById("productionChart")
            .getContext("2d");
        productionChart = new Chart(productionCtx, {
            type: "bar",
            data: {
                labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul"],
                datasets: [
                    {
                        label: "Milk Production (Liters)",
                        data: [32000, 34000, 36000, 38000, 37000, 39000, 40000],
                        backgroundColor: "rgba(66, 133, 244, 0.7)",
                        borderColor: "var(--primary)",
                        borderWidth: 1,
                    },
                ],
            },
            options: getChartOptions("Monthly Milk Production)"),
        });

        // Growth Chart
        const growthCtx = document
            .getElementById("growthChart")
            .getContext("2d");
        growthChart = new Chart(growthCtx, {
            type: "line",
            data: {
                labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul"],
                datasets: [
                    {
                        label: "Total Customers",
                        data: [180, 190, 200, 210, 220, 235, 248],
                        borderColor: "var(--secondary)",
                        backgroundColor: "rgba(52, 168, 83, 0.1)",
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true,
                    },
                ],
            },
            options: getChartOptions("Customer Growth)"),
        });
    }

    function getChartOptions(title) {
        return {
            responsive: true,
            plugins: {
                legend: {
                    position: "top",
                    labels: {
                        color: "var(--text)",
                    },
                },
                title: {
                    display: true,
                    text: title,
                    color: "var(--text)",
                },
                tooltip: {
                    mode: "index",
                    intersect: false,
                },
            },
            scales: {
                x: {
                    grid: {
                        color: "var(--border)",
                    },
                    ticks: {
                        color: "var(--text-light)",
                    },
                },
                y: {
                    grid: {
                        color: "var(--border)",
                    },
                    ticks: {
                        color: "var(--text-light)",
                    },
                    beginAtZero: false,
                },
            },
        };
    }

    function updateCharts() {
        // Update data for all charts
        collectionChart.data.datasets[0].data = [
            1200, 1150, 1250, 1300, 1245, 1100, 1050,
        ];
        collectionChart.update();

        revenueChart.data.datasets[0].data = [65, 20, 10, 5];
        revenueChart.update();

        productionChart.data.datasets[0].data = [
            32000, 34000, 36000, 38000, 37000, 39000, 40000,
        ];
        productionChart.update();

        growthChart.data.datasets[0].data = [180, 190, 200, 210, 220, 235, 248];
        growthChart.update();
    }

    function updateCollectionChart(range) {
        let labels, data;

        if (range === "7days") {
            labels = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
            data = [1200, 1150, 1250, 1300, 1245, 1100, 1050];
            collectionChart.options.plugins.title.text =
                "Milk Collection Trend (Last 7 Days)";
        } else if (range === "30days") {
            labels = ["Week 1", "Week 2", "Week 3", "Week 4", "Week 5"];
            data = [8500, 8700, 8900, 8800];
            collectionChart.options.plugins.title.text =
                "Milk Collection Trend (Last 30 Days)";
        } else if (range === "90days") {
            labels = ["Month 1", "Month 2", "Month 3"];
            data = [35000, 37000, 36000];
            collectionChart.options.plugins.title.text =
                "Milk Collection Trend (Last 90 Days)";
        }

        collectionChart.data.labels = labels;
        collectionChart.data.datasets[0].data = data;
        collectionChart.update();

        // Update active button
        document
            .querySelectorAll("#collectionChart + .chart-actions .chart-btn")
            .forEach((btn) => {
                btn.classList.remove("active");
            });
        event.currentTarget.classList.add("active");
    }

    // CRUD operations
    function saveCustomer(e) {
        e.preventDefault();

        const id = document.getElementById("customer-id").value;
        const customer = {
            name: document.getElementById("customer-name").value,
            phone: document.getElementById("customer-phone").value,
            email: document.getElementById("customer-email").value,
            address: document.getElementById("customer-address").value,
            payment: document.getElementById("customer-payment").value,
            deliverySchedule: document.getElementById("customer-schedule").value,
            status: document.getElementById("customer-status").value,
        };

        if (id) {
            // Update existing customer
            const index = appData.customers.findIndex((c) => c.id == id);
            appData.customers[index] = {
                ...appData.customers[index],
                ...customer,
            };

            // Add activity
            appData.activities.unshift({
                id: getNextId(appData.activities),
                type: "Note",
                content: `Updated customer: ${customer.name}`,
                user: "Admin",
                time: getCurrentTime(),
            });
        } else {
            // Add new customer
            customer.id = getNextId(appData.customers);
            appData.customers.push(customer);

            // Add activity
            appData.activities.unshift({
                id: getNextId(appData.activities),
                type: "Note",
                content: `Added new customer: ${customer.name}`,
                user: "Admin",
                time: getCurrentTime(),
            });
        }

        closeModal("customer-modal");
        loadCustomers();
        loadActivities();
    }

    function saveSupplier(e) {
        e.preventDefault();

        const id = document.getElementById("supplier-id").value;
        const supplier = {
            name: document.getElementById("supplier-name").value,
            contact: document.getElementById("supplier-contact").value,
            location: document.getElementById("supplier-location").value,
            cows: parseInt(document.getElementById("supplier-cows").value),
            yield: parseFloat(document.getElementById("supplier-yield").value),
            status: document.getElementById("supplier-status").value,
        };

        if (id) {
            // Update existing supplier
            const index = appData.suppliers.findIndex((s) => s.id == id);
            appData.suppliers[index] = {
                ...appData.suppliers[index],
                ...supplier,
            };

            // Add activity
            appData.activities.unshift({
                id: getNextId(appData.activities),
                type: "Note",
                content: `Updated supplier: ${supplier.name}`,
                user: "Admin",
                time: getCurrentTime(),
            });
        } else {
            // Add new supplier
            supplier.id = getNextId(appData.suppliers);
            appData.suppliers.push(supplier);

            // Add activity
            appData.activities.unshift({
                id: getNextId(appData.activities),
                type: "Note",
                content: `Added new supplier: ${supplier.name}`,
                user: "Admin",
                time: getCurrentTime(),
            });
        }

        closeModal("supplier-modal");
        loadSuppliers();
        loadActivities();
    }

    function saveDelivery(e) {
        e.preventDefault();

        const id = document.getElementById("delivery-id").value;
        const delivery = {
            customerId: parseInt(
                document.getElementById("delivery-customer").value
            ),
            date: document.getElementById("delivery-date").value,
            time: document.getElementById("delivery-time").value,
            items: document.getElementById("delivery-items").value,
            quantity: parseInt(
                document.getElementById("delivery-quantity").value
            ),
            notes: document.getElementById("delivery-notes").value,
            status: id
                ? appData.deliveries.find((d) => d.id == id).status
                : "Pending",
        };

        if (id) {
            // Update existing delivery
            const index = appData.deliveries.findIndex((d) => d.id == id);
            appData.deliveries[index] = {
                ...appData.deliveries[index],
                ...delivery,
            };

            // Add activity
            const customer = appData.customers.find(
                (c) => c.id == delivery.customerId
            );
            appData.activities.unshift({
                id: getNextId(appData.activities),
                type: "Note",
                content: `Updated delivery for ${customer ? customer.name : "customer"
                    }`,
                user: "Admin",
                time: getCurrentTime(),
            });
        } else {
            // Add new delivery
            delivery.id = getNextId(appData.deliveries);
            appData.deliveries.push(delivery);

            // Add activity
            const customer = appData.customers.find(
                (c) => c.id == delivery.customerId
            );
            appData.activities.unshift({
                id: getNextId(appData.activities),
                type: "Note",
                content: `Scheduled delivery for ${customer ? customer.name : "customer"
                    }: ${delivery.quantity}L ${delivery.items}`,
                user: "Admin",
                time: getCurrentTime(),
            });
        }

        closeModal("delivery-modal");
        loadDeliveries();
        loadActivities();
    }

    function savePayment(e) {
        e.preventDefault();

        const id = document.getElementById("payment-id").value;
        const payment = {
            supplierId: parseInt(
                document.getElementById("payment-supplier").value
            ),
            date: document.getElementById("payment-date").value,
            amount: parseFloat(document.getElementById("payment-amount").value),
            method: document.getElementById("payment-method").value,
            status: document.getElementById("payment-status").value,
            notes: document.getElementById("payment-notes").value,
        };

        if (id.startsWith("PY-")) {
            // Update existing payment
            const index = appData.payments.findIndex((p) => p.id === id);
            if (index >= 0) {
                appData.payments[index] = {
                    ...appData.payments[index],
                    ...payment,
                };

                // Add activity
                const supplier = appData.suppliers.find(
                    (s) => s.id == payment.supplierId
                );
                appData.activities.unshift({
                    id: getNextId(appData.activities),
                    type: "Note",
                    content: `Updated payment record for ${supplier ? supplier.name : "supplier"
                        }`,
                    user: "Admin",
                    time: getCurrentTime(),
                });
            }
        } else {
            // Add new payment
            const today = new Date();
            payment.id = `PY-${today.getFullYear()}-${(today.getMonth() + 1)
                .toString()
                .padStart(2, "0")}${today.getDate().toString().padStart(2, "0")}`;
            appData.payments.push(payment);

            // Add activity
            const supplier = appData.suppliers.find(
                (s) => s.id == payment.supplierId
            );
            appData.activities.unshift({
                id: getNextId(appData.activities),
                type: "Note",
                content: `Recorded payment to ${supplier ? supplier.name : "supplier"
                    }: $${payment.amount.toFixed(2)}`,
                user: "Admin",
                time: getCurrentTime(),
            });
        }

        closeModal("payment-modal");
        loadPayments();
        loadActivities();
    }

    function saveActivity(e) {
        e.preventDefault();

        const activity = {
            id: getNextId(appData.activities),
            type: document.getElementById("activity-type").value,
            content: document.getElementById("activity-content").value,
            user: "Admin",
            time: getCurrentTime(),
        };

        appData.activities.unshift(activity);
        closeModal("activity-modal");
        loadActivities();
    }

    // Delete operations
    function deleteCustomer(id) {
        if (confirm("Are you sure you want to delete this customer?")) {
            const customer = appData.customers.find((c) => c.id === id);
            if (customer) {
                // Add activity
                appData.activities.unshift({
                    id: getNextId(appData.activities),
                    type: "Alert",
                    content: `Deleted customer: ${customer.name}`,
                    user: "Admin",
                    time: getCurrentTime(),
                });

                // Remove customer
                appData.customers = appData.customers.filter((c) => c.id !== id);
                loadCustomers();
                loadActivities();
            }
        }
    }

    function deleteSupplier(id) {
        if (confirm("Are you sure you want to delete this supplier?")) {
            const supplier = appData.suppliers.find((s) => s.id === id);
            if (supplier) {
                // Add activity
                appData.activities.unshift({
                    id: getNextId(appData.activities),
                    type: "Alert",
                    content: `Deleted supplier: ${supplier.name}`,
                    user: "Admin",
                    time: getCurrentTime(),
                });

                // Remove supplier
                appData.suppliers = appData.suppliers.filter((s) => s.id !== id);
                loadSuppliers();
                loadActivities();
            }
        }
    }

    function deleteDelivery(id) {
        if (confirm("Are you sure you want to delete this delivery?")) {
            const delivery = appData.deliveries.find((d) => d.id === id);
            if (delivery) {
                // Add activity
                const customer = appData.customers.find(
                    (c) => c.id === delivery.customerId
                );
                appData.activities.unshift({
                    id: getNextId(appData.activities),
                    type: "Alert",
                    content: `Deleted delivery for ${customer ? customer.name : "customer"
                        }`,
                    user: "Admin",
                    time: getCurrentTime(),
                });

                // Remove delivery
                appData.deliveries = appData.deliveries.filter((d) => d.id !== id);
                loadDeliveries();
                loadActivities();
            }
        }
    }

    function deletePayment(id) {
        if (confirm("Are you sure you want to delete this payment record?")) {
            const payment = appData.payments.find((p) => p.id === id);
            if (payment) {
                // Add activity
                const supplier = appData.suppliers.find(
                    (s) => s.id === payment.supplierId
                );
                appData.activities.unshift({
                    id: getNextId(appData.activities),
                    type: "Alert",
                    content: `Deleted payment record for ${supplier ? supplier.name : "supplier"
                        }`,
                    user: "Admin",
                    time: getCurrentTime(),
                });

                // Remove payment
                appData.payments = appData.payments.filter((p) => p.id !== id);
                loadPayments();
                loadActivities();
            }
        }
    }

    // Other operations
    function completeDelivery(id) {
        const delivery = appData.deliveries.find((d) => d.id === id);
        if (delivery) {
            delivery.status = "Completed";

            // Add activity
            const customer = appData.customers.find(
                (c) => c.id === delivery.customerId
            );
            appData.activities.unshift({
                id: getNextId(appData.activities),
                type: "Note",
                content: `Completed delivery for ${customer ? customer.name : "customer"
                    }`,
                user: "Admin",
                time: getCurrentTime(),
            });

            loadDeliveries();
            loadActivities();
        }
    }

    function filterPayments(filter) {
        loadPayments(filter);
    }

    // Export functions
    function exportCustomersToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.text("Customer List", 10, 10);
        let y = 20;

        appData.customers.forEach((customer) => {
            doc.text(`Name: ${customer.name}`, 10, y);
            doc.text(`Phone: ${customer.phone}`, 10, y + 5);
            doc.text(`Email: ${customer.email}`, 10, y + 10);
            doc.text(`Address: ${customer.address}`, 10, y + 15);
            doc.text(`Status: ${customer.status}`, 10, y + 20);
            doc.text("--------------------------------", 10, y + 25);
            y += 30;
        });

        doc.save("customers.pdf");
    }

    function exportSuppliersToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.text("Supplier List", 10, 10);
        let y = 20;

        appData.suppliers.forEach((supplier) => {
            doc.text(`Name: ${supplier.name}`, 10, y);
            doc.text(`Contact: ${supplier.contact}`, 10, y + 5);
            doc.text(`Location: ${supplier.location}`, 10, y + 10);
            doc.text(`Cows: ${supplier.cows}`, 10, y + 15);
            doc.text(`Avg. Yield: ${supplier.yield} L/day`, 10, y + 20);
            doc.text(`Status: ${supplier.status}`, 10, y + 25);
            doc.text("--------------------------------", 10, y + 30);
            y += 35;
        });

        doc.save("suppliers.pdf");
    }


    function exportActivityToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.text("Activity Log", 10, 10);
        let y = 20;

        appData.activities.forEach((activity) => {
            doc.text(`Type: ${activity.type}`, 10, y);
            doc.text(`User: ${activity.user}`, 10, y + 5);
            doc.text(`Time: ${activity.time}`, 10, y + 10);
            doc.text(`Details: ${activity.content}`, 10, y + 15);
            doc.text("--------------------------------", 10, y + 20);
            y += 25;
        });

        doc.save("activity_log.pdf");
    }

    function exportReportsToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.text("Financial Reports", 10, 10);
        let y = 20;

        appData.reports.forEach((report) => {
            doc.text(`Period: ${report.period}`, 10, y);
            doc.text(`Revenue: $${report.revenue.toFixed(2)}`, 10, y + 5);
            doc.text(`Expenses: $${report.expenses.toFixed(2)}`, 10, y + 10);
            doc.text(`Profit: $${report.profit.toFixed(2)}`, 10, y + 15);
            doc.text(`Milk Collected: ${report.milkCollected} L`, 10, y + 20);
            doc.text(`New Customers: ${report.newCustomers}`, 10, y + 25);
            doc.text("--------------------------------", 10, y + 30);
            y += 35;
        });

        doc.save("financial_reports.pdf");
    }

    function exportCustomersToExcel() {
        const worksheet = XLSX.utils.json_to_sheet(appData.customers);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Customers");
        XLSX.writeFile(workbook, "customers.xlsx");
    }

    function exportSuppliersToExcel() {
        const worksheet = XLSX.utils.json_to_sheet(appData.suppliers);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Suppliers");
        XLSX.writeFile(workbook, "suppliers.xlsx");
    }

    function exportActivityToExcel() {
        const worksheet = XLSX.utils.json_to_sheet(appData.activities);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Activity Log");
        XLSX.writeFile(workbook, "activity_log.xlsx");
    }

    function exportReportsToExcel() {
        const worksheet = XLSX.utils.json_to_sheet(appData.reports);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Financial Reports");
        XLSX.writeFile(workbook, "financial_reports.xlsx");
    }

    // Settings functions
    function toggleTheme() {
        document.body.classList.toggle("dark-mode");
        appData.settings.darkMode =
            document.body.classList.contains("dark-mode");
        updateThemeModeLabel();
        updateCharts();
    }

    function toggleThemeMode() {
        document.body.classList.toggle(
            "dark-mode",
            document.getElementById("theme-mode").checked
        );
        appData.settings.darkMode =
            document.getElementById("theme-mode").checked;
        updateThemeModeLabel();
        updateCharts();
    }

    function updateThemeModeLabel() {
        const label = document.getElementById("theme-mode-label");
        label.textContent = appData.settings.darkMode
            ? "Dark Mode"
            : "Light Mode";
        label.style.color = appData.settings.darkMode
            ? "var(--dark)"
            : "var(--text)";
    }

    function backupData() {
        const dataStr = JSON.stringify(appData, null, 2);
        const dataUri =
            "data:application/json;charset=utf-8," + encodeURIComponent(dataStr);

        const exportName =
            "dairymaster_backup_" +
            new Date().toISOString().split("T")[0] +
            ".json";

        const linkElement = document.createElement("a");
        linkElement.setAttribute("href", dataUri);
        linkElement.setAttribute("download", exportName);
        linkElement.click();

        // Add activity
        appData.activities.unshift({
            id: getNextId(appData.activities),
            type: "Note",
            content: "System data backup created",
            user: "System",
            time: getCurrentTime(),
        });
        loadActivities();
    }

    function restoreData() {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".json";

        input.onchange = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();

            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    Object.assign(appData, data);

                    // Reload all data
                    loadCustomers();
                    loadSuppliers();
                    loadDeliveries();
                    loadPayments();
                    loadActivities();
                    loadReports();
                    loadSettings();
                    updateCharts();

                    // Add activity
                    appData.activities.unshift({
                        id: getNextId(appData.activities),
                        type: "Note",
                        content: "System data restored from backup",
                        user: "System",
                        time: getCurrentTime(),
                    });
                    loadActivities();

                    alert("Data restored successfully!");
                } catch (err) {
                    alert("Error restoring data: Invalid file format");
                    console.error(err);
                }
            };

            reader.readAsText(file);
        };

        input.click();
    }

    function checkForUpdates() {
        // Simulate update check
        setTimeout(() => {
            alert("Your system is up to date!");

            // Add activity
            appData.activities.unshift({
                id: getNextId(appData.activities),
                type: "Note",
                content: "Checked for system updates",
                user: "System",
                time: getCurrentTime(),
            });
            loadActivities();
        }, 1000);
    }

    function generateReport() {
        // Simulate report generation
        setTimeout(() => {
            alert("Financial report generated successfully!");

            // Add activity
            appData.activities.unshift({
                id: getNextId(appData.activities),
                type: "Note",
                content: "Generated financial report",
                user: "Admin",
                time: getCurrentTime(),
            });
            loadActivities();
        }, 1000);
    }

    // Helper functions
    function getNextId(items) {
        return items.length > 0
            ? Math.max(...items.map((item) => item.id)) + 1
            : 1;
    }

    function getCurrentTime() {
        return (
            "Today, " +
            new Date().toLocaleTimeString("en-US", {
                hour: "2-digit",
                minute: "2-digit",
            })
        );
    }

    document.querySelectorAll('.chart-actions').forEach(actionGroup => {
        const buttons = actionGroup.querySelectorAll('.chart-btn');
        buttons.forEach(btn => {
            btn.addEventListener('click', () => {
                buttons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
        });
    });

    // Fix chart button active toggle behavior
    document.querySelectorAll('.chart-actions').forEach(container => {
        container.querySelectorAll('.chart-btn').forEach(button => {
            button.addEventListener('click', () => {
                container.querySelectorAll('.chart-btn').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
            });
        });
    });

    // Fix modal close button functionality
    function closeModal() {
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.style.display = 'none';
        });
    }

    // Attach event listeners for close buttons (ensures all future modals are covered)
    document.addEventListener('click', function (event) {
        if (event.target.matches('.modal-content button') || event.target.matches('.modal-close')) {
            closeModal();
        }
    });

    // Sidebar dropdown accordion behavior
    document.querySelectorAll(".sidebar li.nav-item").forEach(item => {
        item.addEventListener("click", function () {
            const submenu = this.querySelector(".submenu");
            const arrow = this.querySelector(".dropdown-toggle span:last-child");
            const isOpen = submenu && submenu.style.display === "block";
            submenu.style.display = isOpen ? "none" : "block";
            arrow.textContent = isOpen ? "⌃" : "⌄";
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
        const navItems = document.querySelectorAll(".sidebar .nav-item");

        navItems.forEach(item => {
            const toggle = item.querySelector(".dropdown-toggle");
            const submenu = item.querySelector(".submenu");
            const arrow = toggle ? toggle.querySelector("span:last-child") : null;

            if (toggle && submenu && arrow) {
                submenu.style.display = "none"; // Ensure all start closed

                toggle.addEventListener("click", function (e) {
                    e.stopPropagation();

                    const isOpen = submenu.style.display === "block";

                    // Close all others
                    document.querySelectorAll(".sidebar .submenu").forEach(sub => sub.style.display = "none");
                    document.querySelectorAll(".sidebar .dropdown-toggle span:last-child").forEach(a => a.textContent = "⌃");

                    // Toggle current
                    submenu.style.display = isOpen ? "none" : "block";
                    arrow.textContent = isOpen ? "⌃" : "⌄";
                });
            }
        });
    });

    function applyTheme(mode) {
        const html = document.documentElement;
        html.classList.toggle('dark-mode', mode === 'dark');
        localStorage.setItem('theme', mode);
        const icon = document.querySelector('#theme-toggle i');
        if (icon) {
            icon.className = mode === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }
        const label = document.getElementById("theme-mode-label");
        if (label) {
            label.textContent = mode === "dark" ? "Dark Mode" : "Light Mode";
            label.style.color = mode === "dark" ? "var(--dark)" : "var(--text)";
        }
        const toggleCheckbox = document.getElementById("theme-mode");
        if (toggleCheckbox) {
            toggleCheckbox.checked = (mode === 'dark');
        }
    }

    function toggleTheme() {
        const isDark = document.documentElement.classList.contains("dark-mode");
        applyTheme(isDark ? "light" : "dark");
    }

    function toggleThemeMode() {
        document.body.classList.toggle(
            "dark-mode",
            document.getElementById("theme-mode").checked
        );
        appData.settings.darkMode =
            document.getElementById("theme-mode").checked;
        updateThemeModeLabel();
        updateCharts();
    }

    document.addEventListener("DOMContentLoaded", () => {
        const savedTheme = localStorage.getItem("theme") || "light";
        applyTheme(savedTheme);

        const toggleBtn = document.getElementById("theme-toggle");
        if (toggleBtn) {
            toggleBtn.addEventListener("click", toggleTheme);
        }

        const themeCheckbox = document.getElementById("theme-mode");
        if (themeCheckbox) {
            themeCheckbox.addEventListener("change", () => {
                applyTheme(themeCheckbox.checked ? "dark" : "light");
            });
        }
    });

    // Close modal on clicking the X button
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.modal-close').forEach(button => {
            button.addEventListener('click', () => {
                const modal = button.closest('.modal');
                if (modal) modal.style.display = 'none';
            });
        });

        // Optional: close modal on clicking outside modal content
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', e => {
                if (e.target === modal) modal.style.display = 'none';
            });
        });
    });
</script>


<script>
    let suppliers = [
        { name: "Rajesh Patel", contact: "9876543210", location: "Village A", cows: 5, yield: 24.5, status: "Active" },
        { name: "Meena Sharma", contact: "8765432109", location: "Village B", cows: 8, yield: 38.2, status: "Active" },
        { name: "Vijay Kumar", contact: "7654321098", location: "Village C", cows: 12, yield: 52.7, status: "New" }
    ];
    let editingIndex = -1;

    function renderSuppliers() {
        const tbody = document.getElementById("supplierTableBody");
        tbody.innerHTML = "";
        suppliers.forEach((s, i) => {
            const row = `<tr>
        <td>${s.name}</td>
        <td>${s.contact}</td>
        <td>${s.location}</td>
        <td>${s.cows}</td>
        <td>${s.yield.toFixed(1)} L</td>
        <td><span class="status ${s.status === 'Active' ? 'status-active' : s.status === 'New' ? 'status-pending' : 'status-inactive'}">${s.status}</span></td>
        <td>
          <button class="action-btn" onclick="viewSupplier(${i})"><i class="fas fa-eye"></i></button>
          <button class="action-btn" onclick="editSupplier(${i})"><i class="fas fa-edit"></i></button>
          <button class="action-btn" onclick="deleteSupplier(${i})"><i class="fas fa-trash"></i></button>
        </td>
      </tr>`;
            tbody.innerHTML += row;
        });
        updateSupplierCards();
    }

    function updateSupplierCards() {
        const total = suppliers.length;
        const active = suppliers.filter(s => s.status === "Active").length;
        const avg = total > 0 ? suppliers.reduce((a, s) => a + s.yield, 0) / total : 0;
        const top = suppliers.reduce((max, s) => s.yield > max.yield ? s : max, suppliers[0]);
        document.getElementById("supplierCount").innerText = total;
        document.getElementById("activeSupplierCount").innerText = active;
        document.getElementById("avgDailySupply").innerText = `${avg.toFixed(1)} L`;
        document.getElementById("topSupplier").innerText = top ? top.name : "None";
    }

    function openAddSupplierModal() {
        editingIndex = -1;
        document.getElementById("modalTitle").innerText = "Add Supplier";
        ["supplierName", "supplierContact", "supplierLocation", "supplierCows", "supplierYield"].forEach(id => document.getElementById(id).value = "");
        document.getElementById("supplierStatus").value = "Active";
        document.getElementById("supplierModal").style.display = "flex";
    }

    function closeSupplierModal() {
        document.getElementById("supplierModal").style.display = "none";
    }

    function saveSupplier() {
        const name = document.getElementById("supplierName").value;
        const contact = document.getElementById("supplierContact").value;
        const location = document.getElementById("supplierLocation").value;
        const cows = parseInt(document.getElementById("supplierCows").value);
        const yieldL = parseFloat(document.getElementById("supplierYield").value);
        const status = document.getElementById("supplierStatus").value;
        if (!name || !contact || !location || isNaN(cows) || isNaN(yieldL)) {
            alert("Please fill all fields correctly.");
            return;
        }
        const newSupplier = { name, contact, location, cows, yield: yieldL, status };
        if (editingIndex > -1) {
            suppliers[editingIndex] = newSupplier;
            logActivity(name, "Updated supplier details");
        } else {
            suppliers.push(newSupplier);
            logActivity(name, "Added new supplier");
        }
        closeSupplierModal();
        renderSuppliers();
    }

    function viewSupplier(index) {
        const s = suppliers[index];
        document.getElementById("viewName").innerText = s.name;
        document.getElementById("viewContact").innerText = s.contact;
        document.getElementById("viewLocation").innerText = s.location;
        document.getElementById("viewCows").innerText = s.cows;
        document.getElementById("viewYield").innerText = s.yield.toFixed(1);
        document.getElementById("viewStatus").innerText = s.status;
        document.getElementById("viewSupplierModal").style.display = "flex";
    }

    function editSupplier(index) {
        editingIndex = index;
        const s = suppliers[index];
        document.getElementById("modalTitle").innerText = "Edit Supplier";
        document.getElementById("supplierName").value = s.name;
        document.getElementById("supplierContact").value = s.contact;
        document.getElementById("supplierLocation").value = s.location;
        document.getElementById("supplierCows").value = s.cows;
        document.getElementById("supplierYield").value = s.yield;
        document.getElementById("supplierStatus").value = s.status;
        document.getElementById("supplierModal").style.display = "flex";
    }

    function deleteSupplier(index) {
        const name = suppliers[index].name;
        if (confirm(`Delete ${name}?`)) {
            suppliers.splice(index, 1);
            logActivity(name, "Deleted from system");
            renderSuppliers();
        }
    }

    function logActivity(supplierName, action) {
        const logBody = document.getElementById("activityLog");
        const now = new Date().toLocaleString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: true });
        const row = document.createElement("tr");
        row.innerHTML = `<td>${supplierName}</td><td>${action}</td><td>${now}</td>`;
        logBody.prepend(row);
        if (logBody.rows.length > 25) logBody.deleteRow(25);
    }

    function exportSuppliersPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("Supplier Records", 14, 16);
        doc.autoTable({
            startY: 20,
            head: [["Name", "Contact", "Location", "Cows", "Avg Yield", "Status"]],
            body: suppliers.map(s => [s.name, s.contact, s.location, s.cows, s.yield, s.status])
        });
        doc.save("suppliers.pdf");
    }

    function exportSuppliersExcel() {
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(suppliers);
        XLSX.utils.book_append_sheet(wb, ws, "Suppliers");
        XLSX.writeFile(wb, "suppliers.xlsx");
    }

    renderSuppliers();
</script>


<script>
    let payments = [
        { date: "2025-01-10", recipient: "Ravi Kumar", type: "Customer", amount: 1200, method: "UPI", status: "Received" },
        { date: "2025-03-18", recipient: "Meena Iyer", type: "Supplier", amount: 850, method: "Cash", status: "Pending" },
        { date: "2025-05-22", recipient: "Raj Patel", type: "Customer", amount: 650, method: "Bank Transfer", status: "Received" },
        { date: "2025-06-02", recipient: "Asha Nair", type: "Supplier", amount: 900, method: "Cheque", status: "Received" }
    ];
    let activityLog = [];
    editIndex = null;
    let trendChart, methodChart, statusChart, typeChart;

    function renderPayments() {
        const tbody = document.getElementById("paymentsTableBody");
        const feed = document.getElementById("activityFeed");
        tbody.innerHTML = "";
        feed.innerHTML = "";

        let total = 0, received = 0, pending = 0;
        payments.forEach((p, i) => {
            const amt = Number(p.amount);
            total += amt;
            if (p.status === "Received") received += amt;
            else pending += amt;

            tbody.innerHTML += `<tr><td>${p.date}</td><td>${p.recipient}</td><td>${p.type}</td><td>₹${p.amount}</td><td>${p.method}</td>
      <td><span class="status-badge ${p.status === 'Received' ? 'status-completed' : 'status-warning'}">${p.status}</span></td>
      <td><button class="btn" onclick="showReceipt(${i})">View</button></td>
      <td><button onclick="editPayment(${i})">✏️</button><button onclick="deletePayment(${i})">🗑️</button></td></tr>`;
        });

        activityLog.forEach(entry => {
            feed.innerHTML += `<li>${entry}</li>`;
        });

        document.getElementById("totalPayments").textContent = `₹${total}`;
        document.getElementById("paymentsReceived").textContent = `₹${received}`;
        document.getElementById("pendingPayments").textContent = `₹${pending}`;
        document.getElementById("averagePayment").textContent = payments.length ? `₹${(total / payments.length).toFixed(2)}` : '₹0';

        updateCharts();
    }

    function openPaymentModal() {
        editIndex = null;
        document.getElementById("paymentDate").value = "";
        document.getElementById("paymentRecipient").value = "";
        document.getElementById("paymentAmount").value = "";
        document.getElementById("paymentType").value = "Customer";
        document.getElementById("paymentMethod").value = "Cash";
        document.getElementById("paymentStatus").value = "Received";
        document.getElementById("paymentModal").style.display = "flex";
    }

    function closePaymentModal() {
        document.getElementById("paymentModal").style.display = "none";
    }

    function savePayment() {
        const date = document.getElementById("paymentDate").value;
        const recipient = document.getElementById("paymentRecipient").value.trim();
        const type = document.getElementById("paymentType").value;
        const amount = document.getElementById("paymentAmount").value;
        const method = document.getElementById("paymentMethod").value;
        const status = document.getElementById("paymentStatus").value;

        const nameRegex = /^[a-zA-Z\s]+$/;
        if (!date) return alert("Date is required.");
        if (!nameRegex.test(recipient)) return alert("Recipient name must contain only letters.");
        if (!amount || isNaN(amount) || amount <= 0) return alert("Enter valid amount.");

        const payment = { date, recipient, type, amount, method, status };
        if (editIndex !== null) {
            payments[editIndex] = payment;
            logActivity(`✏️ Updated payment for ${recipient} on ${date}`);
        } else {
            payments.push(payment);
            logActivity(`➕ Added payment for ${recipient} on ${date}`);
        }
        closePaymentModal();
        renderPayments();
    }

    function editPayment(i) {
        const p = payments[i]; editIndex = i;
        document.getElementById("paymentDate").value = p.date;
        document.getElementById("paymentRecipient").value = p.recipient;
        document.getElementById("paymentType").value = p.type;
        document.getElementById("paymentAmount").value = p.amount;
        document.getElementById("paymentMethod").value = p.method;
        document.getElementById("paymentStatus").value = p.status;
        document.getElementById("paymentModal").style.display = "flex";
    }

    function deletePayment(i) {
        const p = payments[i];
        logActivity(`🗑️ Deleted payment for ${p.recipient} dated ${p.date}`);
        payments.splice(i, 1);
        renderPayments();
    }

    function showReceipt(i) {
        const p = payments[i];
        document.getElementById("receiptContent").innerHTML = `
    <p><strong>Date:</strong> ${p.date}</p>
    <p><strong>Recipient:</strong> ${p.recipient}</p>
    <p><strong>Type:</strong> ${p.type}</p>
    <p><strong>Amount:</strong> ₹${p.amount}</p>
    <p><strong>Method:</strong> ${p.method}</p>
    <p><strong>Status:</strong> ${p.status}</p>`;
        document.getElementById("receiptModal").style.display = "flex";
    }

    function closeReceiptModal() {
        document.getElementById("receiptModal").style.display = "none";
    }

    function applyDateFilter() {
        const start = document.getElementById("filterStart").value;
        const end = document.getElementById("filterEnd").value;
        if (!start && !end) return renderPayments();
        const filtered = payments.filter(p => (!start || p.date >= start) && (!end || p.date <= end));
        renderFilteredPayments(filtered);
    }

    function renderFilteredPayments(filtered) {
        const tbody = document.getElementById("paymentsTableBody");
        tbody.innerHTML = "";
        filtered.forEach((p, i) => {
            tbody.innerHTML += `<tr><td>${p.date}</td><td>${p.recipient}</td><td>${p.type}</td><td>₹${p.amount}</td><td>${p.method}</td>
      <td><span class="status-badge ${p.status === 'Received' ? 'status-completed' : 'status-warning'}">${p.status}</span></td>
      <td><button class="btn" onclick="showReceipt(${i})">View</button></td>
      <td><button onclick="editPayment(${i})">✏️</button><button onclick="deletePayment(${i})">🗑️</button></td></tr>`;
        });
    }

    function logActivity(msg) {
        activityLog.unshift(`🧾 ${msg} - ${new Date().toLocaleString()}`);
    }

    function exportPayments(type) {
        const data = payments.map(p => ({ Date: p.date, Recipient: p.recipient, Type: p.type, Amount: p.amount, Method: p.method, Status: p.status }));
        if (type === 'pdf') {
            const doc = new jspdf.jsPDF();
            doc.autoTable({ head: [["Date", "Recipient", "Type", "Amount", "Method", "Status"]], body: data.map(Object.values) });
            doc.save("payments.pdf");
        } else {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Payments");
            XLSX.writeFile(wb, "payments.xlsx");
        }
    }

    function updateCharts() {
        const trend = new Array(12).fill(0);
        const method = { Cash: 0, UPI: 0, "Bank Transfer": 0, Cheque: 0 };
        const status = { Received: 0, Pending: 0 };
        const types = { Customer: 0, Supplier: 0 };

        payments.forEach(p => {
            const m = new Date(p.date).getMonth();
            trend[m] += Number(p.amount);
            method[p.method] += Number(p.amount);
            status[p.status] += 1;
            types[p.type] += 1;
        });

        if (trendChart) trendChart.destroy();
        trendChart = new Chart(document.getElementById("paymentTrendChart"), {
            type: 'bar',
            data: { labels: [..."Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" ")], datasets: [{ label: "Monthly", data: trend, backgroundColor: "#6366f1" }] },
            options: { responsive: true, plugins: { legend: { display: false } } }
        });

        if (methodChart) methodChart.destroy();
        methodChart = new Chart(document.getElementById("paymentMethodChart"), {
            type: 'pie',
            data: { labels: Object.keys(method), datasets: [{ data: Object.values(method), backgroundColor: ["#3b82f6", "#10b981", "#6366f1", "#f59e0b"] }] },
            options: { responsive: true }
        });

        if (statusChart) statusChart.destroy();
        statusChart = new Chart(document.getElementById("paymentStatusChart"), {
            type: 'doughnut',
            data: { labels: Object.keys(status), datasets: [{ data: Object.values(status), backgroundColor: ["#22c55e", "#ef4444"] }] },
            options: { responsive: true }
        });

        if (typeChart) typeChart.destroy();
        typeChart = new Chart(document.getElementById("paymentTypeChart"), {
            type: 'bar',
            data: { labels: Object.keys(types), datasets: [{ label: "Count", data: Object.values(types), backgroundColor: ["#8b5cf6", "#ec4899"] }] },
            options: { responsive: true, plugins: { legend: { display: false } } }
        });
    }

    renderPayments();
</script>

<script>
    let customers = [
        { name: "Ravi Kumar", email: "ravi@example.com", phone: "9876543210", region: "North", status: "Active", orders: 14, lat: 28.6139, lng: 77.2090 },
        { name: "Meena Iyer", email: "meena@example.com", phone: "9988776655", region: "South", status: "Inactive", orders: 6, lat: 12.9716, lng: 77.5946 },
        { name: "Raj Patel", email: "raj@example.com", phone: "9123456780", region: "West", status: "Active", orders: 9, lat: 19.0760, lng: 72.8777 },
        { name: "Asha Nair", email: "asha@example.com", phone: "9090909090", region: "East", status: "Active", orders: 12, lat: 22.5726, lng: 88.3639 }
    ];
    let customerChart;
    let customerMap;
    let editingCustomer = null;
    activityLog = [];

    function renderCustomers() {
        const tbody = document.getElementById("customerTableBody");
        const feed = document.getElementById("customerActivityFeed");
        tbody.innerHTML = "";
        feed.innerHTML = "";

        let total = 0, active = 0, inactive = 0, totalOrders = 0;

        customers.forEach((c, i) => {
            total++;
            if (c.status === "Active") active++;
            else inactive++;
            totalOrders += Number(c.orders);

            tbody.innerHTML += `<tr><td>${c.name}</td><td>${c.email}</td><td>${c.phone}</td><td>${c.region}</td>
      <td><span class="status-badge ${c.status === 'Active' ? 'status-completed' : 'status-warning'}">${c.status}</span></td><td>${c.orders}</td>
      <td><button onclick="editCustomer(${i})">✏️</button><button onclick="deleteCustomer(${i})">🗑️</button></td></tr>`;
        });

        activityLog.forEach(entry => feed.innerHTML += `<li>${entry}</li>`);

        document.getElementById("totalCustomers").textContent = total;
        document.getElementById("activeCustomers").textContent = active;
        document.getElementById("inactiveCustomers").textContent = inactive;
        document.getElementById("avgOrderValue").textContent = total > 0 ? `₹${(totalOrders / total).toFixed(2)}` : '₹0';

        updateCustomerChart();
        updateCustomerMap();
    }

    function updateCustomerChart() {
        const months = [..."Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" ")];
        const monthly = new Array(12).fill(0);
        const now = new Date();
        customers.forEach((_, i) => {
            const m = (now.getMonth() - i + 12) % 12;
            monthly[m] += 1;
        });
        if (customerChart) customerChart.destroy();
        customerChart = new Chart(document.getElementById("customerTrendChart"), {
            type: 'bar',
            data: {
                labels: months,
                datasets: [{
                    label: 'Monthly Customers',
                    data: monthly,
                    backgroundColor: '#4f46e5'
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, stepSize: 1 } }
            }
        });
    }

    function updateCustomerMap() {
        if (!customerMap) {
            customerMap = L.map("customerMap").setView([22.9734, 78.6569], 5);
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                attribution: '&copy; OpenStreetMap contributors',
                maxZoom: 10
            }).addTo(customerMap);
        }

        // Remove all previous markers
        customerMap.eachLayer(layer => {
            if (layer instanceof L.Marker) customerMap.removeLayer(layer);
        });

        // Add markers
        customers.forEach(c => {
            if (c.lat && c.lng) {
                const popupContent = `<strong>${c.name}</strong><br>${c.email}<br>${c.region} - ${c.status}`;
                L.marker([c.lat, c.lng]).addTo(customerMap).bindPopup(popupContent);
            }
        });
    }
    function openCustomerModal() {
        editingCustomer = null;
        document.getElementById("custName").value = "";
        document.getElementById("custEmail").value = "";
        document.getElementById("custPhone").value = "";
        document.getElementById("custRegion").value = "North";
        document.getElementById("custStatus").value = "Active";
        document.getElementById("customerModal").style.display = "flex";
    }
    function closeCustomerModal() {
        document.getElementById("customerModal").style.display = "none";
    }
    function saveCustomer() {
        const name = document.getElementById("custName").value.trim();
        const email = document.getElementById("custEmail").value.trim();
        const phone = document.getElementById("custPhone").value.trim();
        const region = document.getElementById("custRegion").value;
        const status = document.getElementById("custStatus").value;
        const nameRegex = /^[a-zA-Z\s]+$/;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const phoneRegex = /^\d{10}$/;
        if (!nameRegex.test(name)) return alert("Name must contain only alphabets.");
        if (!emailRegex.test(email)) return alert("Enter a valid email.");
        if (!phoneRegex.test(phone)) return alert("Phone must be 10 digits.");

        const newCustomer = { name, email, phone, region, status, orders: Math.floor(Math.random() * 15 + 1), lat: 20 + Math.random() * 5, lng: 77 + Math.random() * 5 };
        if (editingCustomer !== null) {
            customers[editingCustomer] = newCustomer;
            activityLog.unshift(`✏️ Edited ${name} (${region}) - ${new Date().toLocaleString()}`);
        } else {
            customers.push(newCustomer);
            activityLog.unshift(`➕ Added ${name} (${region}) - ${new Date().toLocaleString()}`);
        }
        closeCustomerModal();
        renderCustomers();
    }
    function editCustomer(i) {
        const c = customers[i]; editingCustomer = i;
        document.getElementById("custName").value = c.name;
        document.getElementById("custEmail").value = c.email;
        document.getElementById("custPhone").value = c.phone;
        document.getElementById("custRegion").value = c.region;
        document.getElementById("custStatus").value = c.status;
        document.getElementById("customerModal").style.display = "flex";
    }
    function deleteCustomer(i) {
        const c = customers[i];
        activityLog.unshift(`🗑️ Removed ${c.name} (${c.region}) - ${new Date().toLocaleString()}`);
        customers.splice(i, 1);
        renderCustomers();
    }
    function applyCustomerFilters() {
        const region = document.getElementById("filterRegion").value;
        const status = document.getElementById("filterStatus").value;
        const tbody = document.getElementById("customerTableBody");
        tbody.innerHTML = "";
        customers.filter(c => (!region || c.region === region) && (!status || c.status === status)).forEach((c, i) => {
            tbody.innerHTML += `<tr><td>${c.name}</td><td>${c.email}</td><td>${c.phone}</td><td>${c.region}</td>
      <td><span class="status-badge ${c.status === 'Active' ? 'status-completed' : 'status-warning'}">${c.status}</span></td><td>${c.orders}</td>
      <td><button onclick="editCustomer(${i})">✏️</button><button onclick="deleteCustomer(${i})">🗑️</button></td></tr>`;
        });
    }
    function exportCustomers(type) {
        const data = customers.map(c => ({ Name: c.name, Email: c.email, Phone: c.phone, Region: c.region, Status: c.status, Orders: c.orders }));
        if (type === 'pdf') {
            const doc = new jspdf.jsPDF();
            doc.autoTable({ head: [["Name", "Email", "Phone", "Region", "Status", "Orders"]], body: data.map(Object.values) });
            doc.save("customers.pdf");
        } else {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Customers");
            XLSX.writeFile(wb, "customers.xlsx");
        }
    }

    renderCustomers();
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/charts/loader.js"></script>
<script>
    let dashboardData = [];
    let editIndex = -1;
    let dashboardChart;
    let polarChart;

    // Validation functions
    function validateForm() {
        const customer = document.getElementById("inputCustomer").value.trim();
        const milk = document.getElementById("inputMilk").value;
        const revenue = document.getElementById("inputRevenue").value;
        const date = document.getElementById("inputDate").value;

        let isValid = true;
        const errors = [];

        // Reset errors
        document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.form-control').forEach(el => el.classList.remove('error'));
        document.getElementById('validationSummary').style.display = 'none';

        // Validate customer
        if (!customer) {
            document.getElementById('customerError').style.display = 'block';
            document.getElementById('inputCustomer').classList.add('error');
            isValid = false;
            errors.push("Customer name is required");
        }

        // Validate milk
        if (!milk || parseFloat(milk) < 1) {
            document.getElementById('milkError').style.display = 'block';
            document.getElementById('inputMilk').classList.add('error');
            isValid = false;
            errors.push("Milk quantity must be at least 1L");
        }

        // Validate revenue
        if (!revenue || parseFloat(revenue) <= 0) {
            document.getElementById('revenueError').style.display = 'block';
            document.getElementById('inputRevenue').classList.add('error');
            isValid = false;
            errors.push("Revenue must be a positive number");
        }

        // Validate date
        const today = new Date().toISOString().split('T')[0];
        if (!date || date > today) {
            document.getElementById('dateError').style.display = 'block';
            document.getElementById('inputDate').classList.add('error');
            isValid = false;
            errors.push("Date is required and cannot be in the future");
        }

        // Show validation summary if errors exist
        if (errors.length > 0) {
            const summary = document.getElementById('validationSummary');
            summary.innerHTML = '<strong>Please fix the following errors:</strong><ul>' +
                errors.map(e => `<li>${e}</li>`).join('') + '</ul>';
            summary.style.display = 'block';
        }

        return isValid;
    }

    // Open modal for new or existing entry
    function openDashboardModal(index = -1) {
        editIndex = index;
        const modal = document.getElementById("dashboardModal");
        modal.style.display = "flex";

        // Reset validation
        document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.form-control').forEach(el => el.classList.remove('error'));
        document.getElementById('validationSummary').style.display = 'none';

        // Set modal title
        document.getElementById('modalTitle').textContent =
            index >= 0 ? "Edit Sale" : "Add Sale";

        if (index >= 0) {
            const row = dashboardData[index];
            document.getElementById("inputCustomer").value = row.customer;
            document.getElementById("inputMilk").value = row.milk;
            document.getElementById("inputRevenue").value = row.revenue;
            document.getElementById("inputDate").value = row.date;
            document.getElementById("inputStatus").value = row.status;
        } else {
            document.querySelectorAll("#dashboardModal input, #dashboardModal select").forEach(i => i.value = "");
            // Set today as default date
            document.getElementById("inputDate").value = new Date().toISOString().split('T')[0];
        }
    }

    function closeDashboardModal() {
        document.getElementById("dashboardModal").style.display = "none";
        editIndex = -1;
    }

    function saveDashboardRecord() {
        if (!validateForm()) {
            return;
        }

        const customer = document.getElementById("inputCustomer").value.trim();
        const milk = parseFloat(document.getElementById("inputMilk").value);
        const revenue = parseFloat(document.getElementById("inputRevenue").value);
        const date = document.getElementById("inputDate").value;
        const status = document.getElementById("inputStatus").value;

        const record = { customer, milk, revenue, date, status };

        if (editIndex >= 0) {
            dashboardData[editIndex] = record;
            logDashboardActivity(`✏️ Edited record for <b>${customer}</b>`);
        } else {
            dashboardData.push(record);
            logDashboardActivity(`🆕 Added new record for <b>${customer}</b>`);
        }

        closeDashboardModal();
        renderDashboardTable();
        updateDashboardCards();
        updateDashboardChart();
        updatePolarChart();
    }

    function deleteDashboardRecord(index) {
        const customer = dashboardData[index].customer;
        if (confirm(`Delete record for ${customer}?`)) {
            dashboardData.splice(index, 1);
            logDashboardActivity(`🗑️ Deleted record of <b>${customer}</b>`);
            renderDashboardTable();
            updateDashboardCards();
            updateDashboardChart();
            updatePolarChart();
        }
    }

    function renderDashboardTable() {
        const tbody = document.getElementById("dashboardTableBody");
        const search = document.getElementById("dashboardSearch").value.toLowerCase();
        tbody.innerHTML = "";

        dashboardData.forEach((r, i) => {
            if (
                r.customer.toLowerCase().includes(search) ||
                r.status.toLowerCase().includes(search) ||
                r.date.includes(search)
            ) {
                const row = `<tr>
                        <td>${r.customer}</td>
                        <td>${r.milk.toFixed(1)}</td>
                        <td>₹${r.revenue.toFixed(2)}</td>
                        <td>${r.date}</td>
                        <td><span class="status ${r.status === "Completed" ? "status-active" : "status-inactive"}">${r.status}</span></td>
                        <td>
                            <button class="action-btn" onclick="openDashboardModal(${i})" title="Edit"><i class="fas fa-edit"></i></button>
                            <button class="action-btn" onclick="deleteDashboardRecord(${i})" title="Delete"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                tbody.innerHTML += row;
            }
        });
    }

    function updateDashboardCards() {
        const totalMilk = dashboardData.reduce((sum, r) => sum + r.milk, 0);
        const totalRevenue = dashboardData.reduce((sum, r) => sum + r.revenue, 0);
        const customerSet = new Set(dashboardData.map(r => r.customer));
        const totalCustomers = customerSet.size;

        document.getElementById("cardTotalMilk").textContent = totalMilk.toFixed(1);
        document.getElementById("cardTotalRevenue").textContent = "₹" + totalRevenue.toFixed(2);
        document.getElementById("cardTotalCustomers").textContent = totalCustomers;

        // Calculate changes
        const prevTotalMilk = parseFloat(document.getElementById("cardTotalMilk").dataset.prev) || 0;
        const prevTotalRevenue = parseFloat(document.getElementById("cardTotalRevenue").dataset.prev) || 0;
        const prevTotalCustomers = parseInt(document.getElementById("cardTotalCustomers").dataset.prev) || 0;

        // Save current values for next calculation
        document.getElementById("cardTotalMilk").dataset.prev = totalMilk;
        document.getElementById("cardTotalRevenue").dataset.prev = totalRevenue;
        document.getElementById("cardTotalCustomers").dataset.prev = totalCustomers;

        // Calculate and display changes
        const milkChange = totalMilk - prevTotalMilk;
        const revenueChange = totalRevenue - prevTotalRevenue;
        const customerChange = totalCustomers - prevTotalCustomers;

        function formatChange(value, prefix = "") {
            if (value === 0) return "No change";
            const sign = value > 0 ? "+" : "";
            return `${prefix}${sign}${value.toFixed(2)}`;
        }

        document.getElementById("cardChangeMilk").textContent = formatChange(milkChange, "L");
        document.getElementById("cardChangeMilk").className = `card-change ${milkChange >= 0 ? 'positive' : 'negative'}`;

        document.getElementById("cardChangeRevenue").textContent = formatChange(revenueChange, "₹");
        document.getElementById("cardChangeRevenue").className = `card-change ${revenueChange >= 0 ? 'positive' : 'negative'}`;

        document.getElementById("cardChangeCustomers").textContent = formatChange(customerChange);
        document.getElementById("cardChangeCustomers").className = `card-change ${customerChange >= 0 ? 'positive' : 'negative'}`;
    }

    function updateDashboardChart() {
        const container = document.getElementById('dashboardChart');
        container.innerHTML = '';

        if (dashboardData.length === 0) {
            container.innerHTML = '<div class="no-data">No data available for chart</div>';
            return;
        }

        // Aggregate data by date
        const dataByDate = {};
        dashboardData.forEach(r => {
            if (!dataByDate[r.date]) {
                dataByDate[r.date] = { milk: 0, revenue: 0 };
            }
            dataByDate[r.date].milk += r.milk;
            dataByDate[r.date].revenue += r.revenue;
        });

        const dates = Object.keys(dataByDate).sort();
        const milkData = dates.map(date => dataByDate[date].milk);
        const revenueData = dates.map(date => dataByDate[date].revenue);

        // Create chart using Chart.js since Google Charts was causing issues
        const ctx = document.createElement('canvas');
        ctx.height = 400;
        container.appendChild(ctx);

        if (dashboardChart) dashboardChart.destroy();

        dashboardChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: dates,
                datasets: [
                    {
                        label: 'Milk (L)',
                        data: milkData,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Revenue (₹)',
                        data: revenueData,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1,
                        type: 'line',
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Milk (L)'
                        }
                    },
                    y1: {
                        position: 'right',
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Revenue (₹)'
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Revenue and Milk Trends Over Time'
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                if (context.parsed.y !== null) {
                                    if (context.datasetIndex === 0) {
                                        label += context.parsed.y.toFixed(1) + 'L';
                                    } else {
                                        label += '₹' + context.parsed.y.toFixed(2);
                                    }
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    function updatePolarChart() {
        const ctx = document.getElementById('polarChart').getContext('2d');

        if (dashboardData.length === 0) {
            if (polarChart) polarChart.destroy();
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

            // Draw "No data" message
            ctx.fillStyle = '#999';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('No data available for chart', ctx.canvas.width / 2, ctx.canvas.height / 2);
            return;
        }

        // Aggregate data by customer
        const dataByCustomer = {};
        dashboardData.forEach(r => {
            if (!dataByCustomer[r.customer]) {
                dataByCustomer[r.customer] = { milk: 0, revenue: 0 };
            }
            dataByCustomer[r.customer].milk += r.milk;
            dataByCustomer[r.customer].revenue += r.revenue;
        });

        const customers = Object.keys(dataByCustomer);
        const revenueData = customers.map(customer => dataByCustomer[customer].revenue);

        // Generate colors
        const colors = generateColors(customers.length);

        if (polarChart) polarChart.destroy();

        polarChart = new Chart(ctx, {
            type: 'polarArea',
            data: {
                labels: customers,
                datasets: [{
                    data: revenueData,
                    backgroundColor: colors,
                    borderColor: '#fff',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'right' },
                    title: {
                        display: true,
                        text: 'Customer Revenue Distribution'
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return `${context.label}: ₹${context.raw.toFixed(2)}`;
                            }
                        }
                    }
                },
                scales: {
                    r: {
                        ticks: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    function generateColors(count) {
        const colors = [];
        const hueStep = 360 / count;

        for (let i = 0; i < count; i++) {
            const hue = i * hueStep;
            colors.push(`hsla(${hue}, 70%, 60%, 0.7)`);
        }

        return colors;
    }

    function logDashboardActivity(message) {
        const log = document.getElementById("dashboardActivity");
        const time = new Date().toLocaleTimeString();
        const item = document.createElement("li");
        item.innerHTML = `<span style="color:#888">${time}</span> — ${message}`;

        // Add fade-in animation
        item.style.opacity = 0;
        item.style.transition = 'opacity 0.5s';

        log.prepend(item);

        // Trigger reflow to apply animation
        setTimeout(() => {
            item.style.opacity = 1;
        }, 10);

        // Limit to 10 items
        if (log.children.length > 10) {
            log.removeChild(log.lastChild);
        }
    }

    function exportDashboardChart() {
        if (!polarChart) {
            alert("No chart data to export");
            return;
        }

        const canvas = document.getElementById("polarChart");
        const url = canvas.toDataURL("image/png");

        const a = document.createElement('a');
        a.href = url;
        a.download = 'customer-revenue-distribution.png';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    // Initialize
    window.addEventListener("DOMContentLoaded", () => {
        // Sample data
        dashboardData = [
            { customer: "Ravi Kumar", milk: 120, revenue: 4800, date: "2025-06-01", status: "Completed" },
            { customer: "Anjali Dairy", milk: 75.5, revenue: 3120, date: "2025-06-02", status: "Pending" },
            { customer: "Govind Traders", milk: 150, revenue: 6000, date: "2025-06-03", status: "Completed" },
            { customer: "Lakshmi Dairy", milk: 90.25, revenue: 3780, date: "2025-06-04", status: "Completed" },
            { customer: "Sharma Milk Center", milk: 110, revenue: 4620, date: "2025-06-05", status: "Completed" },
            { customer: "Patel Dairy Farm", milk: 85.75, revenue: 3515, date: "2025-06-06", status: "Pending" }
        ];

        renderDashboardTable();
        updateDashboardCards();
        updateDashboardChart();
        updatePolarChart();
        logDashboardActivity("📅 Dashboard initialized with sample data");

        document.getElementById("dashboardSearch").addEventListener("input", renderDashboardTable);
    });
</script>


<script src="https://www.gstatic.com/charts/loader.js"></script>


<script>
    // Namespace pattern to avoid conflicts
    const farmerMgmt = (function () {
        // Farmer data with realistic coordinates (lat, lon)
        let farmers = [
            {
                name: "Lakshmi Nair",
                region: "Kerala South",
                milk: 120,
                latitude: 9.9312,
                longitude: 76.2673,
            },
            {
                name: "Ramesh Patel",
                region: "Gujarat West",
                milk: 95,
                latitude: 22.3072,
                longitude: 73.1812,
            },
            {
                name: "Anita Singh",
                region: "Uttar Pradesh North",
                milk: 110,
                latitude: 26.8467,
                longitude: 80.9462,
            },
            {
                name: "Suresh Kumar",
                region: "Tamil Nadu South",
                milk: 130,
                latitude: 13.0827,
                longitude: 80.2707,
            },
            {
                name: "Geeta Sharma",
                region: "Rajasthan West",
                milk: 85,
                latitude: 26.9124,
                longitude: 75.7873,
            },
            {
                name: "Rajesh Verma",
                region: "Punjab North",
                milk: 105,
                latitude: 31.6340,
                longitude: 74.8723,
            },
            {
                name: "Meena Devi",
                region: "Bihar East",
                milk: 90,
                latitude: 25.0961,
                longitude: 85.3131,
            },
            {
                name: "Vikram Reddy",
                region: "Andhra Pradesh South",
                milk: 115,
                latitude: 17.3850,
                longitude: 78.4867,
            }
        ];
        let currentPage = 1;
        const rowsPerPage = 4;
        let markers = [];
        let map;
        let chartsLoaded = false;

        // DOM References
        const nameInput = document.getElementById("name");
        const regionInput = document.getElementById("region");
        const milkInput = document.getElementById("milk");
        const latitudeInput = document.getElementById("latitude");
        const longitudeInput = document.getElementById("longitude");
        const editIndexInput = document.getElementById("editIndex");
        const farmerForm = document.getElementById("farmerForm");
        const tableBody = document.getElementById("farmerTableBody");
        const searchInput = document.getElementById("searchInput");
        const regionFilter = document.getElementById("regionFilter");
        const activityLog = document.getElementById("activityLog");
        const paginationControls = document.getElementById("paginationControls");

        // Initialize Google Charts
        google.charts.load('current', { packages: ['corechart'] });
        google.charts.setOnLoadCallback(() => {
            chartsLoaded = true;
            updateCharts();
        });

        // Initialize Google Maps with fallback
        function initMap() {
            // Try to load Google Maps API
            const script = document.createElement('script');
            script.src = 'https://maps.googleapis.com/maps/api/js?callback=farmerMgmt.initGoogleMap&key=YOUR_API_KEY';
            script.async = true;
            script.defer = true;
            script.onerror = () => {
                console.error('Failed to load Google Maps API');
                showMapFallback();
            };
            document.head.appendChild(script);
        }

        // Initialize Google Maps once API is loaded
        function initGoogleMap() {
            try {
                // Default center (India)
                const center = { lat: 20.5937, lng: 78.9629 };

                // Create map
                map = new google.maps.Map(document.getElementById("map"), {
                    zoom: 5,
                    center: center,
                    mapTypeId: 'roadmap',
                    styles: [
                        {
                            featureType: "poi",
                            stylers: [{ visibility: "off" }]
                        }
                    ]
                });

                updateMapMarkers();
            } catch (error) {
                console.error('Error initializing Google Maps:', error);
                showMapFallback();
            }
        }

        // Fallback when Google Maps fails to load
        function showMapFallback() {
            document.getElementById('map-fallback').style.display = 'block';
            document.getElementById('map').style.background = '#f5f5f5';
            updateCoordinatesDisplay();
        }

        // Display coordinates as text when map fails
        function updateCoordinatesDisplay() {
            const filteredFarmers = getFilteredFarmers();
            const display = document.getElementById('coordinates-display');
            display.innerHTML = '';

            if (filteredFarmers.length === 0) {
                display.innerHTML = '<p>No farmers to display</p>';
                return;
            }

            const list = document.createElement('ul');
            list.style.listStyle = 'none';
            list.style.padding = '0';

            filteredFarmers.forEach(f => {
                const item = document.createElement('li');
                item.style.margin = '5px 0';
                item.innerHTML = `<strong>${f.name}</strong>: ${f.latitude.toFixed(6)}, ${f.longitude.toFixed(6)}`;
                list.appendChild(item);
            });

            display.appendChild(list);
        }

        // Add markers to map
        function updateMapMarkers() {
            if (!map) return;

            // Clear existing markers
            markers.forEach(marker => marker.setMap(null));
            markers = [];

            const filteredFarmers = getFilteredFarmers();

            if (filteredFarmers.length === 0) return;

            // Create bounds to fit all markers
            const bounds = new google.maps.LatLngBounds();

            filteredFarmers.forEach(f => {
                if (typeof f.latitude === 'number' && !isNaN(f.latitude) &&
                    (typeof f.longitude === 'number' && !isNaN(f.longitude))) {
                    const position = { lat: f.latitude, lng: f.longitude };
                    const marker = new google.maps.Marker({
                        position: position,
                        map: map,
                        title: f.name
                    });

                    // Add info window
                    const infoWindow = new google.maps.InfoWindow({
                        content: `<b>${f.name}</b><br>${f.region}<br>Milk: ${f.milk} L`
                    });

                    marker.addListener('click', () => {
                        infoWindow.open(map, marker);
                    });

                    markers.push(marker);
                    bounds.extend(position);
                }
            });

            // Fit map to bounds if we have markers
            if (markers.length > 0) {
                if (markers.length === 1) {
                    map.setCenter(bounds.getCenter());
                    map.setZoom(10);
                } else {
                    map.fitBounds(bounds);
                }
            }
        }

        function getFilteredFarmers() {
            const searchVal = searchInput.value.trim().toLowerCase();
            const regionVal = regionFilter.value;
            return farmers.filter((f) => {
                let matchesSearch =
                    f.name.toLowerCase().includes(searchVal) ||
                    f.region.toLowerCase().includes(searchVal);
                let matchesRegion = regionVal === "" || f.region === regionVal;
                return matchesSearch && matchesRegion;
            });
        }

        function renderFarmers() {
            const filteredFarmers = getFilteredFarmers();

            const start = (currentPage - 1) * rowsPerPage;
            const paginatedFarmers = filteredFarmers.slice(start, start + rowsPerPage);

            tableBody.innerHTML = "";
            paginatedFarmers.forEach((f, i) => {
                const globalIndex = farmers.indexOf(f);
                const tr = document.createElement("tr");
                tr.innerHTML = `
                <td>${f.name}</td>
                <td>${f.region}</td>
                <td>${f.milk.toFixed(2)}</td>
                <td>${f.latitude.toFixed(6)}</td>
                <td>${f.longitude.toFixed(6)}</td>
                <td>
                    <button class="edit" onclick="farmerMgmt.editFarmer(${globalIndex})">Edit</button>
                    <button class="delete" onclick="farmerMgmt.confirmDelete(${globalIndex})">Delete</button>
                </td>`;
                tableBody.appendChild(tr);
            });

            updatePagination(filteredFarmers.length);
            updateRegionFilter();
            updateSummary();
            updateCharts();

            // Update map or coordinates display based on what's available
            if (typeof google !== 'undefined' && google.maps) {
                updateMapMarkers();
            } else {
                updateCoordinatesDisplay();
            }
        }

        function updatePagination(totalItems) {
            paginationControls.innerHTML = "";
            const totalPages = Math.ceil(totalItems / rowsPerPage);

            if (totalPages <= 1) return;

            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement("button");
                btn.textContent = i;
                if (i === currentPage) {
                    btn.classList.add("active");
                    btn.disabled = true;
                }
                btn.onclick = () => {
                    currentPage = i;
                    renderFarmers();
                };
                paginationControls.appendChild(btn);
            }
        }

        function updateRegionFilter() {
            const regions = Array.from(new Set(farmers.map((f) => f.region))).sort();
            const current = regionFilter.value;
            regionFilter.innerHTML = `<option value="">All Regions</option>`;
            regions.forEach((r) => {
                const option = document.createElement("option");
                option.value = r;
                option.textContent = r;
                if (r === current) option.selected = true;
                regionFilter.appendChild(option);
            });
        }

        function updateSummary() {
            document.getElementById("totalFarmers").textContent = farmers.length;
            const totalMilk = farmers.reduce((acc, f) => acc + f.milk, 0);
            document.getElementById("totalMilk").textContent = totalMilk.toFixed(2);
            document.getElementById(
                "activeRegions"
            ).textContent = new Set(farmers.map((f) => f.region)).size;
        }

        function editFarmer(i) {
            const f = farmers[i];
            nameInput.value = f.name;
            regionInput.value = f.region;
            milkInput.value = f.milk;
            latitudeInput.value = f.latitude;
            longitudeInput.value = f.longitude;
            editIndexInput.value = i;
            window.scrollTo({ top: 0, behavior: "smooth" });
        }

        function resetForm() {
            editIndexInput.value = "-1";
            farmerForm.reset();
            clearAllErrors();
        }

        function confirmDelete(i) {
            showModal(`Are you sure you want to delete farmer: ${farmers[i].name}?`, () => {
                logActivity(`Deleted farmer: ${farmers[i].name}`);
                farmers.splice(i, 1);
                saveToLocalStorage();
                if ((currentPage - 1) * rowsPerPage >= farmers.length && currentPage > 1) {
                    currentPage--;
                }
                renderFarmers();
                showToast("Farmer deleted successfully.");
            });
        }

        // Modal functionality
        const modal = document.getElementById("modal");
        const modalMessage = document.getElementById("modalMessage");
        let modalCallback = null;

        function showModal(msg, callback) {
            modalMessage.textContent = msg;
            modal.style.display = "flex";
            modalCallback = callback;
        }

        function closeModal() {
            modal.style.display = "none";
            modalCallback = null;
        }

        function confirmModal() {
            if (modalCallback) modalCallback();
            closeModal();
        }

        // Toast notifications
        function showToast(msg) {
            const toastContainer = document.getElementById("toastContainer");
            if (!toastContainer) {
                const container = document.createElement("div");
                container.id = "toastContainer";
                container.style.position = "fixed";
                container.style.top = "20px";
                container.style.right = "20px";
                container.style.zIndex = "10000";
                document.body.appendChild(container);
            }

            const toast = document.createElement("div");
            toast.className = "toast";
            toast.textContent = msg;
            document.getElementById("toastContainer").appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Export CSV
        function exportToCSV() {
            const filtered = getFilteredFarmers();
            let csv = "Name,Region,Milk (L),Latitude,Longitude\n";
            filtered.forEach((f) => {
                csv += `"${f.name}","${f.region}",${f.milk.toFixed(
                    2
                )},${f.latitude},${f.longitude}\n`;
            });
            const blob = new Blob([csv], { type: "text/csv" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "farmers.csv";
            a.click();
            URL.revokeObjectURL(url);
            showToast("CSV Exported!");
        }

        // Form validation
        function validateForm() {
            let isValid = true;
            clearAllErrors();

            // Name validation
            const name = nameInput.value.trim();
            if (!name) {
                showError(nameInput, "Name is required", "name-error");
                isValid = false;
            } else if (!/^[A-Za-z\s.'-]{2,100}$/.test(name)) {
                showError(nameInput, "Invalid name format (2-100 characters)", "name-error");
                isValid = false;
            }

            // Region validation
            const region = regionInput.value.trim();
            if (!region) {
                showError(regionInput, "Region is required", "region-error");
                isValid = false;
            } else if (!/^[A-Za-z0-9\s.'-]{2,50}$/.test(region)) {
                showError(regionInput, "Invalid region format (2-50 characters)", "region-error");
                isValid = false;
            }

            // Milk validation
            const milk = parseFloat(milkInput.value);
            if (isNaN(milk)) {
                showError(milkInput, "Milk quantity is required", "milk-error");
                isValid = false;
            } else if (milk < 0) {
                showError(milkInput, "Milk quantity cannot be negative", "milk-error");
                isValid = false;
            } else if (milk > 10000) {
                showError(milkInput, "Milk quantity is too high", "milk-error");
                isValid = false;
            }

            // Latitude validation
            const latitude = parseFloat(latitudeInput.value);
            if (isNaN(latitude)) {
                showError(latitudeInput, "Latitude is required", "latitude-error");
                isValid = false;
            } else if (latitude < -90 || latitude > 90) {
                showError(latitudeInput, "Latitude must be between -90 and 90", "latitude-error");
                isValid = false;
            }

            // Longitude validation
            const longitude = parseFloat(longitudeInput.value);
            if (isNaN(longitude)) {
                showError(longitudeInput, "Longitude is required", "longitude-error");
                isValid = false;
            } else if (longitude < -180 || longitude > 180) {
                showError(longitudeInput, "Longitude must be between -180 and 180", "longitude-error");
                isValid = false;
            }

            return isValid;
        }

        function showError(input, message, errorId) {
            const errorElement = document.getElementById(errorId);
            errorElement.textContent = message;
            errorElement.style.display = "block";
            input.classList.add("input-error");
        }

        function clearError(inputId, errorId) {
            const input = document.getElementById(inputId);
            const errorElement = document.getElementById(errorId);
            errorElement.textContent = "";
            errorElement.style.display = "none";
            input.classList.remove("input-error");
        }

        function clearAllErrors() {
            document.querySelectorAll(".error-message").forEach(el => {
                el.textContent = "";
                el.style.display = "none";
            });
            document.querySelectorAll(".form-control").forEach(input => {
                input.classList.remove("input-error");
            });
        }

        // Form submission
        farmerForm.addEventListener("submit", (e) => {
            e.preventDefault();

            if (!validateForm()) return;

            const newFarmer = {
                name: nameInput.value.trim(),
                region: regionInput.value.trim(),
                milk: parseFloat(milkInput.value),
                latitude: parseFloat(latitudeInput.value),
                longitude: parseFloat(longitudeInput.value),
            };

            const editIdx = parseInt(editIndexInput.value);
            if (editIdx >= 0) {
                // Update existing
                farmers[editIdx] = newFarmer;
                logActivity(`Edited farmer: ${newFarmer.name}`);
                showToast("Farmer updated successfully.");
            } else {
                // Add new
                farmers.push(newFarmer);
                logActivity(`Added new farmer: ${newFarmer.name}`);
                showToast("Farmer added successfully.");
            }

            resetForm();
            currentPage = Math.ceil(farmers.length / rowsPerPage); // go to last page
            saveToLocalStorage();
            renderFarmers();
        });

        // Input event listeners for validation
        nameInput.addEventListener('input', () => {
            clearError('name', 'name-error');
        });
        regionInput.addEventListener('input', () => {
            clearError('region', 'region-error');
        });
        milkInput.addEventListener('input', () => {
            clearError('milk', 'milk-error');
        });
        latitudeInput.addEventListener('input', () => {
            clearError('latitude', 'latitude-error');
        });
        longitudeInput.addEventListener('input', () => {
            clearError('longitude', 'longitude-error');
        });

        // Search and filter
        searchInput.addEventListener("input", () => {
            currentPage = 1;
            renderFarmers();
        });
        regionFilter.addEventListener("change", () => {
            currentPage = 1;
            renderFarmers();
        });

        // Local Storage
        function saveToLocalStorage() {
            localStorage.setItem("farmersData", JSON.stringify(farmers));
        }

        function loadFromLocalStorage() {
            const data = localStorage.getItem("farmersData");
            if (data) {
                try {
                    farmers = JSON.parse(data);
                } catch {
                    // Invalid JSON, ignore
                }
            }
        }

        // Activity Log
        function logActivity(msg) {
            const li = document.createElement("li");
            li.textContent = `${new Date().toLocaleTimeString()} - ${msg}`;
            activityLog.prepend(li);
            if (activityLog.children.length > 50) {
                activityLog.removeChild(activityLog.lastChild);
            }
        }

        // Charts
        function updateCharts() {
            if (!chartsLoaded) return;

            const filtered = getFilteredFarmers();

            // Aggregate milk by region for pie
            const milkByRegion = {};
            filtered.forEach((f) => {
                milkByRegion[f.region] = (milkByRegion[f.region] || 0) + f.milk;
            });

            const pieLabels = Object.keys(milkByRegion);
            const pieData = Object.values(milkByRegion);

            // Sort by name for area chart
            const sorted = [...filtered].sort((a, b) =>
                a.name.localeCompare(b.name)
            );

            const areaLabels = sorted.map((f) => f.name);
            const areaData = sorted.map((f) => f.milk);

            // Draw Pie Chart
            if (typeof google !== 'undefined' && typeof google.visualization !== 'undefined') {
                const pieDataTable = new google.visualization.DataTable();
                pieDataTable.addColumn('string', 'Region');
                pieDataTable.addColumn('number', 'Milk (L)');
                pieLabels.forEach((label, i) => {
                    pieDataTable.addRow([label, pieData[i]]);
                });

                const pieOptions = {
                    title: 'Milk Distribution by Region',
                    width: '100%',
                    height: 300,
                    chartArea: { width: '90%', height: '80%' },
                    legend: { position: 'right' },
                    backgroundColor: 'transparent',
                    pieSliceText: 'value'
                };

                const pieChart = new google.visualization.PieChart(document.getElementById('pie_chart'));
                pieChart.draw(pieDataTable, pieOptions);

                // Draw Area Chart
                const areaDataTable = new google.visualization.DataTable();
                areaDataTable.addColumn('string', 'Farmer');
                areaDataTable.addColumn('number', 'Milk Production (L)');
                areaLabels.forEach((label, i) => {
                    areaDataTable.addRow([label, areaData[i]]);
                });

                const areaOptions = {
                    title: 'Milk Production Trend',
                    width: '100%',
                    height: 300,
                    chartArea: { width: '85%', height: '70%' },
                    legend: { position: 'none' },
                    backgroundColor: 'transparent',
                    colors: ['#007bff'],
                    areaOpacity: 0.3,
                    hAxis: { title: 'Farmer' },
                    vAxis: { title: 'Milk (L)' }
                };

                const areaChart = new google.visualization.AreaChart(document.getElementById('area_chart'));
                areaChart.draw(areaDataTable, areaOptions);
            }
        }

        // Initialization
        function init() {
            loadFromLocalStorage();
            initMap();
            renderFarmers();

            // Add event listeners
            document.querySelectorAll('.form-control').forEach(input => {
                input.addEventListener('blur', () => validateForm());
            });
        }

        // Initialize Google Maps with fallback
        function initMap() {
            try {
                // Create map if container exists
                const mapEl = document.getElementById("map");
                if (!mapEl) return;

                // Default center (India)
                const center = { lat: 20.5937, lng: 78.9629 };

                // Create map
                map = new google.maps.Map(mapEl, {
                    zoom: 5,
                    center: center,
                    mapTypeId: 'roadmap'
                });

                updateMapMarkers();
            } catch (error) {
                console.error('Error initializing Google Maps:', error);
                showMapFallback();
            }
        }

        // Initialize only when section is active
        function checkAndInitMap() {
            const section = document.getElementById("farmer-mgmt");
            if (section.classList.contains('active')) {
                initMap();
            }
        }

        // Initialize Google Maps once API is loaded
        function initGoogleMap() {
            try {
                checkAndInitMap();
            } catch (error) {
                console.error('Error in initGoogleMap:', error);
                showMapFallback();
            }
        }

        // Initialize charts immediately
        function initCharts() {
            chartsLoaded = true;
            updateCharts();
        }

        // Initialization
        function init() {
            loadFromLocalStorage();
            renderFarmers();
            initCharts();  // Initialize charts immediately

            // Load Google Maps API
            const script = document.createElement('script');
            script.src = 'https://maps.googleapis.com/maps/api/js?callback=farmerMgmt.initGoogleMap';
            script.async = true;
            script.defer = true;
            script.onerror = showMapFallback;
            document.head.appendChild(script);

            // Re-check map when section becomes active
            const observer = new MutationObserver(checkAndInitMap);
            observer.observe(document.getElementById("farmer-mgmt"), {
                attributes: true,
                attributeFilter: ['class']
            });
        }

        return {
            init,
            resetForm,
            editFarmer,
            confirmDelete,
            exportToCSV,
            closeModal,
            confirmModal,
            initGoogleMap
        };
    })();

    // Initialize on window load
    window.onload = farmerMgmt.init;
    google.charts.load('current', { packages: ['corechart'] });
    google.charts.setOnLoadCallback(farmerMgmt.initCharts);
</script>
<!-- JS comes next -->
<script>
    // Load Google Charts
    google.charts.load('current', { 'packages': ['corechart', 'bar'] });

    // Sample predefined entries
    let dairy_entries = [
        { id: 1, farmer: 'Anita Singh', date: '2025-06-07T08:00', qty: 20, fat: 4.2, snf: 8.5, rate: 30, amount: 600 },
        { id: 2, farmer: 'Suresh Kumar', date: '2025-06-08T09:15', qty: 15, fat: 3.8, snf: 8.2, rate: 28, amount: 420 },
        { id: 3, farmer: 'Geeta Sharma', date: '2025-06-09T07:30', qty: 25, fat: 4.5, snf: 8.7, rate: 32, amount: 800 },
        { id: 4, farmer: 'Vikram Reddy', date: '2025-06-10T10:00', qty: 18, fat: 4.0, snf: 8.4, rate: 29, amount: 522 },
        { id: 5, farmer: 'Robin Hood', date: '2025-06-11T06:45', qty: 22, fat: 4.3, snf: 8.6, rate: 31, amount: 682 },
    ];

    let dairy_nextId = 6;

    // DOM elements
    const dairy_form = document.getElementById('dairy_entryForm');
    const dairy_tableBody = document.querySelector('#dairy_dataTable tbody');
    const dairy_recentActivity = document.getElementById('dairy_recentActivity');
    const dairy_modal = document.getElementById('dairy_modal');
    const dairy_modalForm = document.getElementById('dairy_modalForm');

    // Form inputs
    const dairy_farmerInput = document.getElementById('dairy_farmer');
    const dairy_qtyInput = document.getElementById('dairy_qty');
    const dairy_fatInput = document.getElementById('dairy_fat');
    const dairy_snfInput = document.getElementById('dairy_snf');
    const dairy_rateInput = document.getElementById('dairy_rate');
    const dairy_datetimeInput = document.getElementById('dairy_datetime');

    // Modal inputs
    const dairy_editIdInput = document.getElementById('dairy_editId');
    const dairy_editFarmerInput = document.getElementById('dairy_editFarmer');
    const dairy_editQtyInput = document.getElementById('dairy_editQty');
    const dairy_editFatInput = document.getElementById('dairy_editFat');
    const dairy_editSNFInput = document.getElementById('dairy_editSNF');
    const dairy_editRateInput = document.getElementById('dairy_editRate');
    const dairy_editDateInput = document.getElementById('dairy_editDate');

    function dairy_renderTable(data) {
        dairy_tableBody.innerHTML = '';
        data.forEach(entry => {
            const tr = document.createElement('tr');
            tr.style.borderBottom = '1px solid #ddd';

            tr.innerHTML = `
                    <td style="padding: 8px;">${entry.id}</td>
                    <td style="padding: 8px;">${entry.farmer}</td>
                    <td style="padding: 8px;">${new Date(entry.date).toLocaleString()}</td>
                    <td style="padding: 8px; text-align: right;">${entry.qty.toFixed(2)}</td>
                    <td style="padding: 8px; text-align: right;">${entry.fat.toFixed(2)}</td>
                    <td style="padding: 8px; text-align: right;">${entry.snf.toFixed(2)}</td>
                    <td style="padding: 8px; text-align: right;">₹${entry.rate.toFixed(2)}</td>
                    <td style="padding: 8px; text-align: right;">₹${entry.amount.toFixed(2)}</td>
                    <td style="padding: 8px; text-align:center;">
                        <button class="action-btn dairy_viewBtn" data-id="${entry.id}"><i class="fas fa-eye"></i></button>
                        <button class="action-btn dairy_editBtn" data-id="${entry.id}"><i class="fas fa-edit"></i></button>
                        <button class="action-btn dairy_deleteBtn" data-id="${entry.id}"><i class="fas fa-trash"></i></button>
                    </td>
                `;
            dairy_tableBody.appendChild(tr);
        });

        // Add event listeners to action buttons
        document.querySelectorAll('.dairy_viewBtn').forEach(btn => {
            btn.addEventListener('click', () => {
                const id = parseInt(btn.getAttribute('data-id'));
                dairy_openModalView(id);
            });
        });

        document.querySelectorAll('.dairy_editBtn').forEach(btn => {
            btn.addEventListener('click', () => {
                const id = parseInt(btn.getAttribute('data-id'));
                dairy_openModalEdit(id);
            });
        });

        document.querySelectorAll('.dairy_deleteBtn').forEach(btn => {
            btn.addEventListener('click', () => {
                const id = parseInt(btn.getAttribute('data-id'));
                dairy_deleteEntry(id);
            });
        });
    }

    function dairy_updateDashboard(data) {
        // Calculate aggregates
        const totalQty = data.reduce((sum, e) => sum + e.qty, 0);
        const totalFat = data.reduce((sum, e) => sum + e.fat, 0) / (data.length || 1);
        const totalSNF = data.reduce((sum, e) => sum + e.snf, 0) / (data.length || 1);
        const uniqueFarmers = new Set(data.map(e => e.farmer)).size;

        // Update cards values
        document.getElementById('dairy_totalLitresVal').textContent = `${totalQty.toFixed(2)} L`;
        document.getElementById('dairy_totalFarmersVal').textContent = uniqueFarmers;
        document.getElementById('dairy_avgFatVal').textContent = `${totalFat.toFixed(2)} %`;
        document.getElementById('dairy_avgSNFVal').textContent = `${totalSNF.toFixed(2)} %`;

        // Draw mini pie charts
        dairy_drawMiniPieChart('dairy_totalLitresChart', totalQty);
        dairy_drawMiniPieChart('dairy_totalFarmersChart', uniqueFarmers);
        dairy_drawMiniPieChart('dairy_avgFatChart', totalFat);
        dairy_drawMiniPieChart('dairy_avgSNFChart', totalSNF);

        // Draw daily total milk chart
        dairy_drawDailyMilkChart(data);

        // Draw Farmer Fat & SNF Bar Chart
        dairy_drawFatSNFChart(data);
    }

    function dairy_drawMiniPieChart(containerId, value) {
        const data = google.visualization.arrayToDataTable([
            ['Label', 'Value'],
            ['', value]
        ]);
        const options = {
            legend: 'none',
            pieSliceText: 'none',
            pieStartAngle: 0,
            width: 120,
            height: 100,
            colors: ['#4caf50'],
            chartArea: { width: '100%', height: '100%' }
        };
        const chart = new google.visualization.PieChart(document.getElementById(containerId));
        chart.draw(data, options);
    }

    function dairy_drawDailyMilkChart(data) {
        const dailyTotals = {};
        data.forEach(e => {
            const day = new Date(e.date).toLocaleDateString();
            dailyTotals[day] = (dailyTotals[day] || 0) + e.qty;
        });
        const chartData = [['Date', 'Total Milk (L)']];
        Object.entries(dailyTotals).forEach(([day, total]) => {
            chartData.push([day, total]);
        });

        // Remove old chart container if exists
        let oldChart = document.getElementById('dairy_dailyMilkChart');
        if (oldChart) oldChart.remove();

        const container = document.getElementById('dairy_dailyMilkChartContainer');
        container.innerHTML = '';
        const chartDiv = document.createElement('div');
        chartDiv.id = 'dairy_dailyMilkChart';
        chartDiv.style.height = '300px';
        container.appendChild(chartDiv);


        const chart = google.visualization.arrayToDataTable(chartData);
        const options = {
            title: 'Daily Total Milk Collected (Litres)',
            hAxis: { title: 'Date' },
            vAxis: { title: 'Litres' },
            legend: 'none',
            colors: ['#3f51b5'],
            height: 300
        };
        const colChart = new google.visualization.ColumnChart(container);
        colChart.draw(chart, options);
    }

    function dairy_drawFatSNFChart(data) {
        const chartDataArray = [['Farmer', 'Fat %', 'SNF %']];
        data.forEach(e => {
            chartDataArray.push([e.farmer, e.fat, e.snf]);
        });

        // Remove old chart container if exists
        let oldChart = document.getElementById('dairy_fatSNFChart');
        if (oldChart) oldChart.remove();

        const container = document.getElementById('dairy_fatSNFChartContainer');
        container.innerHTML = '';

        const chartDiv = document.createElement('div');
        chartDiv.id = 'dairy_fatSNFChart';
        chartDiv.style.width = '100%';
        chartDiv.style.height = '300px';
        container.appendChild(chartDiv);


        const chartData = google.visualization.arrayToDataTable(chartDataArray);
        const options = {
            title: 'Farmer-wise Fat & SNF %',
            chartArea: { width: '60%' },
            hAxis: {
                title: 'Percentage (%)',
                minValue: 0
            },
            vAxis: {
                title: 'Farmer'
            },
            bars: 'horizontal',
            colors: ['#e91e63', '#00bcd4'],
            height: 300
        };
        const barChart = new google.visualization.BarChart(container);
        barChart.draw(chartData, options);
    }

    // Add Entry Form Submission
    dairy_form.addEventListener('submit', e => {
        e.preventDefault();
        if (!dairy_form.checkValidity()) {
            alert('Please fill all required fields correctly.');
            return;
        }
        const newEntry = {
            id: dairy_nextId++,
            farmer: dairy_farmerInput.value.trim(),
            date: dairy_datetimeInput.value,
            qty: parseFloat(dairy_qtyInput.value),
            fat: parseFloat(dairy_fatInput.value),
            snf: parseFloat(dairy_snfInput.value),
            rate: parseFloat(dairy_rateInput.value),
        };
        newEntry.amount = newEntry.qty * newEntry.rate;
        dairy_entries.push(newEntry);
        dairy_renderTable(dairy_entries);
        dairy_updateDashboard(dairy_entries);
        dairy_addRecentActivity(`Added entry for ${newEntry.farmer}`);
        dairy_form.reset();
    });

    // Recent activity helper
    function dairy_addRecentActivity(message) {
        const li = document.createElement('li');
        const timestamp = new Date().toLocaleString();
        li.textContent = `[${timestamp}] ${message}`;
        dairy_recentActivity.prepend(li);
    }

    // Delete Entry
    function dairy_deleteEntry(id) {
        if (!confirm('Are you sure you want to delete this entry?')) return;
        dairy_entries = dairy_entries.filter(e => e.id !== id);
        dairy_renderTable(dairy_entries);
        dairy_updateDashboard(dairy_entries);
        dairy_addRecentActivity(`Deleted entry with ID ${id}`);
    }

    // Modal Functions
    function dairy_openModalView(id) {
        const entry = dairy_entries.find(e => e.id === id);
        if (!entry) return;
        document.getElementById('dairy_modalTitle').textContent = 'View Entry';
        dairy_modalForm.style.display = 'none';
        dairy_showModal();
        // Display data in readonly format
        if (!document.getElementById('dairy_viewDetails')) {
            const viewDiv = document.createElement('div');
            viewDiv.id = 'dairy_viewDetails';
            viewDiv.style.padding = '10px';
            viewDiv.style.lineHeight = '1.6';
            dairy_modal.querySelector('div').appendChild(viewDiv);
        }
        const viewDetails = document.getElementById('dairy_viewDetails');
        viewDetails.innerHTML = `
                <b>Farmer:</b> ${entry.farmer}<br/>
                <b>Date:</b> ${new Date(entry.date).toLocaleString()}<br/>
                <b>Quantity:</b> ${entry.qty.toFixed(2)} L<br/>
                <b>Fat %:</b> ${entry.fat.toFixed(2)} %<br/>
                <b>SNF %:</b> ${entry.snf.toFixed(2)} %<br/>
                <b>Rate:</b> ₹${entry.rate.toFixed(2)}<br/>
                <b>Amount:</b> ₹${entry.amount.toFixed(2)}
            `;
    }

    function dairy_openModalEdit(id) {
        const entry = dairy_entries.find(e => e.id === id);
        if (!entry) return;
        document.getElementById('dairy_modalTitle').textContent = 'Edit Entry';
        dairy_modalForm.style.display = 'block';
        const viewDetails = document.getElementById('dairy_viewDetails');
        if (viewDetails) viewDetails.innerHTML = '';
        dairy_showModal();
        dairy_editIdInput.value = entry.id;
        dairy_editFarmerInput.value = entry.farmer;
        dairy_editQtyInput.value = entry.qty;
        dairy_editFatInput.value = entry.fat;
        dairy_editSNFInput.value = entry.snf;
        dairy_editRateInput.value = entry.rate;
        // Format date for datetime-local input
        dairy_editDateInput.value = entry.date;
    }

    dairy_modalForm.addEventListener('submit', e => {
        e.preventDefault();
        // Validate
        if (!dairy_modalForm.checkValidity()) {
            alert('Please fill all fields correctly.');
            return;
        }
        const id = parseInt(dairy_editIdInput.value);
        const index = dairy_entries.findIndex(e => e.id === id);
        if (index === -1) return;

        const updatedEntry = {
            id: id,
            farmer: dairy_editFarmerInput.value.trim(),
            qty: parseFloat(dairy_editQtyInput.value),
            fat: parseFloat(dairy_editFatInput.value),
            snf: parseFloat(dairy_editSNFInput.value),
            rate: parseFloat(dairy_editRateInput.value),
            date: dairy_editDateInput.value
        };
        updatedEntry.amount = updatedEntry.qty * updatedEntry.rate;

        dairy_entries[index] = updatedEntry;

        dairy_renderTable(dairy_entries);
        dairy_updateDashboard(dairy_entries);
        dairy_addRecentActivity(`Updated entry for ${updatedEntry.farmer}`);
        dairy_closeModal();
    });

    function dairy_showModal() {
        dairy_modal.style.display = 'flex';
    }

    function dairy_closeModal() {
        dairy_modal.style.display = 'none';
        dairy_modalForm.reset();
    }

    // Close modal on background click
    dairy_modal.addEventListener('click', e => {
        if (e.target === dairy_modal) dairy_closeModal();
    });

    // Export to Excel
    function dairy_downloadExcel() {
        const wb = XLSX.utils.book_new();
        const wsData = [
            ['ID', 'Farmer', 'Date', 'Qty (L)', 'Fat %', 'SNF %', 'Rate ₹/L', 'Amount ₹']
        ];
        dairy_entries.forEach(e => {
            wsData.push([
                e.id, e.farmer, new Date(e.date).toLocaleString(), e.qty, e.fat, e.snf, e.rate, e.amount
            ]);
        });
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        XLSX.utils.book_append_sheet(wb, ws, 'MilkCollection');
        XLSX.writeFile(wb, 'MilkCollectionData.xlsx');
    }

    // Export to PDF
    function dairy_downloadPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFontSize(16);
        doc.text("Milk Collection Records", 14, 20);
        doc.setFontSize(10);

        const rows = dairy_entries.map(e => [
            e.id,
            e.farmer,
            new Date(e.date).toLocaleString(),
            e.qty.toFixed(2),
            e.fat.toFixed(2),
            e.snf.toFixed(2),
            `₹${e.rate.toFixed(2)}`,
            `₹${e.amount.toFixed(2)}`
        ]);

        doc.autoTable({
            head: [['ID', 'Farmer', 'Date', 'Qty', 'Fat', 'SNF', 'Rate', 'Amount']],
            body: rows,
            startY: 25,
            theme: 'striped',
            styles: { fontSize: 8 },
        });

        doc.save('MilkCollectionData.pdf');
    }

    // Wait for Google Charts to be loaded before initial render
    google.charts.setOnLoadCallback(() => {
        dairy_renderTable(dairy_entries);
        dairy_updateDashboard(dairy_entries);
        dairy_addRecentActivity('Dashboard initialized with sample data');
    });

    // Add event listeners for export buttons
    document.getElementById('dairy_excelBtn').addEventListener('click', dairy_downloadExcel);
    document.getElementById('dairy_pdfBtn').addEventListener('click', dairy_downloadPDF);
    document.getElementById('dairy_closeModalBtn').addEventListener('click', dairy_closeModal);

    // Initialize charts with proper sizing
    function initMilkCharts() {
        dairy_updateDashboard(dairy_entries);
    }

    // Redraw charts when section becomes active
    function handleMilkSectionActive() {
        const section = document.getElementById('milk-collection');
        if (section.classList.contains('active')) {
            setTimeout(() => {
                dairy_updateDashboard(dairy_entries);
            }, 100);
        }
    }

    // Initialization
    google.charts.load('current', { packages: ['corechart', 'bar'] });
    google.charts.setOnLoadCallback(initMilkCharts);

    // Set up section observer
    const milkObserver = new MutationObserver(handleMilkSectionActive);
    milkObserver.observe(document.getElementById('milk-collection'), {
        attributes: true,
        attributeFilter: ['class']
    });
</script>

<!-- Load jsPDF AutoTable plugin -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<!-- Google Charts Loader -->
<script src="https://www.gstatic.com/charts/loader.js"></script>
<script>
    // Initialize Google Charts
    google.charts.load('current', { packages: ['corechart', 'line'] });
    google.charts.setOnLoadCallback(init);

    // Sample data for chilling centers
    let chillingCentersData = [
        { id: 'CC-1001', name: 'Mumbai Central', location: 'Mumbai', totalCapacity: 15000, currentCapacity: 12000, temperature: 3.5, status: 'Active', energyType: 'Solar', lastUpdated: '2023-06-15T08:30:00' },
        { id: 'CC-1002', name: 'Delhi North', location: 'Delhi', totalCapacity: 25000, currentCapacity: 18000, temperature: 4.2, status: 'Active', energyType: 'Grid Power', lastUpdated: '2023-06-15T09:15:00' },
        { id: 'CC-1003', name: 'Chennai South', location: 'Chennai', totalCapacity: 18000, currentCapacity: 15000, temperature: 2.8, status: 'Maintenance', energyType: 'Generator', lastUpdated: '2023-06-14T14:20:00' },
        { id: 'CC-1004', name: 'Kolkata East', location: 'Kolkata', totalCapacity: 22000, currentCapacity: 19500, temperature: 3.9, status: 'Active', energyType: 'Solar', lastUpdated: '2023-06-15T10:45:00' },
        { id: 'CC-1005', name: 'Bangalore Tech', location: 'Bangalore', totalCapacity: 30000, currentCapacity: 28000, temperature: 4.5, status: 'Active', energyType: 'Battery', lastUpdated: '2023-06-15T11:30:00' }
    ];

    // Recent activity log
    let activities = [
        { id: 'A-1001', type: 'add', message: 'Added new center: Bangalore Tech', timestamp: '2023-06-15T11:30:00' },
        { id: 'A-1002', type: 'update', message: 'Updated center: Kolkata East', timestamp: '2023-06-15T10:45:00' },
        { id: 'A-1003', type: 'add', message: 'Added new center: Chennai South', timestamp: '2023-06-14T14:20:00' }
    ];

    // Initialize app
    function init() {
        renderTable();
        updateSummary();
        drawAllCharts();
        renderActivity();
        setupEventListeners();
    }

    // Set up event listeners
    function setupEventListeners() {
        document.getElementById('entryForm').addEventListener('submit', handleFormSubmit);
        document.getElementById('addCenterBtn').addEventListener('click', () => showForm());
        document.getElementById('cancelBtn').addEventListener('click', closeForm);
        document.getElementById('searchInput').addEventListener('input', filterTable);

        // Add input validation listeners
        document.getElementById('totalCapacity').addEventListener('input', validateCapacity);
        document.getElementById('currentCapacity').addEventListener('input', validateCapacity);
    }

    // Show the form (add/edit)
    function showForm(id = null) {
        document.getElementById('formContainer').style.display = 'block';
        const formTitle = document.getElementById('formTitle');
        const submitBtn = document.getElementById('submitBtn');
        const form = document.getElementById('entryForm');

        resetFormErrors();

        if (id) {
            const center = chillingCentersData.find(c => c.id === id);
            if (!center) return alert('Center not found');

            formTitle.innerHTML = '<i class="fas fa-edit"></i> Edit Chilling Center';
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Update Center';
            document.getElementById('editId').value = center.id;
            document.getElementById('centerName').value = center.name;
            document.getElementById('location').value = center.location;
            document.getElementById('totalCapacity').value = center.totalCapacity;
            document.getElementById('currentCapacity').value = center.currentCapacity;
            document.getElementById('temperature').value = center.temperature;
            document.getElementById('status').value = center.status;
            document.getElementById('energyType').value = center.energyType;
        } else {
            formTitle.innerHTML = '<i class="fas fa-plus-circle"></i> Add New Chilling Center';
            submitBtn.innerHTML = '<i class="fas fa-plus"></i> Add Center';
            form.reset();
            document.getElementById('editId').value = '';
            // Set default values
            document.getElementById('totalCapacity').value = 1000;
            document.getElementById('currentCapacity').value = 0;
            document.getElementById('temperature').value = 4.0;
            document.getElementById('status').value = 'Active';
            document.getElementById('energyType').value = 'Solar';
        }

        // Scroll to form
        document.getElementById('formContainer').scrollIntoView({ behavior: 'smooth' });
    }

    // Close the form and reset
    function closeForm() {
        document.getElementById('formContainer').style.display = 'none';
        document.getElementById('entryForm').reset();
        resetFormErrors();
    }

    // Reset form error messages
    function resetFormErrors() {
        document.querySelectorAll('.error-message').forEach(el => {
            el.style.display = 'none';
        });
    }

    // Validate capacity inputs
    function validateCapacity() {
        const totalCapacity = parseInt(document.getElementById('totalCapacity').value, 10);
        const currentCapacity = parseInt(document.getElementById('currentCapacity').value, 10);
        const error = document.getElementById('currentCapacityError');

        if (isNaN(currentCapacity)) {
            error.textContent = 'Please enter a valid number';
            error.style.display = 'block';
            return false;
        }

        if (currentCapacity > totalCapacity) {
            error.textContent = 'Current capacity cannot exceed total capacity';
            error.style.display = 'block';
            return false;
        }

        error.style.display = 'none';
        return true;
    }

    // Validate form inputs
    function validateForm() {
        let isValid = true;
        resetFormErrors();

        const name = document.getElementById('centerName').value.trim();
        const location = document.getElementById('location').value.trim();
        const totalCapacity = parseInt(document.getElementById('totalCapacity').value, 10);
        const currentCapacity = parseInt(document.getElementById('currentCapacity').value, 10);
        const temperature = parseFloat(document.getElementById('temperature').value);
        const status = document.getElementById('status').value;
        const energyType = document.getElementById('energyType').value;

        if (!name || name.length < 2) {
            document.getElementById('nameError').style.display = 'block';
            isValid = false;
        }

        if (!location || location.length < 2) {
            document.getElementById('locationError').style.display = 'block';
            isValid = false;
        }

        if (isNaN(totalCapacity) || totalCapacity < 1000) {
            document.getElementById('totalCapacityError').style.display = 'block';
            isValid = false;
        }

        if (isNaN(currentCapacity) || currentCapacity < 0 || currentCapacity > totalCapacity) {
            document.getElementById('currentCapacityError').style.display = 'block';
            isValid = false;
        }

        if (isNaN(temperature) || temperature < 0 || temperature > 10) {
            document.getElementById('temperatureError').style.display = 'block';
            isValid = false;
        }

        if (!status) {
            document.getElementById('statusError').style.display = 'block';
            isValid = false;
        }

        if (!energyType) {
            document.getElementById('energyTypeError').style.display = 'block';
            isValid = false;
        }

        return isValid;
    }

    // Handle add/edit form submit
    function handleFormSubmit(e) {
        e.preventDefault();

        if (!validateForm()) return;

        const id = document.getElementById('editId').value || 'CC-' + (1000 + Math.floor(Math.random() * 9000));
        const name = document.getElementById('centerName').value.trim();
        const location = document.getElementById('location').value.trim();
        const totalCapacity = parseInt(document.getElementById('totalCapacity').value, 10);
        const currentCapacity = parseInt(document.getElementById('currentCapacity').value, 10);
        const temperature = parseFloat(document.getElementById('temperature').value);
        const status = document.getElementById('status').value;
        const energyType = document.getElementById('energyType').value;

        const existingIndex = chillingCentersData.findIndex(c => c.id === id);
        const actionType = existingIndex >= 0 ? 'update' : 'add';

        if (existingIndex >= 0) {
            // Update existing center
            chillingCentersData[existingIndex] = {
                ...chillingCentersData[existingIndex],
                name,
                location,
                totalCapacity,
                currentCapacity,
                temperature,
                status,
                energyType,
                lastUpdated: new Date().toISOString()
            };
            logActivity('update', `Updated center: ${name}`);
        } else {
            // Add new center
            chillingCentersData.push({
                id,
                name,
                location,
                totalCapacity,
                currentCapacity,
                temperature,
                status,
                energyType,
                lastUpdated: new Date().toISOString()
            });
            logActivity('add', `Added new center: ${name}`);
        }

        closeForm();
        renderTable();
        updateSummary();
        drawAllCharts();
    }

    // Render table rows with progress bars
    function renderTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        chillingCentersData.sort((a, b) => b.lastUpdated.localeCompare(a.lastUpdated));

        chillingCentersData.forEach(center => {
            const tr = document.createElement('tr');

            // Calculate percentage for progress bar
            const percentage = Math.min(100, Math.round((center.currentCapacity / center.totalCapacity) * 100));

            // Format capacity with commas
            const formattedTotalCapacity = center.totalCapacity.toLocaleString();
            const formattedCurrentCapacity = center.currentCapacity.toLocaleString();

            tr.innerHTML = `
                <td>${center.id}</td>
                <td>${center.name}</td>
                <td>${center.location}</td>
                <td>
                    <div class="progress-label">${formattedCurrentCapacity} / ${formattedTotalCapacity} L</div>
                    <div class="capacity-progress">
                        <div class="capacity-progress-bar" style="width: ${percentage}%"></div>
                    </div>
                </td>
                <td>${center.temperature.toFixed(1)}°C</td>
                <td><span class="status-badge status-${center.status.toLowerCase()}">${center.status}</span></td>
                <td>${center.energyType}</td>
                <td>
                    <button class="action-btn" onclick="showForm('${center.id}')"><i class="fas fa-edit"></i></button>
                    <button class="action-btn delete" onclick="deleteCenter('${center.id}')"><i class="fas fa-trash"></i></button>
                </td>
            `;

            tbody.appendChild(tr);
        });
    }

    // Delete center
    function deleteCenter(id) {
        if (confirm('Are you sure you want to delete this chilling center?')) {
            const center = chillingCentersData.find(c => c.id === id);
            if (center) {
                logActivity('delete', `Deleted center: ${center.name}`);
            }

            chillingCentersData = chillingCentersData.filter(c => c.id !== id);
            renderTable();
            updateSummary();
            drawAllCharts();
        }
    }

    // Update summary cards
    function updateSummary() {
        const totalCenters = chillingCentersData.length;
        const avgTemp = totalCenters
            ? (chillingCentersData.reduce((acc, c) => acc + c.temperature, 0) / totalCenters).toFixed(1)
            : 0;
        const totalCapacity = chillingCentersData.reduce((acc, c) => acc + c.totalCapacity, 0);
        const currentCapacity = chillingCentersData.reduce((acc, c) => acc + c.currentCapacity, 0);

        // Calculate energy mix
        const energyCounts = chillingCentersData.reduce((acc, c) => {
            acc[c.energyType] = (acc[c.energyType] || 0) + 1;
            return acc;
        }, {});

        let energyMix = "N/A";
        if (totalCenters > 0) {
            const solarPercentage = Math.round((energyCounts['Solar'] || 0) / totalCenters * 100);
            energyMix = `${solarPercentage}% Solar`;
        }

        document.getElementById('summary_totalCenters').textContent = totalCenters;
        document.getElementById('summary_avgTemp').textContent = `${avgTemp}°C`;
        document.getElementById('summary_totalCapacity').textContent = totalCapacity.toLocaleString() + ' L';
        document.getElementById('summary_currentCapacity').textContent = currentCapacity.toLocaleString() + ' L';
        document.getElementById('summary_energyMix').textContent = energyMix;
    }

    // Filter table rows by search input
    function filterTable() {
        const filter = document.getElementById('searchInput').value.toLowerCase();
        const rows = document.getElementById('tableBody').rows;

        for (let row of rows) {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(filter) ? '' : 'none';
        }
    }

    // Draw all charts
    function drawAllCharts() {
        drawTemperatureChart();
        drawCapacityChart();
        drawEnergyChart();
        drawTemperaturePerformanceChart();
    }

    // Draw Temperature Chart
    function drawTemperatureChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Center');
        data.addColumn('number', 'Temperature (°C)');

        chillingCentersData.forEach(c => {
            data.addRow([c.name, c.temperature]);
        });

        const options = {
            title: 'Current Temperatures',
            height: 350,
            colors: ['#4285F4'],
            hAxis: { title: 'Chilling Centers' },
            vAxis: {
                title: 'Temperature (°C)',
                minValue: 0,
                maxValue: 10
            },
            legend: { position: 'none' },
            chartArea: { width: '85%', height: '75%' }
        };

        const chart = new google.visualization.ColumnChart(document.getElementById('temperatureChart'));
        chart.draw(data, options);
    }

    // Draw Capacity Chart
    function drawCapacityChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Center');
        data.addColumn('number', 'Total Capacity (L)');
        data.addColumn('number', 'Current Capacity (L)');

        chillingCentersData.forEach(c => {
            data.addRow([c.name, c.currentCapacity, c.totalCapacity]);
        });

        const options = {
            title: 'Capacity Utilization',
            height: 350,
            colors: ['#34A853', '#EA4335'],
            hAxis: { title: 'Chilling Centers' },
            vAxis: { title: 'Capacity (L)' },
            isStacked: false,
            chartArea: { width: '85%', height: '75%' }
        };

        const chart = new google.visualization.ColumnChart(document.getElementById('capacityChart'));
        chart.draw(data, options);
    }

    // Draw Energy Chart
    function drawEnergyChart() {
        const energyCounts = chillingCentersData.reduce((acc, c) => {
            acc[c.energyType] = (acc[c.energyType] || 0) + 1;
            return acc;
        }, {});

        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Energy Source');
        data.addColumn('number', 'Count');

        for (const [energyType, count] of Object.entries(energyCounts)) {
            data.addRow([energyType, count]);
        }

        const options = {
            title: 'Energy Source Distribution',
            height: 350,
            pieHole: 0.4,
            colors: ['#4285F4', '#34A853', '#FBBC05', '#EA4335'],
            chartArea: { width: '90%', height: '90%' }
        };

        const chart = new google.visualization.PieChart(document.getElementById('energyChart'));
        chart.draw(data, options);
    }

    // Draw Temperature Performance Chart
    function drawTemperaturePerformanceChart() {
        // Generate mock temperature data for a day
        const times = ['6am', '8am', '10am', '12pm', '2pm', '4pm', '6pm'];
        const avgTemps = [4.2, 3.8, 3.5, 4.0, 4.5, 4.2, 3.9];

        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Time');
        data.addColumn('number', 'Temperature (°C)');

        times.forEach((time, i) => {
            data.addRow([time, avgTemps[i]]);
        });

        const options = {
            title: 'Temperature Performance (24h)',
            height: 350,
            colors: ['#EA4335'],
            hAxis: { title: 'Time' },
            vAxis: {
                title: 'Temperature (°C)',
                minValue: 0,
                maxValue: 5
            },
            curveType: 'function',
            legend: { position: 'none' },
            chartArea: { width: '85%', height: '75%' }
        };

        const chart = new google.visualization.LineChart(document.getElementById('tempPerformanceChart'));
        chart.draw(data, options);
    }

    // Log activity
    function logActivity(type, message) {
        const activity = {
            id: 'A-' + (1000 + Math.floor(Math.random() * 9000)),
            type,
            message,
            timestamp: new Date().toISOString()
        };

        activities.unshift(activity);
        renderActivity();

        // Highlight the activity container
        const container = document.getElementById('activityContainer');
        container.classList.add('highlight');
        setTimeout(() => container.classList.remove('highlight'), 1500);
    }

    // Render activity
    function renderActivity() {
        const container = document.getElementById('activityContainer');
        container.innerHTML = '';

        // Show latest 5 activities
        const recentActivities = activities.slice(0, 5);

        recentActivities.forEach(activity => {
            const item = document.createElement('div');
            item.className = 'activity-item';

            let iconClass = 'fas fa-plus-circle';
            let iconColor = '#34A853';

            if (activity.type === 'update') {
                iconClass = 'fas fa-edit';
                iconColor = '#4285F4';
            } else if (activity.type === 'delete') {
                iconClass = 'fas fa-trash-alt';
                iconColor = '#EA4335';
            }

            const date = new Date(activity.timestamp);
            const timeString = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const dateString = date.toLocaleDateString();

            item.innerHTML = `
                <div class="activity-content">
                    <div class="activity-title"><i class="${iconClass}" style="color: ${iconColor};"></i> ${activity.message}</div>
                    <div class="activity-time">${dateString} at ${timeString}</div>
                </div>
            `;

            container.appendChild(item);
        });

        if (recentActivities.length === 0) {
            container.innerHTML = '<div class="activity-item"><div class="activity-content">No recent activity</div></div>';
        }
    }

    // Redraw charts on window resize for responsiveness
    window.addEventListener('resize', drawAllCharts);
</script>



<script>
    // Product options for dropdown
    const PRODUCT_OPTIONS = [
        "Milk", "Cheese", "Butter", "Ice Cream",
        "Yogurt", "Ghee", "Paneer", "Cream",
        "Milk Powder", "Condensed Milk"
    ];

    // Sample initial data for processing section
    let procData = [
        {
            id: 1,
            name: "Alpha Milk Plant",
            location: "Delhi",
            capacity: 40000,
            status: "Active",
            manager: "Ajay Kumar",
            products: { Milk: 20000, Butter: 10000, Cheese: 10000 },
            activity: "Plant created",
            timestamp: new Date('2023-01-15').getTime()
        },
        {
            id: 2,
            name: "Beta Dairy",
            location: "Pune",
            capacity: 50000,
            status: "Inactive",
            manager: "Rita Sen",
            products: { Yogurt: 30000, IceCream: 20000 },
            activity: "Temporarily shut down",
            timestamp: new Date('2023-02-20').getTime()
        },
        {
            id: 3,
            name: "Gamma Agro Foods",
            location: "Lucknow",
            capacity: 45000,
            status: "Active",
            manager: "Suresh Yadav",
            products: { Milk: 25000, Ghee: 10000, Paneer: 10000 },
            activity: "Daily production ongoing",
            timestamp: new Date('2023-03-10').getTime()
        },
        {
            id: 4,
            name: "Delta Dairy Processing",
            location: "Ahmedabad",
            capacity: 60000,
            status: "Maintenance",
            manager: "Pooja Mehta",
            products: { Milk: 30000, Butter: 15000, Yogurt: 10000 },
            activity: "Under scheduled maintenance",
            timestamp: new Date('2023-04-05').getTime()
        },
        {
            id: 5,
            name: "Omega Milk Industries",
            location: "Bangalore",
            capacity: 55000,
            status: "Active",
            manager: "Rahul Desai",
            products: { Milk: 28000, Cheese: 15000, IceCream: 12000 },
            activity: "New product line launched",
            timestamp: new Date('2023-05-18').getTime()
        }
    ];

    let procEditingId = null;
    let stackedBarChart = null;

    function renderProcessingAll() {
        renderProcCards();
        renderProcTable();
        updateProcSummaryCards();
        renderProcChart();
        renderProcActivities();
    }

    function getFilteredProc() {
        const name = document.getElementById('procSearch').value.toLowerCase();
        const status = document.getElementById('procStatusFilter').value;
        return procData.filter(p => {
            const matchName = !name || p.name.toLowerCase().includes(name);
            const matchStatus = !status || p.status === status;
            return matchName && matchStatus;
        });
    }

    function renderProcCards() {
        const container = document.getElementById('procCardView');
        container.innerHTML = '';
        const data = getFilteredProc();

        if (data.length === 0) {
            container.innerHTML = '<div class="no-data">No plants found matching your criteria</div>';
            return;
        }

        data.forEach(p => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
      <div class="card-icon"><i class="fas fa-industry"></i></div>
      <h3>${p.name}</h3>
      <p><strong><i class="fas fa-map-marker-alt"></i> Location:</strong> ${p.location}</p>
      <p><strong><i class="fas fa-user-tie"></i> Manager:</strong> ${p.manager}</p>
      <p><strong><i class="fas fa-power-off"></i> Status:</strong> <span class="status ${getStatusClass(p.status)}">${p.status}</span></p>
      <p><strong><i class="fas fa-flask"></i> Capacity:</strong> ${p.capacity.toLocaleString()} L</p>
      <p><strong><i class="fas fa-boxes"></i> Products:</strong> ${Object.entries(p.products).map(([k, v]) => `${k}: ${v}L`).join(', ')}</p>
      <div class="form-actions">
        <button class="btn btn-primary" onclick="editProcPlant(${p.id})"><i class="fas fa-edit"></i> Edit</button>
        <button class="btn btn-danger" onclick="deleteProcPlant(${p.id})"><i class="fas fa-trash"></i> Delete</button>
      </div>
    `;
            container.appendChild(card);
        });
    }

    function getStatusClass(status) {
        switch (status) {
            case 'Active': return 'status-active';
            case 'Inactive': return 'status-inactive';
            case 'Maintenance': return 'status-maintenance';
            default: return '';
        }
    }

    function renderProcTable() {
        const body = document.getElementById('procTableBody');
        body.innerHTML = '';
        const data = getFilteredProc();

        if (data.length === 0) {
            body.innerHTML = `<tr><td colspan="7" class="text-center">No plants found</td></tr>`;
            return;
        }

        data.forEach(p => {
            const row = document.createElement('tr');
            row.innerHTML = `
      <td><i class="fas fa-industry"></i> ${p.name}</td>
      <td><i class="fas fa-map-marker-alt"></i> ${p.location}</td>
      <td>${p.capacity.toLocaleString()} L</td>
      <td><span class="status ${getStatusClass(p.status)}">${p.status}</span></td>
      <td><i class="fas fa-user-tie"></i> ${p.manager}</td>
      <td>${Object.entries(p.products).map(([k, v]) => `${k}: ${v}L`).join(', ')}</td>
      <td>
        <button class="action-btn" onclick="editProcPlant(${p.id})"><i class="fas fa-edit"></i></button>
        <button class="action-btn" onclick="deleteProcPlant(${p.id})"><i class="fas fa-trash"></i></button>
      </td>
    `;
            body.appendChild(row);
        });
    }

    function updateProcSummaryCards() {
        // Always show overall stats, not filtered stats
        document.getElementById('procTotalPlants').textContent = procData.length;
        document.getElementById('procTotalCapacity').textContent =
            procData.reduce((a, b) => a + b.capacity, 0).toLocaleString() + ' L';
        document.getElementById('procActivePlants').textContent =
            procData.filter(p => p.status === 'Active').length;
        document.getElementById('procTotalProducts').textContent =
            procData.reduce((a, b) => a + Object.keys(b.products).length, 0);
    }

    function toggleProcView(view) {
        document.getElementById('procCardView').style.display = view === 'cards' ? 'grid' : 'none';
        document.getElementById('procTableView').style.display = view === 'table' ? 'block' : 'none';
        document.querySelectorAll('.chart-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.chart-btn')[view === 'cards' ? 0 : 1].classList.add('active');
    }

    function openProcModal() {
        procEditingId = null;
        document.getElementById('procModalTitle').textContent = 'Add Processing Plant';
        document.getElementById('procPlantName').value = '';
        document.getElementById('procPlantLocation').value = '';
        document.getElementById('procPlantCapacity').value = '';
        document.getElementById('procPlantStatus').value = 'Active';
        document.getElementById('procPlantManager').value = '';

        // Reset product inputs
        const container = document.getElementById('procProductInputs');
        container.innerHTML = `
    <div class="product-row">
      <select class="productName form-control">
        <option value="">Select Product</option>
        ${PRODUCT_OPTIONS.map(p => `<option value="${p}">${p}</option>`).join('')}
      </select>
      <input type="number" class="productQty form-control" min="0" placeholder="Liters">
      <button class="btn btn-danger" onclick="removeProcProduct(this)"><i class="fas fa-trash"></i></button>
    </div>
  `;

        document.getElementById('capacityWarning').style.display = 'none';
        document.getElementById('procModal').style.display = 'flex';
    }

    function closeProcModal() {
        document.getElementById('procModal').style.display = 'none';
    }

    function addProcProduct() {
        const div = document.createElement('div');
        div.className = 'product-row';
        div.innerHTML = `
    <select class="productName form-control">
      <option value="">Select Product</option>
      ${PRODUCT_OPTIONS.map(p => `<option value="${p}">${p}</option>`).join('')}
    </select>
    <input type="number" class="productQty form-control" min="0" placeholder="Liters">
    <button class="btn btn-danger" onclick="removeProcProduct(this)"><i class="fas fa-trash"></i></button>
  `;
        document.getElementById('procProductInputs').appendChild(div);
    }

    function removeProcProduct(btn) {
        btn.parentElement.remove();
        validateCapacity();
    }

    function validateCapacity() {
        const capacity = parseInt(document.getElementById('procPlantCapacity').value) || 0;
        let totalProducts = 0;

        document.querySelectorAll('#procProductInputs .product-row').forEach(row => {
            const qty = parseInt(row.querySelector('.productQty').value) || 0;
            totalProducts += qty;
        });

        const warning = document.getElementById('capacityWarning');
        if (totalProducts > capacity) {
            warning.style.display = 'block';
            warning.textContent = `Total products (${totalProducts}L) exceed capacity (${capacity}L)!`;
            return false;
        }

        warning.style.display = 'none';
        return true;
    }

    function saveProcPlant() {
        const name = document.getElementById('procPlantName').value.trim();
        const location = document.getElementById('procPlantLocation').value.trim();
        const capacity = parseInt(document.getElementById('procPlantCapacity').value);
        const status = document.getElementById('procPlantStatus').value;
        const manager = document.getElementById('procPlantManager').value.trim();

        // Basic validation
        if (!name || !location || !manager || isNaN(capacity) || capacity <= 0) {
            alert('Please fill all required fields with valid values');
            return;
        }

        // Validate product quantities
        if (!validateCapacity()) {
            return;
        }

        // Collect products
        const products = {};
        let hasProducts = false;

        document.querySelectorAll('#procProductInputs .product-row').forEach(row => {
            const pname = row.querySelector('.productName').value;
            const pqty = parseInt(row.querySelector('.productQty').value) || 0;

            if (pname && pqty > 0) {
                products[pname] = pqty;
                hasProducts = true;
            }
        });

        if (!hasProducts) {
            alert('Please add at least one product');
            return;
        }

        // Create plant object
        const plant = {
            id: procEditingId || Date.now(),
            name,
            location,
            capacity,
            status,
            manager,
            products,
            activity: procEditingId ? 'Plant updated' : 'Plant created',
            timestamp: Date.now()
        };

        // Save to data
        if (procEditingId) {
            const index = procData.findIndex(p => p.id === procEditingId);
            procData[index] = plant;
        } else {
            procData.push(plant);
        }

        closeProcModal();
        renderProcessingAll();
    }

    function editProcPlant(id) {
        const p = procData.find(p => p.id === id);
        if (!p) return;

        procEditingId = id;
        document.getElementById('procModalTitle').textContent = 'Edit Plant: ' + p.name;
        document.getElementById('procPlantName').value = p.name;
        document.getElementById('procPlantLocation').value = p.location;
        document.getElementById('procPlantCapacity').value = p.capacity;
        document.getElementById('procPlantStatus').value = p.status;
        document.getElementById('procPlantManager').value = p.manager;

        const container = document.getElementById('procProductInputs');
        container.innerHTML = '';

        Object.entries(p.products).forEach(([k, v]) => {
            const row = document.createElement('div');
            row.className = 'product-row';
            row.innerHTML = `
      <select class="productName form-control">
        <option value="">Select Product</option>
        ${PRODUCT_OPTIONS.map(p =>
                `<option value="${p}" ${p === k ? 'selected' : ''}>${p}</option>`
            ).join('')}
      </select>
      <input type="number" class="productQty form-control" value="${v}" min="0" placeholder="Liters">
      <button class="btn btn-danger" onclick="removeProcProduct(this)"><i class="fas fa-trash"></i></button>
    `;
            container.appendChild(row);
        });

        document.getElementById('capacityWarning').style.display = 'none';
        document.getElementById('procModal').style.display = 'flex';
    }

    function deleteProcPlant(id) {
        if (!confirm('Are you sure you want to delete this plant?')) return;

        procData = procData.filter(p => p.id !== id);
        renderProcessingAll();
    }

    function renderProcActivities() {
        const logs = document.getElementById('procActivityLogs');
        logs.innerHTML = '';

        // Sort by timestamp descending
        const recent = [...procData]
            .sort((a, b) => b.timestamp - a.timestamp)
            .slice(0, 5);

        if (recent.length === 0) {
            logs.innerHTML = '<div class="no-activity">No recent activities</div>';
            return;
        }

        recent.forEach(p => {
            const item = document.createElement('div');
            item.className = 'log-item';
            item.innerHTML = `
      <div class="log-icon"><i class="fas fa-industry"></i></div>
      <div class="log-content">
        <div class="log-title">${p.name}</div>
        <div class="log-details">${p.activity}</div>
        <div class="log-time">
          <i class="far fa-clock"></i> ${formatDate(p.timestamp)}
        </div>
      </div>
    `;
            logs.appendChild(item);
        });
    }

    function formatDate(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function renderProcChart() {
        const ctx = document.getElementById('procStackedBarChart').getContext('2d');

        // Destroy previous chart instance if exists
        if (stackedBarChart) {
            stackedBarChart.destroy();
        }

        // Prepare data
        const labels = procData.map(p => p.name);
        const products = [...new Set(procData.flatMap(p => Object.keys(p.products)))];

        const datasets = products.map((product, i) => {
            const colors = [
                '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#6366f1',
                '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#64748b'
            ];

            return {
                label: product,
                data: procData.map(p => p.products[product] || 0),
                backgroundColor: colors[i % colors.length]
            };
        });

        // Create chart
        stackedBarChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        stacked: true,
                        title: {
                            display: true,
                            text: 'Plants'
                        }
                    },
                    y: {
                        stacked: true,
                        title: {
                            display: true,
                            text: 'Liters'
                        },
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Plant-wise Stacked Products'
                    }
                }
            }
        });
    }

    // Add event listeners for capacity validation
    document.getElementById('procPlantCapacity').addEventListener('input', validateCapacity);
    document.getElementById('procProductInputs').addEventListener('input', function (e) {
        if (e.target.classList.contains('productQty')) {
            validateCapacity();
        }
    });

    window.addEventListener('DOMContentLoaded', renderProcessingAll);
</script>

</html>
