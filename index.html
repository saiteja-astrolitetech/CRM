<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diary Dashboard</title>

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />

    <!-- Leaflet CSS -->
    <link href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" rel="stylesheet" />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- jsPDF and Plugins -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <!-- SheetJS (XLSX) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <link rel="stylesheet" href="CRM.css">

</head>

<body>

    <header>
        <!-- LEFT: Logo and Hamburger -->
        <div class="hdr-left">
            <img alt="Logo" class="hdr-logo" onclick="showSection('dashboard')" src="Company logo.jpg" />
            <button onclick="toggleSidebar()">‚ò∞</button>
        </div>

        <!-- CENTER: Search Bar -->
        <div class="hdr-center">
            <input class="hdr-search" placeholder="Search..." type="text" />
        </div>

        <!-- RIGHT: All other icons -->
        <div class="hdr-right">
            <i class="fas fa-bell hdr-icon"></i>
            <i class="fas fa-envelope hdr-icon"></i>

            <div class="dropdown">
                <button class="dropdown-btn">English</button>
                <div class="dropdown-content">
                    <div class="dropdown-item" onclick="setLanguage('en')">English</div>
                    <div class="dropdown-item" onclick="setLanguage('hi')">Hindi</div>
                    <div class="dropdown-item" onclick="setLanguage('te')">Telugu</div>
                    <div class="dropdown-item" onclick="setLanguage('de')">German</div>
                </div>
            </div>

            <div class="dropdown">
                <button class="dropdown-btn"><span class="dot green"></span> Active</button>
                <div class="dropdown-content">
                    <div class="dropdown-item" onclick="setWorkMode('active')"><span class="dot green"></span> Active
                    </div>
                    <div class="dropdown-item" onclick="setWorkMode('away')"><span class="dot gray"></span> Away</div>
                    <div class="dropdown-item" onclick="setWorkMode('dnd')"><span class="dot red"></span> Do Not Disturb
                    </div>
                </div>
            </div>

            <button class="theme-toggle" id="theme-toggle"><i class="fas fa-moon"></i></button>

            <div class="profile-section"
                onclick="document.querySelectorAll('.section').forEach(s=>s.classList.remove('active')); document.getElementById('profile').classList.add('active');">
                <span class="profile-name">Sai Teja</span>
                <img alt="Profile" class="profile-img" src="image.png" />
            </div>
        </div>
    </header>
    <aside class="sidebar" id="sidebar">
        <ul>
            <li class="active" onclick="activateNav(this,'dashboard')"><i class="fas fa-home"></i> Dashboard</li>
            <li onclick="activateNav(this,'farmer-mgmt')"><i class="fas fa-users"></i> Farmer Management</li>
            <li onclick="activateNav(this,'milk-collection')"><i class="fas fa-tint"></i> Milk Collection</li>
            <li onclick="activateNav(this,'chilling')"><i class="fas fa-snowflake"></i> Chilling Centers</li>
            <li onclick="activateNav(this,'processing')"><i class="fas fa-cogs"></i> Processing Plants</li>
            <li onclick="activateNav(this,'inventory')"><i class="fas fa-boxes"></i> Product Inventory</li>
            <li onclick="activateNav(this,'logistics')"><i class="fas fa-truck"></i> Distribution &amp; Logistics</li>
            <li onclick="activateNav(this,'retail')"><i class="fas fa-store"></i> Retail &amp; Franchise</li>
            <li onclick="activateNav(this,'customers-section')"><i class="fas fa-user-friends"></i> Customers</li>
            <li onclick="activateNav(this,'deliveries-section')"><i class="fas fa-shipping-fast"></i> Deliveries</li>
            <li onclick="activateNav(this,'payments-section')"><i class="fas fa-rupee-sign"></i> Payments</li>
            <li onclick="activateNav(this,'reports-section')"><i class="fas fa-file-alt"></i> Reports</li>
            <li onclick="activateNav(this,'settings-section')"><i class="fas fa-cog"></i> Settings</li>
        </ul>
    </aside>

    <div class="main" id="main">

        <div class="section active fade-in" id="dashboard">
            <!-- Dashboard Banner -->
            <div class="banner">
                üìä Real-Time Dashboard Metrics
            </div>

            <!-- Dashboard Cards -->
            <div class="cards-grid" id="dashboardCards">
                <!-- Total Milk (L) -->
                <div class="stat-card card-sky">
                    <div class="stat-header">
                        <span class="stat-title">Total Milk (L)</span>
                        <i class="fas fa-wine-bottle stat-icon"></i>
                    </div>
                    <div id="cardTotalMilk" class="stat-value">0</div>
                    <div id="cardChangeMilk" class="stat-trend">N/A</div>
                </div>

                <!-- Total Revenue -->
                <div class="stat-card card-amber">
                    <div class="stat-header">
                        <span class="stat-title">Total Revenue</span>
                        <i class="fas fa-rupee-sign stat-icon"></i>
                    </div>
                    <div id="cardTotalRevenue" class="stat-value">‚Çπ0</div>
                    <div id="cardChangeRevenue" class="stat-trend">N/A</div>
                </div>

                <!-- Customers -->
                <div class="stat-card card-emerald">
                    <div class="stat-header">
                        <span class="stat-title">Customers</span>
                        <i class="fas fa-user stat-icon"></i>
                    </div>
                    <div id="cardTotalCustomers" class="stat-value">0</div>
                    <div id="cardChangeCustomers" class="stat-trend">N/A</div>
                </div>
            </div>





            <!-- Sales Records Section -->
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-file-invoice-dollar"></i>
                    Sales Records
                </h3>
            </div>
            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                <input type="text" placeholder="Search..." id="dashboardSearch" class="form-control"
                    style="flex-grow: 1; padding: 0.5rem 1rem; border-radius: 8px; border: 1.5px solid #ccc; font-size: 1rem;" />
                <button class="btn btn-success" onclick="openDashboardModal()"
                    style="white-space: nowrap; padding: 0.5rem 1.2rem; border-radius: 8px;">
                    <i class="fas fa-plus" style="margin-right: 0.5rem;"></i> Add Record
                </button>
            </div>


            <!-- Sales Table -->
            <table class="custom-table">
                <thead>
                    <tr>
                        <th>Customer</th>
                        <th>Milk (L)</th>
                        <th>Revenue (‚Çπ)</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="dashboardTableBody"></tbody>
            </table>

            <!-- Revenue Trends Chart -->
            <div class="chart-container">
                <div class="chart-box">
                    <div class="chart-header">
                        <div class="chart-title">
                            üìà Revenue Trends
                        </div>
                    </div>
                    <div id="dashboardChart"></div>
                </div>
            </div>

            <!-- Customer Revenue Distribution Chart -->
            <div class="chart-container">
                <div class="chart-box">
                    <div class="chart-header">
                        <div class="chart-title">
                            üìä Customer Revenue Distribution
                        </div>
                        <div class="chart-actions">
                            <button class="btn btn-export" onclick="exportDashboardChart()">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    <canvas id="polarChart" height="400" width="400"></canvas>
                </div>
            </div>

            <!-- Recent Activity Log -->
            <div class="alert-container">
                <h4>
                    <i class="fas fa-history"></i>
                    üïíRecent Activity
                </h4>
                <ul id="dashboardActivity" style="padding-left: 1rem; line-height: 1.6;"></ul>
            </div>

            <!-- Modal for Adding/Editing Sales Record -->
            <div class="modal" id="dashboardModal">
                <div class="modal-content">
                    <button class="modal-close" onclick="closeDashboardModal()">&times;</button>
                    <div class="modal-title" id="modalTitle">Add Sale</div>

                    <div id="validationSummary" class="validation-summary"></div>

                    <div class="form-group">
                        <label>Customer Name <span class="required">*</span></label>
                        <input type="text" id="inputCustomer" class="form-control" required />
                        <div id="customerError" class="error-message">Customer name is required</div>
                    </div>
                    <div class="form-group">
                        <label>Milk Quantity (L) <span class="required">*</span></label>
                        <input type="number" id="inputMilk" class="form-control" min="1" step="0.1" />
                        <div id="milkError" class="error-message">Milk quantity must be at least 1L</div>
                    </div>
                    <div class="form-group">
                        <label>Revenue (‚Çπ) <span class="required">*</span></label>
                        <input type="number" id="inputRevenue" class="form-control" min="0" step="1" />
                        <div id="revenueError" class="error-message">Revenue must be a positive number</div>
                    </div>
                    <div class="form-group">
                        <label>Date <span class="required">*</span></label>
                        <input type="date" id="inputDate" class="form-control" />
                        <div id="dateError" class="error-message">Date is required and cannot be in the future</div>
                    </div>
                    <div class="form-group">
                        <label>Status <span class="required">*</span></label>
                        <select id="inputStatus" class="form-control">
                            <option>Completed</option>
                            <option>Pending</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-success" onclick="saveDashboardRecord()">
                            <i class="fas fa-save"></i> üíæ Save
                        </button>
                        <button class="btn btn-outline" onclick="closeDashboardModal()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="section fade-in" id="farmer-mgmt">
            <div class="banner">Farmer Management</div>

            <!-- Summary Cards -->
            <section class="cards-grid">
                <!-- Total Farmers - Blue -->
                <div class="stat-card card-blue">
                    <div class="stat-header">
                        <span class="stat-title">Total Farmers</span>
                        <i class="fas fa-users stat-icon"></i>
                    </div>
                    <div id="totalFarmers" class="stat-value">0</div>
                </div>

                <!-- Total Milk (L) - Teal -->
                <div class="stat-card card-emerald">
                    <div class="stat-header">
                        <span class="stat-title">Total Milk (L)</span>
                        <i class="fas fa-tint stat-icon"></i>
                    </div>
                    <div id="totalMilk" class="stat-value">0</div>
                </div>

                <!-- Active Regions - Orange -->
                <div class="stat-card card-orange">
                    <div class="stat-header">
                        <span class="stat-title">Active Regions</span>
                        <i class="fas fa-map-marker-alt stat-icon"></i>
                    </div>
                    <div id="activeRegions" class="stat-value">0</div>
                </div>
            </section>




            <!-- Add/Edit Form -->
            <section class="data-section">
                <p class="section-title" style="margin-bottom: 1.5rem;">Add / Edit Farmer</p>
                <form id="farmerForm" class="settings-grid" novalidate>
                    <input type="hidden" id="editIndex" value="-1" />
                    <div class="form-group">
                        <input type="text" id="name" placeholder="Farmer Name" required pattern="[A-Za-z\s.'-]{2,100}"
                            title="2-100 characters, only letters, spaces, hyphens, apostrophes, and periods"
                            class="form-control" />
                        <div class="error-message" id="name-error"></div>
                    </div>
                    <div class="form-group">
                        <input type="number" id="longitude" placeholder="Longitude" required step="0.000001" min="-180"
                            max="180" class="form-control" />
                        <div class="error-message" id="longitude-error"></div>
                    </div>
                    <div class="form-group">
                        <input type="number" id="milk" placeholder="Milk (liters)" required min="0" max="10000"
                            step="0.01" class="form-control" />
                        <div class="error-message" id="milk-error"></div>
                    </div>
                    <div class="form-group">
                        <input type="number" id="latitude" placeholder="Latitude" required step="0.000001" min="-90"
                            max="90" class="form-control" />
                        <div class="error-message" id="latitude-error"></div>
                    </div>
                    <div class="form-group">
                        <input type="text" id="region" placeholder="Region" required pattern="[A-Za-z0-9\s.'-]{2,50}"
                            title="2-50 characters, letters, numbers, spaces, hyphens, apostrophes, and periods"
                            class="form-control" />
                        <div class="error-message" id="region-error"></div>
                    </div>
                    <div class="form-actions" style="grid-column: span 2;">
                        <button type="submit" class="btn btn-primary">Save Farmer</button>
                        <button type="button" onclick="farmerMgmt.resetForm()" class="btn btn-outline">Cancel</button>
                    </div>
                </form>
            </section>

            <!-- Table & Filters -->
            <section class="table-section">
                <div class="data-section">
                    <div class="section-actions">
                        <input type="text" id="searchInput" placeholder="Search by name or region..."
                            class="form-control" />
                        <select id="regionFilter" class="form-control">
                            <option value="">All Regions</option>
                        </select>
                        <button onclick="farmerMgmt.exportToCSV()" class="btn btn-outline">Export CSV</button>
                        <button onclick="window.print()" class="btn btn-outline">üñ®Ô∏è Print</button>
                    </div>
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Region</th>
                                <th>Milk (L)</th>
                                <th>Latitude</th>
                                <th>Longitude</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="farmerTableBody"></tbody>
                    </table>
                    <div id="paginationControls" class="pagination"></div>
                </div>
            </section>

            <!-- Charts -->
            <div class="chart-grid">
                <div class="chart-container">
                    <h2>Milk Distribution by Region</h2>
                    <div id="pie_chart" class="chart-box"></div>
                </div>
                <div class="chart-container">
                    <h2>Milk Production Trend</h2>
                    <div id="area_chart" class="chart-box"></div>
                </div>
            </div>

            <!-- Map -->
            <div class="map-container data-section">
                <h2 style="margin-bottom: 1.5rem;">Farmers Map</h2>
                <div id="map" class="map-placeholder" style="height: 400px; background-color: #e0e0e0;">
                    <div id="map-fallback" style="display: none; padding: 20px; text-align: center;">
                        <p>Google Maps couldn't be loaded. Showing coordinates instead.</p>
                        <div id="coordinates-display"></div>
                    </div>
                </div>
            </div>

            <!-- Activity Log -->
            <section class="alert-container">
                <h2>Recent Activity Log</h2>
                <ul id="activityLog"></ul>
            </section>

            <!-- Modal -->
            <div id="modal" class="modal">
                <div class="modal-content">
                    <p id="modalMessage"></p>
                    <button onclick="farmerMgmt.confirmModal()" class="btn btn-primary">Confirm</button>
                    <button onclick="farmerMgmt.closeModal()" class="btn btn-outline">Cancel</button>
                </div>
            </div>
        </div>

        <div class="section fade-in" id="milk-collection">
            <div class="banner">Milk Collections</div>

            <!-- Summary Cards -->
            <div class="cards-grid">
                <!-- Total Milk Collected - Indigo -->
                <div id="dairy_totalLitresCard" class="stat-card card-indigo">
                    <div class="stat-header">
                        <span class="stat-title">Total Milk Collected</span>
                        <i class="fas fa-tint stat-icon"></i>
                    </div>
                    <div id="dairy_totalLitresChart" style="display: none;"></div>
                    <div id="dairy_totalLitresVal" class="stat-value">0 L</div>
                </div>

                <!-- Total Farmers - Emerald -->
                <div id="dairy_totalFarmersCard" class="stat-card card-green">
                    <div class="stat-header">
                        <span class="stat-title">Total Farmers</span>
                        <i class="fas fa-users stat-icon"></i>
                    </div>
                    <div id="dairy_totalFarmersChart" style="display: none;"></div>
                    <div id="dairy_totalFarmersVal" class="stat-value">0</div>
                </div>

                <!-- Average Fat % - Amber -->
                <div id="dairy_avgFatCard" class="stat-card card-yellow">
                    <div class="stat-header">
                        <span class="stat-title">Average Fat %</span>
                        <i class="fas fa-percentage stat-icon"></i>
                    </div>
                    <div id="dairy_avgFatChart" style="display: none;"></div>
                    <div id="dairy_avgFatVal" class="stat-value">0%</div>
                </div>

                <!-- Average SNF % - Rose -->
                <div id="dairy_avgSNFCard" class="stat-card card-rose">
                    <div class="stat-header">
                        <span class="stat-title">Average SNF %</span>
                        <i class="fas fa-chart-pie stat-icon"></i>
                    </div>
                    <div id="dairy_avgSNFChart" style="display: none;"></div>
                    <div id="dairy_avgSNFVal" class="stat-value">0%</div>
                </div>
            </div>



            <!-- Form -->
            <div class="data-section">
                <h2>Add Milk Collection Entry</h2>
                <form id="dairy_entryForm" class="settings-grid" style="margin-top: 1rem;">
                    <div class="form-group">
                        <input type="text" id="dairy_farmer" placeholder="Farmer Name" required class="form-control" />
                    </div>
                    <div class="form-group">
                        <input type="number" id="dairy_qty" placeholder="Qty (L)" min="0" required
                            class="form-control" />
                    </div>
                    <div class="form-group">
                        <input type="number" id="dairy_fat" placeholder="Fat %" min="0" max="10" step="0.1" required
                            class="form-control" />
                    </div>
                    <div class="form-group">
                        <input type="number" id="dairy_snf" placeholder="SNF %" min="0" max="10" step="0.1" required
                            class="form-control" />
                    </div>
                    <div class="form-group">
                        <input type="number" id="dairy_rate" placeholder="Rate ‚Çπ/L" min="0" required
                            class="form-control" />
                    </div>
                    <div class="form-group">
                        <input type="datetime-local" id="dairy_datetime" required class="form-control" />
                    </div>
                    <div class="form-actions" style="grid-column: span 2;">
                        <button type="submit" class="btn btn-primary">Add Entry</button>
                    </div>
                </form>
            </div>

            <!-- Export Buttons -->
            <div class="section-actions" style="margin-bottom: 1rem;">
                <button id="dairy_excelBtn" class="btn btn-outline">Export to Excel</button>
                <button id="dairy_pdfBtn" class="btn btn-outline">Export to PDF</button>
            </div>

            <!-- Table -->
            <div class="data-section">
                <h3>Milk Collection Records</h3>
                <table id="dairy_dataTable" class="custom-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Farmer</th>
                            <th>Date</th>
                            <th>Qty</th>
                            <th>Fat</th>
                            <th>SNF</th>
                            <th>Rate</th>
                            <th>Amount</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Recent Activity -->
            <div class="alert-container">
                <h3>Recent Activity</h3>
                <ul id="dairy_recentActivity"></ul>
            </div>

            <!-- View/Edit Modal -->
            <div id="dairy_modal" class="modal">
                <div class="modal-content">
                    <h3 id="dairy_modalTitle">View/Edit Entry</h3>
                    <form id="dairy_modalForm" class="settings-grid">
                        <input type="hidden" id="dairy_editId" />
                        <div class="form-group">
                            <input type="text" id="dairy_editFarmer" required placeholder="Farmer"
                                class="form-control" />
                        </div>
                        <div class="form-group">
                            <input type="number" id="dairy_editQty" required placeholder="Quantity"
                                class="form-control" />
                        </div>
                        <div class="form-group">
                            <input type="number" id="dairy_editFat" required placeholder="Fat %" step="0.1"
                                class="form-control" />
                        </div>
                        <div class="form-group">
                            <input type="number" id="dairy_editSNF" required placeholder="SNF %" step="0.1"
                                class="form-control" />
                        </div>
                        <div class="form-group">
                            <input type="number" id="dairy_editRate" required placeholder="Rate" class="form-control" />
                        </div>
                        <div class="form-group">
                            <input type="datetime-local" id="dairy_editDate" required class="form-control" />
                        </div>
                        <div class="form-actions" style="grid-column: span 2;">
                            <button type="submit" class="btn btn-primary">Update Entry</button>
                        </div>
                    </form>
                    <button id="dairy_closeModalBtn" class="modal-close">‚úñ</button>
                </div>
            </div>

            <div id="dairy_dailyMilkChartContainer" style="margin-top: 30px;"></div>
            <div id="dairy_fatSNFChartContainer" style="margin-top: 30px;"></div>

        </div>


        <div class="section fade-in" id="chilling">
            <div class="container">
                <!-- Banner -->
                <div class="banner fade-in">
                    Chilling Centers Management
                </div>

                <!-- Summary Cards -->
                <div class="cards-grid">
                    <!-- Total Centers - Blue -->
                    <div class="stat-card card-blue">
                        <div class="stat-header">
                            <span class="stat-title">Total Centers</span>
                            <i class="fas fa-building stat-icon"></i>
                        </div>
                        <div id="summary_totalCenters" class="stat-value">0</div>
                    </div>

                    <!-- Avg. Temperature - Orange -->
                    <div class="stat-card card-orange">
                        <div class="stat-header">
                            <span class="stat-title">Avg. Temperature</span>
                            <i class="fas fa-thermometer-half stat-icon"></i>
                        </div>
                        <div id="summary_avgTemp" class="stat-value">0¬∞C</div>
                    </div>

                    <!-- Total Capacity - Teal -->
                    <div class="stat-card card-teal">
                        <div class="stat-header">
                            <span class="stat-title">Total Capacity</span>
                            <i class="fas fa-tint stat-icon"></i>
                        </div>
                        <div id="summary_totalCapacity" class="stat-value">0 L</div>
                    </div>

                    <!-- Current Capacity - Violet -->
                    <div class="stat-card card-violet">
                        <div class="stat-header">
                            <span class="stat-title">Current Capacity</span>
                            <i class="fas fa-tint stat-icon"></i>
                        </div>
                        <div id="summary_currentCapacity" class="stat-value">0 L</div>
                    </div>

                    <!-- Energy Utilization - Amber -->
                    <div class="stat-card card-yellow">
                        <div class="stat-header">
                            <span class="stat-title">Energy Utilization</span>
                            <i class="fas fa-solar-panel stat-icon"></i>
                        </div>
                        <div id="summary_energyMix" class="stat-value">0% Solar</div>
                    </div>
                </div>


                <!-- Form Container -->
                <div class="profile-form" id="chillingFormContainer" style="display:none;">
                    <h3 id="chillingFormTitle"><i class="fa-plus-circle fas"></i> Add New Chilling Center</h3>
                    <form class="settings-grid" id="chillingEntryForm">
                        <input id="chillingEditId" type="hidden" />
                        <div class="form-group">
                            <label for="chillingCenterName">Center Name</label>
                            <input class="form-control" id="chillingCenterName" required type="text" />
                            <div class="error-message" id="chillingNameError">Center name must be at least 2 characters
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="chillingLocation">Location</label>
                            <input class="form-control" id="chillingLocation" required type="text" />
                            <div class="error-message" id="chillingLocationError">Location must be at least 2 characters
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="chillingTotalCapacity">Total Capacity (L)</label>
                            <input class="form-control" id="chillingTotalCapacity" min="1000" required type="number"
                                value="1000" />
                            <div class="error-message" id="chillingTotalCapacityError">Capacity must be at least 1,000 L
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="chillingCurrentCapacity">Current Capacity (L)</label>
                            <input class="form-control" id="chillingCurrentCapacity" min="0" required type="number"
                                value="0" />
                            <div class="error-message" id="chillingCurrentCapacityError">Current capacity cannot exceed
                                total capacity</div>
                        </div>
                        <div class="form-group">
                            <label for="chillingTemperature">Temperature (¬∞C)</label>
                            <input class="form-control" id="chillingTemperature" required step="0.1" type="number"
                                value="4.0" />
                            <div class="error-message" id="chillingTemperatureError">Temperature must be between 0¬∞C and
                                10¬∞C</div>
                        </div>
                        <div class="form-group">
                            <label for="chillingStatus">Status</label>
                            <select class="form-control" id="chillingStatus" required>
                                <option value="">Select Status</option>
                                <option selected value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                                <option value="Maintenance">Maintenance</option>
                            </select>
                            <div class="error-message" id="chillingStatusError">Please select a status</div>
                        </div>
                        <div class="form-group">
                            <label for="chillingEnergyType">Energy Source</label>
                            <select class="form-control" id="chillingEnergyType" required>
                                <option value="">Select Energy Source</option>
                                <option value="Grid Power">Grid Power</option>
                                <option selected value="Solar">Solar</option>
                                <option value="Generator">Generator</option>
                                <option value="Battery">Battery</option>
                            </select>
                            <div class="error-message" id="chillingEnergyTypeError">Please select an energy source</div>
                        </div>
                        <div class="form-actions">
                            <button class="btn-primary btn-outline btn" id="chillingCancelBtn" type="button">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                            <button class="btn-primary btn btn-success" id="chillingSubmitBtn" type="submit">
                                <i class="fa-plus fas"></i> Add Center
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Search and Filter -->
                <div class="data-section">
                    <div class="section-header">
                        <h3 class="section-title"><i class="fas fa-list"></i> Chilling Centers</h3>
                        <div class="search-container">
                            <input class="form-control" id="chillingSearchInput" placeholder="Search by any field..."
                                type="text" />
                        </div>
                        <!-- Add New Button -->
                        <div class="section-actions">
                            <button class="btn-primary btn" id="chillingAddCenterBtn">
                                <i class="fa-plus fas"></i> Add New Center
                            </button>
                        </div>
                    </div>
                    <!-- Table -->
                    <table class="custom-table" id="chillingDataTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Center Name</th>
                                <th>Location</th>
                                <th>Capacity (L)</th>
                                <th>Temp (¬∞C)</th>
                                <th>Status</th>
                                <th>Energy Source</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="chillingTableBody"></tbody>
                    </table>
                </div>

                <!-- Charts Section -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title"><i class="fa-chart-line fas"></i> Performance Dashboard</h3>
                    </div>
                    <div class="chart-grid">
                        <div class="chart-wrapper" id="chillingTemperatureChart"></div>
                        <div class="chart-wrapper" id="chillingCapacityChart"></div>
                        <div class="chart-wrapper" id="chillingEnergyChart"></div>
                        <div class="chart-wrapper" id="chillingTempPerformanceChart"></div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="data-section">
                    <div class="section-header">
                        <h3 class="section-title"><i class="fa-history fas"></i> Recent Activity</h3>
                    </div>
                    <div id="chillingActivityContainer">
                        <!-- Activity items will be added here -->
                    </div>
                </div>
            </div>
        </div>

        <div class="section fade-in" id="processing">
            <div class="banner">ü•õ Processing Plant Management</div>

            <div class="cards-grid">
                <!-- Total Plants -->
                <div class="stat-card card-indigo">
                    <div class="stat-header">
                        <span class="stat-title">Total Plants</span>
                        <i class="fas fa-industry stat-icon"></i>
                    </div>
                    <div id="procTotalPlants" class="stat-value">0</div>
                </div>

                <!-- Total Capacity -->
                <div class="stat-card card-orange">
                    <div class="stat-header">
                        <span class="stat-title">Total Capacity</span>
                        <i class="fas fa-flask stat-icon"></i>
                    </div>
                    <div id="procTotalCapacity" class="stat-value">0 L</div>
                </div>

                <!-- Active Plants -->
                <div class="stat-card card-green">
                    <div class="stat-header">
                        <span class="stat-title">Active Plants</span>
                        <i class="fas fa-bolt stat-icon"></i>
                    </div>
                    <div id="procActivePlants" class="stat-value">0</div>
                </div>

                <!-- Total Products -->
                <div class="stat-card card-blue">
                    <div class="stat-header">
                        <span class="stat-title">Total Products</span>
                        <i class="fas fa-boxes stat-icon"></i>
                    </div>
                    <div id="procTotalProducts" class="stat-value">0</div>
                </div>
            </div>





            <!-- Filters -->
            <div class="filter-list">
                <input type="text" class="form-control" id="procSearch" placeholder="üîç Search Plant Name"
                    oninput="renderProcessingAll()">
                <select class="form-control" id="procStatusFilter" onchange="renderProcessingAll()">
                    <option value="">All Status</option>
                    <option value="Active">Active</option>
                    <option value="Inactive">Inactive</option>
                    <option value="Maintenance">Maintenance</option>
                </select>
            </div>

            <!-- View Switch & Add Button -->
            <div class="section-header">
                <div class="section-actions">
                    <button class="chart-btn active" onclick="toggleProcView('cards')"><i class="fas fa-th-large"></i>
                        Card View</button>
                    <button class="chart-btn" onclick="toggleProcView('table')"><i class="fas fa-table"></i> Table
                        View</button>
                    <button class="btn btn-primary" onclick="openProcModal()"><i class="fas fa-plus"></i> Add
                        Plant</button>
                </div>
            </div>

            <!-- Card View -->
            <div id="procCardView" class="cards-grid"></div>

            <!-- Table View -->
            <div id="procTableView" class="data-section" style="display: none">
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th>Plant</th>
                            <th>Location</th>
                            <th>Capacity</th>
                            <th>Status</th>
                            <th>Manager</th>
                            <th>Products</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="procTableBody"></tbody>
                </table>
            </div>

            <!-- Charts Section -->
            <div class="chart-container">
                <div class="chart-box">
                    <div class="chart-header">
                        <h4 class="chart-title"><i class="fas fa-chart-bar"></i> Plant-wise Stacked Products</h4>
                    </div>
                    <canvas id="procStackedBarChart" height="400"></canvas>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="log-section">
                <h2><i class="fas fa-history"></i> Recent Processing Activities</h2>
                <div class="log-list" id="procActivityLogs"></div>
            </div>

            <!-- Modal Form -->
            <div id="procModal" class="modal">
                <div class="modal-content">
                    <button class="modal-close" onclick="closeProcModal()">&times;</button>
                    <h2 class="modal-title" id="procModalTitle">Add Processing Plant</h2>
                    <div class="form-group">
                        <label>Plant Name</label>
                        <input type="text" id="procPlantName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="procPlantLocation" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Capacity (L)</label>
                        <input type="number" id="procPlantCapacity" class="form-control" min="1000" max="1000000"
                            required>
                        <small class="form-text">Min: 1,000L - Max: 1,000,000L</small>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="procPlantStatus" class="form-control" required>
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                            <option value="Maintenance">Maintenance</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Manager</label>
                        <input type="text" id="procPlantManager" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Products</label>
                        <div id="procProductInputs">
                            <div class="product-row">
                                <select class="productName form-control">
                                    <option value="">Select Product</option>
                                    <option value="Milk">Milk</option>
                                    <option value="Cheese">Cheese</option>
                                    <option value="Butter">Butter</option>
                                    <option value="Ice Cream">Ice Cream</option>
                                    <option value="Yogurt">Yogurt</option>
                                    <option value="Ghee">Ghee</option>
                                    <option value="Paneer">Paneer</option>
                                </select>
                                <input type="number" class="productQty form-control" min="0" placeholder="Liters">
                                <button class="btn btn-danger" onclick="removeProcProduct(this)"><i
                                        class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <button class="btn btn-outline" onclick="addProcProduct()">+ Add Product</button>
                        <div id="capacityWarning" class="text-danger mt-2" style="display: none;">
                            Total products exceed plant capacity!
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-warning" onclick="closeProcModal()">Cancel</button>
                        <button class="btn btn-success" onclick="saveProcPlant()">Save</button>
                    </div>
                </div>
            </div>
        </div>


        <div class="section fade-in" id="inventory">
            <div class="banner">üì¶ Inventory Management</div>

            <!-- Summary Cards with Icons -->
            <div class="cards-grid">
                <!-- Total Products -->
                <div class="stat-card card-azure">
                    <div class="stat-header">
                        <span class="stat-title">Total Products</span>
                        <i class="fas fa-box-open stat-icon"></i>
                    </div>
                    <div id="invx_totalProducts" class="stat-value">0</div>
                </div>

                <!-- Total Stock -->
                <div class="stat-card card-lime">
                    <div class="stat-header">
                        <span class="stat-title">Total Stock</span>
                        <i class="fas fa-warehouse stat-icon"></i>
                    </div>
                    <div id="invx_totalStock" class="stat-value">0</div>
                </div>

                <!-- Inventory Value -->
                <div class="stat-card card-yellow">
                    <div class="stat-header">
                        <span class="stat-title">Inventory Value</span>
                        <i class="fas fa-coins stat-icon"></i>
                    </div>
                    <div id="invx_totalValue" class="stat-value">‚Çπ0</div>
                </div>

                <!-- Expiring Soon -->
                <div class="stat-card card-red">
                    <div class="stat-header">
                        <span class="stat-title">Expiring Soon</span>
                        <i class="fas fa-clock stat-icon"></i>
                    </div>
                    <div id="invx_expiringSoon" class="stat-value">0</div>
                </div>
            </div>


            <!-- Bar Chart for Category Stock -->
            <div class="chart-section">
                <h4><i class="fas fa-chart-bar"></i> Stock by Category</h4>
                <canvas id="invx_categoryBarChart" height="300"></canvas>
            </div>

            <!-- Expiry Summary Selector -->
            <div class="data-section">
                <h4><i class="fas fa-hourglass-half"></i> Expiry Summary</h4>
                <div class="form-group">
                    <label for="invx_expiryRange">Select Range:</label>
                    <select id="invx_expiryRange" class="form-control" onchange="updateExpirySummary()">
                        <option value="7">Next 7 Days</option>
                        <option value="15">Next 15 Days</option>
                        <option value="30">Next 30 Days</option>
                    </select>
                </div>
                <div class="alert-card" style="margin-bottom: 1.5rem;">
                    <p style="margin-bottom: 1.5rem; font-size: 1rem;">Items expiring in selected range:
                        <span id="invx_expiryCount">0</span>
                    </p>
                </div>
            </div>

            <!-- Table Controls -->
            <div class="table-controls">
                <input style="margin-bottom: 1.5rem;" type="text" id="invx_search" placeholder="Search Product..."
                    class="form-control" oninput="filterInventory()" />
                <div class="button-group" style="margin-bottom: 1.5rem;">
                    <button class="btn btn-primary" onclick="openInvModal()">
                        <i class="fas fa-plus"></i> Add Product
                    </button>
                    <button class="btn btn-outline" onclick="exportInvCSV()">
                        <i class="fas fa-file-export"></i> Export CSV
                    </button>
                    <button class="btn btn-outline" onclick="document.getElementById('invx_csvFile').click()">
                        <i class="fas fa-file-import"></i> Import CSV
                    </button>
                    <input type="file" id="invx_csvFile" accept=".csv" hidden onchange="importInvCSV(this)" />
                </div>
            </div>

            <!-- Inventory Table -->
            <div class="data-section">
                <table class="custom-table" id="invx_table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>SKU</th>
                            <th>Category</th>
                            <th>Stock</th>
                            <th>Price</th>
                            <th>Manufacture</th>
                            <th>Expiry</th>
                            <th>Status</th>
                            <th>Supplier</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="invx_body"></tbody>
                </table>
            </div>

            <!-- Modal Form -->
            <div class="modal" id="invx_modal">
                <div class="modal-content">
                    <button class="modal-close" onclick="closeInvModal()">&times;</button>
                    <h3 id="invx_modalTitle">Add Product</h3>
                    <form id="invx_form" class="settings-grid">
                        <input type="hidden" id="invx_editIndex" />

                        <div class="form-group">
                            <label for="invx_dropdown">Select Product Template</label>
                            <select class="form-control" id="invx_dropdown" onchange="autoFillProduct()">
                                <option value="">Select a Product</option>
                                <option value="Whole Milk 1L">Whole Milk 1L</option>
                                <option value="Butter 500g">Butter 500g</option>
                                <option value="Yogurt 250g">Yogurt 250g</option>
                                <option value="Paneer 200g">Paneer 200g</option>
                                <option value="Ghee 1L">Ghee 1L</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="invx_name">Product Name</label>
                            <input class="form-control" id="invx_name" placeholder="Product Name" required />
                        </div>

                        <div class="form-group">
                            <label for="invx_sku">SKU</label>
                            <input class="form-control" id="invx_sku" placeholder="SKU" required />
                        </div>

                        <div class="form-group">
                            <label for="invx_category">Category</label>
                            <input class="form-control" id="invx_category" placeholder="Category" required />
                        </div>

                        <div class="form-group">
                            <label for="invx_stock">Stock Quantity</label>
                            <input class="form-control" type="number" id="invx_stock" placeholder="Stock Qty" min="0"
                                required />
                        </div>

                        <div class="form-group">
                            <label for="invx_price">Selling Price (‚Çπ)</label>
                            <input class="form-control" type="number" id="invx_price" placeholder="Selling Price ‚Çπ"
                                min="0" step="0.01" required />
                        </div>

                        <div class="form-group">
                            <label for="invx_manu">Manufacture Date</label>
                            <input class="form-control" type="date" id="invx_manu" required />
                        </div>

                        <div class="form-group">
                            <label for="invx_expiry">Expiry Date</label>
                            <input class="form-control" type="date" id="invx_expiry" required />
                        </div>

                        <div class="form-group">
                            <label for="invx_status">Status</label>
                            <select class="form-control" id="invx_status" required>
                                <option value="Available">Available</option>
                                <option value="Low Stock">Low Stock</option>
                                <option value="Expired">Expired</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="invx_supplier">Supplier Name</label>
                            <input class="form-control" id="invx_supplier" placeholder="Supplier Name" />
                        </div>

                        <div class="form-actions">
                            <button class="btn btn-success" type="submit">
                                <i class="fas fa-save"></i> Save
                            </button>
                            <button class="btn btn-outline" type="button" onclick="closeInvModal()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Activity Log -->
            <div class="activity-log">
                <h3><i class="fas fa-history"></i> Recent Activity</h3>
                <ul id="invx_log" class="activity-list"></ul>
            </div>
        </div>


        <div class="section fade-in" id="logistics">
            <div class="banner">
                <i class="fas fa-truck"></i>
                Distribution & Logistics Dashboard
            </div>

            <!-- Delivery Summary Cards -->
            <div class="cards-grid">
                <!-- Total Deliveries - Blue -->
                <div class="stat-card card-blue delivery-card">
                    <div class="delivery-header">
                        <i class="fas fa-truck stat-icon"></i>
                        <h4 class="delivery-title">Total Deliveries</h4>
                    </div>
                    <h2 id="dist-total-deliveries" class="delivery-value">0</h2>
                    <p class="delivery-trend positive">
                        <i class="fas fa-arrow-up"></i>
                        <span id="dist-deliveries-change">0%</span> from last month
                    </p>
                </div>

                <!-- On-time Delivery Rate - Green -->
                <div class="stat-card card-green delivery-card">
                    <div class="delivery-header">
                        <i class="fas fa-clock stat-icon"></i>
                        <h4 class="delivery-title">On-time Delivery Rate</h4>
                    </div>
                    <h2 id="dist-on-time-rate" class="delivery-value">0%</h2>
                    <p class="delivery-trend positive">
                        <i class="fas fa-arrow-up"></i>
                        <span id="dist-on-time-change">0%</span> from last month
                    </p>
                </div>

                <!-- Avg. Delivery Time - Amber -->
                <div class="stat-card card-yellow delivery-card">
                    <div class="delivery-header">
                        <i class="fas fa-hourglass-half stat-icon"></i>
                        <h4 class="delivery-title">Avg. Delivery Time</h4>
                    </div>
                    <h2 id="dist-avg-delivery-time" class="delivery-value">0 hrs</h2>
                    <p class="delivery-trend negative">
                        <i class="fas fa-arrow-down"></i>
                        <span id="dist-delivery-time-change">0 hrs</span> from last month
                    </p>
                </div>

                <!-- Fuel Efficiency - Purple -->
                <div class="stat-card card-purple delivery-card">
                    <div class="delivery-header">
                        <i class="fas fa-gas-pump stat-icon"></i>
                        <h4 class="delivery-title">Fuel Efficiency</h4>
                    </div>
                    <h2 id="dist-fuel-efficiency" class="delivery-value">0 km/L</h2>
                    <p class="delivery-trend positive">
                        <i class="fas fa-arrow-up"></i>
                        <span id="dist-fuel-change">0 km/L</span> from last month
                    </p>
                </div>
            </div>

            <!-- Charts -->
            <div class="chart-grid">
                <div class="chart-box">
                    <div class="chart-header">
                        <h4 class="chart-title">Delivery Volume by Product</h4>
                        <select id="dist-time-filter" class="chart-btn">
                            <option value="7">Last 7 Days</option>
                            <option value="30" selected>Last 30 Days</option>
                            <option value="90">Last 90 Days</option>
                        </select>
                    </div>
                    <canvas id="dist-deliveryVolumeChart" height="300"></canvas>
                </div>
                <div class="chart-box">
                    <div class="chart-header">
                        <h4 class="chart-title">Delivery Status Distribution</h4>
                    </div>
                    <canvas id="dist-statusDistributionChart" height="300"></canvas>
                </div>
            </div>

            <!-- New Charts -->
            <div class="chart-grid">
                <div class="chart-box">
                    <div class="chart-header">
                        <h4 class="chart-title">Regional Delivery Performance</h4>
                    </div>
                    <canvas id="dist-regionPerformanceChart" height="300"></canvas>
                </div>
                <div class="chart-box">
                    <div class="chart-header">
                        <h4 class="chart-title">Delivery Time Analysis</h4>
                        <select id="dist-region-filter" class="chart-btn">
                            <option value="">All Regions</option>
                            <option>Hyderabad</option>
                            <option>Vijayawada</option>
                            <option>Guntur</option>
                            <option>Visakhapatnam</option>
                            <option>Nellore</option>
                        </select>
                    </div>
                    <canvas id="dist-deliveryTimeChart" height="300"></canvas>
                </div>
            </div>

            <!-- Delivery Table -->
            <div class="data-section">
                <div class="section-header">
                    <h4 class="section-title">Delivery Management</h4>
                    <button class="btn btn-primary" id="dist-add-delivery-btn">
                        <i class="fas fa-plus"></i> Add Delivery
                    </button>
                </div>
                <div class="section-actions">
                    <input type="text" class="form-control" id="dist-search-input" placeholder="Search...">
                    <select class="form-control" id="dist-status-filter">
                        <option value="">All Status</option>
                        <option>Pending</option>
                        <option>In Transit</option>
                        <option>Delivered</option>
                        <option>Cancelled</option>
                    </select>
                    <select class="form-control" id="dist-region-table-filter">
                        <option value="">All Regions</option>
                        <option>Hyderabad</option>
                        <option>Vijayawada</option>
                        <option>Guntur</option>
                        <option>Visakhapatnam</option>
                        <option>Nellore</option>
                    </select>
                </div>
                <table class="custom-table" id="dist-deliveries-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Customer</th>
                            <th>Product</th>
                            <th>Quantity</th>
                            <th>Date</th>
                            <th>Address</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="dist-deliveries-table-body"></tbody>
                </table>
            </div>

            <!-- Delivery Modal -->
            <div class="modal" id="dist-delivery-modal">
                <div class="modal-content">
                    <button class="modal-close">&times;</button>
                    <h3 id="dist-modal-title">Add New Delivery</h3>
                    <form id="dist-delivery-form" class="settings-grid">
                        <input type="hidden" id="dist-edit-id">

                        <div class="form-group">
                            <label for="dist-customer">Customer</label>
                            <input type="text" id="dist-customer" class="form-control">
                            <div class="error" id="dist-customer-error">Customer name is required</div>
                        </div>

                        <div class="form-group">
                            <label for="dist-product">Product</label>
                            <select id="dist-product" class="form-control">
                                <option value="">Select Product</option>
                                <option>Full Cream Milk</option>
                                <option>Toned Milk</option>
                                <option>Paneer</option>
                                <option>Butter</option>
                                <option>Ghee</option>
                                <option>Yogurt</option>
                            </select>
                            <div class="error" id="dist-product-error">Please select a product</div>
                        </div>

                        <div class="form-group">
                            <label for="dist-quantity">Quantity</label>
                            <input type="text" id="dist-quantity" class="form-control">
                            <div class="error" id="dist-quantity-error">Please enter a valid quantity (e.g., 500L or 80kg)</div>
                        </div>

                        <div class="form-group">
                            <label for="dist-date">Delivery Date</label>
                            <input type="date" id="dist-date" class="form-control">
                            <div class="error" id="dist-date-error">Please select a valid date</div>
                        </div>

                        <div class="form-group">
                            <label for="dist-address">Address</label>
                            <input type="text" id="dist-address" class="form-control">
                            <div class="error" id="dist-address-error">Address is required</div>
                        </div>

                        <div class="form-group">
                            <label for="dist-amount">Amount (‚Çπ)</label>
                            <input type="number" id="dist-amount" class="form-control" min="1">
                            <div class="error" id="dist-amount-error">Please enter a valid amount</div>
                        </div>

                        <div class="form-group">
                            <label for="dist-status">Status</label>
                            <select id="dist-status" class="form-control">
                                <option value="Pending">Pending</option>
                                <option value="In Transit">In Transit</option>
                                <option value="Delivered">Delivered</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-success">Save Delivery</button>
                            <button type="button" class="btn btn-outline">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    



        <div class="section fade-in" id="retail">
            <div class="banner">Retail & Franchise Hub</div>

            <div class="card-grid" id="dashboard-kpis"></div>

            <div class="section-title">üó∫Ô∏è Zone Distribution</div>
            <div class="card-grid" id="region-blocks"></div>

            <div class="section-title">üîç Search & Filters</div>
            <div class="section-header">
                <input type="text" id="search-input" placeholder="Search by name or phone" class="form-control" />
                <select id="filter-type" class="form-control">
                    <option value="all">All Types</option>
                    <option value="retail">Retail</option>
                    <option value="franchise">Franchise</option>
                </select>
                <select id="filter-zone" class="form-control">
                    <option value="all">All Zones</option>
                    <option value="north">North</option>
                    <option value="south">South</option>
                    <option value="east">East</option>
                    <option value="west">West</option>
                </select>
                <select id="filter-status" class="form-control">
                    <option value="all">All Status</option>
                    <option value="setup">Setup</option>
                    <option value="pending">Pending</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                </select>
                <button id="open-add-modal" class="btn btn-primary">‚ûï Add Outlet</button>
                <div class="section-actions">
                    <button id="toggle-card" class="btn btn-outline active">üóÇÔ∏è Card View</button>
                    <button id="toggle-table" class="btn btn-outline">üìã Table View</button>
                </div>
            </div>

            <div id="outlet-card-list" class="card-grid"></div>

            <div id="outlet-table-container" class="data-section" style="display:none;">
                <div class="section-title">üìã Outlet Table</div>
                <table class="custom-table" id="outlet-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Zone</th>
                            <th>Owner</th>
                            <th>Contact</th>
                            <th>Status</th>
                            <th>Rating</th>
                            <th>Revenue</th>
                            <th>Expenses</th>
                            <th>Profit</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="section-title">üïí Recent Activity</div>
            <ul class="card-grid" id="activity-feed"></ul>

            <div class="section-title">üì¶ Setup Pipeline</div>
            <div class="card-grid" id="pipeline-board"></div>

            <div class="section-title">üó∫Ô∏è Outlet Map View (India)</div>
            <div class="map-container">
                <iframe id="full-map" width="100%" height="400" loading="lazy" allowfullscreen
                    referrerpolicy="no-referrer-when-downgrade"></iframe>
            </div>

            <div class="modal" id="add-outlet-modal">
                <div class="modal-content">
                    <div class="modal-title">Add Outlet</div>
                    <form id="add-outlet-form">
                        <div class="form-group">
                            <input type="text" name="name" placeholder="Outlet Name" class="form-control" required />
                        </div>
                        <div class="form-group">
                            <select name="type" class="form-control" required>
                                <option value="retail">Retail</option>
                                <option value="franchise">Franchise</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <select name="zone" class="form-control" required>
                                <option value="north">North</option>
                                <option value="south">South</option>
                                <option value="east">East</option>
                                <option value="west">West</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <input type="text" name="owner" placeholder="Owner Name" class="form-control" required />
                        </div>
                        <div class="form-group">
                            <input type="tel" name="contact" placeholder="Contact Number" class="form-control"
                                required />
                        </div>
                        <div class="form-group">
                            <select name="status" class="form-control" required>
                                <option value="setup">Setup</option>
                                <option value="pending">Pending</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <input type="number" name="rating" placeholder="Rating (1-5)" min="1" max="5"
                                class="form-control" required />
                        </div>
                        <div class="form-group">
                            <input type="number" name="revenue" placeholder="Monthly Revenue (‚Çπ)" class="form-control"
                                required />
                        </div>
                        <div class="form-group">
                            <input type="number" name="expenses" placeholder="Monthly Expenses (‚Çπ)" class="form-control"
                                required />
                        </div>
                        <div class="form-group">
                            <input type="number" name="latitude" step="0.0001" placeholder="Latitude"
                                class="form-control" required />
                        </div>
                        <div class="form-group">
                            <input type="number" name="longitude" step="0.0001" placeholder="Longitude"
                                class="form-control" required />
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Save</button>
                            <button type="button" class="btn btn-outline" id="close-modal">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="modal" id="info-modal">
                <div class="modal-content">
                    <div class="modal-title">Outlet Info</div>
                    <div id="info-details"></div>
                    <iframe id="info-map" width="100%" height="250" loading="lazy" allowfullscreen></iframe>
                    <div class="form-actions">
                        <button class="btn btn-outline" id="close-info">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="section fade-in" id="customers-section">

            <!-- Dashboard Cards -->
            <section id="cards-grid" style="display: flex;">
                <div class="card">
                    <i class="fas fa-users"></i>
                    <h3>Total Customers</h3>
                    <div class="value" id="totalCustomers">5</div>
                    <div class="trend"><i class="fas fa-arrow-up"></i> <span id="customerTrend">25%</span> from last
                        month</div>
                </div>
                <div class="card">
                    <i class="fas fa-shopping-cart"></i>
                    <h3>Active Orders</h3>
                    <div class="value" id="activeOrders">8</div>
                    <div class="trend"><i class="fas fa-arrow-up"></i> <span id="orderTrend">14%</span> from last week
                    </div>
                </div>
                <div class="card">
                    <i class="fas fa-rupee-sign"></i>
                    <h3>Total Sales</h3>
                    <div class="value" id="totalSales">‚Çπ15,840</div>
                    <div class="trend"><i class="fas fa-arrow-up"></i> <span id="salesTrend">18%</span> from last month
                    </div>
                </div>
                <div class="card">
                    <i class="fas fa-clock"></i>
                    <h3>Pending Payments</h3>
                    <div class="value" id="pendingPayments">‚Çπ3,220</div>
                    <div class="trend down"><i class="fas fa-arrow-down"></i> <span id="paymentTrend">5%</span> from
                        last week</div>
                </div>
            </section>

            <!-- Charts Section -->
            <section id="charts-section" class="chart-container">
                <div class="chart-card" class="chart-box">
                    <h3><i class="fas fa-chart-pie"></i> Product Sales Distribution</h3>
                    <canvas id="productChart"></canvas>
                </div>

                <div class="chart-card" class="chart-box">
                    <h3><i class="fas fa-chart-line"></i> Revenue by Customer Type</h3>
                    <canvas id="customerTypeChart"></canvas>
                </div>
            </section>

            <!-- Search, Filter, Export -->
            <section id="search-filter-export" class="section-header">
                <div class="search-box" class="section-actions">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Search customers...">
                </div>

                <select id="filterType">
                    <option value="">All Types</option>
                    <option value="retail">Retail</option>
                    <option value="wholesale">Wholesale</option>
                    <option value="consumer">End Consumer</option>
                </select>

                <div class="export-buttons">
                    <button id="exportCSV"><i class="fas fa-file-csv"></i> Export CSV</button>
                    <button id="exportPDF"><i class="fas fa-file-pdf"></i> Export PDF</button>
                </div>
            </section>

            <!-- Customer Table -->
            <section id="customer-table-section" class="data-section">
                <div class="table-header">
                    <h2><i class="fas fa-user-friends"></i> Customer Directory</h2>
                    <button class="btn btn-primary" id="addCustomerBtn"><i class="fas fa-plus"></i> Add
                        Customer</button>
                </div>

                <table class="custom-table" id="customerTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>Type</th>
                            <th>Credit Limit</th>
                            <th>Balance</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="customerTableBody">
                        <!-- Customer rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </section>

            <!-- Orders Section -->
            <section id="orders-section" class="data-section">
                <div class="table-header">
                    <h2><i class="fas fa-receipt"></i> Recent Orders</h2>
                    <select id="orderFilter">
                        <option value="all">All Orders</option>
                        <option value="paid">Paid</option>
                        <option value="pending">Pending</option>
                        <option value="partial">Partial</option>
                    </select>
                </div>

                <table class="orders-table" class="custom-table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="orderList">
                        <!-- Orders will be populated by JavaScript -->
                    </tbody>
                </table>
            </section>

            <!-- Recent Activity -->
            <section id="recent-activity" class="data-section">
                <h2><i class="fas fa-history"></i> Recent Activity</h2>

                <div id="activityList">
                    <!-- Activity will be populated by JavaScript -->
                </div>
            </section>

        </div>


        <div class="section fade-in" id="deliveries-section">
            <div class="tabs">
                <div class="tab active" onclick="showDeliveryTab('today')">Today</div>
                <div class="tab" onclick="showDeliveryTab('upcoming')">Upcoming</div>
                <div class="tab" onclick="showDeliveryTab('completed')">
                    Completed
                </div>
            </div>
            <div class="data-section">
                <div class="section-header">
                    <h2 class="section-title">Delivery Management</h2>
                    <div class="section-actions">
                        <button class="btn btn-outline" onclick="exportDeliveriesToPDF()">
                            <i class="fas fa-file-pdf"></i>
                            PDF
                        </button>
                        <button class="btn btn-outline" onclick="exportDeliveriesToExcel()">
                            <i class="fas fa-file-excel"></i>
                            Excel
                        </button>
                        <button class="btn btn-success" onclick="openDeliveryModal()">
                            <i class="fas fa-plus"></i>
                            Schedule Delivery
                        </button>
                    </div>
                </div>
                <table style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
                    <thead>
                        <tr>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Customer</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Date</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Time</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Items</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Quantity</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Status</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="deliveries-table">

                    </tbody>
                </table>
            </div>
        </div>

        <div class="section fade-in" id="payments-section">
            <!-- ‚úÖ FINAL Payments Section: Fully Functional, Clean, Persistent -->
            <div class="banner">Payments Dashboard</div>

            <!-- Summary Cards -->
            <div class="cards-grid">
                <div class="card"><i class="fas fa-wallet card-icon"></i>
                    <h3>Total Payments</h3>
                    <h2 id="totalPayments">‚Çπ0</h2>
                </div>
                <div class="card"><i class="fas fa-arrow-circle-up card-icon"></i>
                    <h3>Received</h3>
                    <h2 id="paymentsReceived">‚Çπ0</h2>
                </div>
                <div class="card"><i class="fas fa-arrow-circle-down card-icon"></i>
                    <h3>Pending</h3>
                    <h2 id="pendingPayments">‚Çπ0</h2>
                </div>
                <div class="card"><i class="fas fa-credit-card card-icon"></i>
                    <h3>Avg Per Payment</h3>
                    <h2 id="averagePayment">‚Çπ0</h2>
                </div>
            </div>

            <!-- Filters + Actions -->
            <div class="section-header">
                <div>
                    <strong>Filter by Date:</strong>
                    <input type="date" id="filterStart"> to <input type="date" id="filterEnd">
                    <button class="btn" onclick="applyDateFilter()">Apply</button>
                </div>
                <div class="section-actions">
                    <button class="btn btn-export" onclick="exportPayments('pdf')"><i class="fas fa-file-pdf"></i>
                        PDF</button>
                    <button class="btn btn-export" onclick="exportPayments('excel')"><i class="fas fa-file-excel"></i>
                        Excel</button>
                    <button class="btn btn-primary" onclick="openPaymentModal()">+ Add Payment</button>
                </div>
            </div>

            <!-- Table -->
            <div class="data-section">
                <h4>Payment Records</h4>
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Recipient</th>
                            <th>Type</th>
                            <th>Amount (‚Çπ)</th>
                            <th>Method</th>
                            <th>Status</th>
                            <th>Receipt</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="paymentsTableBody"></tbody>
                </table>
            </div>

            <!-- Charts Row 1 -->
            <div class="chart-container">
                <div class="chart-box">
                    <div class="chart-title">Monthly Payment Trends</div>
                    <canvas id="paymentTrendChart"></canvas>
                </div>
                <div class="chart-box">
                    <div class="chart-title">Payment Methods Used</div>
                    <canvas id="paymentMethodChart"></canvas>
                </div>
            </div>

            <!-- Charts Row 2 -->
            <div class="chart-container">
                <div class="chart-box">
                    <div class="chart-title">Status Breakdown</div>
                    <canvas id="paymentStatusChart"></canvas>
                </div>
                <div class="chart-box">
                    <div class="chart-title">Recipient Type Distribution</div>
                    <canvas id="paymentTypeChart"></canvas>
                </div>
            </div>
            <div class="flow-container">
                <div class="flow-step">
                    <div class="flow-icon"><i class="fas fa-file-invoice"></i></div>
                    <div class="flow-label">Invoice Generated</div>
                </div>
                <div class="flow-step">
                    <div class="flow-icon"><i class="fas fa-paper-plane"></i></div>
                    <div class="flow-label">Payment Sent</div>
                </div>
                <div class="flow-step">
                    <div class="flow-icon"><i class="fas fa-check-circle"></i></div>
                    <div class="flow-label">Status Verified</div>
                </div>
                <div class="flow-step">
                    <div class="flow-icon"><i class="fas fa-receipt"></i></div>
                    <div class="flow-label">Receipt Generated</div>
                </div>
            </div>
            <div class="info-box-grid"
                style="display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                <div class="info-box">
                    <h4>üß† Tips for Successful Transactions</h4>
                    <ul style="padding-left: 1.2rem;">
                        <li>Always confirm recipient details</li>
                        <li>Double-check invoice amounts</li>
                        <li>Review failed transactions weekly</li>
                    </ul>
                </div>
                <div class="info-box">
                    <h4>üìò Status Guide</h4>
                    <p><strong>Paid</strong> - Fully processed<br><strong>Pending</strong> - Awaiting
                        confirmation<br><strong>Failed</strong> - Error in processing</p>
                </div>
            </div>


            <!-- Activity Feed -->
            <div class="data-section">
                <h4>Persistent Activity Log</h4>
                <ul id="activityFeed" style="list-style:none; padding-left: 0;"></ul>
            </div>

            <!-- Payment Modal -->
            <div class="modal" id="paymentModal">
                <div class="modal-content">
                    <button class="modal-close" onclick="closePaymentModal()">&times;</button>
                    <h2 class="modal-title">Add / Edit Payment</h2>
                    <div class="form-group"><label>Date</label><input type="date" class="form-control" id="paymentDate">
                    </div>
                    <div class="form-group"><label>Recipient</label><input type="text" class="form-control"
                            id="paymentRecipient">
                    </div>
                    <div class="form-group"><label>Recipient Type</label><select id="paymentType" class="form-control">
                            <option>Customer</option>
                            <option>Supplier</option>
                        </select></div>
                    <div class="form-group"><label>Amount</label><input type="number" class="form-control"
                            id="paymentAmount">
                    </div>
                    <div class="form-group"><label>Method</label>
                        <select class="form-control" id="paymentMethod">
                            <option>Cash</option>
                            <option>UPI</option>
                            <option>Bank Transfer</option>
                            <option>Cheque</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Status</label>
                        <select class="form-control" id="paymentStatus">
                            <option>Received</option>
                            <option>Pending</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-success" onclick="savePayment()">Save</button>
                        <button class="btn btn-outline" onclick="closePaymentModal()">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Receipt Modal -->
            <div class="modal" id="receiptModal">
                <div class="modal-content">
                    <button class="modal-close" onclick="closeReceiptModal()">&times;</button>
                    <h2 class="modal-title">Payment Receipt</h2>
                    <div id="receiptContent"></div>
                </div>
            </div>


            <div class="data-section" style="display: none;">
                <div class="section-header">
                    <h2 class="section-title">Payment Records</h2>
                    <div class="section-actions">
                        <button class="btn btn-outline" onclick="filterPayments('all')">
                            All
                        </button>
                        <button class="btn btn-outline" onclick="filterPayments('pending')">
                            Pending
                        </button>
                        <button class="btn btn-outline" onclick="filterPayments('completed')">
                            Completed
                        </button>
                        <button class="btn btn-outline" onclick="exportPaymentsToPDF()">
                            <i class="fas fa-file-pdf"></i>
                            PDF
                        </button>
                        <button class="btn btn-outline" onclick="exportPaymentsToExcel()">
                            <i class="fas fa-file-excel"></i>
                            Excel
                        </button>
                        <button class="btn btn-success" onclick="openPaymentModal()">
                            <i class="fas fa-plus"></i>
                            Record Payment
                        </button>
                    </div>
                </div>
                <table style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
                    <thead>
                        <tr>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Payment ID</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Date</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Supplier</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Amount</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Method</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Status</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="payments-table">

                    </tbody>
                </table>
            </div>
        </div>

        <div class="section fade-in" id="reports-section">
            <div class="banner">Reports </div>
            <div class="chart-grid">
                <div class="chart-container"
                    style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div class="chart-header">
                        <h2 class="chart-title">Monthly Production</h2>
                    </div>
                    <canvas id="productionChart"></canvas>
                </div>
                <div class="chart-container"
                    style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div class="chart-header">
                        <h2 class="chart-title">Customer Growth</h2>
                    </div>
                    <canvas id="growthChart"></canvas>
                </div>
            </div>
            <div class="data-section">
                <div class="section-header">
                    <h2 class="section-title">Financial Summary</h2>
                    <div class="section-actions">
                        <button class="btn btn-outline" onclick="exportReportsToPDF()">
                            <i class="fas fa-file-pdf"></i>
                            PDF
                        </button>
                        <button class="btn btn-outline" onclick="exportReportsToExcel()">
                            <i class="fas fa-file-excel"></i>
                            Excel
                        </button>
                        <button class="btn btn-primary" onclick="generateReport()">
                            <i class="fas fa-file-export"></i>
                            Generate Report
                        </button>
                    </div>
                </div>
                <table style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
                    <thead>
                        <tr>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Period</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Revenue</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Expenses</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Profit</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">Milk Collected</th>
                            <th style="background: #f3f4f6; padding: 12px 16px; text-align: left;">New Customers</th>
                        </tr>
                    </thead>
                    <tbody id="reports-table">

                    </tbody>
                </table>
            </div>
        </div>

        <div class="section fade-in" id="settings-section">

            <div class="banner">Settings </div>

            <div class="settings-grid">
                <div class="setting-card">
                    <h3 class="setting-title">Appearance</h3>
                    <p class="setting-description">
                        Customize the look and feel of your dashboard
                    </p>
                    <div class="form-group">
                        <label for="theme-mode">Theme Mode</label>
                        <div class="switch">
                            <input id="theme-mode" onchange="toggleThemeMode()" type="checkbox" />
                            <span class="slider"></span>
                        </div>
                        <span id="theme-mode-label" style="margin-left: 10px">Dark Mode</span>
                    </div>
                </div>
                <div class="setting-card">
                    <h3 class="setting-title">Notifications</h3>
                    <p class="setting-description">
                        Configure how you receive notifications
                    </p>
                    <div class="form-group">
                        <label for="email-notifications">Email Notifications</label>
                        <div class="switch">
                            <input checked="" id="email-notifications" type="checkbox" />
                            <span class="slider"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="app-notifications">App Notifications</label>
                        <div class="switch">
                            <input checked="" id="app-notifications" type="checkbox" />
                            <span class="slider"></span>
                        </div>
                    </div>
                </div>
                <div class="setting-card">
                    <h3 class="setting-title">Data Management</h3>
                    <p class="setting-description">Manage your data and backups</p>
                    <div class="setting-actions">
                        <button class="btn btn-outline" onclick="backupData()">
                            <i class="fas fa-database"></i>
                            Backup Data
                        </button>
                        <button class="btn btn-outline" onclick="restoreData()">
                            <i class="fas fa-undo"></i>
                            Restore Data
                        </button>
                    </div>
                </div>
                <div class="setting-card">
                    <h3 class="setting-title">System Information</h3>
                    <p class="setting-description">View system details and version</p>
                    <div class="form-group">
                        <label>Version</label>
                        <p>DairyMaster Pro v2.1.0</p>
                    </div>
                    <div class="form-group">
                        <label>Last Updated</label>
                        <p>July 25, 2023</p>
                    </div>
                    <div class="setting-actions">
                        <button class="btn btn-primary" onclick="checkForUpdates()">
                            <i class="fas fa-sync-alt"></i>
                            Check for Updates
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="section fade-in" id="profile">
            <div class="banner">Profile Settings</div>
            <form class="profile-form" onsubmit="saveProfile();return false;">
                <label>Name:</label>
                <input id="pName" placeholder="Rekha Iyer" type="text" />
                <label>Email:</label>
                <input id="pEmail" placeholder="Enter your email" type="email" />
                <label>Phone:</label>
                <input id="pPhone" pattern="[6-9][0-9]{9}" placeholder="Enter 10-digit Indian number" required=""
                    title="Phone number must be 10 digits starting with 6,7,8 or 9" type="tel" />
                <label>Address:</label>
                <textarea id="pAddress" placeholder="Enter your address" rows="3"></textarea>
                <label>Language Preference:</label>
                <select id="pLanguage">
                    <option value="en">English</option>
                    <option value="hi">Hindi</option>
                    <option value="te">Telugu</option>
                    <option value="de">German</option>
                </select>
                <label>Work Mode:</label>
                <select id="pWorkMode">
                    <option value="active">Active</option>
                    <option value="away">Away</option>
                    <option value="dnd">Do Not Disturb</option>
                </select>
                <button type="submit">Save Changes</button>
            </form>
        </div>
    </div>

</body>



<script>
    function applyTheme(mode) {
        const html = document.documentElement;
        html.classList.toggle('dark-mode', mode === 'dark');
        localStorage.setItem('theme', mode);
        const icon = document.querySelector('#theme-toggle i');
        if (icon) {
            icon.className = mode === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }
        const label = document.getElementById("theme-mode-label");
        if (label) {
            label.textContent = mode === "dark" ? "Dark Mode" : "Light Mode";
            label.style.color = mode === "dark" ? "var(--dark)" : "var(--text)";
        }
        const toggleCheckbox = document.getElementById("theme-mode");
        if (toggleCheckbox) {
            toggleCheckbox.checked = (mode === 'dark');
        }
    }

    function toggleTheme() {
        const isDark = document.documentElement.classList.contains("dark-mode");
        applyTheme(isDark ? "light" : "dark");
    }

    document.addEventListener("DOMContentLoaded", () => {
        const savedTheme = localStorage.getItem("theme") || "light";
        applyTheme(savedTheme);

        const toggleBtn = document.getElementById("theme-toggle");
        if (toggleBtn) {
            toggleBtn.addEventListener("click", toggleTheme);
        }

        const themeCheckbox = document.getElementById("theme-mode");
        if (themeCheckbox) {
            themeCheckbox.addEventListener("change", () => {
                applyTheme(themeCheckbox.checked ? "dark" : "light");
            });
        }
    });



    // Auto-format phone input (prevents non-numbers and limits to 10 digits)
    document.getElementById("pPhone").addEventListener("input", function (e) {
        this.value = this.value.replace(/\D/g, '').substring(0, 10);
    });


    // ‚Äî‚Äî Sidebar toggle ‚Äî‚Äî
    function toggleSidebar() {
        document.getElementById("sidebar").classList.toggle("collapsed");
        document.querySelector(".main").classList.toggle("collapsed");
    }

    // ‚Äî‚Äî Navigation ‚Äî‚Äî
    function activateNav(el, sectionId) {
        document.querySelectorAll(".sidebar li").forEach((li) => li.classList.remove("active"));
        el.classList.add("active");
        document.querySelectorAll(".section").forEach((sec) => sec.classList.remove("active"));
        document.getElementById(sectionId).classList.add("active");
        window.scrollTo(0, 0);

        // Reinitialize maps when their sections are shown
        if (sectionId === 'farmer-mgmt' && farmerMap) {
            setTimeout(() => {
                farmerMap.invalidateSize();
            }, 300);
        }
        if (sectionId === 'logistics' && deliveryMap) {
            setTimeout(() => {
                deliveryMap.invalidateSize();
            }, 300);
        }
    }

    function showSection(sectionId) {
        const navItem = document.querySelector(`.sidebar li[onclick*="${sectionId}"]`);
        if (navItem) activateNav(navItem, sectionId);
    }

    // ‚Äî‚Äî Language & Work Mode ‚Äî‚Äî
    function setLanguage(lang) {
        const languages = { en: "English", hi: "Hindi", te: "Telugu", de: "German" };
        document.querySelector(".dropdown-btn span").className =
            (lang === "en" ? "green" : lang === "hi" ? "red" : "gray");
        document.querySelector(".dropdown-btn").innerHTML =
            `<span class=" ${lang === "en" ? "green" : lang === "hi" ? "red" : "gray"}"></span> ${languages[lang]}`;
        localStorage.setItem("language", lang);
    }

    function setWorkMode(mode) {
        const modes = { active: "Active", away: "Away", dnd: "Do Not Disturb" };
        document.querySelectorAll(".dropdown-btn")[1].innerHTML =
            `<span class="dot ${mode === "active" ? "green" : mode === "away" ? "gray" : "red"}"></span> ${modes[mode]}`;
        localStorage.setItem("workMode", mode);
    }

    // ‚Äî‚Äî Profile Save/Load ‚Äî‚Äî
    function saveProfile() {
        const phoneInput = document.getElementById("pPhone");
        const phoneValue = phoneInput.value.replace(/\D/g, ''); // Remove non-digits

        // Validate phone number
        if (!/^[6-9]\d{9}$/.test(phoneValue)) {
            alert("‚ùå Invalid Indian number! Must be 10 digits starting with 6,7,8 or 9");
            phoneInput.focus();
            return false;
        }

        const profile = {
            name: document.getElementById("pName").value,
            email: document.getElementById("pEmail").value,
            phone: "+91 " + phoneValue, // Format as +91 XXXXXXXXXX
            address: document.getElementById("pAddress").value,
            language: document.getElementById("pLanguage").value,
            workMode: document.getElementById("pWorkMode").value,
        };

        localStorage.setItem("profile", JSON.stringify(profile));
        document.querySelector(".profile-name").textContent = profile.name;
        setLanguage(profile.language);
        setWorkMode(profile.workMode);
        alert("‚úÖ Profile saved successfully!");
        return false; // Prevent form submission
    }

    function loadProfile() {
        const profile = JSON.parse(localStorage.getItem("profile")) || {};
        if (profile.name) {
            document.getElementById("pName").value = profile.name;
            document.getElementById("pEmail").value = profile.email || "";
            document.getElementById("pPhone").value = profile.phone || "";
            document.getElementById("pAddress").value = profile.address || "";
            document.getElementById("pLanguage").value = profile.language || "en";
            document.getElementById("pWorkMode").value = profile.workMode || "active";
            document.querySelector(".profile-name").textContent = profile.name;
            setLanguage(profile.language || "en");
            setWorkMode(profile.workMode || "active");
        }
    }

    function loadSettings() {
        document.getElementById("theme-mode").checked =
            appData.settings.darkMode;
        document.getElementById("email-notifications").checked =
            appData.settings.emailNotifications;
        document.getElementById("app-notifications").checked =
            appData.settings.appNotifications;
        updateThemeModeLabel();
    }

    // Settings functions
    function toggleTheme() {
        document.body.classList.toggle("dark-mode");
        appData.settings.darkMode =
            document.body.classList.contains("dark-mode");
        updateThemeModeLabel();
        updateCharts();
    }

    function toggleThemeMode() {
        document.body.classList.toggle(
            "dark-mode",
            document.getElementById("theme-mode").checked
        );
        appData.settings.darkMode =
            document.getElementById("theme-mode").checked;
        updateThemeModeLabel();
        updateCharts();
    }

    function updateThemeModeLabel() {
        const label = document.getElementById("theme-mode-label");
        label.textContent = appData.settings.darkMode
            ? "Dark Mode"
            : "Light Mode";
        label.style.color = appData.settings.darkMode
            ? "var(--dark)"
            : "var(--text)";
    }

    function backupData() {
        const dataStr = JSON.stringify(appData, null, 2);
        const dataUri =
            "data:application/json;charset=utf-8," + encodeURIComponent(dataStr);

        const exportName =
            "dairymaster_backup_" +
            new Date().toISOString().split("T")[0] +
            ".json";

        const linkElement = document.createElement("a");
        linkElement.setAttribute("href", dataUri);
        linkElement.setAttribute("download", exportName);
        linkElement.click();

        // Add activity
        appData.activities.unshift({
            id: getNextId(appData.activities),
            type: "Note",
            content: "System data backup created",
            user: "System",
            time: getCurrentTime(),
        });
        loadActivities();
    }

    function restoreData() {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".json";

        input.onchange = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();

            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    Object.assign(appData, data);

                    // Reload all data
                    loadCustomers();
                    loadSuppliers();
                    loadDeliveries();
                    loadPayments();
                    loadActivities();
                    loadReports();
                    loadSettings();
                    updateCharts();

                    // Add activity
                    appData.activities.unshift({
                        id: getNextId(appData.activities),
                        type: "Note",
                        content: "System data restored from backup",
                        user: "System",
                        time: getCurrentTime(),
                    });
                    loadActivities();

                    alert("Data restored successfully!");
                } catch (err) {
                    alert("Error restoring data: Invalid file format");
                    console.error(err);
                }
            };

            reader.readAsText(file);
        };

        input.click();
    }

    function checkForUpdates() {
        // Simulate update check
        setTimeout(() => {
            alert("Your system is up to date!");

            // Add activity
            appData.activities.unshift({
                id: getNextId(appData.activities),
                type: "Note",
                content: "Checked for system updates",
                user: "System",
                time: getCurrentTime(),
            });
            loadActivities();
        }, 1000);
    }

    function generateReport() {
        // Simulate report generation
        setTimeout(() => {
            alert("Financial report generated successfully!");

            // Add activity
            appData.activities.unshift({
                id: getNextId(appData.activities),
                type: "Note",
                content: "Generated financial report",
                user: "Admin",
                time: getCurrentTime(),
            });
            loadActivities();
        }, 1000);
    }

    // Helper functions
    function getNextId(items) {
        return items.length > 0
            ? Math.max(...items.map((item) => item.id)) + 1
            : 1;
    }

    function getCurrentTime() {
        return (
            "Today, " +
            new Date().toLocaleTimeString("en-US", {
                hour: "2-digit",
                minute: "2-digit",
            })
        );
    }

    document.querySelectorAll('.chart-actions').forEach(actionGroup => {
        const buttons = actionGroup.querySelectorAll('.chart-btn');
        buttons.forEach(btn => {
            btn.addEventListener('click', () => {
                buttons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
        });
    });

    // Fix chart button active toggle behavior
    document.querySelectorAll('.chart-actions').forEach(container => {
        container.querySelectorAll('.chart-btn').forEach(button => {
            button.addEventListener('click', () => {
                container.querySelectorAll('.chart-btn').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
            });
        });
    });

    // Fix modal close button functionality
    function closeModal() {
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.style.display = 'none';
        });
    }

    // Attach event listeners for close buttons (ensures all future modals are covered)
    document.addEventListener('click', function (event) {
        if (event.target.matches('.modal-content button') || event.target.matches('.modal-close')) {
            closeModal();
        }
    });

    // Sidebar dropdown accordion behavior
    document.querySelectorAll(".sidebar li.nav-item").forEach(item => {
        item.addEventListener("click", function () {
            const submenu = this.querySelector(".submenu");
            const arrow = this.querySelector(".dropdown-toggle span:last-child");
            const isOpen = submenu && submenu.style.display === "block";
            submenu.style.display = isOpen ? "none" : "block";
            arrow.textContent = isOpen ? "‚åÉ" : "‚åÑ";
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
        const navItems = document.querySelectorAll(".sidebar .nav-item");

        navItems.forEach(item => {
            const toggle = item.querySelector(".dropdown-toggle");
            const submenu = item.querySelector(".submenu");
            const arrow = toggle ? toggle.querySelector("span:last-child") : null;

            if (toggle && submenu && arrow) {
                submenu.style.display = "none"; // Ensure all start closed

                toggle.addEventListener("click", function (e) {
                    e.stopPropagation();

                    const isOpen = submenu.style.display === "block";

                    // Close all others
                    document.querySelectorAll(".sidebar .submenu").forEach(sub => sub.style.display = "none");
                    document.querySelectorAll(".sidebar .dropdown-toggle span:last-child").forEach(a => a.textContent = "‚åÉ");

                    // Toggle current
                    submenu.style.display = isOpen ? "none" : "block";
                    arrow.textContent = isOpen ? "‚åÉ" : "‚åÑ";
                });
            }
        });
    });

    function applyTheme(mode) {
        const html = document.documentElement;
        html.classList.toggle('dark-mode', mode === 'dark');
        localStorage.setItem('theme', mode);
        const icon = document.querySelector('#theme-toggle i');
        if (icon) {
            icon.className = mode === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }
        const label = document.getElementById("theme-mode-label");
        if (label) {
            label.textContent = mode === "dark" ? "Dark Mode" : "Light Mode";
            label.style.color = mode === "dark" ? "var(--dark)" : "var(--text)";
        }
        const toggleCheckbox = document.getElementById("theme-mode");
        if (toggleCheckbox) {
            toggleCheckbox.checked = (mode === 'dark');
        }
    }

    function toggleTheme() {
        const isDark = document.documentElement.classList.contains("dark-mode");
        applyTheme(isDark ? "light" : "dark");
    }

    function toggleThemeMode() {
        document.body.classList.toggle(
            "dark-mode",
            document.getElementById("theme-mode").checked
        );
        appData.settings.darkMode =
            document.getElementById("theme-mode").checked;
        updateThemeModeLabel();
        updateCharts();
    }

    document.addEventListener("DOMContentLoaded", () => {
        const savedTheme = localStorage.getItem("theme") || "light";
        applyTheme(savedTheme);

        const toggleBtn = document.getElementById("theme-toggle");
        if (toggleBtn) {
            toggleBtn.addEventListener("click", toggleTheme);
        }

        const themeCheckbox = document.getElementById("theme-mode");
        if (themeCheckbox) {
            themeCheckbox.addEventListener("change", () => {
                applyTheme(themeCheckbox.checked ? "dark" : "light");
            });
        }
    });

    // Close modal on clicking the X button
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.modal-close').forEach(button => {
            button.addEventListener('click', () => {
                const modal = button.closest('.modal');
                if (modal) modal.style.display = 'none';
            });
        });

        // Optional: close modal on clicking outside modal content
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', e => {
                if (e.target === modal) modal.style.display = 'none';
            });
        });
    });
</script>





<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/charts/loader.js"></script>
<script>
    let dashboardData = [];
    let editIndex = -1;
    let dashboardChart;
    let polarChart;

    // Validation functions
    function validateForm() {
        const customer = document.getElementById("inputCustomer").value.trim();
        const milk = document.getElementById("inputMilk").value;
        const revenue = document.getElementById("inputRevenue").value;
        const date = document.getElementById("inputDate").value;

        let isValid = true;
        const errors = [];

        // Reset errors
        document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.form-control').forEach(el => el.classList.remove('error'));
        document.getElementById('validationSummary').style.display = 'none';

        // Validate customer
        if (!customer) {
            document.getElementById('customerError').style.display = 'block';
            document.getElementById('inputCustomer').classList.add('error');
            isValid = false;
            errors.push("Customer name is required");
        }

        // Validate milk
        if (!milk || parseFloat(milk) < 1) {
            document.getElementById('milkError').style.display = 'block';
            document.getElementById('inputMilk').classList.add('error');
            isValid = false;
            errors.push("Milk quantity must be at least 1L");
        }

        // Validate revenue
        if (!revenue || parseFloat(revenue) <= 0) {
            document.getElementById('revenueError').style.display = 'block';
            document.getElementById('inputRevenue').classList.add('error');
            isValid = false;
            errors.push("Revenue must be a positive number");
        }

        // Validate date
        const today = new Date().toISOString().split('T')[0];
        if (!date || date > today) {
            document.getElementById('dateError').style.display = 'block';
            document.getElementById('inputDate').classList.add('error');
            isValid = false;
            errors.push("Date is required and cannot be in the future");
        }

        // Show validation summary if errors exist
        if (errors.length > 0) {
            const summary = document.getElementById('validationSummary');
            summary.innerHTML = '<strong>Please fix the following errors:</strong><ul>' +
                errors.map(e => `<li>${e}</li>`).join('') + '</ul>';
            summary.style.display = 'block';
        }

        return isValid;
    }

    // Open modal for new or existing entry
    function openDashboardModal(index = -1) {
        editIndex = index;
        const modal = document.getElementById("dashboardModal");
        modal.style.display = "flex";

        // Reset validation
        document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.form-control').forEach(el => el.classList.remove('error'));
        document.getElementById('validationSummary').style.display = 'none';

        // Set modal title
        document.getElementById('modalTitle').textContent =
            index >= 0 ? "Edit Sale" : "Add Sale";

        if (index >= 0) {
            const row = dashboardData[index];
            document.getElementById("inputCustomer").value = row.customer;
            document.getElementById("inputMilk").value = row.milk;
            document.getElementById("inputRevenue").value = row.revenue;
            document.getElementById("inputDate").value = row.date;
            document.getElementById("inputStatus").value = row.status;
        } else {
            document.querySelectorAll("#dashboardModal input, #dashboardModal select").forEach(i => i.value = "");
            // Set today as default date
            document.getElementById("inputDate").value = new Date().toISOString().split('T')[0];
        }
    }

    function closeDashboardModal() {
        document.getElementById("dashboardModal").style.display = "none";
        editIndex = -1;
    }

    function saveDashboardRecord() {
        if (!validateForm()) {
            return;
        }

        const customer = document.getElementById("inputCustomer").value.trim();
        const milk = parseFloat(document.getElementById("inputMilk").value);
        const revenue = parseFloat(document.getElementById("inputRevenue").value);
        const date = document.getElementById("inputDate").value;
        const status = document.getElementById("inputStatus").value;

        const record = { customer, milk, revenue, date, status };

        if (editIndex >= 0) {
            dashboardData[editIndex] = record;
            logDashboardActivity(`‚úèÔ∏è Edited record for <b>${customer}</b>`);
        } else {
            dashboardData.push(record);
            logDashboardActivity(`üÜï Added new record for <b>${customer}</b>`);
        }

        closeDashboardModal();
        renderDashboardTable();
        updateDashboardCards();
        updateDashboardChart();
        updatePolarChart();
    }

    function deleteDashboardRecord(index) {
        const customer = dashboardData[index].customer;
        if (confirm(`Delete record for ${customer}?`)) {
            dashboardData.splice(index, 1);
            logDashboardActivity(`üóëÔ∏è Deleted record of <b>${customer}</b>`);
            renderDashboardTable();
            updateDashboardCards();
            updateDashboardChart();
            updatePolarChart();
        }
    }

    function renderDashboardTable() {
        const tbody = document.getElementById("dashboardTableBody");
        const search = document.getElementById("dashboardSearch").value.toLowerCase();
        tbody.innerHTML = "";

        dashboardData.forEach((r, i) => {
            if (
                r.customer.toLowerCase().includes(search) ||
                r.status.toLowerCase().includes(search) ||
                r.date.includes(search)
            ) {
                const row = `<tr>
                        <td>${r.customer}</td>
                        <td>${r.milk.toFixed(1)}</td>
                        <td>‚Çπ${r.revenue.toFixed(2)}</td>
                        <td>${r.date}</td>
                        <td><span class="status ${r.status === "Completed" ? "status-active" : "status-inactive"}">${r.status}</span></td>
                        <td>
                            <button class="action-btn" onclick="openDashboardModal(${i})" title="Edit"><i class="fas fa-edit"></i></button>
                            <button class="action-btn" onclick="deleteDashboardRecord(${i})" title="Delete"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                tbody.innerHTML += row;
            }
        });
    }

    function updateDashboardCards() {
        const totalMilk = dashboardData.reduce((sum, r) => sum + r.milk, 0);
        const totalRevenue = dashboardData.reduce((sum, r) => sum + r.revenue, 0);
        const customerSet = new Set(dashboardData.map(r => r.customer));
        const totalCustomers = customerSet.size;

        document.getElementById("cardTotalMilk").textContent = totalMilk.toFixed(1);
        document.getElementById("cardTotalRevenue").textContent = "‚Çπ" + totalRevenue.toFixed(2);
        document.getElementById("cardTotalCustomers").textContent = totalCustomers;

        // Calculate changes
        const prevTotalMilk = parseFloat(document.getElementById("cardTotalMilk").dataset.prev) || 0;
        const prevTotalRevenue = parseFloat(document.getElementById("cardTotalRevenue").dataset.prev) || 0;
        const prevTotalCustomers = parseInt(document.getElementById("cardTotalCustomers").dataset.prev) || 0;

        // Save current values for next calculation
        document.getElementById("cardTotalMilk").dataset.prev = totalMilk;
        document.getElementById("cardTotalRevenue").dataset.prev = totalRevenue;
        document.getElementById("cardTotalCustomers").dataset.prev = totalCustomers;

        // Calculate and display changes
        const milkChange = totalMilk - prevTotalMilk;
        const revenueChange = totalRevenue - prevTotalRevenue;
        const customerChange = totalCustomers - prevTotalCustomers;

        function formatChange(value, prefix = "") {
            if (value === 0) return "No change";
            const sign = value > 0 ? "+" : "";
            return `${prefix}${sign}${value.toFixed(2)}`;
        }

        document.getElementById("cardChangeMilk").textContent = formatChange(milkChange, "L");
        document.getElementById("cardChangeMilk").className = `card-change ${milkChange >= 0 ? 'positive' : 'negative'}`;

        document.getElementById("cardChangeRevenue").textContent = formatChange(revenueChange, "‚Çπ");
        document.getElementById("cardChangeRevenue").className = `card-change ${revenueChange >= 0 ? 'positive' : 'negative'}`;

        document.getElementById("cardChangeCustomers").textContent = formatChange(customerChange);
        document.getElementById("cardChangeCustomers").className = `card-change ${customerChange >= 0 ? 'positive' : 'negative'}`;
    }

    function updateDashboardChart() {
        const container = document.getElementById('dashboardChart');
        container.innerHTML = '';

        if (dashboardData.length === 0) {
            container.innerHTML = '<div class="no-data">No data available for chart</div>';
            return;
        }

        // Aggregate data by date
        const dataByDate = {};
        dashboardData.forEach(r => {
            if (!dataByDate[r.date]) {
                dataByDate[r.date] = { milk: 0, revenue: 0 };
            }
            dataByDate[r.date].milk += r.milk;
            dataByDate[r.date].revenue += r.revenue;
        });

        const dates = Object.keys(dataByDate).sort();
        const milkData = dates.map(date => dataByDate[date].milk);
        const revenueData = dates.map(date => dataByDate[date].revenue);

        // Create chart using Chart.js since Google Charts was causing issues
        const ctx = document.createElement('canvas');
        ctx.height = 400;
        container.appendChild(ctx);

        if (dashboardChart) dashboardChart.destroy();

        dashboardChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: dates,
                datasets: [
                    {
                        label: 'Milk (L)',
                        data: milkData,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Revenue (‚Çπ)',
                        data: revenueData,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1,
                        type: 'line',
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Milk (L)'
                        }
                    },
                    y1: {
                        position: 'right',
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Revenue (‚Çπ)'
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Revenue and Milk Trends Over Time'
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                if (context.parsed.y !== null) {
                                    if (context.datasetIndex === 0) {
                                        label += context.parsed.y.toFixed(1) + 'L';
                                    } else {
                                        label += '‚Çπ' + context.parsed.y.toFixed(2);
                                    }
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    function updatePolarChart() {
        const ctx = document.getElementById('polarChart').getContext('2d');

        if (dashboardData.length === 0) {
            if (polarChart) polarChart.destroy();
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

            // Draw "No data" message
            ctx.fillStyle = '#999';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('No data available for chart', ctx.canvas.width / 2, ctx.canvas.height / 2);
            return;
        }

        // Aggregate data by customer
        const dataByCustomer = {};
        dashboardData.forEach(r => {
            if (!dataByCustomer[r.customer]) {
                dataByCustomer[r.customer] = { milk: 0, revenue: 0 };
            }
            dataByCustomer[r.customer].milk += r.milk;
            dataByCustomer[r.customer].revenue += r.revenue;
        });

        const customers = Object.keys(dataByCustomer);
        const revenueData = customers.map(customer => dataByCustomer[customer].revenue);

        // Generate colors
        const colors = generateColors(customers.length);

        if (polarChart) polarChart.destroy();

        polarChart = new Chart(ctx, {
            type: 'polarArea',
            data: {
                labels: customers,
                datasets: [{
                    data: revenueData,
                    backgroundColor: colors,
                    borderColor: '#fff',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'right' },
                    title: {
                        display: true,
                        text: 'Customer Revenue Distribution'
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return `${context.label}: ‚Çπ${context.raw.toFixed(2)}`;
                            }
                        }
                    }
                },
                scales: {
                    r: {
                        ticks: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    function generateColors(count) {
        const colors = [];
        const hueStep = 360 / count;

        for (let i = 0; i < count; i++) {
            const hue = i * hueStep;
            colors.push(`hsla(${hue}, 70%, 60%, 0.7)`);
        }

        return colors;
    }

    function logDashboardActivity(message) {
        const log = document.getElementById("dashboardActivity");
        const time = new Date().toLocaleTimeString();
        const item = document.createElement("li");
        item.innerHTML = `<span style="color:#888">${time}</span> ‚Äî ${message}`;

        // Add fade-in animation
        item.style.opacity = 0;
        item.style.transition = 'opacity 0.5s';

        log.prepend(item);

        // Trigger reflow to apply animation
        setTimeout(() => {
            item.style.opacity = 1;
        }, 10);

        // Limit to 10 items
        if (log.children.length > 10) {
            log.removeChild(log.lastChild);
        }
    }

    function exportDashboardChart() {
        if (!polarChart) {
            alert("No chart data to export");
            return;
        }

        const canvas = document.getElementById("polarChart");
        const url = canvas.toDataURL("image/png");

        const a = document.createElement('a');
        a.href = url;
        a.download = 'customer-revenue-distribution.png';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    // Initialize
    window.addEventListener("DOMContentLoaded", () => {
        // Sample data
        dashboardData = [
            { customer: "Ravi Kumar", milk: 120, revenue: 4800, date: "2025-06-01", status: "Completed" },
            { customer: "Anjali Dairy", milk: 75.5, revenue: 3120, date: "2025-06-02", status: "Pending" },
            { customer: "Govind Traders", milk: 150, revenue: 6000, date: "2025-06-03", status: "Completed" },
            { customer: "Lakshmi Dairy", milk: 90.25, revenue: 3780, date: "2025-06-04", status: "Completed" },
            { customer: "Sharma Milk Center", milk: 110, revenue: 4620, date: "2025-06-05", status: "Completed" },
            { customer: "Patel Dairy Farm", milk: 85.75, revenue: 3515, date: "2025-06-06", status: "Pending" }
        ];

        renderDashboardTable();
        updateDashboardCards();
        updateDashboardChart();
        updatePolarChart();
        logDashboardActivity("üìÖ Dashboard initialized with sample data");

        document.getElementById("dashboardSearch").addEventListener("input", renderDashboardTable);
    });
</script>


<script src="https://www.gstatic.com/charts/loader.js"></script>


<script>
    // Namespace pattern to avoid conflicts
    const farmerMgmt = (function () {
        // Farmer data with realistic coordinates (lat, lon)
        let farmers = [
            {
                name: "Lakshmi Nair",
                region: "Kerala South",
                milk: 120,
                latitude: 9.9312,
                longitude: 76.2673,
            },
            {
                name: "Ramesh Patel",
                region: "Gujarat West",
                milk: 95,
                latitude: 22.3072,
                longitude: 73.1812,
            },
            {
                name: "Anita Singh",
                region: "Uttar Pradesh North",
                milk: 110,
                latitude: 26.8467,
                longitude: 80.9462,
            },
            {
                name: "Suresh Kumar",
                region: "Tamil Nadu South",
                milk: 130,
                latitude: 13.0827,
                longitude: 80.2707,
            },
            {
                name: "Geeta Sharma",
                region: "Rajasthan West",
                milk: 85,
                latitude: 26.9124,
                longitude: 75.7873,
            },
            {
                name: "Rajesh Verma",
                region: "Punjab North",
                milk: 105,
                latitude: 31.6340,
                longitude: 74.8723,
            },
            {
                name: "Meena Devi",
                region: "Bihar East",
                milk: 90,
                latitude: 25.0961,
                longitude: 85.3131,
            },
            {
                name: "Vikram Reddy",
                region: "Andhra Pradesh South",
                milk: 115,
                latitude: 17.3850,
                longitude: 78.4867,
            }
        ];
        let currentPage = 1;
        const rowsPerPage = 4;
        let markers = [];
        let map;
        let chartsLoaded = false;

        // DOM References
        const nameInput = document.getElementById("name");
        const regionInput = document.getElementById("region");
        const milkInput = document.getElementById("milk");
        const latitudeInput = document.getElementById("latitude");
        const longitudeInput = document.getElementById("longitude");
        const editIndexInput = document.getElementById("editIndex");
        const farmerForm = document.getElementById("farmerForm");
        const tableBody = document.getElementById("farmerTableBody");
        const searchInput = document.getElementById("searchInput");
        const regionFilter = document.getElementById("regionFilter");
        const activityLog = document.getElementById("activityLog");
        const paginationControls = document.getElementById("paginationControls");

        // Initialize Google Charts
        google.charts.load('current', { packages: ['corechart'] });
        google.charts.setOnLoadCallback(() => {
            chartsLoaded = true;
            updateCharts();
        });

        // Initialize Google Maps with fallback
        function initMap() {
            // Try to load Google Maps API
            const script = document.createElement('script');
            script.src = 'https://maps.googleapis.com/maps/api/js?callback=farmerMgmt.initGoogleMap&key=YOUR_API_KEY';
            script.async = true;
            script.defer = true;
            script.onerror = () => {
                console.error('Failed to load Google Maps API');
                showMapFallback();
            };
            document.head.appendChild(script);
        }

        // Initialize Google Maps once API is loaded
        function initGoogleMap() {
            try {
                // Default center (India)
                const center = { lat: 20.5937, lng: 78.9629 };

                // Create map
                map = new google.maps.Map(document.getElementById("map"), {
                    zoom: 5,
                    center: center,
                    mapTypeId: 'roadmap',
                    styles: [
                        {
                            featureType: "poi",
                            stylers: [{ visibility: "off" }]
                        }
                    ]
                });

                updateMapMarkers();
            } catch (error) {
                console.error('Error initializing Google Maps:', error);
                showMapFallback();
            }
        }

        // Fallback when Google Maps fails to load
        function showMapFallback() {
            document.getElementById('map-fallback').style.display = 'block';
            document.getElementById('map').style.background = '#f5f5f5';
            updateCoordinatesDisplay();
        }

        // Display coordinates as text when map fails
        function updateCoordinatesDisplay() {
            const filteredFarmers = getFilteredFarmers();
            const display = document.getElementById('coordinates-display');
            display.innerHTML = '';

            if (filteredFarmers.length === 0) {
                display.innerHTML = '<p>No farmers to display</p>';
                return;
            }

            const list = document.createElement('ul');
            list.style.listStyle = 'none';
            list.style.padding = '0';

            filteredFarmers.forEach(f => {
                const item = document.createElement('li');
                item.style.margin = '5px 0';
                item.innerHTML = `<strong>${f.name}</strong>: ${f.latitude.toFixed(6)}, ${f.longitude.toFixed(6)}`;
                list.appendChild(item);
            });

            display.appendChild(list);
        }

        // Add markers to map
        function updateMapMarkers() {
            if (!map) return;

            // Clear existing markers
            markers.forEach(marker => marker.setMap(null));
            markers = [];

            const filteredFarmers = getFilteredFarmers();

            if (filteredFarmers.length === 0) return;

            // Create bounds to fit all markers
            const bounds = new google.maps.LatLngBounds();

            filteredFarmers.forEach(f => {
                if (typeof f.latitude === 'number' && !isNaN(f.latitude) &&
                    (typeof f.longitude === 'number' && !isNaN(f.longitude))) {
                    const position = { lat: f.latitude, lng: f.longitude };
                    const marker = new google.maps.Marker({
                        position: position,
                        map: map,
                        title: f.name
                    });

                    // Add info window
                    const infoWindow = new google.maps.InfoWindow({
                        content: `<b>${f.name}</b><br>${f.region}<br>Milk: ${f.milk} L`
                    });

                    marker.addListener('click', () => {
                        infoWindow.open(map, marker);
                    });

                    markers.push(marker);
                    bounds.extend(position);
                }
            });

            // Fit map to bounds if we have markers
            if (markers.length > 0) {
                if (markers.length === 1) {
                    map.setCenter(bounds.getCenter());
                    map.setZoom(10);
                } else {
                    map.fitBounds(bounds);
                }
            }
        }

        function getFilteredFarmers() {
            const searchVal = searchInput.value.trim().toLowerCase();
            const regionVal = regionFilter.value;
            return farmers.filter((f) => {
                let matchesSearch =
                    f.name.toLowerCase().includes(searchVal) ||
                    f.region.toLowerCase().includes(searchVal);
                let matchesRegion = regionVal === "" || f.region === regionVal;
                return matchesSearch && matchesRegion;
            });
        }

        function renderFarmers() {
            const filteredFarmers = getFilteredFarmers();

            const start = (currentPage - 1) * rowsPerPage;
            const paginatedFarmers = filteredFarmers.slice(start, start + rowsPerPage);

            tableBody.innerHTML = "";
            paginatedFarmers.forEach((f, i) => {
                const globalIndex = farmers.indexOf(f);
                const tr = document.createElement("tr");
                tr.innerHTML = `
                <td>${f.name}</td>
                <td>${f.region}</td>
                <td>${f.milk.toFixed(2)}</td>
                <td>${f.latitude.toFixed(6)}</td>
                <td>${f.longitude.toFixed(6)}</td>
                <td>
                    <button class="btn-edit" onclick="farmerMgmt.editFarmer(${globalIndex})">Edit</button>
                    <button class="btn-delete" onclick="farmerMgmt.confirmDelete(${globalIndex})">Delete</button>
                </td>`;
                tableBody.appendChild(tr);
            });

            updatePagination(filteredFarmers.length);
            updateRegionFilter();
            updateSummary();
            updateCharts();

            // Update map or coordinates display based on what's available
            if (typeof google !== 'undefined' && google.maps) {
                updateMapMarkers();
            } else {
                updateCoordinatesDisplay();
            }
        }

        function updatePagination(totalItems) {
            paginationControls.innerHTML = "";
            const totalPages = Math.ceil(totalItems / rowsPerPage);

            if (totalPages <= 1) return;

            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement("button");
                btn.textContent = i;
                if (i === currentPage) {
                    btn.classList.add("active");
                    btn.disabled = true;
                }
                btn.onclick = () => {
                    currentPage = i;
                    renderFarmers();
                };
                paginationControls.appendChild(btn);
            }
        }

        function updateRegionFilter() {
            const regions = Array.from(new Set(farmers.map((f) => f.region))).sort();
            const current = regionFilter.value;
            regionFilter.innerHTML = `<option value="">All Regions</option>`;
            regions.forEach((r) => {
                const option = document.createElement("option");
                option.value = r;
                option.textContent = r;
                if (r === current) option.selected = true;
                regionFilter.appendChild(option);
            });
        }

        function updateSummary() {
            document.getElementById("totalFarmers").textContent = farmers.length;
            const totalMilk = farmers.reduce((acc, f) => acc + f.milk, 0);
            document.getElementById("totalMilk").textContent = totalMilk.toFixed(2);
            document.getElementById(
                "activeRegions"
            ).textContent = new Set(farmers.map((f) => f.region)).size;
        }

        function editFarmer(i) {
            const f = farmers[i];
            nameInput.value = f.name;
            regionInput.value = f.region;
            milkInput.value = f.milk;
            latitudeInput.value = f.latitude;
            longitudeInput.value = f.longitude;
            editIndexInput.value = i;
            window.scrollTo({ top: 0, behavior: "smooth" });
        }

        function resetForm() {
            editIndexInput.value = "-1";
            farmerForm.reset();
            clearAllErrors();
        }

        function confirmDelete(i) {
            showModal(`Are you sure you want to delete farmer: ${farmers[i].name}?`, () => {
                logActivity(`Deleted farmer: ${farmers[i].name}`);
                farmers.splice(i, 1);
                saveToLocalStorage();
                if ((currentPage - 1) * rowsPerPage >= farmers.length && currentPage > 1) {
                    currentPage--;
                }
                renderFarmers();
                showToast("Farmer deleted successfully.");
            });
        }

        // Modal functionality
        const modal = document.getElementById("modal");
        const modalMessage = document.getElementById("modalMessage");
        let modalCallback = null;

        function showModal(msg, callback) {
            modalMessage.textContent = msg;
            modal.style.display = "flex";
            modalCallback = callback;
        }

        function closeModal() {
            modal.style.display = "none";
            modalCallback = null;
        }

        function confirmModal() {
            if (modalCallback) modalCallback();
            closeModal();
        }

        // Toast notifications
        function showToast(msg) {
            const toastContainer = document.getElementById("toastContainer");
            if (!toastContainer) {
                const container = document.createElement("div");
                container.id = "toastContainer";
                container.style.position = "fixed";
                container.style.top = "20px";
                container.style.right = "20px";
                container.style.zIndex = "10000";
                document.body.appendChild(container);
            }

            const toast = document.createElement("div");
            toast.className = "toast";
            toast.textContent = msg;
            document.getElementById("toastContainer").appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Export CSV
        function exportToCSV() {
            const filtered = getFilteredFarmers();
            let csv = "Name,Region,Milk (L),Latitude,Longitude\n";
            filtered.forEach((f) => {
                csv += `"${f.name}","${f.region}",${f.milk.toFixed(
                    2
                )},${f.latitude},${f.longitude}\n`;
            });
            const blob = new Blob([csv], { type: "text/csv" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "farmers.csv";
            a.click();
            URL.revokeObjectURL(url);
            showToast("CSV Exported!");
        }

        // Form validation
        function validateForm() {
            let isValid = true;
            clearAllErrors();

            // Name validation
            const name = nameInput.value.trim();
            if (!name) {
                showError(nameInput, "Name is required", "name-error");
                isValid = false;
            } else if (!/^[A-Za-z\s.'-]{2,100}$/.test(name)) {
                showError(nameInput, "Invalid name format (2-100 characters)", "name-error");
                isValid = false;
            }

            // Region validation
            const region = regionInput.value.trim();
            if (!region) {
                showError(regionInput, "Region is required", "region-error");
                isValid = false;
            } else if (!/^[A-Za-z0-9\s.'-]{2,50}$/.test(region)) {
                showError(regionInput, "Invalid region format (2-50 characters)", "region-error");
                isValid = false;
            }

            // Milk validation
            const milk = parseFloat(milkInput.value);
            if (isNaN(milk)) {
                showError(milkInput, "Milk quantity is required", "milk-error");
                isValid = false;
            } else if (milk < 0) {
                showError(milkInput, "Milk quantity cannot be negative", "milk-error");
                isValid = false;
            } else if (milk > 10000) {
                showError(milkInput, "Milk quantity is too high", "milk-error");
                isValid = false;
            }

            // Latitude validation
            const latitude = parseFloat(latitudeInput.value);
            if (isNaN(latitude)) {
                showError(latitudeInput, "Latitude is required", "latitude-error");
                isValid = false;
            } else if (latitude < -90 || latitude > 90) {
                showError(latitudeInput, "Latitude must be between -90 and 90", "latitude-error");
                isValid = false;
            }

            // Longitude validation
            const longitude = parseFloat(longitudeInput.value);
            if (isNaN(longitude)) {
                showError(longitudeInput, "Longitude is required", "longitude-error");
                isValid = false;
            } else if (longitude < -180 || longitude > 180) {
                showError(longitudeInput, "Longitude must be between -180 and 180", "longitude-error");
                isValid = false;
            }

            return isValid;
        }

        function showError(input, message, errorId) {
            const errorElement = document.getElementById(errorId);
            errorElement.textContent = message;
            errorElement.style.display = "block";
            input.classList.add("input-error");
        }

        function clearError(inputId, errorId) {
            const input = document.getElementById(inputId);
            const errorElement = document.getElementById(errorId);
            errorElement.textContent = "";
            errorElement.style.display = "none";
            input.classList.remove("input-error");
        }

        function clearAllErrors() {
            document.querySelectorAll(".error-message").forEach(el => {
                el.textContent = "";
                el.style.display = "none";
            });
            document.querySelectorAll(".form-control").forEach(input => {
                input.classList.remove("input-error");
            });
        }

        // Form submission
        farmerForm.addEventListener("submit", (e) => {
            e.preventDefault();

            if (!validateForm()) return;

            const newFarmer = {
                name: nameInput.value.trim(),
                region: regionInput.value.trim(),
                milk: parseFloat(milkInput.value),
                latitude: parseFloat(latitudeInput.value),
                longitude: parseFloat(longitudeInput.value),
            };

            const editIdx = parseInt(editIndexInput.value);
            if (editIdx >= 0) {
                // Update existing
                farmers[editIdx] = newFarmer;
                logActivity(`Edited farmer: ${newFarmer.name}`);
                showToast("Farmer updated successfully.");
            } else {
                // Add new
                farmers.push(newFarmer);
                logActivity(`Added new farmer: ${newFarmer.name}`);
                showToast("Farmer added successfully.");
            }

            resetForm();
            currentPage = Math.ceil(farmers.length / rowsPerPage); // go to last page
            saveToLocalStorage();
            renderFarmers();
        });

        // Input event listeners for validation
        nameInput.addEventListener('input', () => {
            clearError('name', 'name-error');
        });
        regionInput.addEventListener('input', () => {
            clearError('region', 'region-error');
        });
        milkInput.addEventListener('input', () => {
            clearError('milk', 'milk-error');
        });
        latitudeInput.addEventListener('input', () => {
            clearError('latitude', 'latitude-error');
        });
        longitudeInput.addEventListener('input', () => {
            clearError('longitude', 'longitude-error');
        });

        // Search and filter
        searchInput.addEventListener("input", () => {
            currentPage = 1;
            renderFarmers();
        });
        regionFilter.addEventListener("change", () => {
            currentPage = 1;
            renderFarmers();
        });

        // Local Storage
        function saveToLocalStorage() {
            localStorage.setItem("farmersData", JSON.stringify(farmers));
        }

        function loadFromLocalStorage() {
            const data = localStorage.getItem("farmersData");
            if (data) {
                try {
                    farmers = JSON.parse(data);
                } catch {
                    // Invalid JSON, ignore
                }
            }
        }

        // Activity Log
        function logActivity(msg) {
            const li = document.createElement("li");
            li.textContent = `${new Date().toLocaleTimeString()} - ${msg}`;
            activityLog.prepend(li);
            if (activityLog.children.length > 50) {
                activityLog.removeChild(activityLog.lastChild);
            }
        }

        // Charts
        function updateCharts() {
            if (!chartsLoaded) return;

            const filtered = getFilteredFarmers();

            // Aggregate milk by region for pie
            const milkByRegion = {};
            filtered.forEach((f) => {
                milkByRegion[f.region] = (milkByRegion[f.region] || 0) + f.milk;
            });

            const pieLabels = Object.keys(milkByRegion);
            const pieData = Object.values(milkByRegion);

            // Sort by name for area chart
            const sorted = [...filtered].sort((a, b) =>
                a.name.localeCompare(b.name)
            );

            const areaLabels = sorted.map((f) => f.name);
            const areaData = sorted.map((f) => f.milk);

            // Draw Pie Chart
            if (typeof google !== 'undefined' && typeof google.visualization !== 'undefined') {
                const pieDataTable = new google.visualization.DataTable();
                pieDataTable.addColumn('string', 'Region');
                pieDataTable.addColumn('number', 'Milk (L)');
                pieLabels.forEach((label, i) => {
                    pieDataTable.addRow([label, pieData[i]]);
                });

                const pieOptions = {
                    title: 'Milk Distribution by Region',
                    width: '100%',
                    height: 300,
                    chartArea: { width: '90%', height: '80%' },
                    legend: { position: 'right' },
                    backgroundColor: 'transparent',
                    pieSliceText: 'value'
                };

                const pieChart = new google.visualization.PieChart(document.getElementById('pie_chart'));
                pieChart.draw(pieDataTable, pieOptions);

                // Draw Area Chart
                const areaDataTable = new google.visualization.DataTable();
                areaDataTable.addColumn('string', 'Farmer');
                areaDataTable.addColumn('number', 'Milk Production (L)');
                areaLabels.forEach((label, i) => {
                    areaDataTable.addRow([label, areaData[i]]);
                });

                const areaOptions = {
                    title: 'Milk Production Trend',
                    width: '100%',
                    height: 300,
                    chartArea: { width: '85%', height: '70%' },
                    legend: { position: 'none' },
                    backgroundColor: 'transparent',
                    colors: ['#007bff'],
                    areaOpacity: 0.3,
                    hAxis: { title: 'Farmer' },
                    vAxis: { title: 'Milk (L)' }
                };

                const areaChart = new google.visualization.AreaChart(document.getElementById('area_chart'));
                areaChart.draw(areaDataTable, areaOptions);
            }
        }

        // Initialization
        function init() {
            loadFromLocalStorage();
            initMap();
            renderFarmers();

            // Add event listeners
            document.querySelectorAll('.form-control').forEach(input => {
                input.addEventListener('blur', () => validateForm());
            });
        }

        // Initialize Google Maps with fallback
        function initMap() {
            try {
                // Create map if container exists
                const mapEl = document.getElementById("map");
                if (!mapEl) return;

                // Default center (India)
                const center = { lat: 20.5937, lng: 78.9629 };

                // Create map
                map = new google.maps.Map(mapEl, {
                    zoom: 5,
                    center: center,
                    mapTypeId: 'roadmap'
                });

                updateMapMarkers();
            } catch (error) {
                console.error('Error initializing Google Maps:', error);
                showMapFallback();
            }
        }

        // Initialize only when section is active
        function checkAndInitMap() {
            const section = document.getElementById("farmer-mgmt");
            if (section.classList.contains('active')) {
                initMap();
            }
        }

        // Initialize Google Maps once API is loaded
        function initGoogleMap() {
            try {
                checkAndInitMap();
            } catch (error) {
                console.error('Error in initGoogleMap:', error);
                showMapFallback();
            }
        }

        // Initialize charts immediately
        function initCharts() {
            chartsLoaded = true;
            updateCharts();
        }

        // Initialization
        function init() {
            loadFromLocalStorage();
            renderFarmers();
            initCharts();  // Initialize charts immediately

            // Load Google Maps API
            const script = document.createElement('script');
            script.src = 'https://maps.googleapis.com/maps/api/js?callback=farmerMgmt.initGoogleMap';
            script.async = true;
            script.defer = true;
            script.onerror = showMapFallback;
            document.head.appendChild(script);

            // Re-check map when section becomes active
            const observer = new MutationObserver(checkAndInitMap);
            observer.observe(document.getElementById("farmer-mgmt"), {
                attributes: true,
                attributeFilter: ['class']
            });
        }

        return {
            init,
            resetForm,
            editFarmer,
            confirmDelete,
            exportToCSV,
            closeModal,
            confirmModal,
            initGoogleMap
        };
    })();

    // Initialize on window load
    window.onload = farmerMgmt.init;
    google.charts.load('current', { packages: ['corechart'] });
    google.charts.setOnLoadCallback(farmerMgmt.initCharts);
</script>
<!-- JS comes next -->
<script>
    // Load Google Charts
    google.charts.load('current', { 'packages': ['corechart', 'bar'] });

    // Sample predefined entries
    let dairy_entries = [
        { id: 1, farmer: 'Anita Singh', date: '2025-06-07T08:00', qty: 20, fat: 4.2, snf: 8.5, rate: 30, amount: 600 },
        { id: 2, farmer: 'Suresh Kumar', date: '2025-06-08T09:15', qty: 15, fat: 3.8, snf: 8.2, rate: 28, amount: 420 },
        { id: 3, farmer: 'Geeta Sharma', date: '2025-06-09T07:30', qty: 25, fat: 4.5, snf: 8.7, rate: 32, amount: 800 },
        { id: 4, farmer: 'Vikram Reddy', date: '2025-06-10T10:00', qty: 18, fat: 4.0, snf: 8.4, rate: 29, amount: 522 },
        { id: 5, farmer: 'Robin Hood', date: '2025-06-11T06:45', qty: 22, fat: 4.3, snf: 8.6, rate: 31, amount: 682 },
    ];

    let dairy_nextId = 6;

    // DOM elements
    const dairy_form = document.getElementById('dairy_entryForm');
    const dairy_tableBody = document.querySelector('#dairy_dataTable tbody');
    const dairy_recentActivity = document.getElementById('dairy_recentActivity');
    const dairy_modal = document.getElementById('dairy_modal');
    const dairy_modalForm = document.getElementById('dairy_modalForm');

    // Form inputs
    const dairy_farmerInput = document.getElementById('dairy_farmer');
    const dairy_qtyInput = document.getElementById('dairy_qty');
    const dairy_fatInput = document.getElementById('dairy_fat');
    const dairy_snfInput = document.getElementById('dairy_snf');
    const dairy_rateInput = document.getElementById('dairy_rate');
    const dairy_datetimeInput = document.getElementById('dairy_datetime');

    // Modal inputs
    const dairy_editIdInput = document.getElementById('dairy_editId');
    const dairy_editFarmerInput = document.getElementById('dairy_editFarmer');
    const dairy_editQtyInput = document.getElementById('dairy_editQty');
    const dairy_editFatInput = document.getElementById('dairy_editFat');
    const dairy_editSNFInput = document.getElementById('dairy_editSNF');
    const dairy_editRateInput = document.getElementById('dairy_editRate');
    const dairy_editDateInput = document.getElementById('dairy_editDate');

    function dairy_renderTable(data) {
        dairy_tableBody.innerHTML = '';
        data.forEach(entry => {
            const tr = document.createElement('tr');
            tr.style.borderBottom = '1px solid #ddd';

            tr.innerHTML = `
                    <td style="padding: 8px;">${entry.id}</td>
                    <td style="padding: 8px;">${entry.farmer}</td>
                    <td style="padding: 8px;">${new Date(entry.date).toLocaleString()}</td>
                    <td style="padding: 8px; text-align: right;">${entry.qty.toFixed(2)}</td>
                    <td style="padding: 8px; text-align: right;">${entry.fat.toFixed(2)}</td>
                    <td style="padding: 8px; text-align: right;">${entry.snf.toFixed(2)}</td>
                    <td style="padding: 8px; text-align: right;">‚Çπ${entry.rate.toFixed(2)}</td>
                    <td style="padding: 8px; text-align: right;">‚Çπ${entry.amount.toFixed(2)}</td>
                    <td style="padding: 8px; text-align:center;">
                        <button class="action-btn dairy_viewBtn" data-id="${entry.id}"><i class="fas fa-eye"></i></button>
                        <button class="action-btn dairy_editBtn" data-id="${entry.id}"><i class="fas fa-edit"></i></button>
                        <button class="action-btn dairy_deleteBtn" data-id="${entry.id}"><i class="fas fa-trash"></i></button>
                    </td>
                `;
            dairy_tableBody.appendChild(tr);
        });

        // Add event listeners to action buttons
        document.querySelectorAll('.dairy_viewBtn').forEach(btn => {
            btn.addEventListener('click', () => {
                const id = parseInt(btn.getAttribute('data-id'));
                dairy_openModalView(id);
            });
        });

        document.querySelectorAll('.dairy_editBtn').forEach(btn => {
            btn.addEventListener('click', () => {
                const id = parseInt(btn.getAttribute('data-id'));
                dairy_openModalEdit(id);
            });
        });

        document.querySelectorAll('.dairy_deleteBtn').forEach(btn => {
            btn.addEventListener('click', () => {
                const id = parseInt(btn.getAttribute('data-id'));
                dairy_deleteEntry(id);
            });
        });
    }

    function dairy_updateDashboard(data) {
        // Calculate aggregates
        const totalQty = data.reduce((sum, e) => sum + e.qty, 0);
        const totalFat = data.reduce((sum, e) => sum + e.fat, 0) / (data.length || 1);
        const totalSNF = data.reduce((sum, e) => sum + e.snf, 0) / (data.length || 1);
        const uniqueFarmers = new Set(data.map(e => e.farmer)).size;

        // Update cards values
        document.getElementById('dairy_totalLitresVal').textContent = `${totalQty.toFixed(2)} L`;
        document.getElementById('dairy_totalFarmersVal').textContent = uniqueFarmers;
        document.getElementById('dairy_avgFatVal').textContent = `${totalFat.toFixed(2)} %`;
        document.getElementById('dairy_avgSNFVal').textContent = `${totalSNF.toFixed(2)} %`;

        // Draw mini pie charts
        dairy_drawMiniPieChart('dairy_totalLitresChart', totalQty);
        dairy_drawMiniPieChart('dairy_totalFarmersChart', uniqueFarmers);
        dairy_drawMiniPieChart('dairy_avgFatChart', totalFat);
        dairy_drawMiniPieChart('dairy_avgSNFChart', totalSNF);

        // Draw daily total milk chart
        dairy_drawDailyMilkChart(data);

        // Draw Farmer Fat & SNF Bar Chart
        dairy_drawFatSNFChart(data);
    }

    function dairy_drawMiniPieChart(containerId, value) {
        const data = google.visualization.arrayToDataTable([
            ['Label', 'Value'],
            ['', value]
        ]);
        const options = {
            legend: 'none',
            pieSliceText: 'none',
            pieStartAngle: 0,
            width: 120,
            height: 100,
            colors: ['#4caf50'],
            chartArea: { width: '100%', height: '100%' }
        };
        const chart = new google.visualization.PieChart(document.getElementById(containerId));
        chart.draw(data, options);
    }

    function dairy_drawDailyMilkChart(data) {
        const dailyTotals = {};
        data.forEach(e => {
            const day = new Date(e.date).toLocaleDateString();
            dailyTotals[day] = (dailyTotals[day] || 0) + e.qty;
        });
        const chartData = [['Date', 'Total Milk (L)']];
        Object.entries(dailyTotals).forEach(([day, total]) => {
            chartData.push([day, total]);
        });

        // Remove old chart container if exists
        let oldChart = document.getElementById('dairy_dailyMilkChart');
        if (oldChart) oldChart.remove();

        const container = document.getElementById('dairy_dailyMilkChartContainer');
        container.innerHTML = '';
        const chartDiv = document.createElement('div');
        chartDiv.id = 'dairy_dailyMilkChart';
        chartDiv.style.height = '300px';
        container.appendChild(chartDiv);


        const chart = google.visualization.arrayToDataTable(chartData);
        const options = {
            title: 'Daily Total Milk Collected (Litres)',
            hAxis: { title: 'Date' },
            vAxis: { title: 'Litres' },
            legend: 'none',
            colors: ['#3f51b5'],
            height: 300
        };
        const colChart = new google.visualization.ColumnChart(container);
        colChart.draw(chart, options);
    }

    function dairy_drawFatSNFChart(data) {
        const chartDataArray = [['Farmer', 'Fat %', 'SNF %']];
        data.forEach(e => {
            chartDataArray.push([e.farmer, e.fat, e.snf]);
        });

        // Remove old chart container if exists
        let oldChart = document.getElementById('dairy_fatSNFChart');
        if (oldChart) oldChart.remove();

        const container = document.getElementById('dairy_fatSNFChartContainer');
        container.innerHTML = '';

        const chartDiv = document.createElement('div');
        chartDiv.id = 'dairy_fatSNFChart';
        chartDiv.style.width = '100%';
        chartDiv.style.height = '300px';
        container.appendChild(chartDiv);


        const chartData = google.visualization.arrayToDataTable(chartDataArray);
        const options = {
            title: 'Farmer-wise Fat & SNF %',
            chartArea: { width: '60%' },
            hAxis: {
                title: 'Percentage (%)',
                minValue: 0
            },
            vAxis: {
                title: 'Farmer'
            },
            bars: 'horizontal',
            colors: ['#e91e63', '#00bcd4'],
            height: 300
        };
        const barChart = new google.visualization.BarChart(container);
        barChart.draw(chartData, options);
    }

    // Add Entry Form Submission
    dairy_form.addEventListener('submit', e => {
        e.preventDefault();
        if (!dairy_form.checkValidity()) {
            alert('Please fill all required fields correctly.');
            return;
        }
        const newEntry = {
            id: dairy_nextId++,
            farmer: dairy_farmerInput.value.trim(),
            date: dairy_datetimeInput.value,
            qty: parseFloat(dairy_qtyInput.value),
            fat: parseFloat(dairy_fatInput.value),
            snf: parseFloat(dairy_snfInput.value),
            rate: parseFloat(dairy_rateInput.value),
        };
        newEntry.amount = newEntry.qty * newEntry.rate;
        dairy_entries.push(newEntry);
        dairy_renderTable(dairy_entries);
        dairy_updateDashboard(dairy_entries);
        dairy_addRecentActivity(`Added entry for ${newEntry.farmer}`);
        dairy_form.reset();
    });

    // Recent activity helper
    function dairy_addRecentActivity(message) {
        const li = document.createElement('li');
        const timestamp = new Date().toLocaleString();
        li.textContent = `[${timestamp}] ${message}`;
        dairy_recentActivity.prepend(li);
    }

    // Delete Entry
    function dairy_deleteEntry(id) {
        if (!confirm('Are you sure you want to delete this entry?')) return;
        dairy_entries = dairy_entries.filter(e => e.id !== id);
        dairy_renderTable(dairy_entries);
        dairy_updateDashboard(dairy_entries);
        dairy_addRecentActivity(`Deleted entry with ID ${id}`);
    }

    // Modal Functions
    function dairy_openModalView(id) {
        const entry = dairy_entries.find(e => e.id === id);
        if (!entry) return;
        document.getElementById('dairy_modalTitle').textContent = 'View Entry';
        dairy_modalForm.style.display = 'none';
        dairy_showModal();
        // Display data in readonly format
        if (!document.getElementById('dairy_viewDetails')) {
            const viewDiv = document.createElement('div');
            viewDiv.id = 'dairy_viewDetails';
            viewDiv.style.padding = '10px';
            viewDiv.style.lineHeight = '1.6';
            dairy_modal.querySelector('div').appendChild(viewDiv);
        }
        const viewDetails = document.getElementById('dairy_viewDetails');
        viewDetails.innerHTML = `
                <b>Farmer:</b> ${entry.farmer}<br/>
                <b>Date:</b> ${new Date(entry.date).toLocaleString()}<br/>
                <b>Quantity:</b> ${entry.qty.toFixed(2)} L<br/>
                <b>Fat %:</b> ${entry.fat.toFixed(2)} %<br/>
                <b>SNF %:</b> ${entry.snf.toFixed(2)} %<br/>
                <b>Rate:</b> ‚Çπ${entry.rate.toFixed(2)}<br/>
                <b>Amount:</b> ‚Çπ${entry.amount.toFixed(2)}
            `;
    }

    function dairy_openModalEdit(id) {
        const entry = dairy_entries.find(e => e.id === id);
        if (!entry) return;
        document.getElementById('dairy_modalTitle').textContent = 'Edit Entry';
        dairy_modalForm.style.display = 'block';
        const viewDetails = document.getElementById('dairy_viewDetails');
        if (viewDetails) viewDetails.innerHTML = '';
        dairy_showModal();
        dairy_editIdInput.value = entry.id;
        dairy_editFarmerInput.value = entry.farmer;
        dairy_editQtyInput.value = entry.qty;
        dairy_editFatInput.value = entry.fat;
        dairy_editSNFInput.value = entry.snf;
        dairy_editRateInput.value = entry.rate;
        // Format date for datetime-local input
        dairy_editDateInput.value = entry.date;
    }

    dairy_modalForm.addEventListener('submit', e => {
        e.preventDefault();
        // Validate
        if (!dairy_modalForm.checkValidity()) {
            alert('Please fill all fields correctly.');
            return;
        }
        const id = parseInt(dairy_editIdInput.value);
        const index = dairy_entries.findIndex(e => e.id === id);
        if (index === -1) return;

        const updatedEntry = {
            id: id,
            farmer: dairy_editFarmerInput.value.trim(),
            qty: parseFloat(dairy_editQtyInput.value),
            fat: parseFloat(dairy_editFatInput.value),
            snf: parseFloat(dairy_editSNFInput.value),
            rate: parseFloat(dairy_editRateInput.value),
            date: dairy_editDateInput.value
        };
        updatedEntry.amount = updatedEntry.qty * updatedEntry.rate;

        dairy_entries[index] = updatedEntry;

        dairy_renderTable(dairy_entries);
        dairy_updateDashboard(dairy_entries);
        dairy_addRecentActivity(`Updated entry for ${updatedEntry.farmer}`);
        dairy_closeModal();
    });

    function dairy_showModal() {
        dairy_modal.style.display = 'flex';
    }

    function dairy_closeModal() {
        dairy_modal.style.display = 'none';
        dairy_modalForm.reset();
    }

    // Close modal on background click
    dairy_modal.addEventListener('click', e => {
        if (e.target === dairy_modal) dairy_closeModal();
    });

    // Export to Excel
    function dairy_downloadExcel() {
        const wb = XLSX.utils.book_new();
        const wsData = [
            ['ID', 'Farmer', 'Date', 'Qty (L)', 'Fat %', 'SNF %', 'Rate ‚Çπ/L', 'Amount ‚Çπ']
        ];
        dairy_entries.forEach(e => {
            wsData.push([
                e.id, e.farmer, new Date(e.date).toLocaleString(), e.qty, e.fat, e.snf, e.rate, e.amount
            ]);
        });
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        XLSX.utils.book_append_sheet(wb, ws, 'MilkCollection');
        XLSX.writeFile(wb, 'MilkCollectionData.xlsx');
    }

    // Export to PDF
    function dairy_downloadPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFontSize(16);
        doc.text("Milk Collection Records", 14, 20);
        doc.setFontSize(10);

        const rows = dairy_entries.map(e => [
            e.id,
            e.farmer,
            new Date(e.date).toLocaleString(),
            e.qty.toFixed(2),
            e.fat.toFixed(2),
            e.snf.toFixed(2),
            `‚Çπ${e.rate.toFixed(2)}`,
            `‚Çπ${e.amount.toFixed(2)}`
        ]);

        doc.autoTable({
            head: [['ID', 'Farmer', 'Date', 'Qty', 'Fat', 'SNF', 'Rate', 'Amount']],
            body: rows,
            startY: 25,
            theme: 'striped',
            styles: { fontSize: 8 },
        });

        doc.save('MilkCollectionData.pdf');
    }

    // Wait for Google Charts to be loaded before initial render
    google.charts.setOnLoadCallback(() => {
        dairy_renderTable(dairy_entries);
        dairy_updateDashboard(dairy_entries);
        dairy_addRecentActivity('Dashboard initialized with sample data');
    });

    // Add event listeners for export buttons
    document.getElementById('dairy_excelBtn').addEventListener('click', dairy_downloadExcel);
    document.getElementById('dairy_pdfBtn').addEventListener('click', dairy_downloadPDF);
    document.getElementById('dairy_closeModalBtn').addEventListener('click', dairy_closeModal);

    // Initialize charts with proper sizing
    function initMilkCharts() {
        dairy_updateDashboard(dairy_entries);
    }

    // Redraw charts when section becomes active
    function handleMilkSectionActive() {
        const section = document.getElementById('milk-collection');
        if (section.classList.contains('active')) {
            setTimeout(() => {
                dairy_updateDashboard(dairy_entries);
            }, 100);
        }
    }

    // Initialization
    google.charts.load('current', { packages: ['corechart', 'bar'] });
    google.charts.setOnLoadCallback(initMilkCharts);

    // Set up section observer
    const milkObserver = new MutationObserver(handleMilkSectionActive);
    milkObserver.observe(document.getElementById('milk-collection'), {
        attributes: true,
        attributeFilter: ['class']
    });
</script>

<!-- Load jsPDF AutoTable plugin -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<!-- Google Charts Loader -->
<script src="https://www.gstatic.com/charts/loader.js"></script>
<script>
    // Initialize Google Charts
    google.charts.load('current', { packages: ['corechart', 'line'] });
    google.charts.setOnLoadCallback(initChillingCenters);

    // Sample data for chilling centers
    let chillingCentersData = [
        { id: 'CC-1001', name: 'Mumbai Central', location: 'Mumbai', totalCapacity: 15000, currentCapacity: 12000, temperature: 3.5, status: 'Active', energyType: 'Solar', lastUpdated: '2023-06-15T08:30:00' },
        { id: 'CC-1002', name: 'Delhi North', location: 'Delhi', totalCapacity: 25000, currentCapacity: 18000, temperature: 4.2, status: 'Active', energyType: 'Grid Power', lastUpdated: '2023-06-15T09:15:00' },
        { id: 'CC-1003', name: 'Chennai South', location: 'Chennai', totalCapacity: 18000, currentCapacity: 15000, temperature: 2.8, status: 'Maintenance', energyType: 'Generator', lastUpdated: '2023-06-14T14:20:00' },
        { id: 'CC-1004', name: 'Kolkata East', location: 'Kolkata', totalCapacity: 22000, currentCapacity: 19500, temperature: 3.9, status: 'Active', energyType: 'Solar', lastUpdated: '2023-06-15T10:45:00' },
        { id: 'CC-1005', name: 'Bangalore Tech', location: 'Bangalore', totalCapacity: 30000, currentCapacity: 28000, temperature: 4.5, status: 'Active', energyType: 'Battery', lastUpdated: '2023-06-15T11:30:00' }
    ];

    // Recent activity log
    let chillingActivities = [
        { id: 'A-1001', type: 'add', message: 'Added new center: Bangalore Tech', timestamp: '2023-06-15T11:30:00' },
        { id: 'A-1002', type: 'update', message: 'Updated center: Kolkata East', timestamp: '2023-06-15T10:45:00' },
        { id: 'A-1003', type: 'add', message: 'Added new center: Chennai South', timestamp: '2023-06-14T14:20:00' }
    ];

    // Initialize app
    function initChillingCenters() {
        renderChillingTable();
        updateChillingSummary();
        drawAllChillingCharts();
        renderChillingActivity();
        setupChillingEventListeners();
    }

    // Set up event listeners
    function setupChillingEventListeners() {
        document.getElementById('chillingEntryForm').addEventListener('submit', handleChillingFormSubmit);
        document.getElementById('chillingAddCenterBtn').addEventListener('click', () => showChillingForm());
        document.getElementById('chillingCancelBtn').addEventListener('click', closeChillingForm);
        document.getElementById('chillingSearchInput').addEventListener('input', filterChillingTable);

        // Add input validation listeners
        document.getElementById('chillingTotalCapacity').addEventListener('input', validateChillingCapacity);
        document.getElementById('chillingCurrentCapacity').addEventListener('input', validateChillingCapacity);
    }

    // Show the form (add/edit)
    function showChillingForm(id = null) {
        document.getElementById('chillingFormContainer').style.display = 'block';
        const formTitle = document.getElementById('chillingFormTitle');
        const submitBtn = document.getElementById('chillingSubmitBtn');
        const form = document.getElementById('chillingEntryForm');

        resetChillingFormErrors();

        if (id) {
            const center = chillingCentersData.find(c => c.id === id);
            if (!center) return alert('Center not found');

            formTitle.innerHTML = '<i class="fas fa-edit"></i> Edit Chilling Center';
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Update Center';
            document.getElementById('chillingEditId').value = center.id;
            document.getElementById('chillingCenterName').value = center.name;
            document.getElementById('chillingLocation').value = center.location;
            document.getElementById('chillingTotalCapacity').value = center.totalCapacity;
            document.getElementById('chillingCurrentCapacity').value = center.currentCapacity;
            document.getElementById('chillingTemperature').value = center.temperature;
            document.getElementById('chillingStatus').value = center.status;
            document.getElementById('chillingEnergyType').value = center.energyType;
        } else {
            formTitle.innerHTML = '<i class="fas fa-plus-circle"></i> Add New Chilling Center';
            submitBtn.innerHTML = '<i class="fas fa-plus"></i> Add Center';
            form.reset();
            document.getElementById('chillingEditId').value = '';
        }

        // Scroll to form
        document.getElementById('chillingFormContainer').scrollIntoView({ behavior: 'smooth' });
    }

    // Close the form and reset
    function closeChillingForm() {
        document.getElementById('chillingFormContainer').style.display = 'none';
        document.getElementById('chillingEntryForm').reset();
        resetChillingFormErrors();
    }

    // Reset form error messages
    function resetChillingFormErrors() {
        document.querySelectorAll('.error-message').forEach(el => {
            el.style.display = 'none';
        });
    }

    // Validate capacity inputs
    function validateChillingCapacity() {
        const totalCapacity = parseInt(document.getElementById('chillingTotalCapacity').value, 10) || 0;
        const currentCapacity = parseInt(document.getElementById('chillingCurrentCapacity').value, 10) || 0;
        const error = document.getElementById('chillingCurrentCapacityError');

        if (isNaN(currentCapacity)) {
            error.textContent = 'Please enter a valid number';
            error.style.display = 'block';
            return false;
        }

        if (currentCapacity > totalCapacity) {
            error.textContent = 'Current capacity cannot exceed total capacity';
            error.style.display = 'block';
            return false;
        }

        error.style.display = 'none';
        return true;
    }

    // Validate form inputs
    function validateChillingForm() {
        let isValid = true;
        resetChillingFormErrors();

        const name = document.getElementById('chillingCenterName').value.trim();
        const location = document.getElementById('chillingLocation').value.trim();
        const totalCapacity = parseInt(document.getElementById('chillingTotalCapacity').value, 10);
        const currentCapacity = parseInt(document.getElementById('chillingCurrentCapacity').value, 10);
        const temperature = parseFloat(document.getElementById('chillingTemperature').value);
        const status = document.getElementById('chillingStatus').value;
        const energyType = document.getElementById('chillingEnergyType').value;

        if (!name || name.length < 2) {
            document.getElementById('chillingNameError').style.display = 'block';
            isValid = false;
        }

        if (!location || location.length < 2) {
            document.getElementById('chillingLocationError').style.display = 'block';
            isValid = false;
        }

        if (isNaN(totalCapacity) || totalCapacity < 1000) {
            document.getElementById('chillingTotalCapacityError').style.display = 'block';
            isValid = false;
        }

        if (isNaN(currentCapacity) || currentCapacity < 0 || currentCapacity > totalCapacity) {
            document.getElementById('chillingCurrentCapacityError').style.display = 'block';
            isValid = false;
        }

        if (isNaN(temperature) || temperature < 0 || temperature > 10) {
            document.getElementById('chillingTemperatureError').style.display = 'block';
            isValid = false;
        }

        if (!status) {
            document.getElementById('chillingStatusError').style.display = 'block';
            isValid = false;
        }

        if (!energyType) {
            document.getElementById('chillingEnergyTypeError').style.display = 'block';
            isValid = false;
        }

        return isValid;
    }

    // Handle add/edit form submit
    function handleChillingFormSubmit(e) {
        e.preventDefault();

        if (!validateChillingForm()) return;

        const id = document.getElementById('chillingEditId').value || 'CC-' + (1000 + Math.floor(Math.random() * 9000));
        const name = document.getElementById('chillingCenterName').value.trim();
        const location = document.getElementById('chillingLocation').value.trim();
        const totalCapacity = parseInt(document.getElementById('chillingTotalCapacity').value, 10);
        const currentCapacity = parseInt(document.getElementById('chillingCurrentCapacity').value, 10);
        const temperature = parseFloat(document.getElementById('chillingTemperature').value);
        const status = document.getElementById('chillingStatus').value;
        const energyType = document.getElementById('chillingEnergyType').value;

        const existingIndex = chillingCentersData.findIndex(c => c.id === id);
        const actionType = existingIndex >= 0 ? 'update' : 'add';

        if (existingIndex >= 0) {
            // Update existing center
            chillingCentersData[existingIndex] = {
                ...chillingCentersData[existingIndex],
                name,
                location,
                totalCapacity,
                currentCapacity,
                temperature,
                status,
                energyType,
                lastUpdated: new Date().toISOString()
            };
            logChillingActivity('update', `Updated center: ${name}`);
        } else {
            // Add new center
            chillingCentersData.push({
                id,
                name,
                location,
                totalCapacity,
                currentCapacity,
                temperature,
                status,
                energyType,
                lastUpdated: new Date().toISOString()
            });
            logChillingActivity('add', `Added new center: ${name}`);
        }

        closeChillingForm();
        renderChillingTable();
        updateChillingSummary();
        drawAllChillingCharts();
    }

    // Render table rows with progress bars
    function renderChillingTable() {
        const tbody = document.getElementById('chillingTableBody');
        tbody.innerHTML = '';

        chillingCentersData.sort((a, b) => b.lastUpdated.localeCompare(a.lastUpdated));

        chillingCentersData.forEach(center => {
            const tr = document.createElement('tr');

            // Calculate percentage for progress bar
            const percentage = Math.min(100, Math.round((center.currentCapacity / center.totalCapacity) * 100));

            // Format capacity with commas
            const formattedTotalCapacity = center.totalCapacity.toLocaleString();
            const formattedCurrentCapacity = center.currentCapacity.toLocaleString();

            tr.innerHTML = `
                <td>${center.id}</td>
                <td>${center.name}</td>
                <td>${center.location}</td>
                <td>
                    <div class="progress-label">${formattedCurrentCapacity} / ${formattedTotalCapacity} L</div>
                    <div class="capacity-progress">
                        <div class="capacity-progress-bar" style="width: ${percentage}%"></div>
                    </div>
                </td>
                <td>${center.temperature.toFixed(1)}¬∞C</td>
                <td><span class="status-badge status-${center.status.toLowerCase()}">${center.status}</span></td>
                <td>${center.energyType}</td>
                <td>
                    <button class="action-btn" onclick="showChillingForm('${center.id}')"><i class="fas fa-edit"></i></button>
                    <button class="action-btn delete" onclick="deleteChillingCenter('${center.id}')"><i class="fas fa-trash"></i></button>
                </td>
            `;

            tbody.appendChild(tr);
        });
    }

    // Delete center
    function deleteChillingCenter(id) {
        if (confirm('Are you sure you want to delete this chilling center?')) {
            const center = chillingCentersData.find(c => c.id === id);
            if (center) {
                logChillingActivity('delete', `Deleted center: ${center.name}`);
            }

            chillingCentersData = chillingCentersData.filter(c => c.id !== id);
            renderChillingTable();
            updateChillingSummary();
            drawAllChillingCharts();
        }
    }

    // Update summary cards
    function updateChillingSummary() {
        const totalCenters = chillingCentersData.length;
        const avgTemp = totalCenters
            ? (chillingCentersData.reduce((acc, c) => acc + c.temperature, 0) / totalCenters).toFixed(1)
            : 0;
        const totalCapacity = chillingCentersData.reduce((acc, c) => acc + c.totalCapacity, 0);
        const currentCapacity = chillingCentersData.reduce((acc, c) => acc + c.currentCapacity, 0);

        // Calculate energy mix
        const energyCounts = chillingCentersData.reduce((acc, c) => {
            acc[c.energyType] = (acc[c.energyType] || 0) + 1;
            return acc;
        }, {});

        let energyMix = "N/A";
        if (totalCenters > 0) {
            const solarPercentage = Math.round((energyCounts['Solar'] || 0) / totalCenters * 100);
            energyMix = `${solarPercentage}% Solar`;
        }

        document.getElementById('summary_totalCenters').textContent = totalCenters;
        document.getElementById('summary_avgTemp').textContent = `${avgTemp}¬∞C`;
        document.getElementById('summary_totalCapacity').textContent = totalCapacity.toLocaleString() + ' L';
        document.getElementById('summary_currentCapacity').textContent = currentCapacity.toLocaleString() + ' L';
        document.getElementById('summary_energyMix').textContent = energyMix;
    }

    // Filter table rows by search input
    function filterChillingTable() {
        const filter = document.getElementById('chillingSearchInput').value.toLowerCase();
        const rows = document.getElementById('chillingTableBody').rows;

        for (let row of rows) {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(filter) ? '' : 'none';
        }
    }

    // Draw all charts
    function drawAllChillingCharts() {
        drawChillingTemperatureChart();
        drawChillingCapacityChart();
        drawChillingEnergyChart();
        drawChillingTemperaturePerformanceChart();
    }

    // Draw Temperature Chart
    function drawChillingTemperatureChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Center');
        data.addColumn('number', 'Temperature (¬∞C)');

        chillingCentersData.forEach(c => {
            data.addRow([c.name, c.temperature]);
        });

        const options = {
            title: 'Current Temperatures',
            height: 350,
            colors: ['#4285F4'],
            hAxis: { title: 'Chilling Centers' },
            vAxis: {
                title: 'Temperature (¬∞C)',
                minValue: 0,
                maxValue: 10
            },
            legend: { position: 'none' },
            chartArea: { width: '85%', height: '75%' }
        };

        const chart = new google.visualization.ColumnChart(document.getElementById('chillingTemperatureChart'));
        chart.draw(data, options);
    }

    // Draw Capacity Chart
    function drawChillingCapacityChart() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Center');
        data.addColumn('number', 'Current Capacity (L)');
        data.addColumn('number', 'Total Capacity (L)');

        chillingCentersData.forEach(c => {
            data.addRow([c.name, c.currentCapacity, c.totalCapacity]);
        });

        const options = {
            title: 'Capacity Utilization',
            height: 350,
            colors: ['#34A853', '#EA4335'],
            hAxis: { title: 'Chilling Centers' },
            vAxis: { title: 'Capacity (L)' },
            isStacked: false,
            chartArea: { width: '85%', height: '75%' }
        };

        const chart = new google.visualization.ColumnChart(document.getElementById('chillingCapacityChart'));
        chart.draw(data, options);
    }

    // Draw Energy Chart
    function drawChillingEnergyChart() {
        const energyCounts = chillingCentersData.reduce((acc, c) => {
            acc[c.energyType] = (acc[c.energyType] || 0) + 1;
            return acc;
        }, {});

        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Energy Source');
        data.addColumn('number', 'Count');

        for (const [energyType, count] of Object.entries(energyCounts)) {
            data.addRow([energyType, count]);
        }

        const options = {
            title: 'Energy Source Distribution',
            height: 350,
            pieHole: 0.4,
            colors: ['#4285F4', '#34A853', '#FBBC05', '#EA4335'],
            chartArea: { width: '90%', height: '90%' }
        };

        const chart = new google.visualization.PieChart(document.getElementById('chillingEnergyChart'));
        chart.draw(data, options);
    }

    // Draw Temperature Performance Chart
    function drawChillingTemperaturePerformanceChart() {
        // Generate mock temperature data for a day
        const times = ['6am', '8am', '10am', '12pm', '2pm', '4pm', '6pm'];
        const avgTemps = [4.2, 3.8, 3.5, 4.0, 4.5, 4.2, 3.9];

        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Time');
        data.addColumn('number', 'Temperature (¬∞C)');

        times.forEach((time, i) => {
            data.addRow([time, avgTemps[i]]);
        });

        const options = {
            title: 'Temperature Performance (24h)',
            height: 350,
            colors: ['#EA4335'],
            hAxis: { title: 'Time' },
            vAxis: {
                title: 'Temperature (¬∞C)',
                minValue: 0,
                maxValue: 5
            },
            curveType: 'function',
            legend: { position: 'none' },
            chartArea: { width: '85%', height: '75%' }
        };

        const chart = new google.visualization.LineChart(document.getElementById('chillingTempPerformanceChart'));
        chart.draw(data, options);
    }

    // Log activity
    function logChillingActivity(type, message) {
        const activity = {
            id: 'A-' + (1000 + Math.floor(Math.random() * 9000)),
            type,
            message,
            timestamp: new Date().toISOString()
        };

        chillingActivities.unshift(activity);
        renderChillingActivity();

        // Highlight the activity container
        const container = document.getElementById('chillingActivityContainer');
        container.classList.add('highlight');
        setTimeout(() => container.classList.remove('highlight'), 1500);
    }

    // Render activity
    function renderChillingActivity() {
        const container = document.getElementById('chillingActivityContainer');
        container.innerHTML = '';

        // Show latest 5 activities
        const recentActivities = chillingActivities.slice(0, 5);

        recentActivities.forEach(activity => {
            const item = document.createElement('div');
            item.className = 'activity-item';

            let iconClass = 'fas fa-plus-circle';
            let iconColor = '#34A853';

            if (activity.type === 'update') {
                iconClass = 'fas fa-edit';
                iconColor = '#4285F4';
            } else if (activity.type === 'delete') {
                iconClass = 'fas fa-trash-alt';
                iconColor = '#EA4335';
            }

            const date = new Date(activity.timestamp);
            const timeString = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const dateString = date.toLocaleDateString();

            item.innerHTML = `
                <div class="activity-content">
                    <div class="activity-title"><i class="${iconClass}" style="color: ${iconColor};"></i> ${activity.message}</div>
                    <div class="activity-time">${dateString} at ${timeString}</div>
                </div>
            `;

            container.appendChild(item);
        });

        if (recentActivities.length === 0) {
            container.innerHTML = '<div class="activity-item"><div class="activity-content">No recent activity</div></div>';
        }
    }

    // Redraw charts on window resize for responsiveness
    window.addEventListener('resize', drawAllChillingCharts);
</script>

<script>
    // Product options for dropdown
    const PRODUCT_OPTIONS = [
        "Milk", "Cheese", "Butter", "Ice Cream",
        "Yogurt", "Ghee", "Paneer", "Cream",
        "Milk Powder", "Condensed Milk"
    ];

    // Sample initial data for processing section
    let procData = [
        {
            id: 1,
            name: "Alpha Milk Plant",
            location: "Delhi",
            capacity: 40000,
            status: "Active",
            manager: "Ajay Kumar",
            products: { Milk: 20000, Butter: 10000, Cheese: 10000 },
            activity: "Plant created",
            timestamp: new Date('2023-01-15').getTime()
        },
        {
            id: 2,
            name: "Beta Dairy",
            location: "Pune",
            capacity: 50000,
            status: "Inactive",
            manager: "Rita Sen",
            products: { Yogurt: 30000, IceCream: 20000 },
            activity: "Temporarily shut down",
            timestamp: new Date('2023-02-20').getTime()
        },
        {
            id: 3,
            name: "Gamma Agro Foods",
            location: "Lucknow",
            capacity: 45000,
            status: "Active",
            manager: "Suresh Yadav",
            products: { Milk: 25000, Ghee: 10000, Paneer: 10000 },
            activity: "Daily production ongoing",
            timestamp: new Date('2023-03-10').getTime()
        },
        {
            id: 4,
            name: "Delta Dairy Processing",
            location: "Ahmedabad",
            capacity: 60000,
            status: "Maintenance",
            manager: "Pooja Mehta",
            products: { Milk: 30000, Butter: 15000, Yogurt: 10000 },
            activity: "Under scheduled maintenance",
            timestamp: new Date('2023-04-05').getTime()
        },
        {
            id: 5,
            name: "Omega Milk Industries",
            location: "Bangalore",
            capacity: 55000,
            status: "Active",
            manager: "Rahul Desai",
            products: { Milk: 28000, Cheese: 15000, IceCream: 12000 },
            activity: "New product line launched",
            timestamp: new Date('2023-05-18').getTime()
        }
    ];

    let procEditingId = null;
    let stackedBarChart = null;

    function renderProcessingAll() {
        renderProcCards();
        renderProcTable();
        updateProcSummaryCards();
        renderProcChart();
        renderProcActivities();
    }

    function getFilteredProc() {
        const name = document.getElementById('procSearch').value.toLowerCase();
        const status = document.getElementById('procStatusFilter').value;
        return procData.filter(p => {
            const matchName = !name || p.name.toLowerCase().includes(name);
            const matchStatus = !status || p.status === status;
            return matchName && matchStatus;
        });
    }

    function renderProcCards() {
        const container = document.getElementById('procCardView');
        container.innerHTML = '';
        const data = getFilteredProc();

        if (data.length === 0) {
            container.innerHTML = '<div class="no-data">No plants found matching your criteria</div>';
            return;
        }

        data.forEach(p => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
      <h3>${p.name}</h3>
      <p><strong><i class="fas fa-map-marker-alt"></i> Location:</strong> ${p.location}</p>
      <p><strong><i class="fas fa-user-tie"></i> Manager:</strong> ${p.manager}</p>
      <p><strong><i class="fas fa-power-off"></i> Status:</strong> <span class="status ${getStatusClass(p.status)}">${p.status}</span></p>
      <p><strong><i class="fas fa-flask"></i> Capacity:</strong> ${p.capacity.toLocaleString()} L</p>
      <p><strong><i class="fas fa-boxes"></i> Products:</strong> ${Object.entries(p.products).map(([k, v]) => `${k}: ${v}L`).join(', ')}</p>
      <div class="form-actions">
        <button class="btn btn-primary" onclick="editProcPlant(${p.id})"><i class="fas fa-edit"></i> Edit</button>
        <button class="btn btn-danger" onclick="deleteProcPlant(${p.id})"><i class="fas fa-trash"></i> Delete</button>
      </div>
    `;
            container.appendChild(card);
        });
    }

    function getStatusClass(status) {
        switch (status) {
            case 'Active': return 'status-active';
            case 'Inactive': return 'status-inactive';
            case 'Maintenance': return 'status-maintenance';
            default: return '';
        }
    }

    function renderProcTable() {
        const body = document.getElementById('procTableBody');
        body.innerHTML = '';
        const data = getFilteredProc();

        if (data.length === 0) {
            body.innerHTML = `<tr><td colspan="7" class="text-center">No plants found</td></tr>`;
            return;
        }

        data.forEach(p => {
            const row = document.createElement('tr');
            row.innerHTML = `
      <td><i class="fas fa-industry"></i> ${p.name}</td>
      <td><i class="fas fa-map-marker-alt"></i> ${p.location}</td>
      <td>${p.capacity.toLocaleString()} L</td>
      <td><span class="status ${getStatusClass(p.status)}">${p.status}</span></td>
      <td><i class="fas fa-user-tie"></i> ${p.manager}</td>
      <td>${Object.entries(p.products).map(([k, v]) => `${k}: ${v}L`).join(', ')}</td>
      <td>
        <button class="action-btn" onclick="editProcPlant(${p.id})"><i class="fas fa-edit"></i></button>
        <button class="action-btn" onclick="deleteProcPlant(${p.id})"><i class="fas fa-trash"></i></button>
      </td>
    `;
            body.appendChild(row);
        });
    }

    function updateProcSummaryCards() {
        // Always show overall stats, not filtered stats
        document.getElementById('procTotalPlants').textContent = procData.length;
        document.getElementById('procTotalCapacity').textContent =
            procData.reduce((a, b) => a + b.capacity, 0).toLocaleString() + ' L';
        document.getElementById('procActivePlants').textContent =
            procData.filter(p => p.status === 'Active').length;
        document.getElementById('procTotalProducts').textContent =
            procData.reduce((a, b) => a + Object.keys(b.products).length, 0);
    }

    function toggleProcView(view) {
        document.getElementById('procCardView').style.display = view === 'cards' ? 'grid' : 'none';
        document.getElementById('procTableView').style.display = view === 'table' ? 'block' : 'none';
        document.querySelectorAll('.chart-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.chart-btn')[view === 'cards' ? 0 : 1].classList.add('active');
    }

    function openProcModal() {
        procEditingId = null;
        document.getElementById('procModalTitle').textContent = 'Add Processing Plant';
        document.getElementById('procPlantName').value = '';
        document.getElementById('procPlantLocation').value = '';
        document.getElementById('procPlantCapacity').value = '';
        document.getElementById('procPlantStatus').value = 'Active';
        document.getElementById('procPlantManager').value = '';

        // Reset product inputs
        const container = document.getElementById('procProductInputs');
        container.innerHTML = `
    <div class="product-row">
      <select class="productName form-control">
        <option value="">Select Product</option>
        ${PRODUCT_OPTIONS.map(p => `<option value="${p}">${p}</option>`).join('')}
      </select>
      <input type="number" class="productQty form-control" min="0" placeholder="Liters">
      <button class="btn btn-danger" onclick="removeProcProduct(this)"><i class="fas fa-trash"></i></button>
    </div>
  `;

        document.getElementById('capacityWarning').style.display = 'none';
        document.getElementById('procModal').style.display = 'flex';
    }

    function closeProcModal() {
        document.getElementById('procModal').style.display = 'none';
    }

    function addProcProduct() {
        const div = document.createElement('div');
        div.className = 'product-row';
        div.innerHTML = `
    <select class="productName form-control">
      <option value="">Select Product</option>
      ${PRODUCT_OPTIONS.map(p => `<option value="${p}">${p}</option>`).join('')}
    </select>
    <input type="number" class="productQty form-control" min="0" placeholder="Liters">
    <button class="btn btn-danger" onclick="removeProcProduct(this)"><i class="fas fa-trash"></i></button>
  `;
        document.getElementById('procProductInputs').appendChild(div);
    }

    function removeProcProduct(btn) {
        btn.parentElement.remove();
        validateCapacity();
    }

    function validateCapacity() {
        const capacity = parseInt(document.getElementById('procPlantCapacity').value) || 0;
        let totalProducts = 0;

        document.querySelectorAll('#procProductInputs .product-row').forEach(row => {
            const qty = parseInt(row.querySelector('.productQty').value) || 0;
            totalProducts += qty;
        });

        const warning = document.getElementById('capacityWarning');
        if (totalProducts > capacity) {
            warning.style.display = 'block';
            warning.textContent = `Total products (${totalProducts}L) exceed capacity (${capacity}L)!`;
            return false;
        }

        warning.style.display = 'none';
        return true;
    }

    function saveProcPlant() {
        const name = document.getElementById('procPlantName').value.trim();
        const location = document.getElementById('procPlantLocation').value.trim();
        const capacity = parseInt(document.getElementById('procPlantCapacity').value);
        const status = document.getElementById('procPlantStatus').value;
        const manager = document.getElementById('procPlantManager').value.trim();

        // Basic validation
        if (!name || !location || !manager || isNaN(capacity) || capacity <= 0) {
            alert('Please fill all required fields with valid values');
            return;
        }

        // Validate product quantities
        if (!validateCapacity()) {
            return;
        }

        // Collect products
        const products = {};
        let hasProducts = false;

        document.querySelectorAll('#procProductInputs .product-row').forEach(row => {
            const pname = row.querySelector('.productName').value;
            const pqty = parseInt(row.querySelector('.productQty').value) || 0;

            if (pname && pqty > 0) {
                products[pname] = pqty;
                hasProducts = true;
            }
        });

        if (!hasProducts) {
            alert('Please add at least one product');
            return;
        }

        // Create plant object
        const plant = {
            id: procEditingId || Date.now(),
            name,
            location,
            capacity,
            status,
            manager,
            products,
            activity: procEditingId ? 'Plant updated' : 'Plant created',
            timestamp: Date.now()
        };

        // Save to data
        if (procEditingId) {
            const index = procData.findIndex(p => p.id === procEditingId);
            procData[index] = plant;
        } else {
            procData.push(plant);
        }

        closeProcModal();
        renderProcessingAll();
    }

    function editProcPlant(id) {
        const p = procData.find(p => p.id === id);
        if (!p) return;

        procEditingId = id;
        document.getElementById('procModalTitle').textContent = 'Edit Plant: ' + p.name;
        document.getElementById('procPlantName').value = p.name;
        document.getElementById('procPlantLocation').value = p.location;
        document.getElementById('procPlantCapacity').value = p.capacity;
        document.getElementById('procPlantStatus').value = p.status;
        document.getElementById('procPlantManager').value = p.manager;

        const container = document.getElementById('procProductInputs');
        container.innerHTML = '';

        Object.entries(p.products).forEach(([k, v]) => {
            const row = document.createElement('div');
            row.className = 'product-row';
            row.innerHTML = `
      <select class="productName form-control">
        <option value="">Select Product</option>
        ${PRODUCT_OPTIONS.map(p =>
                `<option value="${p}" ${p === k ? 'selected' : ''}>${p}</option>`
            ).join('')}
      </select>
      <input type="number" class="productQty form-control" value="${v}" min="0" placeholder="Liters">
      <button class="btn btn-danger" onclick="removeProcProduct(this)"><i class="fas fa-trash"></i></button>
    `;
            container.appendChild(row);
        });

        document.getElementById('capacityWarning').style.display = 'none';
        document.getElementById('procModal').style.display = 'flex';
    }

    function deleteProcPlant(id) {
        if (!confirm('Are you sure you want to delete this plant?')) return;

        procData = procData.filter(p => p.id !== id);
        renderProcessingAll();
    }

    function renderProcActivities() {
        const logs = document.getElementById('procActivityLogs');
        logs.innerHTML = '';

        // Sort by timestamp descending
        const recent = [...procData]
            .sort((a, b) => b.timestamp - a.timestamp)
            .slice(0, 5);

        if (recent.length === 0) {
            logs.innerHTML = '<div class="no-activity">No recent activities</div>';
            return;
        }

        recent.forEach(p => {
            const item = document.createElement('div');
            item.className = 'log-item';
            item.innerHTML = `
      <div class="log-icon"><i class="fas fa-industry"></i></div>
      <div class="log-content">
        <div class="log-title">${p.name}</div>
        <div class="log-details">${p.activity}</div>
        <div class="log-time">
          <i class="far fa-clock"></i> ${formatDate(p.timestamp)}
        </div>
      </div>
    `;
            logs.appendChild(item);
        });
    }

    function formatDate(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function renderProcChart() {
        const ctx = document.getElementById('procStackedBarChart').getContext('2d');

        // Destroy previous chart instance if exists
        if (stackedBarChart) {
            stackedBarChart.destroy();
        }

        // Prepare data
        const labels = procData.map(p => p.name);
        const products = [...new Set(procData.flatMap(p => Object.keys(p.products)))];

        const datasets = products.map((product, i) => {
            const colors = [
                '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#6366f1',
                '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#64748b'
            ];

            return {
                label: product,
                data: procData.map(p => p.products[product] || 0),
                backgroundColor: colors[i % colors.length]
            };
        });

        // Create chart
        stackedBarChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        stacked: true,
                        title: {
                            display: true,
                            text: 'Plants'
                        }
                    },
                    y: {
                        stacked: true,
                        title: {
                            display: true,
                            text: 'Liters'
                        },
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Plant-wise Stacked Products'
                    }
                }
            }
        });
    }

    // Add event listeners for capacity validation
    document.getElementById('procPlantCapacity').addEventListener('input', validateCapacity);
    document.getElementById('procProductInputs').addEventListener('input', function (e) {
        if (e.target.classList.contains('productQty')) {
            validateCapacity();
        }
    });

    window.addEventListener('DOMContentLoaded', renderProcessingAll);
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Product catalog with default values
    const invx_catalog = {
        "Whole Milk 1L": { sku: "MILK-001", category: "Milk", price: 60 },
        "Butter 500g": { sku: "BUT-045", category: "Butter", price: 180 },
        "Yogurt 250g": { sku: "YOG-210", category: "Yogurt", price: 40 },
        "Paneer 200g": { sku: "PNR-500", category: "Paneer", price: 75 },
        "Ghee 1L": { sku: "GHEE-900", category: "Ghee", price: 420 }
    };

    // Inventory data
    let invx_data = [];
    let invx_chart = null;

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
        // Load sample data
        invx_data = [
            {
                name: "Whole Milk 1L",
                sku: "MILK-001",
                category: "Milk",
                stock: 500,
                price: 60,
                manufacture: "2025-06-20",
                expiry: "2025-07-10",
                status: "Available",
                supplier: "Dairy Corp"
            },
            {
                name: "Butter 500g",
                sku: "BUT-045",
                category: "Butter",
                stock: 45,
                price: 180,
                manufacture: "2025-06-01",
                expiry: "2025-06-25",
                status: "Low Stock",
                supplier: "AgroMart"
            },
            {
                name: "Paneer 200g",
                sku: "PNR-500",
                category: "Paneer",
                stock: 200,
                price: 75,
                manufacture: "2025-06-15",
                expiry: "2025-06-30",
                status: "Available",
                supplier: "Local Dairy"
            }
        ];

        // Setup event listeners
        document.getElementById('invx_form').addEventListener('submit', handleFormSubmit);

        // Initial render
        renderAllInventory();
    });

    // Auto-fill form from product catalog
    function autoFillProduct() {
        const sel = document.getElementById("invx_dropdown").value;
        if (sel && invx_catalog[sel]) {
            const p = invx_catalog[sel];
            document.getElementById("invx_name").value = sel;
            document.getElementById("invx_sku").value = p.sku;
            document.getElementById("invx_category").value = p.category;
            document.getElementById("invx_price").value = p.price;
        }
    }

    // Log inventory activity
    function logInvActivity(action, name) {
        const log = document.getElementById("invx_log");
        const li = document.createElement("li");

        const icon = document.createElement("i");
        if (action === "Added") icon.className = "fas fa-plus-circle text-success";
        else if (action === "Edited") icon.className = "fas fa-edit text-primary";
        else if (action === "Deleted") icon.className = "fas fa-trash-alt text-danger";

        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const date = new Date().toLocaleDateString();

        li.appendChild(icon);
        li.innerHTML += ` <strong>${action}:</strong> ${name} <span class="activity-time">${date} at ${time}</span>`;
        log.prepend(li);

        // Keep only last 10 activities
        if (log.children.length > 10) {
            log.removeChild(log.lastChild);
        }
    }

    // Update summary cards
    function updateInvCards() {
        const totalProducts = invx_data.length;
        const totalStock = invx_data.reduce((sum, i) => sum + parseInt(i.stock), 0);
        const totalValue = invx_data.reduce((sum, i) => sum + (parseInt(i.stock) * parseFloat(i.price)), 0);
        const expiringSoon = invx_data.filter(i => {
            const expiryDate = new Date(i.expiry);
            const today = new Date();
            const daysDiff = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
            return daysDiff <= 7 && daysDiff >= 0;
        }).length;

        document.getElementById("invx_totalProducts").textContent = totalProducts;
        document.getElementById("invx_totalStock").textContent = totalStock;
        document.getElementById("invx_totalValue").textContent = `‚Çπ${totalValue.toLocaleString('en-IN')}`;
        document.getElementById("invx_expiringSoon").textContent = expiringSoon;
    }

    // Update expiry summary
    function updateExpirySummary() {
        const range = parseInt(document.getElementById("invx_expiryRange").value);
        const today = new Date();
        const futureDate = new Date();
        futureDate.setDate(today.getDate() + range);

        const count = invx_data.filter(i => {
            const expiryDate = new Date(i.expiry);
            return expiryDate >= today && expiryDate <= futureDate;
        }).length;

        document.getElementById("invx_expiryCount").textContent = count;
    }

    // Render the bar chart
    function renderBarChart() {
        const ctx = document.getElementById("invx_categoryBarChart").getContext("2d");

        // Destroy existing chart if it exists
        if (invx_chart) {
            invx_chart.destroy();
        }

        // Group by category
        const categories = [...new Set(invx_data.map(i => i.category))];
        const stockByCategory = {};

        categories.forEach(cat => {
            stockByCategory[cat] = invx_data
                .filter(i => i.category === cat)
                .reduce((sum, i) => sum + parseInt(i.stock), 0);
        });

        // Create chart
        invx_chart = new Chart(ctx, {
            type: "bar",
            data: {
                labels: categories,
                datasets: [{
                    label: "Stock Quantity",
                    data: categories.map(cat => stockByCategory[cat]),
                    backgroundColor: [
                        '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b',
                        '#5a5c69', '#858796', '#3a3b45', '#00cc99', '#ff9966'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Stock by Category'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        },
                        title: {
                            display: true,
                            text: 'Quantity'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Categories'
                        }
                    }
                }
            }
        });
    }

    // Render inventory table
    function renderTable() {
        const tbody = document.getElementById("invx_body");
        tbody.innerHTML = "";

        invx_data.forEach((item, i) => {
            const row = document.createElement("tr");

            // Calculate days until expiry
            const today = new Date();
            const expiryDate = new Date(item.expiry);
            const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));

            // Determine row class based on status
            if (item.status === "Expired" || daysUntilExpiry < 0) {
                row.classList.add("expired-row");
            } else if (item.status === "Low Stock" || daysUntilExpiry <= 7) {
                row.classList.add("warning-row");
            }

            row.innerHTML = `
                <td>${item.name}</td>
                <td>${item.sku}</td>
                <td>${item.category}</td>
                <td>${item.stock}</td>
                <td>‚Çπ${item.price.toLocaleString('en-IN')}</td>
                <td>${formatDate(item.manufacture)}</td>
                <td>${formatDate(item.expiry)} ${daysUntilExpiry >= 0 ? `(${daysUntilExpiry} days)` : '(Expired)'}</td>
                <td>${item.status}</td>
                <td>${item.supplier || '-'}</td>
                <td class="actions">
                    <button class="btn-edit" onclick="editInv(${i})">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="btn-delete" onclick="deleteInv(${i})">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </td>
            `;

            tbody.appendChild(row);
        });
    }

    // Format date for display
    function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-GB', {
            day: '2-digit',
            month: 'short',
            year: 'numeric'
        });
    }

    // Open modal for adding/editing
    function openInvModal() {
        document.getElementById("invx_modal").style.display = "flex";
        document.getElementById("invx_form").reset();
        document.getElementById("invx_manu").valueAsDate = new Date();

        // Set expiry to 30 days from now
        const expiryDate = new Date();
        expiryDate.setDate(expiryDate.getDate() + 30);
        document.getElementById("invx_expiry").valueAsDate = expiryDate;

        document.getElementById("invx_editIndex").value = "";
        document.getElementById("invx_modalTitle").textContent = "Add Product";
        document.getElementById("invx_dropdown").value = "";
    }

    // Close modal
    function closeInvModal() {
        document.getElementById("invx_modal").style.display = "none";
    }

    // Handle form submission
    function handleFormSubmit(e) {
        e.preventDefault();

        const name = document.getElementById("invx_name").value.trim();
        const sku = document.getElementById("invx_sku").value.trim();
        const category = document.getElementById("invx_category").value.trim();
        const stock = parseInt(document.getElementById("invx_stock").value);
        const price = parseFloat(document.getElementById("invx_price").value);
        const manufacture = document.getElementById("invx_manu").value;
        const expiry = document.getElementById("invx_expiry").value;
        const status = document.getElementById("invx_status").value;
        const supplier = document.getElementById("invx_supplier").value.trim();

        // Validate inputs
        if (!name || !sku || !category) {
            alert("Please fill in all required fields");
            return;
        }

        if (isNaN(stock)) {
            alert("Please enter a valid stock quantity");
            return;
        }

        if (isNaN(price)) {
            alert("Please enter a valid price");
            return;
        }

        // Create item object
        const item = {
            name,
            sku,
            category,
            stock,
            price,
            manufacture,
            expiry,
            status,
            supplier: supplier || "N/A"
        };

        const idx = document.getElementById("invx_editIndex").value;
        let action = "Added";

        if (idx === "") {
            // Add new item
            invx_data.push(item);
        } else {
            // Update existing item
            invx_data[idx] = item;
            action = "Edited";
        }

        logInvActivity(action, name);
        closeInvModal();
        renderAllInventory();
    }

    // Edit inventory item
    function editInv(i) {
        const item = invx_data[i];
        openInvModal();

        document.getElementById("invx_editIndex").value = i;
        document.getElementById("invx_name").value = item.name;
        document.getElementById("invx_sku").value = item.sku;
        document.getElementById("invx_category").value = item.category;
        document.getElementById("invx_stock").value = item.stock;
        document.getElementById("invx_price").value = item.price;
        document.getElementById("invx_manu").value = item.manufacture;
        document.getElementById("invx_expiry").value = item.expiry;
        document.getElementById("invx_status").value = item.status;
        document.getElementById("invx_supplier").value = item.supplier;
        document.getElementById("invx_modalTitle").textContent = "Edit Product";
        document.getElementById("invx_dropdown").value = "";
    }

    // Delete inventory item
    function deleteInv(i) {
        if (!confirm("Are you sure you want to delete this product?")) return;

        const name = invx_data[i].name;
        invx_data.splice(i, 1);
        logInvActivity("Deleted", name);
        renderAllInventory();
    }

    // Filter inventory table
    function filterInventory() {
        const searchTerm = document.getElementById("invx_search").value.toLowerCase();
        const rows = document.getElementById("invx_body").getElementsByTagName("tr");

        for (let row of rows) {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? "" : "none";
        }
    }

    // Export to CSV
    function exportInvCSV() {
        let csv = "Name,SKU,Category,Stock,Price,Manufacture,Expiry,Status,Supplier\n";

        invx_data.forEach(item => {
            csv += `"${item.name}",${item.sku},${item.category},${item.stock},${item.price},${item.manufacture},${item.expiry},${item.status},"${item.supplier}"\n`;
        });

        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");

        a.href = url;
        a.download = "inventory_export.csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        logInvActivity("Exported", "CSV file");
    }

    // Import from CSV
    function importInvCSV(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
            const contents = e.target.result;
            const lines = contents.split("\n");
            const newData = [];

            // Skip header line
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const values = line.split(",");
                if (values.length < 8) continue;

                // Handle quoted values
                const name = values[0].replace(/^"|"$/g, '');
                const supplier = values[8] ? values[8].replace(/^"|"$/g, '') : "N/A";

                newData.push({
                    name: name,
                    sku: values[1],
                    category: values[2],
                    stock: parseInt(values[3]),
                    price: parseFloat(values[4]),
                    manufacture: values[5],
                    expiry: values[6],
                    status: values[7],
                    supplier: supplier
                });
            }

            invx_data = [...invx_data, ...newData];
            renderAllInventory();
            logInvActivity("Imported", `${newData.length} products from CSV`);
        };

        reader.readAsText(file);
    }

    // Render all inventory components
    function renderAllInventory() {
        updateInvCards();
        updateExpirySummary();
        renderBarChart();
        renderTable();
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Delivery data with unique variable names
        let distDeliveries = [
            {
                id: "D001",
                customer: "Ravi Dairy",
                product: "Full Cream Milk",
                quantity: "500L",
                date: "2025-06-21",
                address: "Hyderabad",
                amount: "‚Çπ12,000",
                status: "Delivered",
                deliveryTime: 4.2,
                region: "Hyderabad"
            },
            {
                id: "D002",
                customer: "Sujatha Stores",
                product: "Paneer",
                quantity: "80kg",
                date: "2025-06-22",
                address: "Vijayawada",
                amount: "‚Çπ6,400",
                status: "Pending",
                deliveryTime: null,
                region: "Vijayawada"
            },
            {
                id: "D003",
                customer: "Milk Magic",
                product: "Toned Milk",
                quantity: "300L",
                date: "2025-06-20",
                address: "Guntur",
                amount: "‚Çπ7,500",
                status: "In Transit",
                deliveryTime: 5.8,
                region: "Guntur"
            },
            {
                id: "D004",
                customer: "Fresh Foods",
                product: "Butter",
                quantity: "50kg",
                date: "2025-06-23",
                address: "Visakhapatnam",
                amount: "‚Çπ9,000",
                status: "In Transit",
                deliveryTime: 6.3,
                region: "Visakhapatnam"
            },
            {
                id: "D005",
                customer: "Urban Dairy",
                product: "Ghee",
                quantity: "25L",
                date: "2025-06-19",
                address: "Nellore",
                amount: "‚Çπ10,500",
                status: "Delivered",
                deliveryTime: 3.7,
                region: "Nellore"
            },
            {
                id: "D006",
                customer: "City Supermarket",
                product: "Yogurt",
                quantity: "200 units",
                date: "2025-06-24",
                address: "Hyderabad",
                amount: "‚Çπ8,500",
                status: "Delivered",
                deliveryTime: 4.5,
                region: "Hyderabad"
            },
            {
                id: "D007",
                customer: "Daily Needs",
                product: "Full Cream Milk",
                quantity: "350L",
                date: "2025-06-25",
                address: "Vijayawada",
                amount: "‚Çπ9,800",
                status: "In Transit",
                deliveryTime: 5.2,
                region: "Vijayawada"
            },
            {
                id: "D008",
                customer: "Organic Mart",
                product: "Paneer",
                quantity: "60kg",
                date: "2025-06-18",
                address: "Guntur",
                amount: "‚Çπ5,400",
                status: "Cancelled",
                deliveryTime: null,
                region: "Guntur"
            }
        ];

        // Chart instances with unique names
        let distVolumeChart, distStatusChart, distRegionChart, distDeliveryTimeChart;
        
        // Initialize dashboard
        document.addEventListener("DOMContentLoaded", () => {
            // Set up event listeners
            document.getElementById('dist-delivery-form').addEventListener('submit', handleDistDeliverySubmit);
            document.getElementById('dist-add-delivery-btn').addEventListener('click', openDistDeliveryModal);
            document.querySelector('.modal-close').addEventListener('click', closeDistDeliveryModal);
            document.querySelector('.btn-outline').addEventListener('click', closeDistDeliveryModal);
            document.getElementById('dist-time-filter').addEventListener('change', renderDistAllCharts);
            document.getElementById('dist-region-filter').addEventListener('change', renderDistDeliveryTimeChart);
            document.getElementById('dist-search-input').addEventListener('input', filterDistDeliveries);
            document.getElementById('dist-status-filter').addEventListener('change', filterDistDeliveries);
            document.getElementById('dist-region-table-filter').addEventListener('change', filterDistDeliveries);

            // Initialize dashboard
            updateDistDashboard();
            renderDistDeliveriesTable();
            renderDistAllCharts();
        });

        // Update all dashboard components
        function updateDistDashboard() {
            // Calculate metrics
            const totalDeliveries = distDeliveries.length;
            const deliveredCount = distDeliveries.filter(d => d.status === "Delivered").length;
            const onTimeRate = totalDeliveries > 0 ? Math.round((deliveredCount / totalDeliveries) * 100) : 0;
            
            // Calculate average delivery time for delivered orders
            const deliveredOrders = distDeliveries.filter(d => d.status === "Delivered" && d.deliveryTime);
            const totalDeliveryTime = deliveredOrders.reduce((sum, order) => sum + order.deliveryTime, 0);
            const avgDeliveryTime = deliveredOrders.length > 0 ? (totalDeliveryTime / deliveredOrders.length).toFixed(1) : 0;
            
            // Generate fuel efficiency based on average delivery time
            const fuelEfficiency = (12.5 - (avgDeliveryTime * 0.2)).toFixed(1);
            
            // Calculate trends (random but plausible)
            const deliveriesChange = (Math.random() * 10).toFixed(1);
            const onTimeChange = (Math.random() * 5).toFixed(1);
            const deliveryTimeChange = (Math.random() * 1.5).toFixed(1);
            const fuelChange = (Math.random() * 0.5).toFixed(1);

            // Update summary cards
            document.getElementById("dist-total-deliveries").textContent = totalDeliveries;
            document.getElementById("dist-on-time-rate").textContent = `${onTimeRate}%`;
            document.getElementById("dist-avg-delivery-time").textContent = `${avgDeliveryTime} hrs`;
            document.getElementById("dist-fuel-efficiency").textContent = `${fuelEfficiency} km/L`;

            // Update trends
            document.getElementById("dist-deliveries-change").textContent = `${deliveriesChange}%`;
            document.getElementById("dist-on-time-change").textContent = `${onTimeChange}%`;
            document.getElementById("dist-delivery-time-change").textContent = `${deliveryTimeChange} hrs`;
            document.getElementById("dist-fuel-change").textContent = `${fuelChange} km/L`;
        }

        // Render delivery table
        function renderDistDeliveriesTable() {
            const tbody = document.getElementById("dist-deliveries-table-body");
            tbody.innerHTML = "";

            distDeliveries.forEach(delivery => {
                const row = document.createElement("tr");
                row.dataset.id = delivery.id;

                row.innerHTML = `
                    <td>${delivery.id}</td>
                    <td>${delivery.customer}</td>
                    <td>${delivery.product}</td>
                    <td>${delivery.quantity}</td>
                    <td>${formatDistDate(delivery.date)}</td>
                    <td>${delivery.address}</td>
                    <td>${delivery.amount}</td>
                    <td><span class="status-badge status-${delivery.status.toLowerCase().replace(' ', '-')}">${delivery.status}</span></td>
                    <td class="actions">
                        <button class="action-btn edit-btn">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete delete-btn">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;

                tbody.appendChild(row);
            });

            // Add event listeners to action buttons
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const deliveryId = this.closest('tr').dataset.id;
                    editDistDelivery(deliveryId);
                });
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const deliveryId = this.closest('tr').dataset.id;
                    deleteDistDelivery(deliveryId);
                });
            });
        }

        // Format date for display
        function formatDistDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        }

        // Render all charts
        function renderDistAllCharts() {
            renderDistVolumeChart();
            renderDistStatusChart();
            renderDistRegionChart();
            renderDistDeliveryTimeChart();
        }

        // Render delivery volume chart
        function renderDistVolumeChart() {
            const ctx = document.getElementById("dist-deliveryVolumeChart").getContext("2d");

            // Destroy existing chart if it exists
            if (distVolumeChart) distVolumeChart.destroy();

            const range = document.getElementById("dist-time-filter").value;
            const labels = ["Full Cream Milk", "Toned Milk", "Paneer", "Butter", "Ghee", "Yogurt"];

            // Generate data based on selected range
            const data = labels.map(() => Math.floor(Math.random() * 1000) + 200);

            distVolumeChart = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Volume (L/Kg)",
                        data: data,
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(255, 159, 64, 0.7)',
                            'rgba(153, 102, 255, 0.7)',
                            'rgba(201, 203, 207, 0.7)',
                            'rgba(255, 99, 132, 0.7)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: `Delivery Volume (Last ${range} Days)`,
                            font: { size: 16 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Volume (L/Kg)',
                                font: { size: 14 }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Products',
                                font: { size: 14 }
                            }
                        }
                    }
                }
            });
        }

        // Render status distribution chart
        function renderDistStatusChart() {
            const ctx = document.getElementById("dist-statusDistributionChart").getContext("2d");

            // Destroy existing chart if it exists
            if (distStatusChart) distStatusChart.destroy();

            // Count statuses
            const statusCounts = {
                Delivered: distDeliveries.filter(d => d.status === "Delivered").length,
                Pending: distDeliveries.filter(d => d.status === "Pending").length,
                "In Transit": distDeliveries.filter(d => d.status === "In Transit").length,
                Cancelled: distDeliveries.filter(d => d.status === "Cancelled").length
            };

            distStatusChart = new Chart(ctx, {
                type: "doughnut",
                data: {
                    labels: ["Delivered", "Pending", "In Transit", "Cancelled"],
                    datasets: [{
                        data: [
                            statusCounts.Delivered,
                            statusCounts.Pending,
                            statusCounts["In Transit"],
                            statusCounts.Cancelled
                        ],
                        backgroundColor: ["#10b981", "#f59e0b", "#3b82f6", "#ef4444"]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        title: {
                            display: true,
                            text: 'Delivery Status Distribution',
                            font: { size: 16 }
                        }
                    }
                }
            });
        }

        // Render region performance chart
        function renderDistRegionChart() {
            const ctx = document.getElementById("dist-regionPerformanceChart").getContext("2d");

            // Destroy existing chart if it exists
            if (distRegionChart) distRegionChart.destroy();

            // Group by region
            const regions = {};
            distDeliveries.forEach(delivery => {
                if (!regions[delivery.region]) {
                    regions[delivery.region] = 0;
                }
                regions[delivery.region]++;
            });

            const sortedRegions = Object.entries(regions)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const regionLabels = sortedRegions.map(r => r[0]);
            const regionData = sortedRegions.map(r => r[1]);

            distRegionChart = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: regionLabels,
                    datasets: [{
                        label: "Deliveries",
                        data: regionData,
                        backgroundColor: "rgba(74, 108, 247, 0.7)",
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Regional Delivery Performance',
                            font: { size: 16 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Deliveries',
                                font: { size: 14 }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Regions',
                                font: { size: 14 }
                            }
                        }
                    }
                }
            });
        }

        // Render delivery time analysis chart
        function renderDistDeliveryTimeChart() {
            const ctx = document.getElementById("dist-deliveryTimeChart").getContext("2d");
            const selectedRegion = document.getElementById("dist-region-filter").value;

            // Destroy existing chart if it exists
            if (distDeliveryTimeChart) distDeliveryTimeChart.destroy();

            // Filter data
            let filteredDeliveries = distDeliveries;
            if (selectedRegion) {
                filteredDeliveries = distDeliveries.filter(d => d.region === selectedRegion);
            }

            // Group by product
            const productTimes = {};
            filteredDeliveries.forEach(delivery => {
                if (delivery.deliveryTime) {
                    if (!productTimes[delivery.product]) {
                        productTimes[delivery.product] = {
                            total: 0,
                            count: 0
                        };
                    }
                    productTimes[delivery.product].total += delivery.deliveryTime;
                    productTimes[delivery.product].count++;
                }
            });

            const products = Object.keys(productTimes);
            const avgTimes = products.map(product => 
                (productTimes[product].total / productTimes[product].count).toFixed(1)
            );

            distDeliveryTimeChart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: products,
                    datasets: [{
                        label: "Avg. Delivery Time (hrs)",
                        data: avgTimes,
                        backgroundColor: "rgba(139, 92, 246, 0.2)",
                        borderColor: "rgba(139, 92, 246, 1)",
                        borderWidth: 3,
                        tension: 0.3,
                        pointRadius: 6,
                        pointBackgroundColor: "#fff",
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: selectedRegion 
                                ? `Delivery Times in ${selectedRegion}` 
                                : 'Delivery Time Analysis',
                            font: { size: 16 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 0,
                            title: {
                                display: true,
                                text: 'Hours',
                                font: { size: 14 }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Products',
                                font: { size: 14 }
                            }
                        }
                    }
                }
            });
        }

        // Filter deliveries
        function filterDistDeliveries() {
            const searchTerm = document.getElementById("dist-search-input").value.toLowerCase();
            const statusFilter = document.getElementById("dist-status-filter").value;
            const regionFilter = document.getElementById("dist-region-table-filter").value;

            const filtered = distDeliveries.filter(d => {
                const matchesSearch = d.customer.toLowerCase().includes(searchTerm) ||
                    d.product.toLowerCase().includes(searchTerm) ||
                    d.address.toLowerCase().includes(searchTerm);
                const matchesStatus = statusFilter ? d.status === statusFilter : true;
                const matchesRegion = regionFilter ? d.region === regionFilter : true;
                return matchesSearch && matchesStatus && matchesRegion;
            });

            // Render filtered results
            const tbody = document.getElementById("dist-deliveries-table-body");
            tbody.innerHTML = "";

            filtered.forEach(delivery => {
                const row = document.createElement("tr");
                row.dataset.id = delivery.id;

                row.innerHTML = `
                    <td>${delivery.id}</td>
                    <td>${delivery.customer}</td>
                    <td>${delivery.product}</td>
                    <td>${delivery.quantity}</td>
                    <td>${formatDistDate(delivery.date)}</td>
                    <td>${delivery.address}</td>
                    <td>${delivery.amount}</td>
                    <td><span class="status-badge status-${delivery.status.toLowerCase().replace(' ', '-')}">${delivery.status}</span></td>
                    <td class="actions">
                        <button class="action-btn edit-btn">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete delete-btn">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Reattach event listeners
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const deliveryId = this.closest('tr').dataset.id;
                    editDistDelivery(deliveryId);
                });
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const deliveryId = this.closest('tr').dataset.id;
                    deleteDistDelivery(deliveryId);
                });
            });
        }

        // Open delivery modal
        function openDistDeliveryModal() {
            document.getElementById("dist-delivery-modal").style.display = "flex";
            document.getElementById("dist-delivery-form").reset();
            document.getElementById("dist-edit-id").value = "";
            document.getElementById("dist-modal-title").textContent = "Add New Delivery";
            document.getElementById("dist-date").valueAsDate = new Date();
            
            // Reset error states
            document.querySelectorAll('.error').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.form-control').forEach(el => el.classList.remove('invalid'));
        }

        // Close delivery modal
        function closeDistDeliveryModal() {
            document.getElementById("dist-delivery-modal").style.display = "none";
        }

        // Form validation
        function validateDistForm() {
            let isValid = true;
            
            // Customer validation
            const customer = document.getElementById("dist-customer").value.trim();
            if (!customer || customer.length < 3) {
                document.getElementById("dist-customer-error").style.display = 'block';
                document.getElementById("dist-customer").classList.add('invalid');
                isValid = false;
            } else {
                document.getElementById("dist-customer-error").style.display = 'none';
                document.getElementById("dist-customer").classList.remove('invalid');
            }
            
            // Product validation
            const product = document.getElementById("dist-product").value;
            if (!product) {
                document.getElementById("dist-product-error").style.display = 'block';
                document.getElementById("dist-product").classList.add('invalid');
                isValid = false;
            } else {
                document.getElementById("dist-product-error").style.display = 'none';
                document.getElementById("dist-product").classList.remove('invalid');
            }
            
            // Quantity validation
            const quantity = document.getElementById("dist-quantity").value.trim();
            const quantityRegex = /^\d+\s*(kg|L|units)$/i;
            if (!quantity || !quantityRegex.test(quantity)) {
                document.getElementById("dist-quantity-error").style.display = 'block';
                document.getElementById("dist-quantity").classList.add('invalid');
                isValid = false;
            } else {
                document.getElementById("dist-quantity-error").style.display = 'none';
                document.getElementById("dist-quantity").classList.remove('invalid');
            }
            
            // Date validation
            const date = document.getElementById("dist-date").value;
            if (!date) {
                document.getElementById("dist-date-error").style.display = 'block';
                document.getElementById("dist-date").classList.add('invalid');
                isValid = false;
            } else {
                document.getElementById("dist-date-error").style.display = 'none';
                document.getElementById("dist-date").classList.remove('invalid');
            }
            
            // Address validation
            const address = document.getElementById("dist-address").value.trim();
            if (!address || address.length < 5) {
                document.getElementById("dist-address-error").style.display = 'block';
                document.getElementById("dist-address").classList.add('invalid');
                isValid = false;
            } else {
                document.getElementById("dist-address-error").style.display = 'none';
                document.getElementById("dist-address").classList.remove('invalid');
            }
            
            // Amount validation
            const amount = document.getElementById("dist-amount").value;
            if (!amount || isNaN(amount) || amount <= 0) {
                document.getElementById("dist-amount-error").style.display = 'block';
                document.getElementById("dist-amount").classList.add('invalid');
                isValid = false;
            } else {
                document.getElementById("dist-amount-error").style.display = 'none';
                document.getElementById("dist-amount").classList.remove('invalid');
            }
            
            return isValid;
        }

        // Handle delivery form submission
        function handleDistDeliverySubmit(e) {
            e.preventDefault();
            
            if (!validateDistForm()) return;

            // Get form values
            const customer = document.getElementById("dist-customer").value.trim();
            const product = document.getElementById("dist-product").value;
            const quantity = document.getElementById("dist-quantity").value.trim();
            const date = document.getElementById("dist-date").value;
            const address = document.getElementById("dist-address").value.trim();
            const amount = document.getElementById("dist-amount").value;
            const status = document.getElementById("dist-status").value;
            const editId = document.getElementById("dist-edit-id").value;

            // Extract region from address (simple implementation)
            const regions = ["Hyderabad", "Vijayawada", "Guntur", "Visakhapatnam", "Nellore"];
            const foundRegion = regions.find(region => address.includes(region));
            const region = foundRegion || "Other";

            // Generate delivery time based on region and status
            let deliveryTime = null;
            if (status === "Delivered") {
                // Base time + random variation
                deliveryTime = parseFloat((4 + Math.random() * 3).toFixed(1));
            }

            // Create delivery object
            const delivery = {
                id: editId || `D${String(distDeliveries.length + 1).padStart(3, '0')}`,
                customer,
                product,
                quantity,
                date,
                address,
                amount: `‚Çπ${parseInt(amount).toLocaleString('en-IN')}`,
                status,
                deliveryTime,
                region
            };

            // Add or update delivery
            if (editId) {
                const index = distDeliveries.findIndex(d => d.id === editId);
                if (index !== -1) {
                    distDeliveries[index] = delivery;
                }
            } else {
                distDeliveries.push(delivery);
            }

            // Update UI
            closeDistDeliveryModal();
            updateDistDashboard();
            renderDistDeliveriesTable();
            renderDistAllCharts();
            
            // Highlight the updated row
            const row = document.querySelector(`tr[data-id="${delivery.id}"]`);
            if (row) {
                row.classList.add('highlight-row');
                setTimeout(() => {
                    row.classList.remove('highlight-row');
                }, 2000);
            }
        }

        // Edit delivery
        function editDistDelivery(id) {
            const delivery = distDeliveries.find(d => d.id === id);
            if (!delivery) return;

            openDistDeliveryModal();
            document.getElementById("dist-edit-id").value = delivery.id;
            document.getElementById("dist-customer").value = delivery.customer;
            document.getElementById("dist-product").value = delivery.product;
            document.getElementById("dist-quantity").value = delivery.quantity;
            document.getElementById("dist-date").value = delivery.date;
            document.getElementById("dist-address").value = delivery.address;
            document.getElementById("dist-amount").value = delivery.amount.replace('‚Çπ', '').replace(/,/g, '');
            document.getElementById("dist-status").value = delivery.status;
            document.getElementById("dist-modal-title").textContent = "Edit Delivery";
        }

        // Delete delivery
        function deleteDistDelivery(id) {
            if (!confirm("Are you sure you want to delete this delivery?")) return;

            distDeliveries = distDeliveries.filter(d => d.id !== id);
            updateDistDashboard();
            renderDistDeliveriesTable();
            renderDistAllCharts();
        }
    </script>
<script>
    (() => {
        const dashboardKpisEl = document.getElementById("dashboard-kpis");
        const regionBlocksEl = document.getElementById("region-blocks");
        const searchInputEl = document.getElementById("search-input");
        const filterTypeEl = document.getElementById("filter-type");
        const filterZoneEl = document.getElementById("filter-zone");
        const filterStatusEl = document.getElementById("filter-status");
        const openAddModalBtn = document.getElementById("open-add-modal");
        const addOutletModal = document.getElementById("add-outlet-modal");
        const addOutletForm = document.getElementById("add-outlet-form");
        const closeModalBtn = document.getElementById("close-modal");

        const outletCardList = document.getElementById("outlet-card-list");
        const outletTableContainer = document.getElementById("outlet-table-container");
        const outletTableBody = document.querySelector("#outlet-table tbody");

        const toggleCardBtn = document.getElementById("toggle-card");
        const toggleTableBtn = document.getElementById("toggle-table");

        const activityFeed = document.getElementById("activity-feed");
        const pipelineBoard = document.getElementById("pipeline-board");

        const infoModal = document.getElementById("info-modal");
        const infoDetails = document.getElementById("info-details");
        const infoMap = document.getElementById("info-map");
        const closeInfoBtn = document.getElementById("close-info");

        const fullMapFrame = document.getElementById("full-map");

        const ZONES = ["north", "south", "east", "west"];
        const TYPES = ["retail", "franchise"];
        const STATUSES = ["setup", "pending", "active", "inactive"];

        let outlets = [];
        let recentActivities = [];
        let editId = null;

        function loadData() {
            const savedOutlets = localStorage.getItem("dairy_crm_outlets");
            const savedActivities = localStorage.getItem("dairy_crm_activities");

            outlets = savedOutlets ? JSON.parse(savedOutlets) : getSampleOutlets();
            recentActivities = savedActivities ? JSON.parse(savedActivities) : [];

            if (!savedOutlets) saveData();
            if (!savedActivities) saveActivities();
        }

        function saveData() {
            localStorage.setItem("dairy_crm_outlets", JSON.stringify(outlets));
        }

        function saveActivities() {
            localStorage.setItem("dairy_crm_activities", JSON.stringify(recentActivities));
        }

        function getSampleOutlets() {
            return [
                {
                    id: generateId(),
                    name: "Amul Milk Center",
                    type: "retail",
                    zone: "north",
                    owner: "Ramesh Kumar",
                    contact: "9812345678",
                    status: "active",
                    rating: 4,
                    revenue: 50000,
                    expenses: 20000,
                    latitude: 28.7041,
                    longitude: 77.1025,
                }
            ];
        }

        function generateId() {
            return "_" + Math.random().toString(36).substr(2, 9);
        }

        function formatCurrency(num) {
            return `‚Çπ${num.toLocaleString("en-IN")}`;
        }

        function profit(o) {
            return o.revenue - o.expenses;
        }

        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function renderDashboard() {
            const totalOutlets = outlets.length;
            const totalRevenue = outlets.reduce((sum, o) => sum + o.revenue, 0);
            const totalExpenses = outlets.reduce((sum, o) => sum + o.expenses, 0);
            const totalProfit = totalRevenue - totalExpenses;
            const avgRating = outlets.length ? (outlets.reduce((sum, o) => sum + o.rating, 0) / outlets.length).toFixed(1) : 0;

            dashboardKpisEl.innerHTML = `
      <div class="card"><span>Total Outlets</span><h2>${totalOutlets}</h2></div>
      <div class="card"><span>Total Revenue</span><h2>${formatCurrency(totalRevenue)}</h2></div>
      <div class="card"><span>Total Expenses</span><h2>${formatCurrency(totalExpenses)}</h2></div>
      <div class="card"><span>Total Profit</span><h2 style="color:${totalProfit >= 0 ? 'green' : 'red'}">${formatCurrency(totalProfit)}</h2></div>
      <div class="card"><span>Average Rating</span><h2>${avgRating} ‚≠ê</h2></div>
    `;
        }

        function renderRegionSummary() {
            regionBlocksEl.innerHTML = ZONES.map(zone => {
                const count = outlets.filter(o => o.zone === zone).length;
                return `<div class="card">${zone.toUpperCase()}: ${count}</div>`;
            }).join("");
        }

        function renderStars(n) {
            return "‚≠ê".repeat(n) + "‚òÜ".repeat(5 - n);
        }

        function renderOutletCards(list) {
            outletCardList.innerHTML = list.map(o => `
      <div class="card">
        <h3>${o.name}</h3>
        <p><strong>Type:</strong> ${capitalize(o.type)}</p>
        <p><strong>Zone:</strong> ${capitalize(o.zone)}</p>
        <p><strong>Owner:</strong> ${o.owner}</p>
        <p><strong>Contact:</strong> ${o.contact}</p>
        <p><strong>Status:</strong> ${capitalize(o.status)}</p>
        <p><strong>Rating:</strong> ${renderStars(o.rating)}</p>
        <p><strong>Revenue:</strong> ${formatCurrency(o.revenue)}</p>
        <p><strong>Expenses:</strong> ${formatCurrency(o.expenses)}</p>
        <p><strong>Profit:</strong> <span style="color:${profit(o) >= 0 ? 'green' : 'red'}">${formatCurrency(profit(o))}</span></p>
        <div class="btn-row">
          <button class="btn warning" data-id="${o.id}" data-action="edit">Edit</button>
          <button class="btn danger" data-id="${o.id}" data-action="delete">Delete</button>
          <button class="btn info" data-id="${o.id}" data-action="info">More Info</button>
        </div>
      </div>
    `).join("") || `<p>No outlets found.</p>`;
        }

        function renderOutletTable(list) {
            outletTableBody.innerHTML = list.map(o => `
      <tr>
        <td>${o.name}</td>
        <td>${capitalize(o.type)}</td>
        <td>${capitalize(o.zone)}</td>
        <td>${o.owner}</td>
        <td>${o.contact}</td>
        <td>${capitalize(o.status)}</td>
        <td>${renderStars(o.rating)}</td>
        <td>${formatCurrency(o.revenue)}</td>
        <td>${formatCurrency(o.expenses)}</td>
        <td style="color:${profit(o) >= 0 ? 'green' : 'red'}">${formatCurrency(profit(o))}</td>
        <td>
          <button class="btn warning" data-id="${o.id}" data-action="edit">Edit</button>
          <button class="btn danger" data-id="${o.id}" data-action="delete">Delete</button>
          <button class="btn info" data-id="${o.id}" data-action="info">More Info</button>
        </td>
      </tr>
    `).join("") || `<tr><td colspan="11" style="text-align:center;">No data</td></tr>`;
        }

        function renderActivityFeed() {
            activityFeed.innerHTML = recentActivities.length ? recentActivities.map(a => `<li>${a}</li>`).reverse().join("") : `<li>No recent activity.</li>`;
        }

        function renderPipelineBoard() {
            pipelineBoard.innerHTML = STATUSES.map(status => {
                const items = outlets.filter(o => o.status === status);
                return `
        <div class="card">
          <strong>${capitalize(status)}</strong>
          <div>${items.map(i => `<p>${i.name} (${capitalize(i.type)})</p>`).join("") || "<em>No items</em>"}</div>
        </div>
      `;
            }).join("");
        }

        function renderFullMap() {
            fullMapFrame.src = `https://maps.google.com/maps?q=India&z=5&output=embed`;
        }

        function openInfoModal(outlet) {
            infoDetails.innerHTML = `
      <p><strong>Name:</strong> ${outlet.name}</p>
      <p><strong>Type:</strong> ${capitalize(outlet.type)}</p>
      <p><strong>Zone:</strong> ${capitalize(outlet.zone)}</p>
      <p><strong>Owner:</strong> ${outlet.owner}</p>
      <p><strong>Contact:</strong> ${outlet.contact}</p>
      <p><strong>Status:</strong> ${capitalize(outlet.status)}</p>
      <p><strong>Rating:</strong> ${renderStars(outlet.rating)}</p>
      <p><strong>Revenue:</strong> ${formatCurrency(outlet.revenue)}</p>
      <p><strong>Expenses:</strong> ${formatCurrency(outlet.expenses)}</p>
      <p><strong>Profit:</strong> <span style="color:${profit(outlet) >= 0 ? 'green' : 'red'}">${formatCurrency(profit(outlet))}</span></p>
    `;
            infoMap.src = `https://maps.google.com/maps?q=${outlet.latitude},${outlet.longitude}&z=15&output=embed`;
            infoModal.style.display = "flex";
        }

        function closeInfoModal() {
            infoModal.style.display = "none";
            infoMap.src = "";
        }

        function applyFilters() {
            const search = searchInputEl.value.toLowerCase();
            const type = filterTypeEl.value;
            const zone = filterZoneEl.value;
            const status = filterStatusEl.value;

            return outlets.filter(o => {
                return (
                    (o.name.toLowerCase().includes(search) || o.owner.toLowerCase().includes(search) || o.contact.includes(search)) &&
                    (type === "all" || o.type === type) &&
                    (zone === "all" || o.zone === zone) &&
                    (status === "all" || o.status === status)
                );
            });
        }

        function renderAll() {
            const filtered = applyFilters();
            renderDashboard();
            renderRegionSummary();
            renderOutletCards(filtered);
            renderOutletTable(filtered);
            renderActivityFeed();
            renderPipelineBoard();
            renderFullMap();
        }

        function addActivity(msg) {
            const time = new Date().toLocaleString();
            recentActivities.push(`[${time}] ${msg}`);
            if (recentActivities.length > 10) recentActivities.shift();
            saveActivities();
            renderActivityFeed();
        }

        openAddModalBtn.onclick = () => {
            editId = null;
            addOutletForm.reset();
            addOutletModal.style.display = "flex";
        };

        closeModalBtn.onclick = () => {
            addOutletModal.style.display = "none";
        };

        closeInfoBtn.onclick = closeInfoModal;

        addOutletForm.onsubmit = e => {
            e.preventDefault();
            const f = new FormData(addOutletForm);
            const data = {
                name: f.get("name").trim(),
                type: f.get("type"),
                zone: f.get("zone"),
                owner: f.get("owner").trim(),
                contact: f.get("contact").trim(),
                status: f.get("status"),
                rating: +f.get("rating"),
                revenue: +f.get("revenue"),
                expenses: +f.get("expenses"),
                latitude: +f.get("latitude"),
                longitude: +f.get("longitude"),
            };

            if (editId) {
                const i = outlets.findIndex(o => o.id === editId);
                outlets[i] = { ...outlets[i], ...data };
                addActivity(`Edited outlet "${data.name}"`);
            } else {
                outlets.push({ id: generateId(), ...data });
                addActivity(`Added new outlet "${data.name}"`);
            }

            saveData();
            renderAll();
            addOutletModal.style.display = "none";
        };

        function handleAction(e) {
            const btn = e.target.closest("button");
            if (!btn) return;
            const id = btn.dataset.id;
            const act = btn.dataset.action;
            const outlet = outlets.find(o => o.id === id);
            if (!outlet) return;

            if (act === "edit") {
                editId = id;
                addOutletModal.style.display = "flex";
                Object.entries(outlet).forEach(([k, v]) => {
                    if (addOutletForm[k]) addOutletForm[k].value = v;
                });
            } else if (act === "delete") {
                if (confirm("Delete this outlet?")) {
                    outlets = outlets.filter(o => o.id !== id);
                    saveData();
                    addActivity(`Deleted outlet "${outlet.name}"`);
                    renderAll();
                }
            } else if (act === "info") {
                openInfoModal(outlet);
            }
        }

        outletCardList.addEventListener("click", handleAction);
        outletTableBody.addEventListener("click", handleAction);

        [searchInputEl, filterTypeEl, filterZoneEl, filterStatusEl].forEach(i => i.addEventListener("input", renderAll));

        toggleCardBtn.onclick = () => {
            outletCardList.style.display = "grid";
            outletTableContainer.style.display = "none";
            toggleCardBtn.classList.add("active");
            toggleTableBtn.classList.remove("active");
        };

        toggleTableBtn.onclick = () => {
            outletCardList.style.display = "none";
            outletTableContainer.style.display = "block";
            toggleTableBtn.classList.add("active");
            toggleCardBtn.classList.remove("active");
        };

        loadData();
        renderAll();
    })();
</script>
<script>
    // Data Models
    let customers = [
        {
            id: "CU001",
            name: "Rajesh Dairy Farm",
            phone: "9876543210",
            email: "rajesh@dairy.com",
            address: "123 Milk Colony, Delhi",
            type: "wholesale",
            creditLimit: 50000,
            balance: 0,
            discount: 0.1 // 10% for wholesale
        },
        {
            id: "CU002",
            name: "Mohan Milk Center",
            phone: "8765432109",
            email: "mohan@milkcenter.com",
            address: "Gandhi Road, Mumbai",
            type: "retail",
            creditLimit: 20000,
            balance: 0,
            discount: 0.05 // 5% for retail
        },
        {
            id: "CU003",
            name: "Geeta Groceries",
            phone: "7654321098",
            email: "geeta@groceries.com",
            address: "Market Street, Kolkata",
            type: "retail",
            creditLimit: 15000,
            balance: 0,
            discount: 0.05
        },
        {
            id: "CU004",
            name: "Sunil Kumar",
            phone: "6543210987",
            email: "sunil@gmail.com",
            address: "45/A, MG Road, Bangalore",
            type: "consumer",
            creditLimit: 0, // No credit for consumers
            balance: 0,
            discount: 0
        },
        {
            id: "CU005",
            name: "Happy Dairy Products",
            phone: "9432109876",
            email: "happy@dairy.com",
            address: "Industrial Area, Chennai",
            type: "wholesale",
            creditLimit: 75000,
            balance: 0,
            discount: 0.1
        }
    ];

    let orders = [
        {
            id: "ORD1001",
            customerId: "CU001",
            date: "2023-09-15",
            items: [
                { product: "milk", qty: 20, price: 45 },
                { product: "curd", qty: 10, price: 40 }
            ],
            subtotal: 1300,
            discount: 130,
            total: 1170,
            paymentMethod: "credit",
            paymentStatus: "pending",
            amountPaid: 0
        },
        {
            id: "ORD1002",
            customerId: "CU002",
            date: "2023-09-14",
            items: [
                { product: "milk", qty: 15, price: 45 },
                { product: "paneer", qty: 5, price: 200 }
            ],
            subtotal: 1675,
            discount: 83.75,
            total: 1591.25,
            paymentMethod: "credit",
            paymentStatus: "pending",
            amountPaid: 0
        },
        {
            id: "ORD1003",
            customerId: "CU004",
            date: "2023-09-13",
            items: [
                { product: "milk", qty: 5, price: 45 },
                { product: "cheese", qty: 2, price: 300 }
            ],
            subtotal: 825,
            discount: 0,
            total: 825,
            paymentMethod: "cash",
            paymentStatus: "paid",
            amountPaid: 825
        }
    ];

    activityLog = [
        {
            type: "order",
            message: "Rajesh Dairy Farm placed an order for ‚Çπ1,170",
            timestamp: "2023-09-15T10:30:00"
        },
        {
            type: "customer",
            message: "Sunil Kumar was added to the system",
            timestamp: "2023-09-14T15:45:00"
        },
        {
            type: "payment",
            message: "Geeta Groceries paid ‚Çπ825 for order #ORD1003",
            timestamp: "2023-09-14T11:20:00"
        },
        {
            type: "update",
            message: "Happy Dairy Products' credit limit was increased to ‚Çπ75,000",
            timestamp: "2023-09-13T16:15:00"
        }
    ];

    const products = [
        { id: "milk", name: "Fresh Milk", price: 45 },
        { id: "curd", name: "Homemade Curd", price: 40 },
        { id: "paneer", name: "Farm Paneer", price: 200 },
        { id: "cheese", name: "Artisan Cheese", price: 300 }
    ];

    let currentCustomer = null;
    let editMode = false;

    // DOM Elements
    const customerTableBody = document.getElementById('customerTableBody');
    const orderList = document.getElementById('orderList');
    const activityList = document.getElementById('activityList');
    const orderModal = document.getElementById('orderModal');
    const customerModal = document.getElementById('customerFormModal');
    const orderForm = document.getElementById('orderForm');
    const customerForm = document.getElementById('customerForm');
    const creditLimitContainer = document.getElementById('creditLimitContainer');
    const orderFilter = document.getElementById('orderFilter');

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function () {
        renderCustomerTable();
        renderOrderList();
        renderActivityFeed();
        updateDashboard();
        initCharts();
        setupEventListeners();

        // Set today's date as default for order date
        document.getElementById('orderDate').valueAsDate = new Date();
    });

    // Render customer table
    function renderCustomerTable() {
        customerTableBody.innerHTML = '';

        customers.forEach(customer => {
            const row = document.createElement('tr');

            // Credit status indicator
            let creditStatus = '';
            if (customer.type !== 'consumer') {
                const creditAvailable = customer.creditLimit - customer.balance;
                const creditPercentage = (creditAvailable / customer.creditLimit) * 100;

                if (creditPercentage > 50) {
                    creditStatus = `<span class="credit-status credit-good">Good</span>`;
                } else if (creditPercentage > 20) {
                    creditStatus = `<span class="credit-status credit-warning">Warning</span>`;
                } else {
                    creditStatus = `<span class="credit-status credit-danger">Critical</span>`;
                }
            }

            row.innerHTML = `
          <td>${customer.id}</td>
          <td>${customer.name}</td>
          <td>${customer.phone}</td>
          <td>${capitalize(customer.type)}</td>
          <td>${customer.type !== 'consumer' ? '‚Çπ' + customer.creditLimit.toLocaleString() : 'N/A'}</td>
          <td>${customer.type !== 'consumer' ? '‚Çπ' + customer.balance.toLocaleString() + ' ' + creditStatus : 'N/A'}</td>
          <td class="actions">
            <button class="selectOrderBtn" data-id="${customer.id}"><i class="fas fa-shopping-cart"></i> Order</button>
            <button class="editBtn" data-id="${customer.id}"><i class="fas fa-edit"></i> Edit</button>
            <button class="deleteBtn" data-id="${customer.id}"><i class="fas fa-trash"></i> Delete</button>
          </td>
        `;
            customerTableBody.appendChild(row);
        });
    }

    // Render order list
    function renderOrderList() {
        orderList.innerHTML = '';
        const filter = orderFilter.value;

        const filteredOrders = orders.filter(order => {
            if (filter === 'all') return true;
            return order.paymentStatus === filter;
        });

        if (filteredOrders.length === 0) {
            orderList.innerHTML = '<tr><td colspan="6" style="text-align: center;">No orders found</td></tr>';
            return;
        }

        filteredOrders.forEach(order => {
            const customer = customers.find(c => c.id === order.customerId);
            const row = document.createElement('tr');

            row.innerHTML = `
          <td>${order.id}</td>
          <td>${customer ? customer.name : 'Unknown Customer'}</td>
          <td>${formatDate(order.date)}</td>
          <td>‚Çπ${order.total.toFixed(2)}</td>
          <td><span class="status-badge ${order.paymentStatus}">${capitalize(order.paymentStatus)}</span></td>
          <td>
            ${order.paymentStatus === 'pending' || order.paymentStatus === 'partial' ?
                    `<button class="mark-paid-btn" data-id="${order.id}">Mark Paid</button>` :
                    '<span class="credit-status credit-good">Paid</span>'}
          </td>
        `;

            orderList.appendChild(row);
        });
    }

    // Render activity feed
    function renderActivityFeed() {
        activityList.innerHTML = '';

        activityLog.forEach(activity => {
            const activityItem = document.createElement('div');
            activityItem.className = 'activity-item';

            let iconClass = '';
            switch (activity.type) {
                case 'order': iconClass = 'fas fa-shopping-cart'; break;
                case 'customer': iconClass = 'fas fa-user-plus'; break;
                case 'payment': iconClass = 'fas fa-money-bill-wave'; break;
                case 'update': iconClass = 'fas fa-edit'; break;
                default: iconClass = 'fas fa-info-circle';
            }

            activityItem.innerHTML = `
          <div class="activity-icon">
            <i class="${iconClass}"></i>
          </div>
          <div class="activity-content">
            <strong>${activity.message.split(':')[0]}</strong>
            <p>${activity.message.split(':').slice(1).join(':')}</p>
            <div class="activity-time">${formatDateTime(activity.timestamp)}</div>
          </div>
        `;

            activityList.appendChild(activityItem);
        });
    }

    // Update dashboard cards
    function updateDashboard() {
        // Total customers
        document.getElementById('totalCustomers').textContent = customers.length;

        // Active orders (pending and partial)
        const activeOrders = orders.filter(o => o.paymentStatus === 'pending' || o.paymentStatus === 'partial').length;
        document.getElementById('activeOrders').textContent = activeOrders;

        // Total sales
        const totalSales = orders.reduce((sum, order) => sum + order.total, 0);
        document.getElementById('totalSales').textContent = '‚Çπ' + totalSales.toLocaleString('en-IN');

        // Pending payments
        const pendingPayments = orders
            .filter(o => o.paymentStatus !== 'paid')
            .reduce((sum, order) => sum + (order.total - order.amountPaid), 0);
        document.getElementById('pendingPayments').textContent = '‚Çπ' + pendingPayments.toLocaleString('en-IN');
    }

    // Initialize charts
    function initCharts() {
        const productCtx = document.getElementById('productChart').getContext('2d');
        const typeCtx = document.getElementById('customerTypeChart').getContext('2d');

        // Product sales distribution
        const productData = {
            milk: 0,
            curd: 0,
            paneer: 0,
            cheese: 0
        };

        orders.forEach(order => {
            order.items.forEach(item => {
                productData[item.product] += item.qty;
            });
        });

        new Chart(productCtx, {
            type: 'pie',
            data: {
                labels: ['Milk', 'Curd', 'Paneer', 'Cheese'],
                datasets: [{
                    data: [productData.milk, productData.curd, productData.paneer, productData.cheese],
                    backgroundColor: ['#4caf50', '#2196f3', '#ff9800', '#9c27b0'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    title: {
                        display: true,
                        text: 'Product Sales Distribution'
                    }
                }
            }
        });

        // Revenue by customer type
        const typeData = {
            wholesale: 0,
            retail: 0,
            consumer: 0
        };

        orders.forEach(order => {
            const customer = customers.find(c => c.id === order.customerId);
            if (customer) {
                typeData[customer.type] += order.total;
            }
        });

        new Chart(typeCtx, {
            type: 'bar',
            data: {
                labels: ['Wholesale', 'Retail', 'End Consumer'],
                datasets: [{
                    label: 'Revenue (‚Çπ)',
                    data: [typeData.wholesale, typeData.retail, typeData.consumer],
                    backgroundColor: '#4c956c',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Revenue by Customer Type'
                    }
                }
            }
        });
    }

    // Setup event listeners
    function setupEventListeners() {
        // Add customer button
        document.getElementById('addCustomerBtn').addEventListener('click', () => {
            editMode = false;
            document.getElementById('formTitle').textContent = 'Add Customer';
            customerForm.reset();
            document.getElementById('customerId').value = '';
            customerModal.style.display = 'flex';
        });

        // Customer form submission
        customerForm.addEventListener('submit', saveCustomer);

        // Order form submission
        orderForm.addEventListener('submit', placeOrder);

        // Customer table actions
        customerTableBody.addEventListener('click', handleCustomerActions);

        // Order list actions
        orderList.addEventListener('click', handleOrderActions);

        // Modal close buttons
        document.getElementById('closeModal').addEventListener('click', () => orderModal.style.display = 'none');
        document.getElementById('closeCustomerModal').addEventListener('click', () => customerModal.style.display = 'none');
        document.getElementById('cancelOrderBtn').addEventListener('click', () => orderModal.style.display = 'none');
        document.getElementById('cancelFormBtn').addEventListener('click', () => customerModal.style.display = 'none');

        // Quantity controls
        document.querySelectorAll('.qty-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const product = this.dataset.product;
                const input = document.querySelector(`input[name="${product}Qty"]`);
                if (this.classList.contains('plus')) {
                    input.value = parseInt(input.value) + 1;
                } else if (this.classList.contains('minus') && input.value > 0) {
                    input.value = parseInt(input.value) - 1;
                }
                calculateOrderTotal();
            });
        });

        // Quantity input change
        document.querySelectorAll('input[type="number"]').forEach(input => {
            input.addEventListener('input', calculateOrderTotal);
        });

        // Customer type change
        document.getElementById('customerType').addEventListener('change', function () {
            creditLimitContainer.style.display = this.value !== 'consumer' ? 'block' : 'none';
        });

        // Order filter
        orderFilter.addEventListener('change', renderOrderList);

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function () {
            const searchTerm = this.value.toLowerCase();
            const rows = document.querySelectorAll('#customerTableBody tr');

            rows.forEach(row => {
                const name = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                const phone = row.querySelector('td:nth-child(3)').textContent.toLowerCase();

                if (name.includes(searchTerm) || phone.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        // Export CSV
        document.getElementById('exportCSV').addEventListener('click', exportCSV);
    }

    // Handle customer actions (order, edit, delete)
    function handleCustomerActions(e) {
        if (e.target.classList.contains('selectOrderBtn')) {
            const customerId = e.target.dataset.id;
            currentCustomer = customers.find(c => c.id === customerId);
            document.getElementById('modalCustomerName').value = currentCustomer.name;
            document.querySelectorAll('input[type="number"]').forEach(input => input.value = 0);
            calculateOrderTotal();
            orderModal.style.display = 'flex';
        }
        else if (e.target.classList.contains('editBtn')) {
            const customerId = e.target.dataset.id;
            editCustomer(customerId);
        }
        else if (e.target.classList.contains('deleteBtn')) {
            const customerId = e.target.dataset.id;
            deleteCustomer(customerId);
        }
    }

    // Handle order actions (mark as paid)
    function handleOrderActions(e) {
        if (e.target.classList.contains('mark-paid-btn')) {
            const orderId = e.target.dataset.id;
            markOrderAsPaid(orderId);
        }
    }

    // Edit customer
    function editCustomer(customerId) {
        editMode = true;
        const customer = customers.find(c => c.id === customerId);
        if (!customer) return;

        document.getElementById('formTitle').textContent = 'Edit Customer';
        document.getElementById('customerId').value = customer.id;
        document.getElementById('customerName').value = customer.name;
        document.getElementById('customerPhone').value = customer.phone;
        document.getElementById('customerEmail').value = customer.email || '';
        document.getElementById('customerAddress').value = customer.address;
        document.getElementById('customerType').value = customer.type;
        document.getElementById('creditLimit').value = customer.creditLimit;

        creditLimitContainer.style.display = customer.type !== 'consumer' ? 'block' : 'none';

        customerModal.style.display = 'flex';
    }

    // Delete customer
    function deleteCustomer(customerId) {
        if (!confirm('Are you sure you want to delete this customer?')) return;

        const customerIndex = customers.findIndex(c => c.id === customerId);
        if (customerIndex === -1) return;

        const customer = customers[customerIndex];

        // Check if customer has pending orders
        const hasOrders = orders.some(o => o.customerId === customerId && o.paymentStatus !== 'paid');
        if (hasOrders) {
            alert('Cannot delete customer with pending orders!');
            return;
        }

        customers.splice(customerIndex, 1);

        // Log activity
        logActivity(`Deleted customer ${customer.name}`);

        renderCustomerTable();
        updateDashboard();
    }

    // Save customer (add or edit)
    function saveCustomer(e) {
        e.preventDefault();

        const id = document.getElementById('customerId').value;
        const name = document.getElementById('customerName').value.trim();
        const phone = document.getElementById('customerPhone').value.trim();
        const email = document.getElementById('customerEmail').value.trim();
        const address = document.getElementById('customerAddress').value.trim();
        const type = document.getElementById('customerType').value;
        const creditLimit = type !== 'consumer' ? parseFloat(document.getElementById('creditLimit').value) : 0;

        // Validation
        if (!name || !phone || !address || !type) {
            alert('Please fill all required fields');
            return;
        }

        if (phone.length !== 10 || !/^\d+$/.test(phone)) {
            alert('Please enter a valid 10-digit phone number');
            return;
        }

        if (editMode) {
            // Update existing customer
            const customer = customers.find(c => c.id === id);
            if (customer) {
                customer.name = name;
                customer.phone = phone;
                customer.email = email;
                customer.address = address;
                customer.type = type;
                customer.creditLimit = creditLimit;

                // Set discount based on type
                customer.discount = type === 'wholesale' ? 0.1 : type === 'retail' ? 0.05 : 0;

                logActivity(`Updated customer ${name}`);
            }
        } else {
            // Create new customer
            const newId = 'CU' + (customers.length + 1).toString().padStart(3, '0');
            const discount = type === 'wholesale' ? 0.1 : type === 'retail' ? 0.05 : 0;

            customers.push({
                id: newId,
                name,
                phone,
                email,
                address,
                type,
                creditLimit,
                balance: 0,
                discount
            });

            logActivity(`Added new customer ${name}`);
        }

        customerModal.style.display = 'none';
        renderCustomerTable();
        updateDashboard();
    }

    // Place order
    function placeOrder(e) {
        e.preventDefault();

        if (!currentCustomer) return;

        const paymentMethod = document.getElementById('paymentMethod').value;
        const paymentStatus = document.getElementById('paymentStatus').value;

        if (!paymentMethod) {
            alert('Please select a payment method');
            return;
        }

        // Get quantities
        const milkQty = parseInt(document.querySelector('input[name="milkQty"]').value) || 0;
        const curdQty = parseInt(document.querySelector('input[name="curdQty"]').value) || 0;
        const paneerQty = parseInt(document.querySelector('input[name="paneerQty"]').value) || 0;
        const cheeseQty = parseInt(document.querySelector('input[name="cheeseQty"]').value) || 0;

        // Create order items
        const items = [];
        if (milkQty > 0) items.push({ product: 'milk', qty: milkQty, price: 45 });
        if (curdQty > 0) items.push({ product: 'curd', qty: curdQty, price: 40 });
        if (paneerQty > 0) items.push({ product: 'paneer', qty: paneerQty, price: 200 });
        if (cheeseQty > 0) items.push({ product: 'cheese', qty: cheeseQty, price: 300 });

        if (items.length === 0) {
            alert('Please add at least one product to the order');
            return;
        }

        // Calculate order details
        const subtotal = items.reduce((sum, item) => sum + (item.qty * item.price), 0);
        const discount = subtotal * currentCustomer.discount;
        const total = subtotal - discount;

        // Check credit limit if paying with credit
        if (paymentMethod === 'credit') {
            if (currentCustomer.balance + total > currentCustomer.creditLimit) {
                alert(`This order exceeds the customer's credit limit (‚Çπ${currentCustomer.creditLimit.toLocaleString('en-IN')})`);
                return;
            }
        }

        // Create order
        const orderId = 'ORD' + (orders.length + 1001);
        const orderDate = document.getElementById('orderDate').value;

        const order = {
            id: orderId,
            customerId: currentCustomer.id,
            date: orderDate,
            items,
            subtotal,
            discount,
            total,
            paymentMethod,
            paymentStatus,
            amountPaid: paymentStatus === 'paid' ? total : paymentStatus === 'partial' ? total * 0.5 : 0
        };

        orders.push(order);

        // Update customer balance
        if (paymentMethod === 'credit') {
            currentCustomer.balance += total;
        }

        // Log activity
        logActivity(`Placed new order #${orderId} for ${currentCustomer.name} (‚Çπ${total.toFixed(2)})`);

        orderModal.style.display = 'none';
        renderCustomerTable();
        renderOrderList();
        updateDashboard();
        initCharts();
    }

    // Mark order as paid
    function markOrderAsPaid(orderId) {
        const order = orders.find(o => o.id === orderId);
        if (!order) return;

        order.paymentStatus = 'paid';
        order.amountPaid = order.total;

        // Log activity
        logActivity(`Marked order #${orderId} as paid`);

        renderOrderList();
        updateDashboard();
    }

    // Calculate order total
    function calculateOrderTotal() {
        if (!currentCustomer) return;

        const milkQty = parseInt(document.querySelector('input[name="milkQty"]').value) || 0;
        const curdQty = parseInt(document.querySelector('input[name="curdQty"]').value) || 0;
        const paneerQty = parseInt(document.querySelector('input[name="paneerQty"]').value) || 0;
        const cheeseQty = parseInt(document.querySelector('input[name="cheeseQty"]').value) || 0;

        const subtotal =
            (milkQty * 45) +
            (curdQty * 40) +
            (paneerQty * 200) +
            (cheeseQty * 300);

        const discount = subtotal * currentCustomer.discount;
        const total = subtotal - discount;

        document.getElementById('subtotal').textContent = '‚Çπ' + subtotal.toFixed(2);
        document.getElementById('discount').textContent = '‚Çπ' + discount.toFixed(2);
        document.getElementById('orderTotal').textContent = '‚Çπ' + total.toFixed(2);
    }

    // Log activity
    function logActivity(message) {
        activityLog.unshift({
            type: 'info',
            message,
            timestamp: new Date().toISOString()
        });

        // Keep only the last 20 activities
        if (activityLog.length > 20) {
            activityLog.pop();
        }

        renderActivityFeed();
    }

    // Export CSV
    function exportCSV() {
        let csv = 'ID,Name,Phone,Type,Credit Limit,Balance\n';

        customers.forEach(customer => {
            csv += `"${customer.id}","${customer.name}","${customer.phone}","${customer.type}","${customer.creditLimit}","${customer.balance}"\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);

        link.setAttribute('href', url);
        link.setAttribute('download', 'dairy_customers.csv');
        link.style.visibility = 'hidden';

        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Helper functions
    function capitalize(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-IN', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    }

    function formatDateTime(dateTimeString) {
        const date = new Date(dateTimeString);
        return date.toLocaleString('en-IN', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }
</script>

<script>
    let payments = [
        { date: "2025-01-10", recipient: "Ravi Kumar", type: "Customer", amount: 1200, method: "UPI", status: "Received" },
        { date: "2025-03-18", recipient: "Meena Iyer", type: "Supplier", amount: 850, method: "Cash", status: "Pending" },
        { date: "2025-05-22", recipient: "Raj Patel", type: "Customer", amount: 650, method: "Bank Transfer", status: "Received" },
        { date: "2025-06-02", recipient: "Asha Nair", type: "Supplier", amount: 900, method: "Cheque", status: "Received" }
    ];
    let activityLog = [];
    editIndex = null;
    let trendChart, methodChart, statusChart, typeChart;

    function renderPayments() {
        const tbody = document.getElementById("paymentsTableBody");
        const feed = document.getElementById("activityFeed");
        tbody.innerHTML = "";
        feed.innerHTML = "";

        let total = 0, received = 0, pending = 0;
        payments.forEach((p, i) => {
            const amt = Number(p.amount);
            total += amt;
            if (p.status === "Received") received += amt;
            else pending += amt;

            tbody.innerHTML += `<tr><td>${p.date}</td><td>${p.recipient}</td><td>${p.type}</td><td>‚Çπ${p.amount}</td><td>${p.method}</td>
      <td><span class="status-badge ${p.status === 'Received' ? 'status-completed' : 'status-warning'}">${p.status}</span></td>
      <td><button class="btn" onclick="showReceipt(${i})">View</button></td>
      <td><button onclick="editPayment(${i})">‚úèÔ∏è</button><button onclick="deletePayment(${i})">üóëÔ∏è</button></td></tr>`;
        });

        activityLog.forEach(entry => {
            feed.innerHTML += `<li>${entry}</li>`;
        });

        document.getElementById("totalPayments").textContent = `‚Çπ${total}`;
        document.getElementById("paymentsReceived").textContent = `‚Çπ${received}`;
        document.getElementById("pendingPayments").textContent = `‚Çπ${pending}`;
        document.getElementById("averagePayment").textContent = payments.length ? `‚Çπ${(total / payments.length).toFixed(2)}` : '‚Çπ0';

        updateCharts();
    }

    function openPaymentModal() {
        editIndex = null;
        document.getElementById("paymentDate").value = "";
        document.getElementById("paymentRecipient").value = "";
        document.getElementById("paymentAmount").value = "";
        document.getElementById("paymentType").value = "Customer";
        document.getElementById("paymentMethod").value = "Cash";
        document.getElementById("paymentStatus").value = "Received";
        document.getElementById("paymentModal").style.display = "flex";
    }

    function closePaymentModal() {
        document.getElementById("paymentModal").style.display = "none";
    }

    function savePayment() {
        const date = document.getElementById("paymentDate").value;
        const recipient = document.getElementById("paymentRecipient").value.trim();
        const type = document.getElementById("paymentType").value;
        const amount = document.getElementById("paymentAmount").value;
        const method = document.getElementById("paymentMethod").value;
        const status = document.getElementById("paymentStatus").value;

        const nameRegex = /^[a-zA-Z\s]+$/;
        if (!date) return alert("Date is required.");
        if (!nameRegex.test(recipient)) return alert("Recipient name must contain only letters.");
        if (!amount || isNaN(amount) || amount <= 0) return alert("Enter valid amount.");

        const payment = { date, recipient, type, amount, method, status };
        if (editIndex !== null) {
            payments[editIndex] = payment;
            logActivity(`‚úèÔ∏è Updated payment for ${recipient} on ${date}`);
        } else {
            payments.push(payment);
            logActivity(`‚ûï Added payment for ${recipient} on ${date}`);
        }
        closePaymentModal();
        renderPayments();
    }

    function editPayment(i) {
        const p = payments[i]; editIndex = i;
        document.getElementById("paymentDate").value = p.date;
        document.getElementById("paymentRecipient").value = p.recipient;
        document.getElementById("paymentType").value = p.type;
        document.getElementById("paymentAmount").value = p.amount;
        document.getElementById("paymentMethod").value = p.method;
        document.getElementById("paymentStatus").value = p.status;
        document.getElementById("paymentModal").style.display = "flex";
    }

    function deletePayment(i) {
        const p = payments[i];
        logActivity(`üóëÔ∏è Deleted payment for ${p.recipient} dated ${p.date}`);
        payments.splice(i, 1);
        renderPayments();
    }

    function showReceipt(i) {
        const p = payments[i];
        document.getElementById("receiptContent").innerHTML = `
    <p><strong>Date:</strong> ${p.date}</p>
    <p><strong>Recipient:</strong> ${p.recipient}</p>
    <p><strong>Type:</strong> ${p.type}</p>
    <p><strong>Amount:</strong> ‚Çπ${p.amount}</p>
    <p><strong>Method:</strong> ${p.method}</p>
    <p><strong>Status:</strong> ${p.status}</p>`;
        document.getElementById("receiptModal").style.display = "flex";
    }

    function closeReceiptModal() {
        document.getElementById("receiptModal").style.display = "none";
    }

    function applyDateFilter() {
        const start = document.getElementById("filterStart").value;
        const end = document.getElementById("filterEnd").value;
        if (!start && !end) return renderPayments();
        const filtered = payments.filter(p => (!start || p.date >= start) && (!end || p.date <= end));
        renderFilteredPayments(filtered);
    }

    function renderFilteredPayments(filtered) {
        const tbody = document.getElementById("paymentsTableBody");
        tbody.innerHTML = "";
        filtered.forEach((p, i) => {
            tbody.innerHTML += `<tr><td>${p.date}</td><td>${p.recipient}</td><td>${p.type}</td><td>‚Çπ${p.amount}</td><td>${p.method}</td>
      <td><span class="status-badge ${p.status === 'Received' ? 'status-completed' : 'status-warning'}">${p.status}</span></td>
      <td><button class="btn" onclick="showReceipt(${i})">View</button></td>
      <td><button onclick="editPayment(${i})">‚úèÔ∏è</button><button onclick="deletePayment(${i})">üóëÔ∏è</button></td></tr>`;
        });
    }

    function logActivity(msg) {
        activityLog.unshift(`üßæ ${msg} - ${new Date().toLocaleString()}`);
    }

    function exportPayments(type) {
        const data = payments.map(p => ({ Date: p.date, Recipient: p.recipient, Type: p.type, Amount: p.amount, Method: p.method, Status: p.status }));
        if (type === 'pdf') {
            const doc = new jspdf.jsPDF();
            doc.autoTable({ head: [["Date", "Recipient", "Type", "Amount", "Method", "Status"]], body: data.map(Object.values) });
            doc.save("payments.pdf");
        } else {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Payments");
            XLSX.writeFile(wb, "payments.xlsx");
        }
    }

    function updateCharts() {
        const trend = new Array(12).fill(0);
        const method = { Cash: 0, UPI: 0, "Bank Transfer": 0, Cheque: 0 };
        const status = { Received: 0, Pending: 0 };
        const types = { Customer: 0, Supplier: 0 };

        payments.forEach(p => {
            const m = new Date(p.date).getMonth();
            trend[m] += Number(p.amount);
            method[p.method] += Number(p.amount);
            status[p.status] += 1;
            types[p.type] += 1;
        });

        if (trendChart) trendChart.destroy();
        trendChart = new Chart(document.getElementById("paymentTrendChart"), {
            type: 'bar',
            data: { labels: [..."Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" ")], datasets: [{ label: "Monthly", data: trend, backgroundColor: "#6366f1" }] },
            options: { responsive: true, plugins: { legend: { display: false } } }
        });

        if (methodChart) methodChart.destroy();
        methodChart = new Chart(document.getElementById("paymentMethodChart"), {
            type: 'pie',
            data: { labels: Object.keys(method), datasets: [{ data: Object.values(method), backgroundColor: ["#3b82f6", "#10b981", "#6366f1", "#f59e0b"] }] },
            options: { responsive: true }
        });

        if (statusChart) statusChart.destroy();
        statusChart = new Chart(document.getElementById("paymentStatusChart"), {
            type: 'doughnut',
            data: { labels: Object.keys(status), datasets: [{ data: Object.values(status), backgroundColor: ["#22c55e", "#ef4444"] }] },
            options: { responsive: true }
        });

        if (typeChart) typeChart.destroy();
        typeChart = new Chart(document.getElementById("paymentTypeChart"), {
            type: 'bar',
            data: { labels: Object.keys(types), datasets: [{ label: "Count", data: Object.values(types), backgroundColor: ["#8b5cf6", "#ec4899"] }] },
            options: { responsive: true, plugins: { legend: { display: false } } }
        });
    }

    renderPayments();
</script>

</html>
